<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPROCANN - Registro de Pacientes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .form-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-inputs {
            flex: 1;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-preview {
            flex: 1;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        label.required::after {
            content: " *";
            color: #e74c3c;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .signature-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
            background: white;
        }
        
        #signatureCanvas {
            border: 1px solid #ccc;
            background: white;
            width: 100%;
            height: 150px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
        }
        
        .signature-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block !important;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block !important;
        }
        
        .config-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .config-panel h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        /* Contenedor para vista previa del formulario con fondo */
        .preview-container {
            position: relative;
            width: 794px; /* Ancho A4 en 96 DPI */
            height: 1123px; /* Alto A4 en 96 DPI */
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .form-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        .form-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        .form-field {
            position: absolute;
            background: transparent;
            border: none;
            padding: 0;
            font-size: 11px;
            min-height: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            pointer-events: none;
        }
        
        .signature-canvas-container {
            position: absolute;
            border: 1px solid transparent;
            background: transparent;
            pointer-events: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-medical"></i> Sistema REPROCANN</h1>
            <p>Registro de Pacientes - Formulario Simplificado</p>
        </div>
        
        <!-- Mensajes de estado -->
        <div id="statusMessage" class="status-message"></div>
        
        <!-- Panel de configuraci√≥n -->
        <div class="config-panel">
            <h3><i class="fas fa-cog"></i> Configuraci√≥n del Sistema</h3>
            <div class="form-group">
                <label>URL del Google Apps Script:</label>
                <input type="text" id="scriptUrl" 
                       placeholder="Pega la URL del Google Apps Script aqu√≠" 
                       style="font-family: monospace; font-size: 0.9rem;">
                <div class="signature-buttons" style="margin-top: 10px;">
                    <button class="btn-secondary" onclick="saveScriptUrl()">
                        <i class="fas fa-save"></i> Guardar URL
                    </button>
                    <button class="btn-secondary" onclick="testConnection()">
                        <i class="fas fa-wifi"></i> Probar Conexi√≥n
                    </button>
                </div>
            </div>
        </div>
        
        <div class="form-container">
            <!-- Formulario para ingresar datos -->
            <div class="form-inputs">
                <div class="section-title">Datos del Paciente</div>
                
                <form id="pacienteForm">
                    <div class="form-group">
                        <label class="required">Apellido y Nombre</label>
                        <input type="text" id="paciente_apellidonombre" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">DNI</label>
                        <input type="text" id="paciente_doc" required pattern="\d{7,8}">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Fecha de Nacimiento</label>
                        <input type="date" id="paciente_nac" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Domicilio</label>
                        <input type="text" id="paciente_dom" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Tel√©fono Celular</label>
                        <input type="tel" id="paciente_telefono_celular" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Correo Electr√≥nico</label>
                        <input type="email" id="paciente_email" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Obra Social</label>
                        <input type="text" id="paciente_obra_social" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Patolog√≠a/Diagn√≥stico</label>
                        <textarea id="patologia" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Tratamiento Actual</label>
                        <textarea id="tratamiento_actual" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Otros Antecedentes M√©dicos</label>
                        <textarea id="otros_antecedentes"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>C√≥digo de Vinculaci√≥n (opcional)</label>
                        <input type="text" id="codigo_vinculacion">
                    </div>
                    
                    <div class="section-title" style="margin-top: 30px;">Firma del Paciente</div>
                    
                    <div class="signature-area">
                        <canvas id="signatureCanvas"></canvas>
                        <div class="signature-buttons">
                            <button type="button" class="btn-secondary" onclick="clearSignature()">
                                <i class="fas fa-eraser"></i> Limpiar Firma
                            </button>
                            <button type="button" class="btn-secondary" onclick="guardarFirma()">
                                <i class="fas fa-save"></i> Guardar Firma
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Fecha de Firma</label>
                        <input type="date" id="paciente_fecha" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-primary" onclick="submitForm()">
                            <i class="fas fa-paper-plane"></i> Guardar y Generar Vista
                        </button>
                        <button type="button" class="btn-danger" onclick="clearForm()">
                            <i class="fas fa-redo"></i> Limpiar Todo
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Vista previa del formulario con fondo -->
            <div class="form-preview">
                <div class="section-title">Vista Previa del Formulario</div>
                <div class="preview-container" id="previewContainer">
                    <!-- Aqu√≠ se generar√° la vista previa con el fondo y datos posicionados -->
                </div>
                <div class="signature-buttons" style="margin-top: 15px;">
                    <button class="btn-primary" onclick="imprimirFormulario()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <script>
        // Variables globales
        let signaturePad = null;
        let scriptUrl = localStorage.getItem('reprocann_script_url') || '';
        
        // Coordenadas exactas del CSV convertidas a p√≠xeles (A4: 794x1123px)
        // Factor de conversi√≥n: 72 DPI (PDF) a 96 DPI (pantalla)
        const coordenadas = {
            // Datos del paciente
            paciente_apellidonombre: { x: 148, y: 184, width: 378, height: 7 },
            paciente_doc: { x: 148, y: 198, width: 142, height: 6 },
            paciente_nac: { x: 371, y: 198, width: 155, height: 6 },
            paciente_dom: { x: 148, y: 211, width: 378, height: 6 },
            paciente_telefono_celular: { x: 371, y: 237, width: 155, height: 6 },
            paciente_email: { x: 148, y: 250, width: 378, height: 6 },
            paciente_obra_social: { x: 148, y: 263, width: 378, height: 6 },
            
            // √Åreas para patolog√≠a y tratamiento (usaremos √°reas del CSV correspondientes)
            patologia: { x: 148, y: 472, width: 234, height: 6 }, // Usando coordenadas de medico_apellidonombre
            tratamiento_actual: { x: 148, y: 485, width: 378, height: 6 }, // Usando coordenadas de medico_historiaclinica
            otros_antecedentes: { x: 148, y: 498, width: 378, height: 7 }, // Usando coordenadas de medico_diagnostico
            
            // Firma del paciente
            paciente_firma: { x: 375, y: 793, width: 164, height: 1 }, // F001
            paciente_fecha: { x: 57, y: 793, width: 166, height: 1 } // F002
        };
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            inicializarFirma();
            cargarConfiguracion();
            
            // Establecer fecha actual por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('paciente_nac').value = hoy;
            document.getElementById('paciente_fecha').value = hoy;
            
            console.log('‚úÖ Sistema REPROCANN inicializado');
        });
        
        function inicializarFirma() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            ctx.scale(ratio, ratio);
            
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 2
            });
        }
        
        function cargarConfiguracion() {
            if (scriptUrl) {
                document.getElementById('scriptUrl').value = scriptUrl;
                mostrarEstado('Configuraci√≥n cargada', 'success');
            }
        }
        
        // Configuraci√≥n del sistema
        function saveScriptUrl() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (url && (url.includes('google.com') || url.includes('script.google.com'))) {
                scriptUrl = url;
                localStorage.setItem('reprocann_script_url', url);
                mostrarEstado('‚úÖ URL guardada correctamente', 'success');
            } else {
                mostrarEstado('‚ùå URL inv√°lida. Debe ser una URL de Google Apps Script', 'error');
            }
        }
        
        async function testConnection() {
            if (!scriptUrl) {
                mostrarEstado('‚ùå Configure la URL primero', 'error');
                return;
            }
            
            mostrarEstado('üîç Probando conexi√≥n...', 'success');
            
            try {
                const response = await fetch(scriptUrl + '?test=1');
                const data = await response.json();
                
                if (data.status === 'online' || data.service === 'REPROCANN API') {
                    mostrarEstado('‚úÖ Conexi√≥n exitosa', 'success');
                } else {
                    mostrarEstado('‚ö†Ô∏è Respuesta inesperada del servidor', 'error');
                }
            } catch (error) {
                mostrarEstado('‚ùå Error de conexi√≥n: ' + error.message, 'error');
            }
        }
        
        // Funciones de firma
        function clearSignature() {
            if (signaturePad) {
                signaturePad.clear();
                mostrarEstado('Firma limpiada', 'success');
            }
        }
        
        function guardarFirma() {
            if (signaturePad && !signaturePad.isEmpty()) {
                localStorage.setItem('firma_paciente', signaturePad.toDataURL());
                mostrarEstado('‚úÖ Firma guardada temporalmente', 'success');
            } else {
                mostrarEstado('‚ùå Dibuje una firma primero', 'error');
            }
        }
        
        // Manejo de datos del formulario
        function obtenerDatosFormulario() {
            return {
                // Datos b√°sicos del paciente
                paciente_apellidonombre: document.getElementById('paciente_apellidonombre').value.trim(),
                paciente_doc: document.getElementById('paciente_doc').value.trim(),
                paciente_nac: document.getElementById('paciente_nac').value,
                paciente_dom: document.getElementById('paciente_dom').value.trim(),
                paciente_telefono_celular: document.getElementById('paciente_telefono_celular').value.trim(),
                paciente_email: document.getElementById('paciente_email').value.trim(),
                paciente_obra_social: document.getElementById('paciente_obra_social').value.trim(),
                
                // Datos m√©dicos
                patologia: document.getElementById('patologia').value.trim(),
                tratamiento_actual: document.getElementById('tratamiento_actual').value.trim(),
                otros_antecedentes: document.getElementById('otros_antecedentes').value.trim(),
                codigo_vinculacion: document.getElementById('codigo_vinculacion').value.trim(),
                
                // Firma
                paciente_firmaclaracion: signaturePad && !signaturePad.isEmpty() ? 
                    signaturePad.toDataURL() : localStorage.getItem('firma_paciente') || '',
                paciente_fecha: document.getElementById('paciente_fecha').value,
                
                // Metadatos
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                screenResolution: `${window.screen.width}x${window.screen.height}`
            };
        }
        
        function validarFormulario() {
            const datos = obtenerDatosFormulario();
            const camposRequeridos = [
                'paciente_apellidonombre',
                'paciente_doc',
                'paciente_nac',
                'paciente_dom',
                'paciente_telefono_celular',
                'paciente_email',
                'paciente_obra_social',
                'patologia',
                'tratamiento_actual',
                'paciente_fecha'
            ];
            
            const camposFaltantes = [];
            
            for (const campo of camposRequeridos) {
                if (!datos[campo] || datos[campo].toString().trim() === '') {
                    const nombreCampo = campo.replace(/_/g, ' ');
                    camposFaltantes.push(nombreCampo);
                }
            }
            
            // Validar DNI
            if (datos.paciente_doc && !/^\d{7,8}$/.test(datos.paciente_doc)) {
                camposFaltantes.push('DNI (7-8 d√≠gitos)');
            }
            
            // Validar firma
            if (!datos.paciente_firmaclaracion) {
                camposFaltantes.push('Firma del paciente');
            }
            
            if (camposFaltantes.length > 0) {
                mostrarEstado(`‚ùå Campos incompletos: ${camposFaltantes.join(', ')}`, 'error');
                return false;
            }
            
            return true;
        }
        
        // Env√≠o de datos y generaci√≥n de vista
        async function submitForm() {
            if (!validarFormulario()) return;
            
            if (!scriptUrl) {
                mostrarEstado('‚ùå Configure la URL del servicio primero', 'error');
                return;
            }
            
            const datos = obtenerDatosFormulario();
            mostrarEstado('üì§ Guardando datos y generando vista...', 'success');
            
            try {
                // Enviar datos al Google Apps Script
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarEstado('‚úÖ Datos guardados correctamente', 'success');
                    generarVistaPrevia(datos);
                    
                    // Mostrar informaci√≥n del registro
                    setTimeout(() => {
                        mostrarEstado(`Registrado en fila: ${result.data.fila} | Paciente: ${datos.paciente_apellidonombre}`, 'success');
                    }, 500);
                    
                } else {
                    mostrarEstado('‚ùå Error al guardar: ' + (result.message || 'Error desconocido'), 'error');
                    // Generar vista previa igualmente
                    generarVistaPrevia(datos);
                }
                
            } catch (error) {
                console.error('Error en el env√≠o:', error);
                mostrarEstado('‚ùå Error de conexi√≥n', 'error');
                // Generar vista previa con los datos locales
                generarVistaPrevia(datos);
            }
        }
        
        function generarVistaPrevia(datos) {
            const previewContainer = document.getElementById('previewContainer');
            
            // Crear estructura HTML con posicionamiento absoluto
            let html = `
                <div class="form-background">
                    <!-- Aqu√≠ ir√≠a la imagen recann-pagina-1.png como fondo -->
                    <div style="width: 100%; height: 100%; background: #f9f9f9; position: relative;">
                        <!-- T√≠tulos del formulario -->
                        <div style="position: absolute; top: 40px; left: 50px; font-size: 14px; font-weight: bold;">
                            Sistema REPROCANN - Formulario Completado
                        </div>
                        
                        <!-- L√≠neas divisorias y estructura del formulario -->
                        <div style="position: absolute; top: 80px; left: 50px; right: 50px; bottom: 50px; border: 1px solid #ddd; padding: 20px; background: white;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 30px;">
                                Fecha de registro: ${new Date().toLocaleString('es-AR')}
                            </div>
            `;
            
            // Agregar cada campo en su posici√≥n exacta
            for (const [campoId, valor] of Object.entries(datos)) {
                if (coordenadas[campoId]) {
                    const coord = coordenadas[campoId];
                    
                    // Solo mostrar campos que tengan valor
                    if (valor && valor !== '') {
                        html += `
                            <div class="form-field" 
                                 style="left: ${coord.x}px; top: ${coord.y}px; width: ${coord.width}px; height: ${coord.height}px;">
                                ${valor}
                            </div>
                        `;
                    }
                }
            }
            
            // Agregar la firma si existe
            if (datos.paciente_firmaclaracion && coordenadas.paciente_firma) {
                const coord = coordenadas.paciente_firma;
                html += `
                    <div class="signature-canvas-container" 
                         style="left: ${coord.x}px; top: ${coord.y}px; width: ${coord.width}px; height: ${coord.height}px;">
                        <img src="${datos.paciente_firmaclaracion}" 
                             style="width: 100%; height: auto; max-height: 50px;">
                    </div>
                `;
            }
            
            // Fecha de firma
            if (datos.paciente_fecha && coordenadas.paciente_fecha) {
                const coord = coordenadas.paciente_fecha;
                html += `
                    <div class="form-field" 
                         style="left: ${coord.x}px; top: ${coord.y}px; width: ${coord.width}px; height: ${coord.height}px;">
                        ${datos.paciente_fecha}
                    </div>
                `;
            }
            
            html += `
                        </div>
                        
                        <!-- Pie de p√°gina -->
                        <div style="position: absolute; bottom: 20px; left: 50px; font-size: 10px; color: #999;">
                            Sistema REPROCANN v3.0 | Formulario generado autom√°ticamente
                        </div>
                    </div>
                </div>
            `;
            
            previewContainer.innerHTML = html;
            
            // Ajustar el tama√±o del contenedor de vista previa
            previewContainer.style.width = '794px';
            previewContainer.style.height = '1123px';
            
            mostrarEstado('‚úÖ Vista previa generada correctamente', 'success');
        }
        
        function imprimirFormulario() {
            const previewContainer = document.getElementById('previewContainer');
            if (previewContainer.innerHTML.trim() === '') {
                mostrarEstado('‚ùå Genere la vista previa primero', 'error');
                return;
            }
            
            const ventanaImpresion = window.open('', '_blank');
            ventanaImpresion.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>REPROCANN - Formulario para Imprimir</title>
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 0;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                            }
                        }
                        .formulario-impresion {
                            width: 794px;
                            height: 1123px;
                            background: white;
                            position: relative;
                            margin: 0 auto;
                        }
                        .form-field {
                            position: absolute;
                            font-size: 11px;
                            white-space: nowrap;
                            overflow: hidden;
                        }
                        .firma-img {
                            position: absolute;
                            max-width: 200px;
                            max-height: 50px;
                        }
                    </style>
                </head>
                <body>
                    ${previewContainer.innerHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 1000);
                        }
                    <\/script>
                </body>
                </html>
            `);
            ventanaImpresion.document.close();
        }
        
        function clearForm() {
            if (confirm('¬øEst√° seguro que desea limpiar todo el formulario?')) {
                // Limpiar todos los campos
                const inputs = document.querySelectorAll('#pacienteForm input, #pacienteForm textarea');
                inputs.forEach(input => {
                    if (input.type !== 'button' && input.type !== 'submit' && input.id !== 'scriptUrl') {
                        input.value = '';
                    }
                });
                
                // Limpiar firma
                clearSignature();
                
                // Establecer fecha actual
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('paciente_nac').value = hoy;
                document.getElementById('paciente_fecha').value = hoy;
                
                // Limpiar vista previa
                document.getElementById('previewContainer').innerHTML = '';
                
                // Limpiar localStorage temporal
                localStorage.removeItem('firma_paciente');
                
                mostrarEstado('Formulario limpiado', 'success');
            }
        }
        
        function mostrarEstado(mensaje, tipo) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = mensaje;
            statusDiv.className = `status-message status-${tipo}`;
            statusDiv.style.display = 'block';
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                if (statusDiv.textContent === mensaje) {
                    statusDiv.style.display = 'none';
                }
            }, 5000);
        }
    </script>
</body>
</html>
