<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario REPROCANN - Prueba</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .section-title {
            background-color: #f8f9fa;
            padding: 10px;
            border-left: 4px solid #007bff;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .signature-container {
            border: 1px solid #ced4da;
            background-color: #f8f9fa;
            border-radius: 4px;
            cursor: crosshair;
            touch-action: none;
        }
        .btn-clear {
            margin-top: 10px;
        }
        .form-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .existing-data {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1 class="text-center mb-4">Formulario REPROCANN - PRUEBA</h1>
        <p class="text-center text-muted mb-4">Todos los campos son opcionales para pruebas</p>
        
        <div id="existingDataAlert" class="existing-data">
            <h5>üìã Datos existentes encontrados para este DNI</h5>
            <p id="existingDataText"></p>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadExistingData()">Cargar datos existentes</button>
        </div>
        
        <form id="reprocannForm">
            <!-- Secci√≥n Paciente -->
            <div class="section-title">Datos del Paciente</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="paciente_doc" class="form-label">DNI del Paciente</label>
                    <input type="text" class="form-control" id="paciente_doc">
                    <small class="text-muted">Al ingresar DNI, se buscar√°n datos existentes</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="paciente_apellidonombre" class="form-label">Apellido y Nombre</label>
                    <input type="text" class="form-control" id="paciente_apellidonombre">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="paciente_nac" class="form-label">Fecha de Nacimiento</label>
                    <input type="date" class="form-control" id="paciente_nac">
                </div>
                <div class="col-md-8 mb-3">
                    <label for="paciente_dom" class="form-label">Domicilio</label>
                    <input type="text" class="form-control" id="paciente_dom">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="paciente_telefono_particular" class="form-label">Tel√©fono Particular</label>
                    <input type="tel" class="form-control" id="paciente_telefono_particular">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="paciente_telefono_celular" class="form-label">Tel√©fono Celular</label>
                    <input type="tel" class="form-control" id="paciente_telefono_celular">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="paciente_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="paciente_email">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="paciente_obra_social" class="form-label">Obra Social</label>
                    <input type="text" class="form-control" id="paciente_obra_social">
                </div>
            </div>
            
            <!-- Secci√≥n Tutor -->
            <div class="section-title">Datos del Tutor (si corresponde)</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="tutor_apellido_nombre" class="form-label">Apellido y Nombre del Tutor</label>
                    <input type="text" class="form-control" id="tutor_apellido_nombre">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="tutor_tipo_doc" class="form-label">Tipo Doc.</label>
                    <select class="form-select" id="tutor_tipo_doc">
                        <option value="">Seleccionar</option>
                        <option value="DNI">DNI</option>
                        <option value="LC">LC</option>
                        <option value="LE">LE</option>
                        <option value="PAS">Pasaporte</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="tutor_nro_doc" class="form-label">N√∫mero Doc.</label>
                    <input type="text" class="form-control" id="tutor_nro_doc">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="tutor_domicilio" class="form-label">Domicilio</label>
                    <input type="text" class="form-control" id="tutor_domicilio">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="tutor_localidad" class="form-label">Localidad</label>
                    <input type="text" class="form-control" id="tutor_localidad">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="tutor_provincia" class="form-label">Provincia</label>
                    <input type="text" class="form-control" id="tutor_provincia">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="tutor_cp" class="form-label">C√≥digo Postal</label>
                    <input type="text" class="form-control" id="tutor_cp">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="tutor_vinculo" class="form-label">V√≠nculo</label>
                    <input type="text" class="form-control" id="tutor_vinculo">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="tutor_telefono_particular" class="form-label">Tel√©fono Particular</label>
                    <input type="tel" class="form-control" id="tutor_telefono_particular">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="tutor_celular" class="form-label">Tel√©fono Celular</label>
                    <input type="tel" class="form-control" id="tutor_celular">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="tutor_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="tutor_email">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="tutor_obrasocial" class="form-label">Obra Social</label>
                    <input type="text" class="form-control" id="tutor_obrasocial">
                </div>
            </div>
            
            <!-- Secci√≥n M√©dico -->
            <div class="section-title">Datos del M√©dico</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="medico_apellidonombre" class="form-label">Apellido y Nombre</label>
                    <input type="text" class="form-control" id="medico_apellidonombre">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="medico_doc" class="form-label">DNI M√©dico</label>
                    <input type="text" class="form-control" id="medico_doc">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="medico_matricula" class="form-label">Matr√≠cula</label>
                    <input type="text" class="form-control" id="medico_matricula">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="medico_especialidad" class="form-label">Especialidad</label>
                    <input type="text" class="form-control" id="medico_especialidad">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="medico_tel_particular" class="form-label">Tel√©fono Particular</label>
                    <input type="tel" class="form-control" id="medico_tel_particular">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="medico_tel_cel" class="form-label">Tel√©fono Celular</label>
                    <input type="tel" class="form-control" id="medico_tel_cel">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="medico_email" class="form-label">Email M√©dico</label>
                    <input type="email" class="form-control" id="medico_email">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_historiaclinica" class="form-label">Resumen Historia Cl√≠nica</label>
                    <textarea class="form-control" id="medico_historiaclinica" rows="2"></textarea>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_diagnostico_ypatologia" class="form-label">Diagn√≥stico y Patolog√≠as Asociadas</label>
                    <textarea class="form-control" id="medico_diagnostico_ypatologia" rows="2"></textarea>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_tratamiento" class="form-label">Tratamiento</label>
                    <textarea class="form-control" id="medico_tratamiento" rows="2"></textarea>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_justificacion" class="form-label">Justificaci√≥n del Cambio</label>
                    <textarea class="form-control" id="medico_justificacion" rows="2"></textarea>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_productoindicado" class="form-label">Producto Indicado</label>
                    <textarea class="form-control" id="medico_productoindicado" rows="2"></textarea>
                </div>
            </div>
            
            <!-- Firma del M√©dico -->
            <div class="section-title">Firma del M√©dico</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Firma del M√©dico</label>
                    <div style="width: 100%; height: 150px; position: relative;">
                        <canvas id="signatureMedico" class="signature-container"></canvas>
                    </div>
                    <button type="button" class="btn btn-secondary btn-clear" onclick="clearSignature('signatureMedico')">Limpiar Firma</button>
                    <input type="hidden" id="medico_firmaclaracion">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="medico_sello" class="form-label">Sello del Consultorio</label>
                    <input type="text" class="form-control" id="medico_sello">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="medico_fecha" class="form-label">Fecha de Emisi√≥n</label>
                    <input type="date" class="form-control" id="medico_fecha">
                </div>
            </div>
            
            <!-- Firma del Paciente/Tutor -->
            <div class="section-title">Firma del Paciente/Tutor</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Firma del Paciente/Tutor</label>
                    <div style="width: 100%; height: 150px; position: relative;">
                        <canvas id="signaturePaciente" class="signature-container"></canvas>
                    </div>
                    <button type="button" class="btn btn-secondary btn-clear" onclick="clearSignature('signaturePaciente')">Limpiar Firma</button>
                    <input type="hidden" id="paciente_firmaclaracion">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="paciente_fecha" class="form-label">Fecha de Firma</label>
                    <input type="date" class="form-control" id="paciente_fecha">
                </div>
            </div>
            
            <!-- Botones de acci√≥n -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="button" class="btn btn-success me-md-2" onclick="testLocalStorage()">Probar Datos Locales</button>
                <button type="button" class="btn btn-secondary me-md-2" onclick="previewPDF()">Vista Previa PDF</button>
                <button type="button" class="btn btn-primary" onclick="saveToGoogleSheets()">Guardar en Google Sheets</button>
            </div>
            
            <!-- Debug Info -->
            <div class="mt-4 p-3 bg-light border rounded">
                <h6>Informaci√≥n de Debug:</h6>
                <div id="debugInfo"></div>
            </div>
        </form>
    </div>

    <!-- Modal para vista previa -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vista Previa del Formulario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <iframe id="pdfPreview" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="printPreview()">Imprimir</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        let existingPatientData = null;
        let signaturePadMedico = null;
        let signaturePadPaciente = null;
        
        // Inicializar pads de firma
        document.addEventListener('DOMContentLoaded', function() {
            const canvasMedico = document.getElementById('signatureMedico');
            const canvasPaciente = document.getElementById('signaturePaciente');
            
            // Configurar canvas
            canvasMedico.width = canvasMedico.offsetWidth;
            canvasMedico.height = canvasMedico.offsetHeight;
            
            canvasPaciente.width = canvasPaciente.offsetWidth;
            canvasPaciente.height = canvasPaciente.offsetHeight;
            
            signaturePadMedico = new SignaturePad(canvasMedico, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 3
            });
            
            signaturePadPaciente = new SignaturePad(canvasPaciente, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 3
            });
            
            // Fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('medico_fecha').value = today;
            document.getElementById('paciente_fecha').value = today;
            
            // Cargar datos de prueba
            loadTestData();
        });
        
        function resizeCanvas(canvas, signaturePad) {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            
            if (signaturePad) {
                signaturePad.clear();
            }
        }
        
        function clearSignature(signatureId) {
            if (signatureId === 'signatureMedico' && signaturePadMedico) {
                signaturePadMedico.clear();
            } else if (signatureId === 'signaturePaciente' && signaturePadPaciente) {
                signaturePadPaciente.clear();
            }
        }
        
        function loadTestData() {
            // Datos de prueba para verificar que funciona
            document.getElementById('paciente_doc').value = '12345678';
            document.getElementById('paciente_apellidonombre').value = 'Gonz√°lez, Juan';
            document.getElementById('paciente_dom').value = 'Calle Falsa 123';
            document.getElementById('paciente_telefono_celular').value = '1122334455';
            document.getElementById('paciente_email').value = 'juan@ejemplo.com';
            
            document.getElementById('medico_apellidonombre').value = 'Dr. P√©rez, Carlos';
            document.getElementById('medico_matricula').value = 'MP-12345';
            document.getElementById('medico_especialidad').value = 'Neurolog√≠a';
            document.getElementById('medico_email').value = 'drperez@ejemplo.com';
            
            updateDebugInfo('Datos de prueba cargados');
        }
        
        async function checkExistingPatient(dni) {
            if (!dni || dni.length < 3) return;
            
            updateDebugInfo(`Buscando paciente con DNI: ${dni}`);
            
            try {
                // Simulaci√≥n de b√∫squeda
                if (dni === '12345678') {
                    existingPatientData = {
                        paciente_apellidonombre: 'Gonz√°lez, Juan',
                        paciente_nac: '1985-05-15',
                        paciente_dom: 'Calle Falsa 123',
                        paciente_telefono_celular: '1122334455',
                        paciente_email: 'juan@ejemplo.com'
                    };
                    
                    document.getElementById('existingDataText').textContent = 
                        `Paciente: ${existingPatientData.paciente_apellidonombre}`;
                    document.getElementById('existingDataAlert').style.display = 'block';
                    
                    updateDebugInfo('Datos existentes encontrados (simulaci√≥n)');
                } else {
                    existingPatientData = null;
                    document.getElementById('existingDataAlert').style.display = 'none';
                    updateDebugInfo('No se encontraron datos para este DNI');
                }
            } catch (error) {
                console.error('Error checking patient:', error);
                updateDebugInfo('Error en b√∫squeda: ' + error.message);
            }
        }
        
        function loadExistingData() {
            if (!existingPatientData) return;
            
            for (const [key, value] of Object.entries(existingPatientData)) {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            }
            
            updateDebugInfo('Datos existentes cargados en el formulario');
        }
        
        function getAllFormData() {
            const formElements = document.querySelectorAll('#reprocannForm input, #reprocannForm textarea, #reprocannForm select');
            const data = {};
            
            formElements.forEach(element => {
                if (element.id) {
                    data[element.id] = element.value;
                }
            });
            
            // Agregar firmas como im√°genes base64
            if (signaturePadMedico && !signaturePadMedico.isEmpty()) {
                data.medico_firmaclaracion = signaturePadMedico.toDataURL('image/png');
            } else {
                data.medico_firmaclaracion = '';
            }
            
            if (signaturePadPaciente && !signaturePadPaciente.isEmpty()) {
                data.paciente_firmaclaracion = signaturePadPaciente.toDataURL('image/png');
            } else {
                data.paciente_firmaclaracion = '';
            }
            
            // Agregar timestamp
            data.timestamp = new Date().toISOString();
            
            return data;
        }
        
        function previewPDF() {
            const data = getAllFormData();
            
            // Mostrar datos en consola para debug
            console.log('Datos para preview:', data);
            updateDebugInfo(`Enviando ${Object.keys(data).length} campos al preview`);
            
            // Guardar datos en sessionStorage
            sessionStorage.setItem('reprocannFormData', JSON.stringify(data));
            
            // Abrir preview en nueva pesta√±a
            const previewWindow = window.open('pdf_preview.html', '_blank');
            if (previewWindow) {
                // Los datos se cargar√°n desde sessionStorage en la nueva ventana
                updateDebugInfo('Preview abierto en nueva ventana');
            } else {
                updateDebugInfo('Error: No se pudo abrir el preview. Verifica los bloqueadores de ventanas emergentes.');
            }
        }
        
        function testLocalStorage() {
            const data = getAllFormData();
            
            // Guardar en localStorage
            localStorage.setItem('reprocann_last_form', JSON.stringify(data));
            
            // Mostrar confirmaci√≥n
            updateDebugInfo(`
                ‚úÖ Datos guardados localmente<br>
                Total campos: ${Object.keys(data).length}<br>
                Firma m√©dico: ${data.medico_firmaclaracion ? 'S√≠' : 'No'}<br>
                Firma paciente: ${data.paciente_firmaclaracion ? 'S√≠' : 'No'}<br>
                <button class="btn btn-sm btn-info mt-2" onclick="showLocalData()">Ver datos guardados</button>
            `);
            
            alert('Datos guardados localmente para pruebas. Revisa la secci√≥n de debug.');
        }
        
        function showLocalData() {
            const data = JSON.parse(localStorage.getItem('reprocann_last_form') || '{}');
            console.log('Datos en localStorage:', data);
            alert(JSON.stringify(data, null, 2));
        }
        
        async function saveToGoogleSheets() {
            const data = getAllFormData();
            
            updateDebugInfo('Enviando datos a Google Sheets...');
            
            try {
                // URL de prueba - reemplazar con tu URL de Google Apps Script
                const scriptUrl = 'https://script.google.com/macros/s/AKfycbyXRGQ3c96NU1Ku-1xkPRw4Xe21fLptvrKopZzK60stWt9jSQpyAvTrLviqB80sZ7zj/exec';
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.text();
                updateDebugInfo(`‚úÖ Respuesta de Google Sheets: ${result}`);
                alert('Datos enviados a Google Sheets exitosamente');
                
            } catch (error) {
                console.error('Error:', error);
                updateDebugInfo(`‚ùå Error al enviar: ${error.message}`);
                alert('Error al enviar datos. Revisa la consola y la configuraci√≥n de Google Apps Script.');
            }
        }
        
        function updateDebugInfo(message) {
            document.getElementById('debugInfo').innerHTML = message;
        }
        
        function printPreview() {
            const iframe = document.getElementById('pdfPreview');
            iframe.contentWindow.print();
        }
        
        // Event listeners
        document.getElementById('paciente_doc').addEventListener('blur', function() {
            checkExistingPatient(this.value);
        });
        
        // Redimensionar canvas al cambiar tama√±o de ventana
        window.addEventListener('resize', function() {
            const canvasMedico = document.getElementById('signatureMedico');
            const canvasPaciente = document.getElementById('signaturePaciente');
            
            canvasMedico.width = canvasMedico.offsetWidth;
            canvasMedico.height = canvasMedico.offsetHeight;
            
            canvasPaciente.width = canvasPaciente.offsetWidth;
            canvasPaciente.height = canvasPaciente.offsetHeight;
            
            if (signaturePadMedico) signaturePadMedico.clear();
            if (signaturePadPaciente) signaturePadPaciente.clear();
        });
    </script>
</body>
</html>
