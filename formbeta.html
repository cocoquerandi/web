<!-- formulario-reprocann.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPROCANN - Registro de Pacientes</title>
    <style>
        /* Estilos profesionales minimalistas */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .form-content {
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        label.required::after {
            content: " *";
            color: #e74c3c;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .signature-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        
        #signatureCanvas {
            border: 1px solid #ccc;
            background: white;
            width: 100%;
            height: 200px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
        }
        
        .signature-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .config-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }
        
        .config-panel h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-medical"></i> Sistema REPROCANN</h1>
            <p>Registro Nacional del Programa de Cannabis</p>
        </div>
        
        <div class="form-content">
            <!-- Mensaje de estado -->
            <div id="statusMessage" class="status"></div>
            
            <!-- Panel de configuraci√≥n -->
            <div class="config-panel">
                <h3><i class="fas fa-cog"></i> Configuraci√≥n del Sistema</h3>
                <div class="form-group">
                    <label>URL del Servicio:</label>
                    <input type="text" id="scriptUrl" placeholder="Pega la URL del Google Apps Script aqu√≠">
                    <div class="signature-buttons" style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="saveScriptUrl()">
                            <i class="fas fa-save"></i> Guardar URL
                        </button>
                        <button class="btn-secondary" onclick="testConnection()">
                            <i class="fas fa-wifi"></i> Probar Conexi√≥n
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Formulario -->
            <form id="pacienteForm">
                <!-- Datos Personales -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-user"></i>
                        <span>Datos Personales</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">DNI</label>
                            <input type="text" id="paciente_doc" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Apellido y Nombre</label>
                            <input type="text" id="paciente_apellidonombre" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha de Nacimiento</label>
                            <input type="date" id="paciente_nac">
                        </div>
                        <div class="form-group">
                            <label class="required">Tel√©fono Celular</label>
                            <input type="tel" id="paciente_telefono_celular" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Domicilio</label>
                        <input type="text" id="paciente_dom">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="paciente_email">
                        </div>
                        <div class="form-group">
                            <label>Obra Social</label>
                            <input type="text" id="paciente_obra_social">
                        </div>
                    </div>
                </div>
                
                <!-- Datos M√©dicos -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-stethoscope"></i>
                        <span>Informaci√≥n M√©dica</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Patolog√≠a/Diagn√≥stico</label>
                        <textarea id="patologia"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Tratamiento Actual</label>
                        <textarea id="tratamiento_actual"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>C√≥digo de Vinculaci√≥n</label>
                        <input type="text" id="codigo_vinculacion">
                    </div>
                </div>
                
                <!-- Firma -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-signature"></i>
                        <span>Firma Digital</span>
                    </div>
                    
                    <div class="signature-area">
                        <canvas id="signatureCanvas"></canvas>
                        <div class="signature-buttons">
                            <button type="button" class="btn-secondary" onclick="clearSignature()">
                                <i class="fas fa-eraser"></i> Limpiar Firma
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" style="max-width: 300px; margin: 20px auto 0;">
                        <label class="required">Fecha de Firma</label>
                        <input type="date" id="paciente_fecha" required>
                    </div>
                </div>
                
                <!-- Botones de acci√≥n -->
                <div class="form-actions">
                    <button type="button" class="btn-primary" onclick="submitForm()">
                        <i class="fas fa-paper-plane"></i> Enviar Formulario
                    </button>
                    <button type="button" class="btn-success" onclick="previewForm()">
                        <i class="fas fa-eye"></i> Vista Previa
                    </button>
                    <button type="button" class="btn-danger" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Limpiar Todo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        // Variables globales
        let signaturePad = null;
        let scriptUrl = localStorage.getItem('reprocann_script_url') || '';
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar canvas de firma
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            ctx.scale(ratio, ratio);
            
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 3
            });
            
            // Cargar configuraci√≥n
            if (scriptUrl) {
                document.getElementById('scriptUrl').value = scriptUrl;
                showStatus('‚úÖ Configuraci√≥n cargada', 'success');
            }
            
            // Fecha actual
            document.getElementById('paciente_fecha').value = new Date().toISOString().split('T')[0];
            
            // Auto-guardar
            setupAutoSave();
            
            console.log('‚úÖ Sistema REPROCANN listo');
        });
        
        // Configuraci√≥n
        function saveScriptUrl() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (url && url.includes('google.com')) {
                scriptUrl = url;
                localStorage.setItem('reprocann_script_url', url);
                showStatus('‚úÖ URL guardada correctamente', 'success');
            } else {
                showStatus('‚ùå URL inv√°lida', 'error');
            }
        }
        
        async function testConnection() {
            if (!scriptUrl) {
                showStatus('‚ùå Configure la URL primero', 'error');
                return;
            }
            
            showStatus('üîç Probando conexi√≥n...', 'success');
            
            try {
                const response = await fetch(scriptUrl + '?test=1');
                const data = await response.json();
                
                if (data.status === 'online') {
                    showStatus('‚úÖ Conexi√≥n exitosa con el servidor', 'success');
                } else {
                    showStatus('‚ö†Ô∏è Servidor respondi√≥ con estado inesperado', 'error');
                }
            } catch (error) {
                showStatus('‚ùå Error de conexi√≥n', 'error');
            }
        }
        
        // Manejo de datos
        function getFormData() {
            return {
                paciente_doc: document.getElementById('paciente_doc').value.trim(),
                paciente_apellidonombre: document.getElementById('paciente_apellidonombre').value.trim(),
                paciente_nac: document.getElementById('paciente_nac').value,
                paciente_dom: document.getElementById('paciente_dom').value.trim(),
                paciente_telefono_celular: document.getElementById('paciente_telefono_celular').value.trim(),
                paciente_email: document.getElementById('paciente_email').value.trim(),
                paciente_obra_social: document.getElementById('paciente_obra_social').value.trim(),
                patologia: document.getElementById('patologia').value.trim(),
                tratamiento_actual: document.getElementById('tratamiento_actual').value.trim(),
                codigo_vinculacion: document.getElementById('codigo_vinculacion').value.trim(),
                paciente_fecha: document.getElementById('paciente_fecha').value,
                paciente_firmaclaracion: signaturePad && !signaturePad.isEmpty() ? 
                    signaturePad.toDataURL('image/png') : '',
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                screenResolution: `${window.screen.width}x${window.screen.height}`
            };
        }
        
        function validateForm() {
            // Campos requeridos
            const required = ['paciente_doc', 'paciente_apellidonombre', 'paciente_telefono_celular'];
            
            for (const field of required) {
                const value = document.getElementById(field).value.trim();
                if (!value) {
                    showStatus(`‚ùå Complete el campo: ${field.replace('_', ' ')}`, 'error');
                    return false;
                }
            }
            
            // Validar firma
            if (!signaturePad || signaturePad.isEmpty()) {
                showStatus('‚ùå Dibuje su firma', 'error');
                return false;
            }
            
            // Validar DNI
            const dni = document.getElementById('paciente_doc').value.trim();
            if (dni && !/^\d{7,8}$/.test(dni)) {
                showStatus('‚ùå DNI inv√°lido (7-8 d√≠gitos)', 'error');
                return false;
            }
            
            return true;
        }
        
        // Env√≠o de datos
        async function submitForm() {
            if (!validateForm()) return;
            if (!scriptUrl) {
                showStatus('‚ùå Configure la URL del servicio', 'error');
                return;
            }
            
            const formData = getFormData();
            showStatus('üì§ Enviando datos...', 'success');
            
            try {
                // M√©todo principal
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                // IMPORTANTE: En modo 'no-cors' no podemos leer la respuesta
                // Pero sabemos que si no hay error, se envi√≥
                
                // Crear un fallback para verificar el env√≠o
                setTimeout(() => {
                    showStatus('‚úÖ Formulario enviado correctamente', 'success');
                    showSuccessMessage(formData);
                    
                    // Guardar en localStorage como backup
                    saveLocalBackup(formData);
                    
                    // Opcional: limpiar formulario despu√©s de enviar
                    setTimeout(() => {
                        if (confirm('¬øDesea limpiar el formulario para un nuevo registro?')) {
                            clearForm();
                        }
                    }, 2000);
                }, 1500);
                
            } catch (error) {
                console.error('Error en env√≠o:', error);
                showStatus('‚ùå Error al enviar los datos', 'error');
                
                // Guardar localmente como backup
                saveLocalBackup(formData);
                showStatus('‚ö†Ô∏è Datos guardados localmente como backup', 'error');
            }
        }
        
        // Funci√≥n alternativa para enviar datos (con par√°metro data)
        async function submitFormAlternative() {
            const formData = getFormData();
            
            try {
                // M√©todo alternativo con par√°metro 'data'
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'data=' + encodeURIComponent(JSON.stringify(formData))
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('‚úÖ ' + result.message, 'success');
                    console.log('Registro exitoso en fila:', result.data.fila);
                } else {
                    showStatus('‚ùå ' + result.message, 'error');
                }
                
                return result;
            } catch (error) {
                console.error('Error en env√≠o alternativo:', error);
                showStatus('‚ùå Error de conexi√≥n', 'error');
                return { success: false, error: error.toString() };
            }
        }
        
        // Otras funciones auxiliares
        function showSuccessMessage(data) {
            const message = `
                <div class="status-success">
                    <h4><i class="fas fa-check-circle"></i> Registro Exitoso</h4>
                    <p><strong>Paciente:</strong> ${data.paciente_apellidonombre}</p>
                    <p><strong>DNI:</strong> ${data.paciente_doc}</p>
                    <p><strong>Fecha:</strong> ${new Date().toLocaleString('es-AR')}</p>
                    <p>Los datos han sido guardados en el sistema REPROCANN.</p>
                </div>
            `;
            
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = message;
            statusDiv.className = 'status status-success';
            statusDiv.style.display = 'block';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function saveLocalBackup(data) {
            try {
                const backups = JSON.parse(localStorage.getItem('reprocann_backups') || '[]');
                backups.push({
                    timestamp: new Date().toISOString(),
                    data: data
                });
                
                // Mantener solo los √∫ltimos 50 registros
                if (backups.length > 50) {
                    backups.splice(0, backups.length - 50);
                }
                
                localStorage.setItem('reprocann_backups', JSON.stringify(backups));
                console.log('Backup guardado localmente. Total:', backups.length);
            } catch (error) {
                console.error('Error guardando backup:', error);
            }
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status status-${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                if (statusDiv.textContent === message) {
                    statusDiv.style.display = 'none';
                }
            }, 5000);
        }
        
        function clearSignature() {
            if (signaturePad) {
                signaturePad.clear();
                showStatus('Firma limpiada', 'success');
            }
        }
        
        function previewForm() {
            const data = getFormData();
            console.log('Vista previa de datos:', data);
            
            const preview = `
                ===== VISTA PREVIA DEL FORMULARIO =====
                DNI: ${data.paciente_doc}
                Nombre: ${data.paciente_apellidonombre}
                Fecha Nac: ${data.paciente_nac || 'No especificada'}
                Tel√©fono: ${data.paciente_telefono_celular}
                Email: ${data.paciente_email || 'No especificado'}
                Obra Social: ${data.paciente_obra_social || 'No especificada'}
                Patolog√≠a: ${data.patologia || 'No especificada'}
                Tratamiento: ${data.tratamiento_actual || 'No especificado'}
                C√≥digo: ${data.codigo_vinculacion || 'No especificado'}
                Firma: ${data.paciente_firmaclaracion ? 'Presente ‚úì' : 'Falta ‚úó'}
                ========================================
            `;
            
            alert(preview);
            showStatus('Vista previa generada en consola', 'success');
        }
        
        function clearForm() {
            if (confirm('¬øEst√° seguro que desea limpiar todo el formulario?')) {
                // Limpiar campos de entrada
                const inputs = document.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    if (input.type !== 'button' && input.type !== 'submit') {
                        input.value = '';
                    }
                });
                
                // Limpiar firma
                if (signaturePad) {
                    signaturePad.clear();
                }
                
                // Restablecer fecha actual
                document.getElementById('paciente_fecha').value = new Date().toISOString().split('T')[0];
                
                showStatus('Formulario limpiado', 'success');
            }
        }
        
        function setupAutoSave() {
            // Auto-guardar cada 30 segundos
            setInterval(() => {
                const data = getFormData();
                // Solo guardar si hay datos m√≠nimos
                if (data.paciente_doc && data.paciente_apellidonombre) {
                    localStorage.setItem('reprocann_autosave', JSON.stringify({
                        timestamp: new Date().toISOString(),
                        data: data
                    }));
                }
            }, 30000);
            
            // Cargar auto-guardado al inicio
            try {
                const autosave = JSON.parse(localStorage.getItem('reprocann_autosave') || 'null');
                if (autosave && autosave.data) {
                    const shouldLoad = confirm('Hay un formulario guardado autom√°ticamente. ¬øDesea cargarlo?');
                    if (shouldLoad) {
                        loadFormData(autosave.data);
                        showStatus('Formulario auto-guardado cargado', 'success');
                    }
                }
            } catch (error) {
                console.error('Error cargando auto-guardado:', error);
            }
        }
        
        function loadFormData(data) {
            document.getElementById('paciente_doc').value = data.paciente_doc || '';
            document.getElementById('paciente_apellidonombre').value = data.paciente_apellidonombre || '';
            document.getElementById('paciente_nac').value = data.paciente_nac || '';
            document.getElementById('paciente_dom').value = data.paciente_dom || '';
            document.getElementById('paciente_telefono_celular').value = data.paciente_telefono_celular || '';
            document.getElementById('paciente_email').value = data.paciente_email || '';
            document.getElementById('paciente_obra_social').value = data.paciente_obra_social || '';
            document.getElementById('patologia').value = data.patologia || '';
            document.getElementById('tratamiento_actual').value = data.tratamiento_actual || '';
            document.getElementById('codigo_vinculacion').value = data.codigo_vinculacion || '';
            document.getElementById('paciente_fecha').value = data.paciente_fecha || new Date().toISOString().split('T')[0];
            
            // Nota: No podemos cargar la firma del localStorage por seguridad
        }
        
        // Funci√≥n para exportar backups locales
        function exportLocalBackups() {
            try {
                const backups = JSON.parse(localStorage.getItem('reprocann_backups') || '[]');
                if (backups.length === 0) {
                    alert('No hay backups locales para exportar');
                    return;
                }
                
                const dataStr = JSON.stringify(backups, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `reprocann_backups_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showStatus(`Backups exportados: ${backups.length} registros`, 'success');
            } catch (error) {
                console.error('Error exportando backups:', error);
                showStatus('Error exportando backups', 'error');
            }
        }
        
        // Agregar esta funci√≥n al panel de configuraci√≥n si es necesario
        function showBackupPanel() {
            const backups = JSON.parse(localStorage.getItem('reprocann_backups') || '[]');
            
            const panel = `
                <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h4><i class="fas fa-database"></i> Backups Locales</h4>
                    <p>Registros pendientes de sincronizaci√≥n: <strong>${backups.length}</strong></p>
                    <button onclick="exportLocalBackups()" class="btn-secondary">
                        <i class="fas fa-download"></i> Exportar Backups
                    </button>
                    ${backups.length > 0 ? 
                        `<button onclick="syncBackups()" class="btn-success" style="margin-left: 10px;">
                            <i class="fas fa-sync"></i> Sincronizar con Servidor
                        </button>` : 
                        ''
                    }
                </div>
            `;
            
            const configPanel = document.querySelector('.config-panel');
            configPanel.insertAdjacentHTML('beforeend', panel);
        }
    </script>
</body>
</html>
