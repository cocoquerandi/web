<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario REPROCANN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .section-title {
            background-color: #f8f9fa;
            padding: 10px;
            border-left: 4px solid #007bff;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .signature-container {
            border: 1px solid #ced4da;
            background-color: #f8f9fa;
            border-radius: 4px;
            cursor: crosshair;
        }
        .btn-clear {
            margin-top: 10px;
        }
        .form-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .existing-data {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1 class="text-center mb-4">Formulario REPROCANN</h1>
        
        <div id="existingDataAlert" class="existing-data">
            <h5>üìã Datos existentes encontrados para este DNI</h5>
            <p id="existingDataText"></p>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadExistingData()">Cargar datos existentes</button>
        </div>
        
        <form id="reprocannForm">
            <!-- Secci√≥n Paciente -->
            <div class="section-title">Datos del Paciente</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="paciente_doc" class="form-label">DNI del Paciente *</label>
                    <input type="text" class="form-control" id="paciente_doc" required 
                           onblur="checkExistingPatient(this.value)">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="paciente_apellidonombre" class="form-label">Apellido y Nombre *</label>
                    <input type="text" class="form-control" id="paciente_apellidonombre" required>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="paciente_nac" class="form-label">Fecha de Nacimiento</label>
                    <input type="date" class="form-control" id="paciente_nac">
                </div>
                <div class="col-md-8 mb-3">
                    <label for="paciente_dom" class="form-label">Domicilio</label>
                    <input type="text" class="form-control" id="paciente_dom">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="paciente_telefono_particular" class="form-label">Tel√©fono Particular</label>
                    <input type="tel" class="form-control" id="paciente_telefono_particular">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="paciente_telefono_celular" class="form-label">Tel√©fono Celular</label>
                    <input type="tel" class="form-control" id="paciente_telefono_celular">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="paciente_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="paciente_email">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="paciente_obra_social" class="form-label">Obra Social</label>
                    <input type="text" class="form-control" id="paciente_obra_social">
                </div>
            </div>
            
            <!-- Secci√≥n Tutor -->
            <div class="section-title">Datos del Tutor (si corresponde)</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="tutor_apellido_nombre" class="form-label">Apellido y Nombre del Tutor</label>
                    <input type="text" class="form-control" id="tutor_apellido_nombre">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="tutor_tipo_doc" class="form-label">Tipo Doc.</label>
                    <select class="form-select" id="tutor_tipo_doc">
                        <option value="">Seleccionar</option>
                        <option value="DNI">DNI</option>
                        <option value="LC">LC</option>
                        <option value="LE">LE</option>
                        <option value="PAS">Pasaporte</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="tutor_nro_doc" class="form-label">N√∫mero Doc.</label>
                    <input type="text" class="form-control" id="tutor_nro_doc">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="tutor_domicilio" class="form-label">Domicilio</label>
                    <input type="text" class="form-control" id="tutor_domicilio">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="tutor_localidad" class="form-label">Localidad</label>
                    <input type="text" class="form-control" id="tutor_localidad">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="tutor_provincia" class="form-label">Provincia</label>
                    <input type="text" class="form-control" id="tutor_provincia">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="tutor_cp" class="form-label">C√≥digo Postal</label>
                    <input type="text" class="form-control" id="tutor_cp">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="tutor_vinculo" class="form-label">V√≠nculo</label>
                    <input type="text" class="form-control" id="tutor_vinculo">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="tutor_telefono_particular" class="form-label">Tel√©fono Particular</label>
                    <input type="tel" class="form-control" id="tutor_telefono_particular">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="tutor_celular" class="form-label">Tel√©fono Celular</label>
                    <input type="tel" class="form-control" id="tutor_celular">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="tutor_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="tutor_email">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="tutor_obrasocial" class="form-label">Obra Social</label>
                    <input type="text" class="form-control" id="tutor_obrasocial">
                </div>
            </div>
            
            <!-- Secci√≥n M√©dico -->
            <div class="section-title">Datos del M√©dico</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="medico_apellidonombre" class="form-label">Apellido y Nombre *</label>
                    <input type="text" class="form-control" id="medico_apellidonombre" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="medico_doc" class="form-label">DNI M√©dico</label>
                    <input type="text" class="form-control" id="medico_doc">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="medico_matricula" class="form-label">Matr√≠cula *</label>
                    <input type="text" class="form-control" id="medico_matricula" required>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="medico_especialidad" class="form-label">Especialidad *</label>
                    <input type="text" class="form-control" id="medico_especialidad" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="medico_tel_particular" class="form-label">Tel√©fono Particular</label>
                    <input type="tel" class="form-control" id="medico_tel_particular">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="medico_tel_cel" class="form-label">Tel√©fono Celular</label>
                    <input type="tel" class="form-control" id="medico_tel_cel">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="medico_email" class="form-label">Email M√©dico *</label>
                    <input type="email" class="form-control" id="medico_email" required>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_historiaclinica" class="form-label">Resumen Historia Cl√≠nica</label>
                    <textarea class="form-control" id="medico_historiaclinica" rows="2"></textarea>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_diagnostico_ypatologia" class="form-label">Diagn√≥stico y Patolog√≠as Asociadas</label>
                    <textarea class="form-control" id="medico_diagnostico_ypatologia" rows="2"></textarea>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_tratamiento" class="form-label">Tratamiento</label>
                    <textarea class="form-control" id="medico_tratamiento" rows="2"></textarea>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_justificacion" class="form-label">Justificaci√≥n del Cambio</label>
                    <textarea class="form-control" id="medico_justificacion" rows="2"></textarea>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="medico_productoindicado" class="form-label">Producto Indicado</label>
                    <textarea class="form-control" id="medico_productoindicado" rows="2"></textarea>
                </div>
            </div>
            
            <!-- Firma del M√©dico -->
            <div class="section-title">Firma del M√©dico</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Firma del M√©dico</label>
                    <div id="signatureMedico" class="signature-container" style="width: 100%; height: 150px;"></div>
                    <button type="button" class="btn btn-secondary btn-clear" onclick="clearSignature('signatureMedico')">Limpiar Firma</button>
                    <input type="hidden" id="medico_firmaclaracion">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="medico_sello" class="form-label">Sello del Consultorio</label>
                    <input type="text" class="form-control" id="medico_sello">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="medico_fecha" class="form-label">Fecha de Emisi√≥n *</label>
                    <input type="date" class="form-control" id="medico_fecha" required>
                </div>
            </div>
            
            <!-- Firma del Paciente/Tutor -->
            <div class="section-title">Firma del Paciente/Tutor</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Firma del Paciente/Tutor</label>
                    <div id="signaturePaciente" class="signature-container" style="width: 100%; height: 150px;"></div>
                    <button type="button" class="btn btn-secondary btn-clear" onclick="clearSignature('signaturePaciente')">Limpiar Firma</button>
                    <input type="hidden" id="paciente_firmaclaracion">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="paciente_fecha" class="form-label">Fecha de Firma *</label>
                    <input type="date" class="form-control" id="paciente_fecha" required>
                </div>
            </div>
            
            <!-- Botones de acci√≥n -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="button" class="btn btn-secondary me-md-2" onclick="previewPDF()">Vista Previa PDF</button>
                <button type="submit" class="btn btn-primary">Guardar Formulario</button>
            </div>
        </form>
    </div>

    <!-- Modal para vista previa -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vista Previa del Formulario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <iframe id="pdfPreview" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        let existingPatientData = null;
        let signaturePadMedico = null;
        let signaturePadPaciente = null;
        
        // Inicializar pads de firma
        document.addEventListener('DOMContentLoaded', function() {
            const canvasMedico = document.getElementById('signatureMedico');
            const canvasPaciente = document.getElementById('signaturePaciente');
            
            signaturePadMedico = new SignaturePad(canvasMedico, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });
            
            signaturePadPaciente = new SignaturePad(canvasPaciente, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });
            
            // Ajustar canvas al tama√±o del contenedor
            resizeCanvas(canvasMedico);
            resizeCanvas(canvasPaciente);
            
            // Fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('medico_fecha').value = today;
            document.getElementById('paciente_fecha').value = today;
        });
        
        function resizeCanvas(canvas) {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }
        
        function clearSignature(signatureId) {
            if (signatureId === 'signatureMedico' && signaturePadMedico) {
                signaturePadMedico.clear();
            } else if (signatureId === 'signaturePaciente' && signaturePadPaciente) {
                signaturePadPaciente.clear();
            }
        }
        
        async function checkExistingPatient(dni) {
            if (!dni || dni.length < 7) return;
            
            try {
                const response = await fetch(`https://script.google.com/macros/s/YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL/exec?action=getPatient&dni=${dni}`);
                const data = await response.json();
                
                if (data.exists) {
                    existingPatientData = data.data;
                    document.getElementById('existingDataText').textContent = 
                        `Paciente: ${data.data.paciente_apellidonombre || ''}`;
                    document.getElementById('existingDataAlert').style.display = 'block';
                } else {
                    existingPatientData = null;
                    document.getElementById('existingDataAlert').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking patient:', error);
            }
        }
        
        function loadExistingData() {
            if (!existingPatientData) return;
            
            // Cargar datos del paciente
            document.getElementById('paciente_apellidonombre').value = existingPatientData.paciente_apellidonombre || '';
            document.getElementById('paciente_nac').value = existingPatientData.paciente_nac || '';
            document.getElementById('paciente_dom').value = existingPatientData.paciente_dom || '';
            document.getElementById('paciente_telefono_particular').value = existingPatientData.paciente_telefono_particular || '';
            document.getElementById('paciente_telefono_celular').value = existingPatientData.paciente_telefono_celular || '';
            document.getElementById('paciente_email').value = existingPatientData.paciente_email || '';
            document.getElementById('paciente_obra_social').value = existingPatientData.paciente_obra_social || '';
            
            // Cargar datos del tutor
            document.getElementById('tutor_apellido_nombre').value = existingPatientData.tutor_apellido_nombre || '';
            document.getElementById('tutor_tipo_doc').value = existingPatientData.tutor_tipo_doc || '';
            document.getElementById('tutor_nro_doc').value = existingPatientData.tutor_nro_doc || '';
            document.getElementById('tutor_domicilio').value = existingPatientData.tutor_domicilio || '';
            document.getElementById('tutor_localidad').value = existingPatientData.tutor_localidad || '';
            document.getElementById('tutor_provincia').value = existingPatientData.tutor_provincia || '';
            document.getElementById('tutor_cp').value = existingPatientData.tutor_cp || '';
            document.getElementById('tutor_vinculo').value = existingPatientData.tutor_vinculo || '';
            document.getElementById('tutor_telefono_particular').value = existingPatientData.tutor_telefono_particular || '';
            document.getElementById('tutor_celular').value = existingPatientData.tutor_celular || '';
            document.getElementById('tutor_email').value = existingPatientData.tutor_email || '';
            document.getElementById('tutor_obrasocial').value = existingPatientData.tutor_obrasocial || '';
        }
        
        async function previewPDF() {
            // Preparar datos para la vista previa
            const formData = new FormData(document.getElementById('reprocannForm'));
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Agregar firmas como im√°genes base64
            if (signaturePadMedico && !signaturePadMedico.isEmpty()) {
                data.medico_firmaclaracion = signaturePadMedico.toDataURL();
            }
            if (signaturePadPaciente && !signaturePadPaciente.isEmpty()) {
                data.paciente_firmaclaracion = signaturePadPaciente.toDataURL();
            }
            
            // Enviar a la p√°gina de vista previa
            sessionStorage.setItem('formData', JSON.stringify(data));
            document.getElementById('pdfPreview').src = 'pdf_preview.html';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        document.getElementById('reprocannForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Agregar firmas como im√°genes base64
            if (signaturePadMedico && !signaturePadMedico.isEmpty()) {
                data.medico_firmaclaracion = signaturePadMedico.toDataURL();
            }
            if (signaturePadPaciente && !signaturePadPaciente.isEmpty()) {
                data.paciente_firmaclaracion = signaturePadPaciente.toDataURL();
            }
            
            try {
                // Enviar datos al servidor de Google Apps Script
                const response = await fetch('https://script.google.com/macros/s/AKfycbyXRGQ3c96NU1Ku-1xkPRw4Xe21fLptvrKopZzK60stWt9jSQpyAvTrLviqB80sZ7zj/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                alert('Formulario enviado correctamente. Los datos han sido guardados en Google Sheets.');
                this.reset();
                signaturePadMedico.clear();
                signaturePadPaciente.clear();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar el formulario. Por favor, intente nuevamente.');
            }
        });
    </script>
</body>
</html>
