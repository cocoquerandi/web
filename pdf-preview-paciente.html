<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Previa - Paciente REPROCANN</title>
    <style>
        /* Tama√±o A4 */
        @page {
            size: A4;
            margin: 0;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .a4-container {
            width: 794px;  /* Ancho A4 en pixels a 96 DPI */
            height: 1123px; /* Alto A4 en pixels */
            background: white;
            position: relative;
            margin: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .page-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 40px;
            box-sizing: border-box;
        }
        
        .field-container {
            position: absolute;
            border: 1px solid #ddd;
            background: rgba(255, 255, 255, 0.95);
            padding: 5px;
            overflow: hidden;
            font-size: 11px;
        }
        
        .field-label {
            color: #666;
            font-size: 9px;
            margin-bottom: 3px;
            border-bottom: 1px dotted #eee;
            padding-bottom: 2px;
        }
        
        .field-value {
            font-size: 11px;
            word-wrap: break-word;
            min-height: 14px;
        }
        
        .signature-img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }
        
        .page-header h1 {
            font-size: 20px;
            margin: 0;
            color: #2c3e50;
        }
        
        .page-header .subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .controls button {
            padding: 8px 15px;
            margin: 0 5px;
            border: none;
            background: #3498db;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .controls button:hover {
            background: #2980b9;
        }
        
        .debug-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
        }
        
        @media print {
            body {
                background: white;
            }
            
            .a4-container {
                margin: 0;
                box-shadow: none;
            }
            
            .controls,
            .debug-panel {
                display: none;
            }
        }
        
        /* Coordenadas de referencia (opcional) */
        .coord-marker {
            position: absolute;
            font-size: 8px;
            color: #999;
            background: rgba(255,255,255,0.7);
            padding: 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- Controles -->
    <div class="controls">
        <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button onclick="window.close()">‚úï Cerrar</button>
        <button onclick="ajustarEscala(0.5)">Escala 50%</button>
        <button onclick="ajustarEscala(0.8)">Escala 80%</button>
        <button onclick="ajustarEscala(1.0)">Escala 100%</button>
    </div>
    
    <!-- Panel de debug -->
    <div class="debug-panel">
        <strong>Vista Previa Paciente</strong><br>
        <small id="debugInfo">Cargando datos...</small>
    </div>
    
    <!-- Contenedor A4 -->
    <div class="a4-container">
        <div class="page-content" id="pageContent">
            <!-- Los campos se insertar√°n aqu√≠ -->
        </div>
    </div>

    <script>
        // Coordenadas ajustadas para A4 (pixels a 96 DPI)
        // Basadas en el CSV pero ajustadas para caber en A4
        const coordenadas = {
            // Campos principales - posiciones ajustadas
            paciente_apellidonombre: { x: 50, y: 120, width: 500, height: 25 },
            paciente_doc: { x: 50, y: 160, width: 200, height: 25 },
            paciente_nac: { x: 300, y: 160, width: 200, height: 25 },
            paciente_dom: { x: 50, y: 200, width: 500, height: 25 },
            paciente_telefono_celular: { x: 50, y: 240, width: 250, height: 25 },
            paciente_email: { x: 350, y: 240, width: 200, height: 25 },
            paciente_obra_social: { x: 50, y: 280, width: 500, height: 25 },
            
            // Campos m√©dicos
            patologia: { x: 50, y: 330, width: 500, height: 80 },
            tratamiento_actual: { x: 50, y: 430, width: 500, height: 80 },
            codigo_vinculacion: { x: 50, y: 530, width: 300, height: 25 },
            
            // Firma y fecha
            paciente_firmaclaracion: { x: 50, y: 600, width: 300, height: 100 },
            paciente_fecha: { x: 400, y: 650, width: 150, height: 25 }
        };
        
        let escala = 0.8; // Escala inicial
        
        // Cargar datos del formulario
        function cargarDatos() {
            try {
                const datosGuardados = sessionStorage.getItem('reprocann_paciente_preview');
                if (!datosGuardados) {
                    throw new Error('No hay datos para mostrar. Complete el formulario primero.');
                }
                
                const datos = JSON.parse(datosGuardados);
                document.getElementById('debugInfo').innerHTML = `
                    Paciente: ${datos.paciente_apellidonombre || 'No especificado'}<br>
                    DNI: ${datos.paciente_doc || 'No especificado'}<br>
                    Campos: ${Object.keys(datos).length}
                `;
                
                return datos;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('debugInfo').innerHTML = 'Error: ' + error.message;
                
                // Datos de ejemplo para prueba
                return {
                    paciente_apellidonombre: 'GONZ√ÅLEZ, JUAN CARLOS',
                    paciente_doc: '12345678',
                    paciente_nac: '1985-05-15',
                    paciente_dom: 'CALLE FALSA 123, PISO 4, DEPTO B',
                    paciente_telefono_celular: '11-2233-4455',
                    paciente_email: 'juan.gonzalez@email.com',
                    paciente_obra_social: 'OSDE - PLAN 310',
                    patologia: 'Epilepsia refractaria - Convulsiones t√≥nico-cl√≥nicas generalizadas',
                    tratamiento_actual: 'Aceite de CBD 20% - 0.5ml cada 12 horas',
                    codigo_vinculacion: 'REP-2024-00123',
                    paciente_fecha: new Date().toISOString().split('T')[0],
                    paciente_firmaclaracion: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                };
            }
        }
        
        // Formatear texto
        function formatearTexto(texto) {
            if (!texto) return '-';
            return texto.toString().trim();
        }
        
        // Formatear fecha
        function formatearFecha(fechaStr) {
            if (!fechaStr) return '-';
            try {
                const fecha = new Date(fechaStr);
                return fecha.toLocaleDateString('es-AR');
            } catch (e) {
                return fechaStr;
            }
        }
        
        // Crear campo
        function crearCampo(nombre, valor, coords) {
            const div = document.createElement('div');
            div.className = 'field-container';
            div.style.left = (coords.x * escala) + 'px';
            div.style.top = (coords.y * escala) + 'px';
            div.style.width = (coords.width * escala) + 'px';
            div.style.height = (coords.height * escala) + 'px';
            
            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = nombre.replace(/_/g, ' ').toUpperCase();
            
            const value = document.createElement('div');
            value.className = 'field-value';
            
            // Procesar seg√∫n el tipo de campo
            if (nombre.includes('firma') && valor && valor.startsWith('data:image')) {
                const img = document.createElement('img');
                img.src = valor;
                img.className = 'signature-img';
                img.alt = 'Firma del paciente';
                value.appendChild(img);
            } else if (nombre.includes('fecha')) {
                value.textContent = formatearFecha(valor);
            } else if (nombre.includes('patologia') || nombre.includes('tratamiento')) {
                value.textContent = formatearTexto(valor);
                value.style.whiteSpace = 'pre-wrap';
                value.style.maxHeight = (coords.height * escala - 20) + 'px';
                value.style.overflowY = 'auto';
            } else {
                value.textContent = formatearTexto(valor);
            }
            
            div.appendChild(label);
            div.appendChild(value);
            
            return div;
        }
        
        // Agregar encabezado
        function agregarEncabezado() {
            const header = document.createElement('div');
            header.className = 'page-header';
            header.innerHTML = `
                <h1>FORMULARIO PACIENTE REPROCANN</h1>
                <div class="subtitle">Registro Nacional del Programa de Cannabis</div>
            `;
            document.getElementById('pageContent').appendChild(header);
        }
        
        // Agregar pie de p√°gina
        function agregarPie() {
            const footer = document.createElement('div');
            footer.style.position = 'absolute';
            footer.style.bottom = '20px';
            footer.style.left = '40px';
            footer.style.right = '40px';
            footer.style.textAlign = 'center';
            footer.style.fontSize = '10px';
            footer.style.color = '#666';
            footer.style.borderTop = '1px solid #eee';
            footer.style.paddingTop = '10px';
            footer.innerHTML = `
                Documento generado el ${new Date().toLocaleDateString('es-AR')} | 
                Sistema REPROCANN v1.0
            `;
            document.getElementById('pageContent').appendChild(footer);
        }
        
        // Renderizar todos los campos
        function renderizarCampos() {
            const datos = cargarDatos();
            const container = document.getElementById('pageContent');
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Agregar encabezado
            agregarEncabezado();
            
            // Agregar cada campo
            for (const [nombre, coords] of Object.entries(coordenadas)) {
                const valor = datos[nombre] || '';
                if (valor || nombre.includes('firma')) { // Mostrar campos con datos o la firma
                    const campo = crearCampo(nombre, valor, coords);
                    container.appendChild(campo);
                }
            }
            
            // Agregar pie de p√°gina
            agregarPie();
            
            // Agregar coordenadas de referencia (opcional, quitar para producci√≥n)
            agregarCoordenadasReferencia();
        }
        
        // Agregar coordenadas de referencia (solo para debug)
        function agregarCoordenadasReferencia() {
            for (const [nombre, coords] of Object.entries(coordenadas)) {
                const marker = document.createElement('div');
                marker.className = 'coord-marker';
                marker.style.left = (coords.x * escala) + 'px';
                marker.style.top = (coords.y * escala) + 'px';
                marker.textContent = `${nombre}: ${coords.x},${coords.y}`;
                marker.title = `Ancho: ${coords.width}, Alto: ${coords.height}`;
                document.getElementById('pageContent').appendChild(marker);
            }
        }
        
        // Ajustar escala
        function ajustarEscala(nuevaEscala) {
            escala = nuevaEscala;
            renderizarCampos();
            document.getElementById('debugInfo').innerHTML += `<br>Escala: ${(escala * 100).toFixed(0)}%`;
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            renderizarCampos();
            
            // Configurar para impresi√≥n
            window.addEventListener('beforeprint', function() {
                // Restaurar escala a 100% para imprimir
                const contenedor = document.querySelector('.a4-container');
                contenedor.style.transform = 'scale(1)';
                contenedor.style.margin = '0';
            });
            
            window.addEventListener('afterprint', function() {
                // Volver a escala normal
                const contenedor = document.querySelector('.a4-container');
                contenedor.style.transform = `scale(${escala})`;
                contenedor.style.margin = '20px';
            });
            
            // Escalar el contenedor para que quepa en pantalla
            const contenedor = document.querySelector('.a4-container');
            contenedor.style.transform = `scale(${escala})`;
            contenedor.style.transformOrigin = 'top left';
        });
        
        // Exponer funciones √∫tiles
        window.mostrarDatos = function() {
            console.log('Datos:', cargarDatos());
        };
        
        window.verCoordenadas = function() {
            console.log('Coordenadas:', coordenadas);
        };
    </script>
</body>
</html>
