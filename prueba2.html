<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPROCANN - Formulario de Registro</title>
    <!-- Cargar librer√≠as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .form-content {
            padding: 30px;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            position: relative;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 80px;
            height: 3px;
            background: #e74c3c;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }
        
        label.required::after {
            content: " *";
            color: #e74c3c;
            font-weight: bold;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .signature-area {
            border: 3px dashed #bdc3c7;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin: 25px 0;
            background: #f8f9fa;
        }
        
        #signatureCanvas {
            border: 2px solid #95a5a6;
            background: white;
            width: 100%;
            height: 150px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            touch-action: none;
            border-radius: 5px;
        }
        
        .signature-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        button {
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            flex: 2;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #219653, #1e8449);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 83, 0.3);
        }
        
        .btn-success:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            flex: 1;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.3);
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.95rem;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .progress-bar-container {
            width: 100%;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .form-instructions {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
            font-size: 0.95rem;
            color: #495057;
        }
        
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .download-link {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            text-align: center;
            animation: slideIn 0.5s ease;
        }
        
        .download-link a {
            display: inline-block;
            padding: 12px 25px;
            background: #27ae60;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .download-link a:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 83, 0.3);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .form-content {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .header {
                padding: 20px;
            }
        }
        
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo h2 {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .logo .subtitle {
            color: #3498db;
            font-size: 1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <h2>REPROCANN</h2>
                <p class="subtitle">Registro Nacional del Programa de Cannabis</p>
            </div>
            <h1>Formulario de Registro de Paciente</h1>
            <p>Complete el formulario para generar su documento oficial</p>
        </div>
        
        <div class="form-content">
            <div id="statusMessage" class="status-message"></div>
            
            <!-- Barra de progreso -->
            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            
            <!-- Spinner de carga -->
            <div class="loading-spinner" id="loadingSpinner"></div>
            
            <!-- Enlace de descarga -->
            <div class="download-link" id="downloadLink">
                <p>‚úÖ Su formulario ha sido generado exitosamente</p>
                <a id="downloadButton" href="#" download>üì• Descargar Formulario PDF</a>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                    El documento tambi√©n se ha guardado en nuestro sistema.
                </p>
            </div>
            
            <div class="form-instructions">
                <h3>üìã Instrucciones para completar el formulario:</h3>
                <p>1. Complete todos los campos marcados con <span style="color:#e74c3c;">*</span> (obligatorios)</p>
                <p>2. Realice su firma en el √°rea designada usando el mouse o su dedo</p>
                <p>3. Revise cuidadosamente todos los datos ingresados</p>
                <p>4. Haga clic en "Generar Documento" para obtener su PDF oficial</p>
            </div>
            
            <form id="pacienteForm">
                <div class="section-title">üìù Datos Personales del Paciente</div>
                
                <div class="form-group">
                    <label class="required">Apellido y Nombre</label>
                    <input type="text" id="paciente_apellidonombre" required 
                           placeholder="Ej: P√©rez, Juan Carlos">
                </div>
                
                <div class="form-group">
                    <label class="required">DNI</label>
                    <input type="text" id="paciente_doc" required 
                           placeholder="Ej: 12345678" 
                           pattern="\d{7,8}"
                           title="Ingrese 7 u 8 d√≠gitos num√©ricos">
                </div>
                
                <div class="form-group">
                    <label class="required">Fecha de Nacimiento</label>
                    <input type="date" id="paciente_nac" required>
                </div>
                
                <div class="form-group">
                    <label class="required">Domicilio</label>
                    <input type="text" id="paciente_dom" required 
                           placeholder="Calle, N√∫mero, Piso, Departamento">
                </div>
                
                <!-- FILA: Localidad, Provincia, CP -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="required">Localidad</label>
                        <input type="text" id="paciente_localidad" required 
                               placeholder="Ej: Buenos Aires">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Provincia</label>
                        <input type="text" id="paciente_provincia" required 
                               placeholder="Ej: Buenos Aires">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">C√≥digo Postal</label>
                        <input type="text" id="paciente_codigo_postal" required 
                               placeholder="Ej: 1000">
                    </div>
                </div>
                
                <!-- FILA: Tel√©fono Particular y Tel√©fono Celular -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Tel√©fono Particular</label>
                        <input type="tel" id="paciente_telefono_particular" 
                               placeholder="Ej: 011-1234-5678">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Tel√©fono Celular</label>
                        <input type="tel" id="paciente_telefono_celular" required 
                               placeholder="Ej: 11-1234-5678">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="required">Correo Electr√≥nico</label>
                    <input type="email" id="paciente_email" required 
                           placeholder="ejemplo@correo.com">
                </div>
                
                <div class="form-group">
                    <label class="required">Obra Social</label>
                    <input type="text" id="paciente_obra_social" required 
                           placeholder="Nombre de su obra social">
                </div>
                
                <div class="section-title" style="margin-top: 35px;">üè• Datos M√©dicos</div>
                
                <div class="form-group">
                    <label class="required">Patolog√≠a/Diagn√≥stico</label>
                    <textarea id="patologia" required 
                              placeholder="Describa su condici√≥n m√©dica"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="required">Tratamiento Actual</label>
                    <textarea id="tratamiento_actual" required 
                              placeholder="Describa su tratamiento actual"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Otros Antecedentes M√©dicos</label>
                    <textarea id="otros_antecedentes" 
                              placeholder="Otros datos m√©dicos relevantes"></textarea>
                </div>
                
                <div class="form-group">
                    <label>C√≥digo de Vinculaci√≥n (opcional)</label>
                    <input type="text" id="codigo_vinculacion" 
                           placeholder="Si tiene un c√≥digo de vinculaci√≥n">
                </div>
                
                <div class="section-title" style="margin-top: 35px;">‚úçÔ∏è Firma del Paciente</div>
                
                <div class="signature-area">
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.95rem;">
                        <strong>Instrucci√≥n:</strong> Firme en el recuadro utilizando el mouse o su dedo en dispositivos t√°ctiles.
                        Su firma es obligatoria para validar el documento.
                    </p>
                    <canvas id="signatureCanvas"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn-danger" id="clearSignatureBtn">
                            üóëÔ∏è Limpiar Firma
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="required">Fecha de Firma</label>
                    <input type="date" id="paciente_fecha" required>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-success" id="submitBtn">
                        üìÑ Generar Documento
                    </button>
                    <button type="button" class="btn-danger" id="clearFormBtn">
                        üóëÔ∏è Limpiar Todo
                    </button>
                </div>
            </form>
            
            <div style="text-align: center; margin-top: 30px; color: #7f8c8d; font-size: 0.85rem;">
                <p>Este formulario cumple con los requisitos del Registro Nacional del Programa de Cannabis (REPROCANN)</p>
                <p>¬© 2024 - Todos los derechos reservados</p>
            </div>
        </div>
    </div>

    <script>
        // URL de tu Google Apps Script - ¬°IMPORTANTE! Cambiar por tu URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyOeOkJ3-Bgizcs-LnpNBQRRj0aMdr6i9EYx_FiPwy-WanePmOCmmAZTQ8G9B8vN2_sZg/exec';
        
        // COORDENADAS EXACTAS del segundo c√≥digo
        const COORDENADAS = {
            // SECCI√ìN SUPERIOR
            paciente_apellidonombre: { x: 147.99, y: 184.31, width: 377.97, height: 6.67 },
            paciente_doc: { x: 147.99, y: 197.64, width: 141.99, height: 6.33 },
            paciente_nac: { x: 370.97, y: 197.64, width: 154.99, height: 6.33 },
            paciente_dom: { x: 147.99, y: 210.64, width: 377.97, height: 6.33 },
            
            // FILA: Localidad, Provincia, CP
            paciente_localidad: { x: 147.99, y: 223.64, width: 207.99, height: 6.33 },
            paciente_provincia: { x: 370.97, y: 223.64, width: 154.99, height: 6.33 },
            paciente_codigo_postal: { x: 502.00, y: 223.64, width: 100.00, height: 6.33 },
            
            // FILA: Tel√©fonos
            paciente_telefono_particular: { x: 184.99, y: 236.64, width: 207.99, height: 6.67 },
            paciente_telefono_celular: { x: 370.97, y: 236.64, width: 154.99, height: 6.33 },
            
            // FILAS SIGUIENTES
            paciente_email: { x: 147.99, y: 249.97, width: 377.97, height: 6.33 },
            paciente_obra_social: { x: 147.99, y: 262.97, width: 377.97, height: 6.33 },
            
            // Datos m√©dicos
            patologia: { x: 317.97, y: 485.27, width: 207.31, height: 6.33 },
            tratamiento_actual: { x: 370.97, y: 498.27, width: 154.99, height: 6.67 },
            otros_antecedentes: { x: 172.65, y: 524.60, width: 353.30, height: 6.33 },
            
            // SECCI√ìN FINAL - Datos junto a la firma
            paciente_nombre_firma: { x: 56.66, y: 760.56, width: 165.65, height: 0.67 },
            paciente_fecha: { x: 56.66, y: 773.56, width: 165.65, height: 0.67 },
            paciente_localidad_final: { x: 56.66, y: 786.56, width: 165.65, height: 0.67 },
            paciente_provincia_final: { x: 56.66, y: 799.56, width: 165.65, height: 0.67 },
            paciente_codigo_postal_final: { x: 56.66, y: 812.56, width: 165.65, height: 0.67 },
            
            // Firma
            paciente_firmaclaracion: { x: 374.97, y: 792.56, width: 163.99, height: 60.00 }
        };
        
        // FACTOR DE CONVERSI√ìN exacto del segundo c√≥digo
        const CALIBRACION = {
            escala: 1.32,
            offsetX: 7.0,
            offsetY: 0.0,
            firma: {
                offsetX: -100,
                offsetY: -50,
                escala: 2.0
            }
        };
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        document.addEventListener('DOMContentLoaded', function() {
            inicializarFirma();
            configurarEventos();
            
            // Establecer fechas por defecto
            const hoy = getFechaActualLocal();
            document.getElementById('paciente_nac').value = hoy;
            document.getElementById('paciente_fecha').value = hoy;
            
            mostrarEstado('Complete todos los campos del formulario para generar su documento REPROCANN.', 'info');
        });
        
        function getFechaActualLocal() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function inicializarFirma() {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            const ctx = canvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000000';
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            function startDrawing(e) {
                e.preventDefault();
                isDrawing = true;
                const pos = getCoordinates(e);
                [lastX, lastY] = [pos.x, pos.y];
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getCoordinates(e);
                const x = pos.x;
                const y = pos.y;
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
                [lastX, lastY] = [x, y];
            }
            
            function stopDrawing(e) {
                if (!isDrawing) return;
                e.preventDefault();
                isDrawing = false;
                ctx.closePath();
            }
            
            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                let x, y;
                if (e.type.includes('touch')) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                return { x, y };
            }
            
            function clearCanvas() {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#000000';
                mostrarEstado('Firma limpiada', 'success');
            }
            
            function getSignatureData() {
                return canvas.toDataURL('image/png');
            }
            
            function hasSignature() {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] !== 255 || data[i + 1] !== 255 || data[i + 2] !== 255) {
                        return true;
                    }
                }
                return false;
            }
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            
            canvas.addEventListener('touchstart', function(e) {
                if (e.cancelable) e.preventDefault();
                startDrawing(e);
            }, { passive: false });
            
            canvas.addEventListener('touchmove', function(e) {
                if (e.cancelable) e.preventDefault();
                draw(e);
            }, { passive: false });
            
            canvas.addEventListener('touchend', function(e) {
                if (e.cancelable) e.preventDefault();
                stopDrawing(e);
            }, { passive: false });
            
            canvas.addEventListener('touchcancel', function(e) {
                if (e.cancelable) e.preventDefault();
                stopDrawing(e);
            }, { passive: false });
            
            canvas.clear = clearCanvas;
            canvas.getSignatureData = getSignatureData;
            canvas.hasSignature = hasSignature;
            
            document.getElementById('clearSignatureBtn').addEventListener('click', clearCanvas);
        }
        
        function configurarEventos() {
            document.getElementById('submitBtn').addEventListener('click', async function() {
                const datos = obtenerDatosFormulario();
                if (!validarFormulario()) {
                    mostrarEstado('‚ùå Complete y valide todos los datos obligatorios', 'error');
                    return;
                }
                
                this.disabled = true;
                this.innerHTML = '‚è≥ Generando...';
                
                mostrarEstado('üìÑ Generando su documento REPROCANN...', 'info');
                document.getElementById('progressBarContainer').style.display = 'block';
                document.getElementById('loadingSpinner').style.display = 'block';
                actualizarProgreso(10);
                
                try {
                    // PRIMERO: Guardar datos en Google Sheets
                    mostrarEstado('üíæ Guardando datos en el sistema...', 'info');
                    const guardadoExitoso = await guardarEnGoogleSheets(datos);
                    
                    if (guardadoExitoso) {
                        mostrarEstado('‚úÖ Datos guardados correctamente', 'success');
                        actualizarProgreso(30);
                        
                        // SEGUNDO: Generar PDF
                        mostrarEstado('üìÑ Generando documento PDF...', 'info');
                        await generarPDFPreciso(datos);
                        
                        actualizarProgreso(100);
                        mostrarEstado('‚úÖ Documento generado y datos guardados exitosamente', 'success');
                        
                        // Mostrar enlace de descarga
                        document.getElementById('downloadLink').style.display = 'block';
                        
                    } else {
                        mostrarEstado('‚ö†Ô∏è Generando documento localmente (sin guardar en sistema)', 'info');
                        await generarPDFPreciso(datos);
                        actualizarProgreso(100);
                        mostrarEstado('‚úÖ Documento generado localmente', 'success');
                    }
                    
                    // Rehabilitar bot√≥n despu√©s de un tiempo
                    setTimeout(() => {
                        document.getElementById('submitBtn').disabled = false;
                        document.getElementById('submitBtn').innerHTML = 'üìÑ Generar Documento';
                        document.getElementById('progressBarContainer').style.display = 'none';
                        document.getElementById('loadingSpinner').style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error en el proceso:', error);
                    mostrarEstado('‚ùå Error al generar el documento: ' + error.message, 'error');
                    
                    // Intentar generar PDF de todos modos
                    try {
                        await generarPDFPreciso(datos);
                        mostrarEstado('‚ö†Ô∏è Documento generado localmente (error en conexi√≥n)', 'info');
                    } catch (pdfError) {
                        mostrarEstado('‚ùå Error cr√≠tico. Intente nuevamente.', 'error');
                    }
                    
                    // Rehabilitar bot√≥n
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').innerHTML = 'üìÑ Generar Documento';
                    document.getElementById('loadingSpinner').style.display = 'none';
                }
            });
            
            document.getElementById('clearFormBtn').addEventListener('click', clearForm);
        }
        
        function obtenerDatosFormulario() {
            const canvas = document.getElementById('signatureCanvas');
            // Crear una versi√≥n reducida de la firma para enviar (m√°s peque√±a para evitar l√≠mites)
            let firmaReducida = '';
            if (canvas && canvas.hasSignature) {
                const firmaCompleta = canvas.getSignatureData();
                // Reducir tama√±o de la firma (solo enviar si es peque√±a)
                if (firmaCompleta.length < 100000) { // 100KB m√°ximo
                    firmaReducida = firmaCompleta;
                }
            }
            
            return {
                paciente_apellidonombre: document.getElementById('paciente_apellidonombre').value.trim(),
                paciente_doc: document.getElementById('paciente_doc').value.trim(),
                paciente_nac: document.getElementById('paciente_nac').value,
                paciente_dom: document.getElementById('paciente_dom').value.trim(),
                paciente_localidad: document.getElementById('paciente_localidad').value.trim(),
                paciente_provincia: document.getElementById('paciente_provincia').value.trim(),
                paciente_codigo_postal: document.getElementById('paciente_codigo_postal').value.trim(),
                paciente_telefono_particular: document.getElementById('paciente_telefono_particular').value.trim(),
                paciente_telefono_celular: document.getElementById('paciente_telefono_celular').value.trim(),
                paciente_email: document.getElementById('paciente_email').value.trim(),
                paciente_obra_social: document.getElementById('paciente_obra_social').value.trim(),
                patologia: document.getElementById('patologia').value.trim(),
                tratamiento_actual: document.getElementById('tratamiento_actual').value.trim(),
                otros_antecedentes: document.getElementById('otros_antecedentes').value.trim(),
                codigo_vinculacion: document.getElementById('codigo_vinculacion').value.trim(),
                paciente_firmaclaracion: firmaReducida,
                paciente_fecha: document.getElementById('paciente_fecha').value,
                timestamp: new Date().toISOString(),
                fecha_hora: new Date().toLocaleString('es-AR')
            };
        }
        
        function validarFormulario() {
            const datos = obtenerDatosFormulario();
            const camposRequeridos = [
                'paciente_apellidonombre',
                'paciente_doc',
                'paciente_nac',
                'paciente_dom',
                'paciente_localidad',
                'paciente_provincia',
                'paciente_codigo_postal',
                'paciente_telefono_celular',
                'paciente_email',
                'paciente_obra_social',
                'paciente_fecha'
            ];
            
            const camposFaltantes = [];
            for (const campo of camposRequeridos) {
                if (!datos[campo] || datos[campo].toString().trim() === '') {
                    const nombreCampo = campo.replace(/_/g, ' ');
                    camposFaltantes.push(nombreCampo);
                }
            }
            
            if (datos.paciente_doc && !/^\d{7,8}$/.test(datos.paciente_doc)) {
                camposFaltantes.push('DNI (7-8 d√≠gitos)');
            }
            
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas || !canvas.hasSignature()) {
                camposFaltantes.push('Firma del paciente');
            }
            
            if (camposFaltantes.length > 0) {
                mostrarEstado(`‚ùå Campos incompletos: ${camposFaltantes.join(', ')}`, 'error');
                return false;
            }
            
            return true;
        }
        
        async function guardarEnGoogleSheets(datos) {
            try {
                // Preparar datos para enviar (excluir firma si es muy grande)
                const datosParaEnviar = { ...datos };
                
                // Si la firma es muy grande, enviar solo un marcador
                if (datosParaEnviar.paciente_firmaclaracion && datosParaEnviar.paciente_firmaclaracion.length > 50000) {
                    datosParaEnviar.paciente_firmaclaracion = '[FIRMA_DEMASIADO_GRANDE]';
                }
                
                // Agregar informaci√≥n adicional
                datosParaEnviar.userAgent = navigator.userAgent;
                datosParaEnviar.platform = navigator.platform;
                datosParaEnviar.fecha_procesamiento = new Date().toISOString();
                
                mostrarEstado('üì§ Enviando datos al servidor...', 'info');
                
                // Enviar datos al Google Apps Script
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Importante para evitar problemas CORS
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datosParaEnviar)
                });
                
                // Con mode: 'no-cors' no podemos leer la respuesta, pero asumimos √©xito
                console.log('Datos enviados a Google Sheets');
                return true;
                
            } catch (error) {
                console.error('Error al guardar en Google Sheets:', error);
                // Continuar aunque falle la conexi√≥n
                return false;
            }
        }
        
        function convertirCoordenadas(campoId, pdfValue, isX = true) {
            let valor = pdfValue * CALIBRACION.escala;
            
            if (isX) {
                valor += CALIBRACION.offsetX;
            } else {
                valor += CALIBRACION.offsetY;
            }
            
            if (campoId === 'paciente_firmaclaracion') {
                if (isX) {
                    valor += CALIBRACION.firma.offsetX;
                } else {
                    valor += CALIBRACION.firma.offsetY;
                }
            }
            
            return valor;
        }
        
        function formatearFecha(fechaISO) {
            if (!fechaISO) return '';
            if (fechaISO.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [anio, mes, dia] = fechaISO.split('-');
                return `${dia}/${mes}/${anio}`;
            }
            
            const fecha = new Date(fechaISO);
            if (isNaN(fecha.getTime())) return fechaISO;
            
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const anio = fecha.getFullYear();
            return `${dia}/${mes}/${anio}`;
        }
        
        async function cargarImagenBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', 0.8)); // Calidad 80% para reducir tama√±o
                };
                img.onerror = () => {
                    // Si falla la carga, rechazar pero con un mensaje espec√≠fico
                    reject(new Error('No se pudo cargar la imagen de fondo'));
                };
                img.src = url;
            });
        }
        
        async function generarPDFPreciso(datos) {
            actualizarProgreso(40);
            
            if (typeof window.jspdf === 'undefined') {
                throw new Error('jsPDF no est√° cargado');
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                compress: true
            });
            
            // Cargar la imagen de fondo (AJUSTA ESTA URL)
            const imagenFondo = 'recann-pagina-1.png'; // Cambia por la URL real
            
            try {
                // Intentar cargar la imagen
                const imgData = await cargarImagenBase64(imagenFondo);
                pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
                actualizarProgreso(50);
            } catch (error) {
                console.warn('No se pudo cargar la imagen de fondo, continuando sin ella:', error);
                // Continuar sin la imagen si no se puede cargar
                actualizarProgreso(50);
            }
            
            // Configurar fuente y color
            pdf.setFont('helvetica');
            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            
            // Funci√≥n para agregar texto en una posici√≥n espec√≠fica (en mm)
            function agregarTexto(texto, x, y, maxWidth) {
                if (!texto || texto.trim() === '') return;
                
                // Convertir coordenadas de p√≠xeles a mil√≠metros
                // Factor de conversi√≥n: 1 mm = 3.779528 px (a 96 DPI)
                const x_mm = (x * 0.264583);
                const y_mm = (y * 0.264583);
                const maxWidth_mm = maxWidth ? (maxWidth * 0.264583) : undefined;
                
                // Dividir texto si es muy largo
                if (maxWidth_mm && texto.length > 30) {
                    const lines = pdf.splitTextToSize(texto, maxWidth_mm);
                    pdf.text(lines, x_mm, y_mm);
                } else {
                    pdf.text(texto, x_mm, y_mm);
                }
            }
            
            // AGREGAR TODOS LOS CAMPOS EN SUS COORDENADAS EXACTAS
            
            // SECCI√ìN SUPERIOR
            if (datos.paciente_apellidonombre && COORDENADAS.paciente_apellidonombre) {
                const coord = COORDENADAS.paciente_apellidonombre;
                const x = convertirCoordenadas('paciente_apellidonombre', coord.x, true);
                const y = convertirCoordenadas('paciente_apellidonombre', coord.y, false);
                agregarTexto(datos.paciente_apellidonombre, x, y, coord.width);
            }
            
            if (datos.paciente_doc && COORDENADAS.paciente_doc) {
                const coord = COORDENADAS.paciente_doc;
                const x = convertirCoordenadas('paciente_doc', coord.x, true);
                const y = convertirCoordenadas('paciente_doc', coord.y, false);
                agregarTexto(datos.paciente_doc, x, y, coord.width);
            }
            
            if (datos.paciente_nac && COORDENADAS.paciente_nac) {
                const coord = COORDENADAS.paciente_nac;
                const x = convertirCoordenadas('paciente_nac', coord.x, true);
                const y = convertirCoordenadas('paciente_nac', coord.y, false);
                const fechaNac = formatearFecha(datos.paciente_nac);
                agregarTexto(fechaNac, x, y, coord.width);
            }
            
            if (datos.paciente_dom && COORDENADAS.paciente_dom) {
                const coord = COORDENADAS.paciente_dom;
                const x = convertirCoordenadas('paciente_dom', coord.x, true);
                const y = convertirCoordenadas('paciente_dom', coord.y, false);
                agregarTexto(datos.paciente_dom, x, y, coord.width);
            }
            
            // FILA: Localidad, Provincia, CP
            if (datos.paciente_localidad && COORDENADAS.paciente_localidad) {
                const coord = COORDENADAS.paciente_localidad;
                const x = convertirCoordenadas('paciente_localidad', coord.x, true);
                const y = convertirCoordenadas('paciente_localidad', coord.y, false);
                agregarTexto(datos.paciente_localidad, x, y, coord.width);
            }
            
            if (datos.paciente_provincia && COORDENADAS.paciente_provincia) {
                const coord = COORDENADAS.paciente_provincia;
                const x = convertirCoordenadas('paciente_provincia', coord.x, true);
                const y = convertirCoordenadas('paciente_provincia', coord.y, false);
                agregarTexto(datos.paciente_provincia, x, y, coord.width);
            }
            
            if (datos.paciente_codigo_postal && COORDENADAS.paciente_codigo_postal) {
                const coord = COORDENADAS.paciente_codigo_postal;
                const x = convertirCoordenadas('paciente_codigo_postal', coord.x, true);
                const y = convertirCoordenadas('paciente_codigo_postal', coord.y, false);
                agregarTexto(datos.paciente_codigo_postal, x, y, coord.width);
            }
            
            // FILA: Tel√©fonos
            if (datos.paciente_telefono_celular && COORDENADAS.paciente_telefono_celular) {
                const coord = COORDENADAS.paciente_telefono_celular;
                const x = convertirCoordenadas('paciente_telefono_celular', coord.x, true);
                const y = convertirCoordenadas('paciente_telefono_celular', coord.y, false);
                agregarTexto(datos.paciente_telefono_celular, x, y, coord.width);
            }
            
            // FILAS SIGUIENTES
            if (datos.paciente_email && COORDENADAS.paciente_email) {
                const coord = COORDENADAS.paciente_email;
                const x = convertirCoordenadas('paciente_email', coord.x, true);
                const y = convertirCoordenadas('paciente_email', coord.y, false);
                agregarTexto(datos.paciente_email, x, y, coord.width);
            }
            
            if (datos.paciente_obra_social && COORDENADAS.paciente_obra_social) {
                const coord = COORDENADAS.paciente_obra_social;
                const x = convertirCoordenadas('paciente_obra_social', coord.x, true);
                const y = convertirCoordenadas('paciente_obra_social', coord.y, false);
                agregarTexto(datos.paciente_obra_social, x, y, coord.width);
            }
            
            actualizarProgreso(60);
            
            // DATOS M√âDICOS (si est√°n en el PDF)
            if (datos.patologia && COORDENADAS.patologia) {
                const coord = COORDENADAS.patologia;
                const x = convertirCoordenadas('patologia', coord.x, true);
                const y = convertirCoordenadas('patologia', coord.y, false);
                agregarTexto(datos.patologia.substring(0, 100), x, y, coord.width);
            }
            
            if (datos.tratamiento_actual && COORDENADAS.tratamiento_actual) {
                const coord = COORDENADAS.tratamiento_actual;
                const x = convertirCoordenadas('tratamiento_actual', coord.x, true);
                const y = convertirCoordenadas('tratamiento_actual', coord.y, false);
                agregarTexto(datos.tratamiento_actual.substring(0, 100), x, y, coord.width);
            }
            
            actualizarProgreso(70);
            
            // SECCI√ìN FINAL - TODOS LOS DATOS JUNTO A LA FIRMA
            
            // 1. Apellido y Nombre (izquierda)
            if (datos.paciente_apellidonombre && COORDENADAS.paciente_nombre_firma) {
                const coord = COORDENADAS.paciente_nombre_firma;
                const x = convertirCoordenadas('paciente_nombre_firma', coord.x, true);
                const y = convertirCoordenadas('paciente_nombre_firma', coord.y, false);
                agregarTexto(datos.paciente_apellidonombre, x, y, coord.width);
            }
            
            // 2. Fecha de Firma
            if (datos.paciente_fecha && COORDENADAS.paciente_fecha) {
                const coord = COORDENADAS.paciente_fecha;
                const x = convertirCoordenadas('paciente_fecha', coord.x, true);
                const y = convertirCoordenadas('paciente_fecha', coord.y, false);
                const fechaFirma = formatearFecha(datos.paciente_fecha);
                agregarTexto(fechaFirma, x, y, coord.width);
            }
            
            // 3. Localidad
            if (datos.paciente_localidad && COORDENADAS.paciente_localidad_final) {
                const coord = COORDENADAS.paciente_localidad_final;
                const x = convertirCoordenadas('paciente_localidad_final', coord.x, true);
                const y = convertirCoordenadas('paciente_localidad_final', coord.y, false);
                agregarTexto(datos.paciente_localidad, x, y, coord.width);
            }
            
            // 4. Provincia
            if (datos.paciente_provincia && COORDENADAS.paciente_provincia_final) {
                const coord = COORDENADAS.paciente_provincia_final;
                const x = convertirCoordenadas('paciente_provincia_final', coord.x, true);
                const y = convertirCoordenadas('paciente_provincia_final', coord.y, false);
                agregarTexto(datos.paciente_provincia, x, y, coord.width);
            }
            
            // 5. C√≥digo Postal
            if (datos.paciente_codigo_postal && COORDENADAS.paciente_codigo_postal_final) {
                const coord = COORDENADAS.paciente_codigo_postal_final;
                const x = convertirCoordenadas('paciente_codigo_postal_final', coord.x, true);
                const y = convertirCoordenadas('paciente_codigo_postal_final', coord.y, false);
                agregarTexto(datos.paciente_codigo_postal, x, y, coord.width);
            }
            
            actualizarProgreso(80);
            
            // AGREGAR LA FIRMA (si existe)
            const canvas = document.getElementById('signatureCanvas');
            if (canvas && canvas.hasSignature() && datos.paciente_firmaclaracion && COORDENADAS.paciente_firmaclaracion) {
                try {
                    const coord = COORDENADAS.paciente_firmaclaracion;
                    const x = convertirCoordenadas('paciente_firmaclaracion', coord.x, true);
                    const y = convertirCoordenadas('paciente_firmaclaracion', coord.y, false);
                    const width = convertirCoordenadas('paciente_firmaclaracion', coord.width, true) * CALIBRACION.firma.escala;
                    
                    // Convertir a mm
                    const x_mm = (x * 0.264583);
                    const y_mm = (y * 0.264583);
                    const width_mm = (width * 0.264583);
                    const height_mm = (coord.height * 0.264583);
                    
                    // Usar la firma completa del canvas (no la reducida)
                    const firmaCompleta = canvas.getSignatureData();
                    pdf.addImage(firmaCompleta, 'PNG', x_mm, y_mm, width_mm, height_mm);
                } catch (error) {
                    console.warn('No se pudo agregar la firma al PDF:', error);
                }
            }
            
            actualizarProgreso(90);
            
            // Guardar el PDF
            const nombreArchivo = `REPROCANN_${datos.paciente_apellidonombre.replace(/\s+/g, '_')}_${datos.paciente_doc}.pdf`;
            pdf.save(nombreArchivo);
            
            // Configurar el enlace de descarga por si acaso
            const pdfOutput = pdf.output('blob');
            const url = URL.createObjectURL(pdfOutput);
            document.getElementById('downloadButton').href = url;
            document.getElementById('downloadButton').download = nombreArchivo;
        }
        
        function actualizarProgreso(porcentaje) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${porcentaje}%`;
            progressBar.textContent = `${porcentaje}%`;
        }
        
        function clearForm() {
            if (confirm('¬øEst√° seguro que desea limpiar todo el formulario? Se perder√°n todos los datos ingresados.')) {
                const inputs = document.querySelectorAll('#pacienteForm input, #pacienteForm textarea');
                inputs.forEach(input => {
                    if (input.type !== 'button' && input.type !== 'submit') {
                        input.value = '';
                    }
                });
                
                const canvas = document.getElementById('signatureCanvas');
                if (canvas && canvas.clear) {
                    canvas.clear();
                }
                
                const hoy = getFechaActualLocal();
                document.getElementById('paciente_nac').value = hoy;
                document.getElementById('paciente_fecha').value = hoy;
                
                document.getElementById('downloadLink').style.display = 'none';
                document.getElementById('progressBarContainer').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').innerHTML = 'üìÑ Generar Documento';
                
                mostrarEstado('Formulario limpiado. Puede comenzar a completarlo nuevamente.', 'success');
            }
        }
        
        function mostrarEstado(mensaje, tipo) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = mensaje;
            statusDiv.className = `status-message status-${tipo}`;
            statusDiv.style.display = 'block';
            
            if (tipo === 'success' || tipo === 'info') {
                setTimeout(() => {
                    if (statusDiv.textContent === mensaje) {
                        statusDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }
    </script>
</body>
</html>