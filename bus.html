<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auditoría GPS - Transporte Público Buenos Aires</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== RESET Y BASE ===== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #0f172a; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            touch-action: pan-x pan-y;
            color: #e2e8f0;
        }
        
        /* ===== MAPA ===== */
        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        /* ===== CONSOLE OVERLAY ===== */
        #consoleOverlay {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 95%;
            max-width: 400px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 12px;
            z-index: 2000;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }
        
        #consoleOverlay.active {
            display: flex;
        }
        
        .console-header {
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.8);
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }
        
        .console-title {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .console-controls {
            display: flex;
            gap: 8px;
        }
        
        .console-btn {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 6px;
            color: #3b82f6;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .console-btn:hover {
            background: rgba(59, 130, 246, 0.3);
        }
        
        .console-content {
            padding: 12px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 6px;
            padding: 4px 6px;
            border-radius: 4px;
            border-left: 3px solid #3b82f6;
            background: rgba(30, 41, 59, 0.3);
            word-break: break-all;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .log-info { border-left-color: #3b82f6; }
        .log-success { border-left-color: #10b981; }
        .log-warning { border-left-color: #f59e0b; }
        .log-error { border-left-color: #ef4444; }
        
        .log-time {
            color: #94a3b8;
            font-size: 10px;
            margin-right: 8px;
        }
        
        /* ===== FLOATING BUTTONS ===== */
        .floating-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .floating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            color: #94a3b8;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .floating-btn:hover {
            transform: scale(1.1);
            background: rgba(30, 41, 59, 0.95);
            color: #3b82f6;
        }
        
        .floating-btn.primary {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .floating-btn.warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .floating-btn.success {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #10b981;
        }
        
        /* ===== STATUS INDICATORS ===== */
        .status-indicators {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .status-badge {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            min-width: 140px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.active { background: #10b981; }
        .status-dot.warning { background: #f59e0b; }
        .status-dot.error { background: #ef4444; }
        .status-dot.inactive { background: #64748b; }
        
        /* ===== MODALES ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 16px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .modal-logo {
            font-size: 40px;
            color: #3b82f6;
            margin-bottom: 12px;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 8px;
        }
        
        .modal-subtitle {
            font-size: 13px;
            color: #94a3b8;
        }
        
        /* ===== FORMULARIOS ===== */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 8px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .form-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        
        /* ===== TEST PANEL ===== */
        .test-panel {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .test-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            background: rgba(30, 41, 59, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .test-option:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .test-option.active {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
        }
        
        /* ===== LOADING ===== */
        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            #consoleOverlay {
                width: calc(100% - 20px);
                max-width: none;
            }
            
            .console-content {
                height: 250px;
            }
            
            .floating-buttons {
                bottom: 15px;
                right: 15px;
            }
            
            .floating-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .status-badge {
                min-width: 120px;
                padding: 6px 10px;
                font-size: 10px;
            }
            
            .console-content {
                height: 200px;
                font-size: 11px;
            }
            
            .floating-buttons {
                bottom: 10px;
                right: 10px;
                gap: 8px;
            }
            
            .floating-btn {
                width: 42px;
                height: 42px;
            }
        }
        
        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 3px;
        }
        
        /* ===== VEHICLE MARKERS ===== */
        .vehicle-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Consola Overlay -->
    <div id="consoleOverlay">
        <div class="console-header">
            <div class="console-title">
                <i class="fas fa-terminal"></i>
                CONSOLA DE DEPURACIÓN
            </div>
            <div class="console-controls">
                <button class="console-btn" onclick="clearConsole()" title="Limpiar">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="console-btn" onclick="toggleConsole()" title="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="console-content" id="consoleOutput"></div>
    </div>
    
    <!-- Indicadores de Estado -->
    <div class="status-indicators">
        <div class="status-badge">
            <div class="status-dot inactive" id="gpsStatusDot"></div>
            <span id="gpsStatusText">GPS: Esperando...</span>
        </div>
        <div class="status-badge">
            <div class="status-dot inactive" id="apiStatusDot"></div>
            <span id="apiStatusText">API: No config.</span>
        </div>
        <div class="status-badge">
            <div class="status-dot inactive" id="dataStatusDot"></div>
            <span id="dataStatusText">Datos: 0 vehículos</span>
        </div>
    </div>
    
    <!-- Botones Flotantes -->
    <div class="floating-buttons">
        <button class="floating-btn" onclick="fetchTransportData()" title="Obtener datos">
            <i class="fas fa-bus"></i>
        </button>
        <button class="floating-btn" onclick="testAllEndpoints()" title="Probar todos los endpoints">
            <i class="fas fa-vial"></i>
        </button>
        <button class="floating-btn" onclick="toggleConsole()" title="Mostrar consola">
            <i class="fas fa-terminal"></i>
        </button>
        <button class="floating-btn primary" onclick="openApiModal()" title="Configurar API">
            <i class="fas fa-cog"></i>
        </button>
    </div>
    
    <!-- Modal de Configuración API -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-logo">
                    <i class="fas fa-bus"></i>
                </div>
                <div class="modal-title">API Transporte Buenos Aires</div>
                <div class="modal-subtitle">Configuración y Pruebas de Conexión</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-key"></i>
                    API Key (Client ID)
                </label>
                <input type="text" 
                       class="form-input" 
                       id="apiKey" 
                       placeholder="Ej: a1b2c3d4e5f6g7h8i9j0"
                       value=""
                       autocomplete="off">
                <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                    Obtén tu API Key en: 
                    <a href="https://apitransporte.buenosaires.gob.ar/console/" 
                       target="_blank" 
                       style="color: #3b82f6;">
                        apitransporte.buenosaires.gob.ar/console/
                    </a>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-user-secret"></i>
                    Client Secret (Opcional)
                </label>
                <input type="text" 
                       class="form-input" 
                       id="clientSecret" 
                       placeholder="Tu client secret si lo tienes"
                       autocomplete="off">
            </div>
            
            <div class="test-panel">
                <label class="form-label">
                    <i class="fas fa-plug"></i>
                    Pruebas de Endpoint
                </label>
                
                <div class="test-option" onclick="testEndpoint('lineas')">
                    <i class="fas fa-route"></i>
                    <div>
                        <div style="font-weight: 600;">Líneas de Colectivos</div>
                        <div style="font-size: 10px; color: #94a3b8;">/colectivos/lineas</div>
                    </div>
                </div>
                
                <div class="test-option" onclick="testEndpoint('positions')">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <div style="font-weight: 600;">Posiciones en Tiempo Real</div>
                        <div style="font-size: 10px; color: #94a3b8;">/colectivos/vehiclePositionsSimple</div>
                    </div>
                </div>
                
                <div class="test-option" onclick="testEndpoint('subtes')">
                    <i class="fas fa-subway"></i>
                    <div>
                        <div style="font-weight: 600;">Líneas de Subte</div>
                        <div style="font-size: 10px; color: #94a3b8;">/subtes/lineas</div>
                    </div>
                </div>
            </div>
            
            <button class="form-button" onclick="saveApiConfig()">
                <span>GUARDAR CONFIGURACIÓN</span>
                <div class="spinner" id="saveSpinner" style="display: none;"></div>
            </button>
            
            <button class="form-button" onclick="testConnection()" style="background: linear-gradient(135deg, #10b981, #059669); margin-top: 8px;">
                <span>PROBAR CONEXIÓN COMPLETA</span>
                <div class="spinner" id="testSpinner" style="display: none;"></div>
            </button>
            
            <button class="form-button" onclick="closeApiModal()" style="background: rgba(100, 116, 139, 0.3); margin-top: 8px;">
                <span>CANCELAR</span>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // SISTEMA DE CONSOLA
        // ============================================
        class ConsoleManager {
            constructor() {
                this.logs = [];
                this.maxLogs = 100;
                this.outputElement = document.getElementById('consoleOutput');
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('es-AR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const logEntry = {
                    timestamp,
                    message,
                    type,
                    id: Date.now() + Math.random()
                };
                
                this.logs.unshift(logEntry);
                
                if (this.logs.length > this.maxLogs) {
                    this.logs.pop();
                }
                
                this.render();
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
            
            render() {
                this.outputElement.innerHTML = '';
                
                this.logs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = `log-entry log-${log.type}`;
                    div.innerHTML = `
                        <span class="log-time">${log.timestamp}</span>
                        <span>${log.message}</span>
                    `;
                    this.outputElement.appendChild(div);
                });
            }
            
            clear() {
                this.logs = [];
                this.render();
            }
            
            error(message) {
                this.log(message, 'error');
            }
            
            success(message) {
                this.log(message, 'success');
            }
            
            warning(message) {
                this.log(message, 'warning');
            }
        }
        
        // ============================================
        // CONFIGURACIÓN
        // ============================================
        const API_CONFIG = {
            BASE_URL: "https://apitransporte.buenosaires.gob.ar/",
            ENDPOINTS: {
                COLECTIVOS_LINEAS: "colectivos/lineas",
                COLECTIVOS_POSITIONS: "colectivos/vehiclePositionsSimple",
                COLECTIVOS_RECORRIDOS: "colectivos/recorridos",
                SUBTES_LINEAS: "subtes/lineas",
                TRENES_LINEAS: "trenes/lineas",
                ECOBICI: "ecobici/estaciones"
            },
            PROXIES: [
                {
                    name: "Directo",
                    getUrl: (endpoint, apiKey) => 
                        `${API_CONFIG.BASE_URL}${endpoint}?client_id=${apiKey}`
                },
                {
                    name: "AllOrigins",
                    getUrl: (endpoint, apiKey) => {
                        const targetUrl = `${API_CONFIG.BASE_URL}${endpoint}?client_id=${apiKey}`;
                        return `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
                    },
                    processResponse: async (response) => {
                        const data = await response.json();
                        return data.contents ? JSON.parse(data.contents) : data;
                    }
                },
                {
                    name: "CorsProxy",
                    getUrl: (endpoint, apiKey) => {
                        const targetUrl = `${API_CONFIG.BASE_URL}${endpoint}?client_id=${apiKey}`;
                        return `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
                    }
                },
                {
                    name: "CorsAnywhere",
                    getUrl: (endpoint, apiKey) => {
                        const targetUrl = `${API_CONFIG.BASE_URL}${endpoint}?client_id=${apiKey}`;
                        return `https://cors-anywhere.herokuapp.com/${targetUrl}`;
                    }
                }
            ]
        };
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map = null;
        let userMarker = null;
        let vehicleMarkers = [];
        let consoleManager = new ConsoleManager();
        let apiKey = '';
        let clientSecret = '';
        let currentLocation = null;
        let activeProxyIndex = 0;
        
        // ============================================
        // INICIALIZACIÓN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            consoleManager.log('Inicializando sistema de auditoría GPS...');
            
            // Cargar configuración guardada
            loadSavedConfig();
            
            // Inicializar mapa
            initMap();
            
            // Iniciar GPS
            startGPS();
            
            // Configurar eventos
            setupEventListeners();
            
            consoleManager.success('Sistema inicializado correctamente');
        });
        
        function setupEventListeners() {
            // Auto-guardar API Key mientras se escribe
            document.getElementById('apiKey').addEventListener('input', function() {
                localStorage.setItem('api_key_temp', this.value);
            });
        }
        
        function loadSavedConfig() {
            const savedApiKey = localStorage.getItem('api_key');
            const savedClientSecret = localStorage.getItem('client_secret');
            
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                apiKey = savedApiKey;
                updateApiStatus('warning', 'API: Configurada');
            }
            
            if (savedClientSecret) {
                document.getElementById('clientSecret').value = savedClientSecret;
                clientSecret = savedClientSecret;
            }
        }
        
        // ============================================
        // SISTEMA DE MAPA
        // ============================================
        function initMap() {
            consoleManager.log('Inicializando mapa...');
            
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true,
                dragging: true,
                tap: true,
                touchZoom: true,
                scrollWheelZoom: true
            });
            
            // Mapa oscuro
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CARTO',
                maxZoom: 19,
                minZoom: 10
            }).addTo(map);
            
            // Vista inicial de Buenos Aires
            map.setView([-34.6037, -58.3816], 13);
            
            consoleManager.success('Mapa inicializado correctamente');
        }
        
        // ============================================
        // SISTEMA GPS
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                consoleManager.error('Tu dispositivo no soporta GPS');
                updateGPSStatus('error', 'GPS: No soportado');
                return;
            }
            
            consoleManager.log('Iniciando seguimiento GPS...');
            updateGPSStatus('warning', 'GPS: Buscando...');
            
            const options = {
                enableHighAccuracy: true,
                maximumAge: 10000,
                timeout: 15000
            };
            
            navigator.geolocation.watchPosition(
                (position) => handleGPSSuccess(position),
                (error) => handleGPSError(error),
                options
            );
        }
        
        function handleGPSSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed || 0;
            
            currentLocation = { lat, lng, accuracy, speed };
            
            consoleManager.log(`GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)} ±${Math.round(accuracy)}m`);
            updateGPSStatus('active', `GPS: ${speed.toFixed(1)} km/h`);
            
            updateUserPosition(lat, lng);
        }
        
        function handleGPSError(error) {
            let message = 'Error GPS: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Permiso denegado';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'Posición no disponible';
                    break;
                case error.TIMEOUT:
                    message += 'Tiempo agotado';
                    break;
                default:
                    message += 'Error desconocido';
            }
            
            consoleManager.error(message);
            updateGPSStatus('error', 'GPS: Error');
        }
        
        function updateUserPosition(lat, lng) {
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'vehicle-marker',
                        html: `<div style="background: #3b82f6;">U</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                userMarker.bindPopup('<strong>Tu posición</strong><br>Auditor GPS Activo');
                userMarker.openPopup();
            } else {
                userMarker.setLatLng([lat, lng]);
            }
            
            // Centrar mapa en la posición si está lejos
            const currentCenter = map.getCenter();
            const distance = map.distance([lat, lng], currentCenter);
            
            if (distance > 1000) { // Si está a más de 1km
                map.setView([lat, lng], 15);
            }
        }
        
        // ============================================
        // SISTEMA API Y CONEXIONES
        // ============================================
        async function testConnection() {
            if (!apiKey) {
                consoleManager.error('No hay API Key configurada');
                alert('Por favor, configura tu API Key primero');
                return;
            }
            
            consoleManager.log('Iniciando prueba de conexión completa...');
            
            const testSpinner = document.getElementById('testSpinner');
            testSpinner.style.display = 'inline-block';
            
            try {
                // Probar cada endpoint
                const endpoints = [
                    { key: 'lineas', name: 'Líneas de Colectivos', endpoint: API_CONFIG.ENDPOINTS.COLECTIVOS_LINEAS },
                    { key: 'positions', name: 'Posiciones en Tiempo Real', endpoint: API_CONFIG.ENDPOINTS.COLECTIVOS_POSITIONS },
                    { key: 'subtes', name: 'Líneas de Subte', endpoint: API_CONFIG.ENDPOINTS.SUBTES_LINEAS }
                ];
                
                let successCount = 0;
                
                for (const ep of endpoints) {
                    consoleManager.log(`Probando: ${ep.name}...`);
                    
                    try {
                        const data = await fetchWithRetry(ep.endpoint, apiKey);
                        if (data) {
                            consoleManager.success(`${ep.name}: OK (${Array.isArray(data) ? data.length + ' elementos' : 'Datos recibidos'})`);
                            successCount++;
                        }
                    } catch (error) {
                        consoleManager.error(`${ep.name}: FALLÓ - ${error.message}`);
                    }
                    
                    // Pequeña pausa entre requests
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                if (successCount > 0) {
                    consoleManager.success(`Prueba completada: ${successCount}/${endpoints.length} endpoints funcionando`);
                    updateApiStatus('active', `API: ${successCount}/3 OK`);
                    
                    // Guardar la configuración exitosa
                    saveApiConfig();
                    
                    // Cerrar modal automáticamente si todo funciona
                    setTimeout(() => {
                        if (successCount === endpoints.length) {
                            closeApiModal();
                        }
                    }, 2000);
                } else {
                    consoleManager.error('Ningún endpoint respondió correctamente');
                    updateApiStatus('error', 'API: Todos fallaron');
                }
                
            } catch (error) {
                consoleManager.error(`Error en prueba de conexión: ${error.message}`);
            } finally {
                testSpinner.style.display = 'none';
            }
        }
        
        async function testAllEndpoints() {
            consoleManager.log('=== PRUEBA COMPLETA DE ENDPOINTS ===');
            
            const endpoints = [
                { name: 'Colectivos - Líneas', endpoint: API_CONFIG.ENDPOINTS.COLECTIVOS_LINEAS },
                { name: 'Colectivos - Posiciones', endpoint: API_CONFIG.ENDPOINTS.COLECTIVOS_POSITIONS },
                { name: 'Colectivos - Recorridos', endpoint: API_CONFIG.ENDPOINTS.COLECTIVOS_RECORRIDOS },
                { name: 'Subtes - Líneas', endpoint: API_CONFIG.ENDPOINTS.SUBTES_LINEAS },
                { name: 'Trenes - Líneas', endpoint: API_CONFIG.ENDPOINTS.TRENES_LINEAS },
                { name: 'Ecobici - Estaciones', endpoint: API_CONFIG.ENDPOINTS.ECOBICI }
            ];
            
            for (const ep of endpoints) {
                await testSpecificEndpoint(ep.name, ep.endpoint);
                await new Promise(resolve => setTimeout(resolve, 300)); // Pausa entre requests
            }
            
            consoleManager.log('=== PRUEBA COMPLETADA ===');
        }
        
        async function testSpecificEndpoint(name, endpoint) {
            if (!apiKey) {
                consoleManager.error(`No se puede probar ${name}: API Key no configurada`);
                return;
            }
            
            consoleManager.log(`Probando ${name} (${endpoint})...`);
            
            try {
                const startTime = Date.now();
                const data = await fetchWithRetry(endpoint, apiKey);
                const responseTime = Date.now() - startTime;
                
                if (data) {
                    const dataSize = JSON.stringify(data).length;
                    consoleManager.success(`${name}: OK (${responseTime}ms, ${dataSize} bytes)`);
                    
                    if (Array.isArray(data)) {
                        consoleManager.log(`  ↳ ${data.length} elementos encontrados`);
                        if (data.length > 0 && data[0]) {
                            consoleManager.log(`  ↳ Primer elemento: ${JSON.stringify(data[0]).substring(0, 100)}...`);
                        }
                    }
                }
            } catch (error) {
                consoleManager.error(`${name}: ERROR - ${error.message}`);
            }
        }
        
        async function testEndpoint(type) {
            if (!apiKey) {
                consoleManager.error('Configura tu API Key primero');
                alert('Por favor, ingresa tu API Key');
                return;
            }
            
            let endpoint, name;
            
            switch(type) {
                case 'lineas':
                    endpoint = API_CONFIG.ENDPOINTS.COLECTIVOS_LINEAS;
                    name = 'Líneas de Colectivos';
                    break;
                case 'positions':
                    endpoint = API_CONFIG.ENDPOINTS.COLECTIVOS_POSITIONS;
                    name = 'Posiciones en Tiempo Real';
                    break;
                case 'subtes':
                    endpoint = API_CONFIG.ENDPOINTS.SUBTES_LINEAS;
                    name = 'Líneas de Subte';
                    break;
                default:
                    return;
            }
            
            consoleManager.log(`Probando endpoint: ${name}...`);
            
            try {
                const data = await fetchWithRetry(endpoint, apiKey);
                
                if (data) {
                    consoleManager.success(`${name}: CONEXIÓN EXITOSA`);
                    consoleManager.log(`Respuesta: ${JSON.stringify(data).substring(0, 200)}...`);
                    
                    if (type === 'positions' && Array.isArray(data)) {
                        consoleManager.log(`Encontrados ${data.length} vehículos`);
                        updateDataStatus('active', `Datos: ${data.length} vehículos`);
                    }
                }
            } catch (error) {
                consoleManager.error(`${name}: ERROR - ${error.message}`);
            }
        }
        
        async function fetchWithRetry(endpoint, apiKey, maxRetries = 3) {
            let lastError = null;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                // Rotar entre proxies
                const proxy = API_CONFIG.PROXIES[activeProxyIndex];
                activeProxyIndex = (activeProxyIndex + 1) % API_CONFIG.PROXIES.length;
                
                try {
                    const url = proxy.getUrl(endpoint, apiKey);
                    consoleManager.log(`Intento ${attempt}/${maxRetries} usando ${proxy.name}: ${url.substring(0, 80)}...`);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    let data;
                    
                    if (proxy.processResponse) {
                        data = await proxy.processResponse(response);
                    } else {
                        data = await response.json();
                    }
                    
                    consoleManager.success(`✓ ${proxy.name} funcionó`);
                    return data;
                    
                } catch (error) {
                    lastError = error;
                    consoleManager.warning(`✗ ${proxy.name} falló: ${error.message}`);
                    
                    if (attempt < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 500 * attempt));
                    }
                }
            }
            
            throw lastError || new Error('Todos los intentos fallaron');
        }
        
        // ============================================
        // OBTENCIÓN DE DATOS DE TRANSPORTE
        // ============================================
        async function fetchTransportData() {
            if (!apiKey) {
                consoleManager.error('No hay API Key configurada');
                alert('Por favor, configura tu API Key primero');
                openApiModal();
                return;
            }
            
            consoleManager.log('Obteniendo datos de transporte en tiempo real...');
            
            try {
                const data = await fetchWithRetry(API_CONFIG.ENDPOINTS.COLECTIVOS_POSITIONS, apiKey);
                
                if (!data || (Array.isArray(data) && data.length === 0)) {
                    consoleManager.warning('No hay datos de vehículos disponibles');
                    return;
                }
                
                // Procesar datos
                processTransportData(data);
                
            } catch (error) {
                consoleManager.error(`Error obteniendo datos: ${error.message}`);
                updateDataStatus('error', 'Datos: Error');
            }
        }
        
        function processTransportData(data) {
            // Limpiar marcadores anteriores
            vehicleMarkers.forEach(marker => map.removeLayer(marker));
            vehicleMarkers = [];
            
            let vehicles = [];
            
            // Normalizar estructura de datos
            if (Array.isArray(data)) {
                vehicles = data;
            } else if (data.vehicles) {
                vehicles = data.vehicles;
            } else if (data.colectivos) {
                vehicles = data.colectivos;
            } else if (data.data) {
                vehicles = data.data;
            } else {
                vehicles = Object.values(data).flat();
            }
            
            // Filtrar vehículos válidos
            vehicles = vehicles.filter(v => v && (v.lat || v.latitude) && (v.lng || v.longitude));
            
            consoleManager.success(`Procesando ${vehicles.length} vehículos`);
            updateDataStatus('active', `Datos: ${vehicles.length} vehículos`);
            
            // Crear marcadores
            vehicles.forEach(vehicle => {
                const lat = vehicle.lat || vehicle.latitude || vehicle.position?.lat;
                const lng = vehicle.lng || vehicle.longitude || vehicle.position?.lng;
                const linea = vehicle.linea || vehicle.route_id || vehicle.line || 'N/A';
                const id = vehicle.id || vehicle.vehicle_id || 'N/A';
                const velocidad = vehicle.velocity || vehicle.speed || 0;
                
                // Color basado en la línea
                const colors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899'];
                const colorIndex = parseInt(linea) % colors.length || 0;
                const color = colors[colorIndex];
                
                // Crear marcador
                const icon = L.divIcon({
                    className: 'vehicle-marker',
                    html: `<div style="background: ${color};">${linea.length <= 3 ? linea : 'B'}</div>`,
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                });
                
                const marker = L.marker([lat, lng], { icon }).addTo(map);
                
                // Tooltip con información
                const tooltip = `
                    <div style="font-size: 12px; max-width: 200px;">
                        <strong>Línea ${linea}</strong><br>
                        ID: ${id}<br>
                        Velocidad: ${velocidad} km/h<br>
                        Posición: ${lat.toFixed(6)}, ${lng.toFixed(6)}
                    </div>
                `;
                
                marker.bindTooltip(tooltip);
                vehicleMarkers.push(marker);
            });
            
            // Mostrar resumen en consola
            if (vehicles.length > 0) {
                const uniqueLines = [...new Set(vehicles.map(v => v.linea || v.route_id))];
                consoleManager.log(`Líneas activas: ${uniqueLines.join(', ')}`);
            }
        }
        
        // ============================================
        // MANEJO DE CONFIGURACIÓN
        // ============================================
        function saveApiConfig() {
            const apiKeyInput = document.getElementById('apiKey').value.trim();
            const clientSecretInput = document.getElementById('clientSecret').value.trim();
            
            if (!apiKeyInput) {
                consoleManager.error('La API Key es requerida');
                alert('Por favor, ingresa tu API Key');
                return;
            }
            
            // Guardar en localStorage
            localStorage.setItem('api_key', apiKeyInput);
            localStorage.setItem('client_secret', clientSecretInput);
            
            apiKey = apiKeyInput;
            clientSecret = clientSecretInput;
            
            consoleManager.success('Configuración guardada correctamente');
            updateApiStatus('warning', 'API: Configurada (probar)');
            
            // Probar automáticamente
            setTimeout(testConnection, 500);
        }
        
        // ============================================
        // INTERFAZ DE USUARIO
        // ============================================
        function toggleConsole() {
            const consoleOverlay = document.getElementById('consoleOverlay');
            consoleOverlay.classList.toggle('active');
        }
        
        function clearConsole() {
            consoleManager.clear();
            consoleManager.log('Consola limpiada');
        }
        
        function openApiModal() {
            document.getElementById('apiModal').classList.add('active');
        }
        
        function closeApiModal() {
            document.getElementById('apiModal').classList.remove('active');
        }
        
        function updateGPSStatus(status, text) {
            const dot = document.getElementById('gpsStatusDot');
            const textEl = document.getElementById('gpsStatusText');
            
            dot.className = 'status-dot ' + status;
            textEl.textContent = text;
        }
        
        function updateApiStatus(status, text) {
            const dot = document.getElementById('apiStatusDot');
            const textEl = document.getElementById('apiStatusText');
            
            dot.className = 'status-dot ' + status;
            textEl.textContent = text;
        }
        
        function updateDataStatus(status, text) {
            const dot = document.getElementById('dataStatusDot');
            const textEl = document.getElementById('dataStatusText');
            
            dot.className = 'status-dot ' + status;
            textEl.textContent = text;
        }
        
        // ============================================
        // FUNCIONES UTILITARIAS
        // ============================================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 4000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideDown 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ============================================
        // INYECTAR CSS ANIMATIONS
        // ============================================
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from { top: -100px; opacity: 0; }
                to { top: 20px; opacity: 1; }
            }
            
            @keyframes slideUp {
                from { top: 20px; opacity: 1; }
                to { top: -100px; opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        consoleManager.log('Sistema listo para auditoría de transporte público');
    </script>
</body>
</html>