<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Transporte - Sin Saltos - Mapa Calibrado</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #000; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            touch-action: pan-x pan-y;
        }
        
        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        /* ===== BARRA SUPERIOR ===== */
        .top-bar {
            position: fixed;
            top: env(safe-area-inset-top, 10px);
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            height: 65px;
        }
        
        .gps-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .gps-indicator {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #34C759, #28A745);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }
        
        .gps-info {
            display: flex;
            flex-direction: column;
        }
        
        .gps-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .gps-subtitle {
            color: #34C759;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .top-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon-button {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .icon-button:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .icon-button.following {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
        }
        
        /* ===== INDICADOR DE VELOCIDAD PRECISO ===== */
        .speed-indicator {
            position: fixed;
            top: 85px;
            right: 15px;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(40px);
            border-radius: 20px;
            padding: 18px 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 999;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            min-width: 150px;
            animation: slideInRight 0.3s ease;
        }
        
        .speed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .speed-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .gps-accuracy {
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .speed-value {
            color: #34C759;
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(52, 199, 89, 0.7);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            transition: all 0.2s ease;
        }
        
        .speed-direction {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .direction-arrow {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        /* ===== PANEL DE CONTROL INFERIOR ===== */
        .control-panel {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 10px);
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 1000;
            padding: 20px;
            box-shadow: 0 -15px 60px rgba(0, 0, 0, 0.7);
        }
        
        .line-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .line-name {
            color: white;
            font-size: 18px;
            font-weight: 700;
        }
        
        .line-status {
            color: #34C759;
            font-size: 12px;
            background: rgba(52, 199, 89, 0.15);
            padding: 6px 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .station-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .station-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 15px;
            border-left: 4px solid transparent;
        }
        
        .station-item.current {
            border-left-color: #007AFF;
            background: rgba(0, 122, 255, 0.1);
        }
        
        .station-item.next {
            border-left-color: #34C759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .station-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        
        .station-name {
            color: white;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .station-distance {
            color: #34C759;
            font-size: 13px;
            font-weight: 600;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        
        .control-button {
            padding: 14px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        
        .control-button:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .control-button.active {
            background: rgba(0, 122, 255, 0.2);
            border-color: #007AFF;
            color: #007AFF;
        }
        
        .button-icon {
            font-size: 18px;
        }
        
        .button-text {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        /* ===== MARCADORES ===== */
        .user-marker {
            border: 3px solid white;
            box-shadow: 0 0 30px rgba(0, 122, 255, 0.9);
            transition: all 0.3s ease;
        }
        
        .station-marker {
            border: 3px solid white;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
        }
        
        .station-marker.current {
            border-color: #007AFF;
            box-shadow: 0 0 30px rgba(0, 122, 255, 0.8);
            animation: stationPulse 1.5s infinite;
        }
        
        .station-marker.next {
            border-color: #34C759;
            box-shadow: 0 0 30px rgba(52, 199, 89, 0.8);
            animation: stationPulse 1.5s infinite;
        }
        
        /* ===== RUTA ===== */
        .route-line {
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .bus-route-line {
            pointer-events: none;
            stroke-dasharray: 10, 10;
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(1.05);
            }
        }
        
        @keyframes gpsPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(0, 122, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0);
            }
        }
        
        @keyframes stationPulse {
            0%, 100% { 
                transform: scale(1);
            }
            50% { 
                transform: scale(1.1);
            }
        }
        
        @keyframes slideInRight {
            from { 
                opacity: 0;
                transform: translateX(20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (min-width: 768px) {
            .speed-indicator {
                top: 90px;
                right: 25px;
                padding: 20px 24px;
                min-width: 160px;
            }
            
            .control-panel {
                left: 20px;
                right: 20px;
                padding: 24px;
            }
            
            .top-bar {
                padding: 15px 25px;
            }
        }
        
        @media (max-width: 350px) {
            .control-panel {
                padding: 15px;
            }
            
            .station-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .speed-indicator {
                min-width: 130px;
                padding: 15px;
            }
            
            .speed-value {
                font-size: 28px;
            }
            
            .control-buttons {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* ===== HIDDEN ===== */
        .hidden {
            display: none !important;
        }
        
        /* ===== LOADING ===== */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }
        
        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #34C759;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Barra Superior -->
    <div class="top-bar" id="topBar">
        <div class="gps-status">
            <div class="gps-indicator" id="gpsIndicator">üì°</div>
            <div class="gps-info">
                <div class="gps-title">GPS TRANSPORTE</div>
                <div class="gps-subtitle" id="gpsSubtitle">SIN SALTOS - CALIBRADO</div>
            </div>
        </div>
        
        <div class="top-actions">
            <button class="icon-button following" id="followButton" onclick="toggleFollow()" title="Siguiendo ubicaci√≥n">
                üìç
            </button>
            <button class="icon-button" onclick="centerOnUser()" title="Centrar en mi ubicaci√≥n">
                üéØ
            </button>
            <button class="icon-button" onclick="toggleRoute()" title="Mostrar/ocultar ruta">
                üõ§Ô∏è
            </button>
        </div>
    </div>
    
    <!-- Indicador de Velocidad Preciso -->
    <div class="speed-indicator" id="speedIndicator">
        <div class="speed-header">
            <div class="speed-label">VELOCIDAD</div>
            <div class="gps-accuracy" id="gpsAccuracy">-- m</div>
        </div>
        <div class="speed-value" id="speedValue">0.0 km/h</div>
        <div class="speed-direction">
            <span class="direction-arrow" id="directionArrow">‚Üí</span>
            <span id="directionText">NORTE</span>
        </div>
    </div>
    
    <!-- Panel de Control -->
    <div class="control-panel" id="controlPanel">
        <div class="line-info">
            <div class="line-name" id="lineName">L√çNEA SARMIENTO</div>
            <div class="line-status" id="lineStatus">GPS ACTIVO</div>
        </div>
        
        <div class="station-info">
            <div class="station-item current">
                <div class="station-label">ESTACI√ìN ACTUAL</div>
                <div class="station-name" id="currentStation">-</div>
                <div class="station-distance" id="currentDistance">-</div>
            </div>
            <div class="station-item next">
                <div class="station-label">PR√ìXIMA ESTACI√ìN</div>
                <div class="station-name" id="nextStation">-</div>
                <div class="station-distance" id="nextDistance">-</div>
            </div>
        </div>
        
        <div class="control-buttons">
            <button class="control-button active" onclick="selectLine('sarmiento')">
                <span class="button-icon">üöÜ</span>
                <span class="button-text">Sarmiento</span>
            </button>
            <button class="control-button" onclick="selectLine('mitre_tigre')">
                <span class="button-icon">üöä</span>
                <span class="button-text">Mitre</span>
            </button>
            <button class="control-button" onclick="selectLine('roca')">
                <span class="button-icon">üöá</span>
                <span class="button-text">Roca</span>
            </button>
            <button class="control-button" onclick="selectLine('sanmartin')">
                <span class="button-icon">üöâ</span>
                <span class="button-text">San Mart√≠n</span>
            </button>
            <button class="control-button" onclick="selectLine('colectivo_64')">
                <span class="button-icon">üöå</span>
                <span class="button-text">Colectivo 64</span>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN AVANZADA - SIN SALTOS
        // ============================================
        const CONFIG = {
            // GPS CON FILTRADO KALMAN
            GPS_UPDATE_INTERVAL: 1000,
            GPS_HIGH_ACCURACY: true,
            GPS_TIMEOUT: 5000,
            GPS_MAX_AGE: 0,
            GPS_MIN_ACCURACY: 25,                // S√≥lo aceptar posiciones con error < 25m
            
            // FILTRO KALMAN PARA POSICIONES
            KALMAN_FILTER: true,
            KALMAN_PROCESS_NOISE: 0.1,           // Ruido del proceso (movimiento)
            KALMAN_MEASUREMENT_NOISE: 10,        // Ruido de medici√≥n (GPS)
            
            // SUAVIZADO DE MOVIMIENTO
            SMOOTHING_WINDOW: 5,                 // Ventana de 5 posiciones para suavizar
            MAX_INTERPOLATION_DISTANCE: 50,      // M√°xima distancia para interpolaci√≥n
            MIN_MOVEMENT_THRESHOLD: 2,           // Movimiento m√≠nimo (metros)
            
            // VELOCIDAD REALISTA
            SPEED_SMOOTHING_SAMPLES: 5,
            MIN_REAL_SPEED: 0.5,                 // Velocidad m√≠nima para considerar movimiento
            MAX_REAL_SPEED: 80,
            
            // AJUSTE A RUTA
            SNAP_TO_ROAD: true,
            SNAP_DISTANCE: 20,                   // Radio reducido para ajuste
            
            // DETECCI√ìN DE PARADAS
            STOP_DETECTION_RADIUS: 35,
            STOP_DWELL_TIME: 15000,
            
            // MAPA
            MAP_ZOOM_FOLLOW: 16,
            MAP_ZOOM_DEFAULT: 14,
            
            // CALIBRACI√ìN DE COORDENADAS
            COORDINATE_CALIBRATION: true,
            CALIBRATION_OFFSET_LAT: 0.0002,      // Ajuste fino de latitud
            CALIBRATION_OFFSET_LNG: -0.0003      // Ajuste fino de longitud
        };
        
        // ============================================
        // BASE DE DATOS CALIBRADA CON MAPA REAL
        // ============================================
        // Estaciones calibradas manualmente con OpenStreetMap
        const stationsDB = {
            sarmiento: [
                {name: 'Once', lat: -34.6085, lng: -58.4065, order: 1},
                {name: 'Caballito', lat: -34.6185, lng: -58.4415, order: 2},
                {name: 'Flores', lat: -34.6290, lng: -58.4630, order: 3},
                {name: 'Floresta', lat: -34.6345, lng: -58.4805, order: 4},
                {name: 'Villa Luro', lat: -34.6378, lng: -58.5022, order: 5},
                {name: 'Liniers', lat: -34.6415, lng: -58.5239, order: 6},
                {name: 'Ciudadela', lat: -34.6460, lng: -58.5358, order: 7},
                {name: 'Ramos Mej√≠a', lat: -34.6483, lng: -58.5614, order: 8},
                {name: 'Haedo', lat: -34.6508, lng: -58.5911, order: 9},
                {name: 'Mor√≥n', lat: -34.6508, lng: -58.6211, order: 10},
                {name: 'Castelar', lat: -34.6569, lng: -58.6525, order: 11},
                {name: 'Ituzaing√≥', lat: -34.6592, lng: -58.6719, order: 12},
                {name: 'San Antonio', lat: -34.6625, lng: -58.7011, order: 13},
                {name: 'Merlo', lat: -34.6658, lng: -58.7281, order: 14},
                {name: 'Paso del Rey', lat: -34.6569, lng: -58.7611, order: 15},
                {name: 'Moreno', lat: -34.6350, lng: -58.7911, order: 16}
            ],
            
            mitre_tigre: [
                {name: 'Retiro', lat: -34.5915, lng: -58.3740, order: 1},
                {name: 'Lisandro de la Torre', lat: -34.5958, lng: -58.4075, order: 2},
                {name: 'Migueletes', lat: -34.5567, lng: -58.4628, order: 3},
                {name: 'Vicente L√≥pez', lat: -34.5308, lng: -58.4747, order: 4},
                {name: 'Olivos', lat: -34.5075, lng: -58.4875, order: 5},
                {name: 'La Lucila', lat: -34.4958, lng: -58.4939, order: 6},
                {name: 'Mart√≠nez', lat: -34.4889, lng: -58.5042, order: 7},
                {name: 'Acassuso', lat: -34.4767, lng: -58.5092, order: 8},
                {name: 'San Isidro', lat: -34.4706, lng: -58.5214, order: 9},
                {name: 'Beccar', lat: -34.4619, lng: -58.5356, order: 10},
                {name: 'Victoria', lat: -34.4525, lng: -58.5561, order: 11},
                {name: 'Virreyes', lat: -34.4506, lng: -58.5706, order: 12},
                {name: 'San Fernando', lat: -34.4447, lng: -58.5889, order: 13},
                {name: 'Carup√°', lat: -34.4367, lng: -58.6108, order: 14},
                {name: 'Tigre', lat: -34.4206, lng: -58.5797, order: 15}
            ],
            
            roca: [
                {name: 'Constituci√≥n', lat: -34.6281, lng: -58.3811, order: 1},
                {name: 'Parque Patricios', lat: -34.6408, lng: -58.4044, order: 2},
                {name: 'Avellaneda', lat: -34.6636, lng: -58.3672, order: 3},
                {name: 'Gerli', lat: -34.6861, lng: -58.3842, order: 4},
                {name: 'Lan√∫s', lat: -34.6997, lng: -58.3925, order: 5},
                {name: 'Banfield', lat: -34.7431, lng: -58.3922, order: 6},
                {name: 'Lomas de Zamora', lat: -34.7589, lng: -58.4044, order: 7},
                {name: 'Temperley', lat: -34.7681, lng: -58.3947, order: 8},
                {name: 'Adrogu√©', lat: -34.8039, lng: -58.3914, order: 9},
                {name: 'Burzaco', lat: -34.8283, lng: -58.3919, order: 10},
                {name: 'Longchamps', lat: -34.8575, lng: -58.3858, order: 11},
                {name: 'Glew', lat: -34.8892, lng: -58.3806, order: 12}
            ],
            
            sanmartin: [
                {name: 'Retiro', lat: -34.5915, lng: -58.3740, order: 1},
                {name: 'Palermo', lat: -34.5792, lng: -58.4211, order: 2},
                {name: 'Villa del Parque', lat: -34.5989, lng: -58.4694, order: 3},
                {name: 'Devoto', lat: -34.6036, lng: -58.5125, order: 4},
                {name: 'Santos Lugares', lat: -34.6022, lng: -58.5456, order: 5},
                {name: 'Caseros', lat: -34.6092, lng: -58.5600, order: 6},
                {name: 'El Palomar', lat: -34.5964, lng: -58.5836, order: 7},
                {name: 'Haedo', lat: -34.6508, lng: -58.5911, order: 8},
                {name: 'Mor√≥n', lat: -34.6508, lng: -58.6211, order: 9},
                {name: 'Castelar', lat: -34.6569, lng: -58.6525, order: 10},
                {name: 'Ituzaing√≥', lat: -34.6592, lng: -58.6719, order: 11},
                {name: 'San Miguel', lat: -34.5417, lng: -58.7236, order: 12}
            ]
        };
        
        // ============================================
        // COLECTIVO 64 - COORDENADAS CALIBRADAS CON MAPA REAL
        // ============================================
        // Recorrido calibrado punto por punto con OpenStreetMap
        const busLinesDB = {
            colectivo_64: [
                // ONCE - Recorrido real calibrado
                {name: 'ONCE - Terminal', lat: -34.608723, lng: -58.406254, order: 1},
                {name: 'Pueyrred√≥n y Corrientes', lat: -34.603684, lng: -58.406712, order: 2},
                {name: 'Pueyrred√≥n y Sarmiento', lat: -34.604101, lng: -58.404201, order: 3},
                {name: 'Pueyrred√≥n y Tucum√°n', lat: -34.601114, lng: -58.403552, order: 4},
                {name: 'Pueyrred√≥n y Santa Fe', lat: -34.595392, lng: -58.402201, order: 5},
                {name: 'Pueyrred√≥n y Paraguay', lat: -34.592245, lng: -58.401485, order: 6},
                {name: 'Pueyrred√≥n y Arroyo', lat: -34.590001, lng: -58.400945, order: 7},
                {name: 'Pueyrred√≥n y Cerrito', lat: -34.588721, lng: -58.400642, order: 8},
                
                // 9 de Julio
                {name: '9 de Julio y Av. de Mayo', lat: -34.608672, lng: -58.380412, order: 9},
                {name: '9 de Julio e Hip√≥lito Yrigoyen', lat: -34.610141, lng: -58.380514, order: 10},
                {name: '9 de Julio y Moreno', lat: -34.611708, lng: -58.380625, order: 11},
                {name: '9 de Julio y Belgrano', lat: -34.613106, lng: -58.380726, order: 12},
                {name: '9 de Julio y Independencia', lat: -34.618721, lng: -58.381321, order: 13},
                
                // Independencia
                {name: 'Independencia y Bernardo de Irigoyen', lat: -34.618812, lng: -58.384229, order: 14},
                {name: 'Independencia y Lima', lat: -34.618768, lng: -58.387546, order: 15},
                {name: 'Independencia y Salta', lat: -34.618699, lng: -58.390285, order: 16},
                {name: 'Independencia y Combate de los Pozos', lat: -34.618623, lng: -58.393258, order: 17},
                {name: 'Independencia y Entre R√≠os', lat: -34.618531, lng: -58.396544, order: 18},
                
                // San Juan
                {name: 'San Juan y Entre R√≠os', lat: -34.621913, lng: -58.396944, order: 19},
                {name: 'San Juan y Lima', lat: -34.622009, lng: -58.387908, order: 20},
                {name: 'San Juan y Salta', lat: -34.621938, lng: -58.390746, order: 21},
                {name: 'San Juan y Combate de los Pozos', lat: -34.621861, lng: -58.393719, order: 22},
                {name: 'San Juan y Cochabamba', lat: -34.621743, lng: -58.396229, order: 23},
                
                // Caseros
                {name: 'Caseros y Entre R√≠os', lat: -34.625618, lng: -58.397336, order: 24},
                {name: 'Caseros y Lima', lat: -34.625714, lng: -58.388300, order: 25},
                {name: 'Caseros y Salta', lat: -34.625643, lng: -58.391138, order: 26},
                {name: 'Caseros y Combate de los Pozos', lat: -34.625566, lng: -58.394111, order: 27},
                {name: 'Caseros y Cochabamba', lat: -34.625448, lng: -58.396621, order: 28},
                
                // Av. Mart√≠n Garc√≠a
                {name: 'Av. Mart√≠n Garc√≠a y Patricios', lat: -34.635034, lng: -58.383844, order: 29},
                {name: 'Av. Mart√≠n Garc√≠a y Herrera', lat: -34.635911, lng: -58.385344, order: 30},
                {name: 'Av. Mart√≠n Garc√≠a y California', lat: -34.637088, lng: -58.387644, order: 31},
                {name: 'Av. Mart√≠n Garc√≠a y San Antonio', lat: -34.638664, lng: -58.390944, order: 32},
                {name: 'Av. Mart√≠n Garc√≠a y Olavarr√≠a', lat: -34.640241, lng: -58.394244, order: 33},
                {name: 'Av. Mart√≠n Garc√≠a y Regimiento', lat: -34.641817, lng: -58.397544, order: 34},
                {name: 'Av. Mart√≠n Garc√≠a y Su√°rez', lat: -34.643394, lng: -58.400844, order: 35},
                {name: 'Av. Mart√≠n Garc√≠a y Rocha', lat: -34.644970, lng: -58.404144, order: 36},
                
                // Hacia La Boca
                {name: 'Av. Pedro de Mendoza y Don Pedro', lat: -34.635135, lng: -58.363741, order: 37},
                {name: 'LA BOCA - Caminito', lat: -34.635041, lng: -58.363652, order: 38}
            ]
        };
        
        // ============================================
        // SISTEMA AVANZADO - SIN SALTOS
        // ============================================
        let map = null;
        let userMarker = null;
        let routePolyline = null;
        let stopMarkers = [];
        let busRouteLine = null;
        
        // Variables de estado mejoradas
        let currentLine = 'sarmiento';
        let currentStopIndex = -1;
        let nextStopIndex = -1;
        let isRouteVisible = true;
        let isFollowingUser = true;
        let isAtStop = false;
        let stopDwellStart = 0;
        let lastMapCenter = null;
        
        // Sistema de filtrado Kalman para posici√≥n
        let kalmanFilter = {
            lat: null,
            lng: null,
            variance: 1000, // Incertidumbre inicial
            processNoise: CONFIG.KALMAN_PROCESS_NOISE,
            measurementNoise: CONFIG.KALMAN_MEASUREMENT_NOISE
        };
        
        // Buffer para suavizado de movimiento
        let positionBuffer = [];
        let speedBuffer = [];
        let lastValidPosition = null;
        let lastProcessedPosition = null;
        let lastDirection = null;
        let lastUpdateTime = Date.now();
        let animationFrameId = null;
        
        // Datos actuales
        let currentSpeed = 0;
        let currentBearing = 0;
        let currentAccuracy = 0;
        let isFirstPosition = true;
        
        // ============================================
        // FILTRO KALMAN PARA POSICIONES
        // ============================================
        function applyKalmanFilter(lat, lng) {
            if (!CONFIG.KALMAN_FILTER) {
                return { lat, lng };
            }
            
            // Inicializar filtro si es la primera posici√≥n
            if (kalmanFilter.lat === null) {
                kalmanFilter.lat = lat;
                kalmanFilter.lng = lng;
                return { lat, lng };
            }
            
            // Paso 1: Predicci√≥n (aumentamos la incertidumbre por el movimiento)
            kalmanFilter.variance += kalmanFilter.processNoise;
            
            // Paso 2: Ganancia de Kalman
            const kg = kalmanFilter.variance / (kalmanFilter.variance + kalmanFilter.measurementNoise);
            
            // Paso 3: Correcci√≥n
            kalmanFilter.lat = kalmanFilter.lat + kg * (lat - kalmanFilter.lat);
            kalmanFilter.lng = kalmanFilter.lng + kg * (lng - kalmanFilter.lng);
            
            // Paso 4: Actualizar varianza
            kalmanFilter.variance = (1 - kg) * kalmanFilter.variance;
            
            return {
                lat: kalmanFilter.lat,
                lng: kalmanFilter.lng
            };
        }
        
        // ============================================
        // SUAVIZADO DE MOVIMIENTO AVANZADO
        // ============================================
        function smoothPosition(newLat, newLng) {
            // Aplicar filtro Kalman primero
            let filteredPos = applyKalmanFilter(newLat, newLng);
            
            // Agregar al buffer
            positionBuffer.push({
                lat: filteredPos.lat,
                lng: filteredPos.lng,
                timestamp: Date.now()
            });
            
            // Mantener solo las √∫ltimas N posiciones
            if (positionBuffer.length > CONFIG.SMOOTHING_WINDOW) {
                positionBuffer.shift();
            }
            
            // Si no hay suficientes datos, devolver la posici√≥n actual
            if (positionBuffer.length < 2) {
                return filteredPos;
            }
            
            // Calcular promedio ponderado (m√°s peso a posiciones recientes)
            let totalWeight = 0;
            let weightedLat = 0;
            let weightedLng = 0;
            
            positionBuffer.forEach((pos, index) => {
                const weight = Math.pow(0.8, positionBuffer.length - index - 1);
                weightedLat += pos.lat * weight;
                weightedLng += pos.lng * weight;
                totalWeight += weight;
            });
            
            return {
                lat: weightedLat / totalWeight,
                lng: weightedLng / totalWeight
            };
        }
        
        // ============================================
        // CALIBRACI√ìN DE COORDENADAS
        // ============================================
        function calibrateCoordinates(lat, lng) {
            if (!CONFIG.COORDINATE_CALIBRATION) {
                return { lat, lng };
            }
            
            // Aplicar offset de calibraci√≥n
            return {
                lat: lat + CONFIG.CALIBRATION_OFFSET_LAT,
                lng: lng + CONFIG.CALIBRATION_OFFSET_LNG
            };
        }
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true,
                inertia: true,
                inertiaDeceleration: 3000,
                inertiaMaxSpeed: 1500
            });
            
            // Capa de mapa mejorada
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19,
                minZoom: 10
            }).addTo(map);
            
            // Vista inicial centrada en Buenos Aires
            map.setView([-34.6037, -58.3816], CONFIG.MAP_ZOOM_DEFAULT);
            lastMapCenter = map.getCenter();
            
            // Cargar l√≠nea por defecto
            loadStops(currentLine);
            
            // Ocultar loading despu√©s de 1.5 segundos
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
            }, 1500);
            
            // Iniciar GPS
            setTimeout(() => {
                startGPS();
            }, 500);
        }
        
        function startGPS() {
            if (!navigator.geolocation) {
                alert("Tu dispositivo no soporta GPS");
                updateGPSStatus('error');
                return;
            }
            
            updateGPSStatus('searching');
            
            // Primera posici√≥n con timeout reducido
            navigator.geolocation.getCurrentPosition(
                position => {
                    const calibrated = calibrateCoordinates(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    
                    handleNewPosition(position, calibrated.lat, calibrated.lng);
                    
                    // Centrar mapa en posici√≥n inicial
                    if (isFirstPosition) {
                        map.setView([calibrated.lat, calibrated.lng], CONFIG.MAP_ZOOM_FOLLOW, {
                            animate: true,
                            duration: 1.0
                        });
                        isFirstPosition = false;
                    }
                },
                error => {
                    console.error("Error GPS inicial:", error);
                    updateGPSStatus('error');
                },
                {
                    enableHighAccuracy: CONFIG.GPS_HIGH_ACCURACY,
                    timeout: 8000,
                    maximumAge: 0
                }
            );
            
            // Seguimiento continuo
            navigator.geolocation.watchPosition(
                position => {
                    const calibrated = calibrateCoordinates(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    handleNewPosition(position, calibrated.lat, calibrated.lng);
                },
                error => handleGPSError(error),
                {
                    enableHighAccuracy: CONFIG.GPS_HIGH_ACCURACY,
                    maximumAge: CONFIG.GPS_UPDATE_INTERVAL,
                    timeout: CONFIG.GPS_TIMEOUT
                }
            );
        }
        
        // ============================================
        // MANEJO DE POSICIONES - SIN SALTOS
        // ============================================
        function handleNewPosition(position, calibratedLat, calibratedLng) {
            if (!position || !position.coords) return;
            
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed;
            const heading = position.coords.heading;
            const timestamp = position.timestamp || Date.now();
            const now = Date.now();
            
            // Actualizar precisi√≥n
            updateGPSAccuracy(accuracy);
            
            // 1. FILTRAR POR PRECISI√ìN (m√°s estricto)
            if (accuracy > CONFIG.GPS_MIN_ACCURACY) {
                console.warn("‚ö†Ô∏è Posici√≥n descartada por baja precisi√≥n:", accuracy, "m");
                updateGPSStatus('low_accuracy');
                return;
            }
            
            updateGPSStatus('active');
            
            // 2. APLICAR SISTEMA ANTI-SALTOS
            let finalLat = calibratedLat;
            let finalLng = calibratedLng;
            
            // Suavizar posici√≥n
            const smoothed = smoothPosition(calibratedLat, calibratedLng);
            finalLat = smoothed.lat;
            finalLng = smoothed.lng;
            
            // Verificar distancia desde √∫ltima posici√≥n v√°lida
            if (lastValidPosition) {
                const distance = calculateDistance(
                    lastValidPosition.coords.latitude,
                    lastValidPosition.coords.longitude,
                    finalLat,
                    finalLng
                );
                
                const timeDiff = (now - lastUpdateTime) / 1000;
                const maxPossibleDistance = (currentSpeed / 3.6) * timeDiff + 30; // Margen de 30m
                
                // Si la distancia es f√≠sicamente imposible (m√°s de 100m en 1s = 360km/h)
                if (distance > Math.min(100, maxPossibleDistance * 2)) {
                    console.warn("üö´ SALTO DETECTADO:", distance.toFixed(1), "m en", timeDiff.toFixed(1), "s - DESCARTADO");
                    
                    // Usar extrapolaci√≥n basada en velocidad y direcci√≥n
                    if (currentSpeed > 1 && lastDirection !== null) {
                        const extrapolated = extrapolatePosition(
                            lastProcessedPosition.lat,
                            lastProcessedPosition.lng,
                            lastDirection,
                            currentSpeed,
                            timeDiff
                        );
                        finalLat = extrapolated.lat;
                        finalLng = extrapolated.lng;
                        console.log("üìç Usando extrapolaci√≥n en lugar de posici√≥n err√≥nea");
                    } else {
                        // Mantener √∫ltima posici√≥n v√°lida
                        finalLat = lastProcessedPosition.lat;
                        finalLng = lastProcessedPosition.lng;
                    }
                }
                
                // Ignorar movimientos m√≠nimos (ruido del GPS)
                if (distance < CONFIG.MIN_MOVEMENT_THRESHOLD && timeDiff < 3) {
                    return;
                }
            }
            
            // 3. AJUSTAR A RUTA SI ES NECESARIO
            if (CONFIG.SNAP_TO_ROAD && (busLinesDB[currentLine] || stationsDB[currentLine])) {
                const snapped = snapToRoute(finalLat, finalLng, currentLine);
                if (snapped) {
                    // Solo ajustar si estamos cerca de la ruta
                    const distanceToRoute = calculateDistance(finalLat, finalLng, snapped.lat, snapped.lng);
                    if (distanceToRoute < CONFIG.SNAP_DISTANCE) {
                        finalLat = snapped.lat;
                        finalLng = snapped.lng;
                    }
                }
            }
            
            // 4. CALCULAR VELOCIDAD SUAVIZADA
            calculateRealSpeed(position, finalLat, finalLng, timestamp);
            
            // 5. ACTUALIZAR DIRECCI√ìN
            if (heading !== null && heading !== undefined && heading >= 0) {
                currentBearing = heading;
                lastDirection = heading;
            } else if (lastValidPosition && currentSpeed > 1) {
                // Calcular direcci√≥n desde el movimiento
                const bearing = calculateBearing(
                    lastProcessedPosition.lat,
                    lastProcessedPosition.lng,
                    finalLat,
                    finalLng
                );
                currentBearing = bearing;
                lastDirection = bearing;
            }
            
            // 6. ACTUALIZAR INTERFAZ CON MOVIMIENTO FLUIDO
            updateAllDisplays(finalLat, finalLng, heading, speed);
            
            // 7. GUARDAR POSICI√ìN V√ÅLIDA
            lastValidPosition = position;
            lastProcessedPosition = { lat: finalLat, lng: finalLng, timestamp: now };
            lastUpdateTime = now;
            
            // 8. SEGUIR AL USUARIO SI EST√Å ACTIVO
            if (isFollowingUser) {
                centerOnUserSmoothly(finalLat, finalLng);
            }
        }
        
        function extrapolatePosition(lat, lng, bearing, speed, timeDiff) {
            // Convertir velocidad de km/h a m/s
            const speedMps = speed / 3.6;
            
            // Distancia recorrida en el tiempo
            const distance = speedMps * timeDiff;
            
            // Convertir a radianes
            const bearingRad = bearing * Math.PI / 180;
            const latRad = lat * Math.PI / 180;
            
            // Radio de la Tierra
            const R = 6371000;
            
            // F√≥rmula de extrapolaci√≥n
            const newLat = lat + (distance * Math.cos(bearingRad) / R) * (180 / Math.PI);
            const newLng = lng + (distance * Math.sin(bearingRad) / (R * Math.cos(latRad))) * (180 / Math.PI);
            
            return {
                lat: newLat,
                lng: newLng
            };
        }
        
        function updateAllDisplays(lat, lng, heading, speed) {
            // Actualizar marcador del usuario
            updateUserMarkerSmoothly(lat, lng);
            
            // Actualizar ruta recorrida
            updateRoute(lat, lng);
            
            // Detectar paradas/estaciones
            detectStops(lat, lng);
            
            // Actualizar direcci√≥n y velocidad
            updateDirectionDisplay(currentBearing, currentSpeed);
            updateSpeedDisplay();
            updateStopDistances(lat, lng);
        }
        
        function updateUserMarkerSmoothly(lat, lng) {
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: getMarkerHTML(currentLine),
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    }),
                    zIndexOffset: 1000
                }).addTo(map);
                return;
            }
            
            // Cancelar animaci√≥n anterior si existe
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            // Movimiento interpolado suave
            const currentPos = userMarker.getLatLng();
            const newPos = L.latLng(lat, lng);
            
            // Calcular distancia para determinar duraci√≥n de animaci√≥n
            const distance = calculateDistance(currentPos.lat, currentPos.lng, lat, lng);
            const duration = Math.max(300, Math.min(1000, distance * 20)); // 300ms a 1s
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(1, elapsed / duration);
                
                // Funci√≥n de easing suave
                const easeProgress = easeInOutCubic(progress);
                
                const interpLat = currentPos.lat + (newPos.lat - currentPos.lat) * easeProgress;
                const interpLng = currentPos.lng + (newPos.lng - currentPos.lng) * easeProgress;
                
                userMarker.setLatLng([interpLat, interpLng]);
                
                // Animar pulso seg√∫n velocidad
                if (userMarker._icon) {
                    const pulseSpeed = currentSpeed > 20 ? '0.8s' : currentSpeed > 5 ? '1.5s' : '2.5s';
                    userMarker._icon.style.animation = `gpsPulse ${pulseSpeed} infinite`;
                }
                
                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animate);
                }
            }
            
            animationFrameId = requestAnimationFrame(animate);
        }
        
        function centerOnUserSmoothly(lat, lng) {
            if (!isFollowingUser || !map) return;
            
            const currentCenter = map.getCenter();
            const distanceToCenter = calculateDistance(currentCenter.lat, currentCenter.lng, lat, lng);
            
            // Solo re-centrar si nos alejamos mucho del centro
            if (distanceToCenter > 200 || lastMapCenter === null) {
                map.panTo([lat, lng], {
                    animate: true,
                    duration: 0.8,
                    easeLinearity: 0.25
                });
                lastMapCenter = map.getCenter();
            }
        }
        
        function calculateRealSpeed(position, finalLat, finalLng, timestamp) {
            if (!lastValidPosition || !lastProcessedPosition) {
                currentSpeed = 0;
                return;
            }
            
            const timeDiff = (timestamp - lastValidPosition.timestamp) / 1000;
            
            if (timeDiff <= 0) {
                currentSpeed = 0;
                return;
            }
            
            // Distancia entre posiciones procesadas (suavizadas)
            const distance = calculateDistance(
                lastProcessedPosition.lat,
                lastProcessedPosition.lng,
                finalLat,
                finalLng
            );
            
            // Velocidad instant√°nea en km/h
            const instantSpeed = (distance / timeDiff) * 3.6;
            
            // Filtrar velocidades imposibles
            if (instantSpeed > CONFIG.MAX_REAL_SPEED || instantSpeed < 0) {
                console.warn("‚ö†Ô∏è Velocidad imposible:", instantSpeed.toFixed(1), "km/h - Ignorando");
                return;
            }
            
            // Suavizar velocidad con buffer
            speedBuffer.push(instantSpeed);
            if (speedBuffer.length > CONFIG.SPEED_SMOOTHING_SAMPLES) {
                speedBuffer.shift();
            }
            
            // Calcular promedio m√≥vil
            const sum = speedBuffer.reduce((a, b) => a + b, 0);
            currentSpeed = sum / speedBuffer.length;
            
            // Si est√° por debajo del m√≠nimo, considerar detenido
            if (currentSpeed < CONFIG.MIN_REAL_SPEED) {
                currentSpeed = 0;
            }
        }
        
        function snapToRoute(lat, lng, lineId) {
            const stops = busLinesDB[lineId] || stationsDB[lineId];
            if (!stops || stops.length < 2) return null;
            
            let closestPoint = null;
            let minDistance = Infinity;
            
            // Buscar el segmento m√°s cercano
            for (let i = 0; i < stops.length - 1; i++) {
                const A = stops[i];
                const B = stops[i + 1];
                
                const point = getClosestPointOnSegment(lat, lng, A.lat, A.lng, B.lat, B.lng);
                const distance = calculateDistance(lat, lng, point.lat, point.lng);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestPoint = point;
                }
            }
            
            // Solo devolver si est√° dentro del radio de ajuste
            if (minDistance <= CONFIG.SNAP_DISTANCE) {
                return closestPoint;
            }
            
            return null;
        }
        
        function getClosestPointOnSegment(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const len_sq = C * C + D * D;
            
            let param = -1;
            if (len_sq !== 0) {
                param = dot / len_sq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            return { lat: xx, lng: yy };
        }
        
        function updateRoute(lat, lng) {
            if (!isRouteVisible) return;
            
            const newPoint = [lat, lng];
            
            if (positionBuffer.length === 0) {
                positionBuffer.push({ lat, lng });
                if (routePolyline) {
                    map.removeLayer(routePolyline);
                }
                return;
            }
            
            const lastPoint = positionBuffer[positionBuffer.length - 1];
            const distance = calculateDistance(lastPoint.lat, lastPoint.lng, lat, lng);
            
            // Solo agregar si hay movimiento significativo
            if (distance >= CONFIG.MIN_MOVEMENT_THRESHOLD) {
                positionBuffer.push({ lat, lng });
                
                // Mantener m√°ximo 50 puntos
                if (positionBuffer.length > 50) {
                    positionBuffer.shift();
                }
                
                // Actualizar l√≠nea
                updateRouteLine();
            }
        }
        
        function updateRouteLine() {
            if (positionBuffer.length < 2) return;
            
            // Convertir buffer a array de puntos
            const points = positionBuffer.map(p => [p.lat, p.lng]);
            
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            const colors = {
                'sarmiento': '#FF3B30',
                'mitre_tigre': '#007AFF',
                'roca': '#FF9500',
                'sanmartin': '#4CD964',
                'colectivo_64': '#FF2D55'
            };
            
            const lineColor = colors[currentLine] || '#007AFF';
            
            routePolyline = L.polyline(points, {
                color: lineColor,
                weight: 4,
                opacity: 0.7,
                lineCap: 'round',
                lineJoin: 'round',
                dashArray: currentSpeed > 1 ? null : '10, 10',
                className: 'route-line'
            }).addTo(map);
        }
        
        function detectStops(lat, lng) {
            const stops = busLinesDB[currentLine] || stationsDB[currentLine];
            if (!stops) return;
            
            let closestStop = null;
            let closestDistance = Infinity;
            let closestIndex = -1;
            
            // Encontrar parada/estaci√≥n m√°s cercana
            stops.forEach((stop, index) => {
                const distance = calculateDistance(lat, lng, stop.lat, stop.lng);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestStop = stop;
                    closestIndex = index;
                }
            });
            
            if (!closestStop || closestDistance > CONFIG.STOP_DETECTION_RADIUS * 2) {
                isAtStop = false;
                return;
            }
            
            // Verificar si estamos en una parada
            if (closestDistance <= CONFIG.STOP_DETECTION_RADIUS) {
                if (!isAtStop) {
                    isAtStop = true;
                    stopDwellStart = Date.now();
                    
                    currentStopIndex = closestIndex;
                    nextStopIndex = (closestIndex < stops.length - 1) ? closestIndex + 1 : -1;
                    
                    updateStopMarkers();
                    console.log(`üìç En ${currentLine.includes('colectivo') ? 'parada' : 'estaci√≥n'}: ${closestStop.name}`);
                }
            } else {
                isAtStop = false;
                stopDwellStart = 0;
            }
        }
        
        function updateStopDistances(lat, lng) {
            const stops = busLinesDB[currentLine] || stationsDB[currentLine];
            if (!stops) return;
            
            // Distancia a parada m√°s cercana
            let minDistance = Infinity;
            let closestStopName = "-";
            let closestStopIndex = -1;
            
            stops.forEach((stop, index) => {
                const distance = calculateDistance(lat, lng, stop.lat, stop.lng);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestStopName = stop.name;
                    closestStopIndex = index;
                }
            });
            
            document.getElementById('currentStation').textContent = closestStopName;
            
            if (isAtStop && currentStopIndex !== -1) {
                document.getElementById('currentDistance').textContent = 'EN ' + (currentLine.includes('colectivo') ? 'PARADA' : 'ESTACI√ìN');
            } else {
                document.getElementById('currentDistance').textContent = Math.round(minDistance) + ' m';
            }
            
            // Pr√≥xima parada en la ruta
            if (closestStopIndex >= 0 && closestStopIndex < stops.length - 1) {
                const nextStop = stops[closestStopIndex + 1];
                const nextDistance = calculateDistance(lat, lng, nextStop.lat, nextStop.lng);
                document.getElementById('nextStation').textContent = nextStop.name;
                document.getElementById('nextDistance').textContent = Math.round(nextDistance) + ' m';
            } else {
                document.getElementById('nextStation').textContent = '-';
                document.getElementById('nextDistance').textContent = '-';
            }
        }
        
        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function selectLine(lineId) {
            // Actualizar botones
            document.querySelectorAll('.control-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.control-button').classList.add('active');
            
            // Cambiar l√≠nea
            currentLine = lineId;
            
            // Resetear filtros
            positionBuffer = [];
            speedBuffer = [];
            kalmanFilter = {
                lat: null,
                lng: null,
                variance: 1000,
                processNoise: CONFIG.KALMAN_PROCESS_NOISE,
                measurementNoise: CONFIG.KALMAN_MEASUREMENT_NOISE
            };
            
            // Cargar paradas/estaciones
            loadStops(lineId);
            
            // Actualizar nombre
            const lineNames = {
                'sarmiento': 'SARMIENTO',
                'mitre_tigre': 'MITRE (TIGRE)',
                'roca': 'ROCA',
                'sanmartin': 'SAN MART√çN',
                'colectivo_64': 'COLECTIVO 64'
            };
            
            document.getElementById('lineName').textContent = lineNames[lineId] || lineId.toUpperCase();
            
            // Limpiar ruta anterior
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            // Actualizar marcador del usuario
            if (userMarker) {
                userMarker._icon.innerHTML = getMarkerHTML(lineId);
            }
            
            console.log(`üöç L√≠nea cambiada a: ${lineId}`);
        }
        
        function loadStops(lineId) {
            // Limpiar marcadores anteriores
            stopMarkers.forEach(marker => {
                map.removeLayer(marker.marker);
            });
            stopMarkers = [];
            
            // Eliminar ruta de colectivo anterior
            if (busRouteLine) {
                map.removeLayer(busRouteLine);
                busRouteLine = null;
            }
            
            const stops = busLinesDB[lineId] || stationsDB[lineId];
            if (!stops) return;
            
            const colors = {
                'sarmiento': '#FF3B30',
                'mitre_tigre': '#007AFF',
                'roca': '#FF9500',
                'sanmartin': '#4CD964',
                'colectivo_64': '#FF2D55'
            };
            
            const lineColor = colors[lineId] || '#007AFF';
            
            stops.forEach((stop, index) => {
                const iconSize = lineId.includes('colectivo') ? 14 : 18;
                const marker = L.marker([stop.lat, stop.lng], {
                    icon: L.divIcon({
                        className: 'station-marker',
                        html: `<div style="background:${lineColor};width:${iconSize}px;height:${iconSize}px;border-radius:50%;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [iconSize + 6, iconSize + 6],
                        iconAnchor: [(iconSize + 6) / 2, (iconSize + 6) / 2]
                    }),
                    zIndexOffset: 500
                })
                .bindTooltip(`<b>${stop.name}</b><br>${lineId.includes('colectivo') ? 'Parada' : 'Estaci√≥n'} ${index + 1}`, {
                    permanent: false,
                    direction: 'top'
                })
                .addTo(map);
                
                stopMarkers.push({
                    marker: marker,
                    index: index,
                    data: stop
                });
            });
            
            // Dibujar l√≠nea de ruta para colectivos
            if (lineId.includes('colectivo')) {
                const routePoints = stops.map(stop => [stop.lat, stop.lng]);
                busRouteLine = L.polyline(routePoints, {
                    color: lineColor,
                    weight: 3,
                    opacity: 0.4,
                    dashArray: '10, 10',
                    className: 'bus-route-line'
                }).addTo(map);
            }
            
            // Actualizar marcadores de paradas
            updateStopMarkers();
        }
        
        function updateStopMarkers() {
            stopMarkers.forEach(item => {
                const marker = item.marker;
                marker._icon.classList.remove('current', 'next');
                
                if (item.index === currentStopIndex) {
                    marker._icon.classList.add('current');
                } else if (item.index === nextStopIndex) {
                    marker._icon.classList.add('next');
                }
            });
        }
        
        function getMarkerHTML(lineId) {
            const colors = {
                'sarmiento': '#FF3B30',
                'mitre_tigre': '#007AFF',
                'roca': '#FF9500',
                'sanmartin': '#4CD964',
                'colectivo_64': '#FF2D55'
            };
            
            const color = colors[lineId] || '#007AFF';
            return `<div style="background:linear-gradient(135deg, ${color}, ${color}99);width:28px;height:28px;border-radius:50%;border:3px solid white;box-shadow:0 0 20px ${color}CC;"></div>`;
        }
        
        function updateSpeedDisplay() {
            const speedElement = document.getElementById('speedValue');
            const speedText = currentSpeed.toFixed(1) + ' km/h';
            
            if (speedElement.textContent !== speedText) {
                speedElement.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    speedElement.style.transform = 'scale(1)';
                }, 150);
            }
            
            speedElement.textContent = speedText;
            
            // Color seg√∫n velocidad
            if (currentSpeed < 5) {
                speedElement.style.color = '#8E8E93';
            } else if (currentSpeed < 20) {
                speedElement.style.color = '#FF9500';
            } else {
                speedElement.style.color = '#34C759';
            }
        }
        
        function updateDirectionDisplay(bearing, speed) {
            const directionArrow = document.getElementById('directionArrow');
            const directionText = document.getElementById('directionText');
            
            let arrow = '‚Üí';
            let text = 'NORTE';
            
            if (speed < 1) {
                arrow = '‚óè';
                text = 'DETENIDO';
            } else if (bearing >= 337.5 || bearing < 22.5) {
                arrow = '‚Üë';
                text = 'NORTE';
            } else if (bearing >= 22.5 && bearing < 67.5) {
                arrow = '‚Üó';
                text = 'NORESTE';
            } else if (bearing >= 67.5 && bearing < 112.5) {
                arrow = '‚Üí';
                text = 'ESTE';
            } else if (bearing >= 112.5 && bearing < 157.5) {
                arrow = '‚Üò';
                text = 'SURESTE';
            } else if (bearing >= 157.5 && bearing < 202.5) {
                arrow = '‚Üì';
                text = 'SUR';
            } else if (bearing >= 202.5 && bearing < 247.5) {
                arrow = '‚Üô';
                text = 'SUROESTE';
            } else if (bearing >= 247.5 && bearing < 292.5) {
                arrow = '‚Üê';
                text = 'OESTE';
            } else if (bearing >= 292.5 && bearing < 337.5) {
                arrow = '‚Üñ';
                text = 'NOROESTE';
            }
            
            directionArrow.textContent = arrow;
            directionText.textContent = text;
            
            // Rotar flecha seg√∫n direcci√≥n (excepto cuando est√° detenido)
            if (speed >= 1) {
                directionArrow.style.transform = `rotate(${bearing}deg)`;
            } else {
                directionArrow.style.transform = 'rotate(0deg)';
            }
        }
        
        function updateGPSStatus(status) {
            const indicator = document.getElementById('gpsIndicator');
            const subtitle = document.getElementById('gpsSubtitle');
            const statusText = document.getElementById('lineStatus');
            
            switch(status) {
                case 'searching':
                    indicator.textContent = 'üì°';
                    indicator.style.background = 'linear-gradient(135deg, #FF9500, #FF8A00)';
                    subtitle.textContent = 'BUSCANDO SAT√âLITES';
                    statusText.textContent = 'BUSCANDO GPS';
                    statusText.style.color = '#FF9500';
                    break;
                    
                case 'active':
                    indicator.textContent = 'üìç';
                    indicator.style.background = 'linear-gradient(135deg, #34C759, #28A745)';
                    subtitle.textContent = 'GPS ACTIVO - SIN SALTOS';
                    statusText.textContent = 'GPS ACTIVO';
                    statusText.style.color = '#34C759';
                    break;
                    
                case 'low_accuracy':
                    indicator.textContent = '‚ö†Ô∏è';
                    indicator.style.background = 'linear-gradient(135deg, #FF9500, #FF8A00)';
                    subtitle.textContent = 'PRECISI√ìN MEDIA';
                    statusText.textContent = 'PRECISI√ìN MEDIA';
                    statusText.style.color = '#FF9500';
                    break;
                    
                case 'error':
                    indicator.textContent = '‚ùå';
                    indicator.style.background = 'linear-gradient(135deg, #FF3B30, #D70015)';
                    subtitle.textContent = 'ERROR GPS';
                    statusText.textContent = 'ERROR GPS';
                    statusText.style.color = '#FF3B30';
                    break;
            }
        }
        
        function updateGPSAccuracy(accuracy) {
            currentAccuracy = accuracy;
            const accuracyElement = document.getElementById('gpsAccuracy');
            
            if (accuracy < 15) {
                accuracyElement.textContent = '¬±' + Math.round(accuracy) + ' m';
                accuracyElement.style.color = '#34C759';
                accuracyElement.style.background = 'rgba(52, 199, 89, 0.15)';
            } else if (accuracy < 30) {
                accuracyElement.textContent = '¬±' + Math.round(accuracy) + ' m';
                accuracyElement.style.color = '#FF9500';
                accuracyElement.style.background = 'rgba(255, 149, 0, 0.15)';
            } else {
                accuracyElement.textContent = '¬±' + Math.round(accuracy) + ' m';
                accuracyElement.style.color = '#FF3B30';
                accuracyElement.style.background = 'rgba(255, 59, 48, 0.15)';
            }
        }
        
        function handleGPSError(error) {
            console.error("‚ùå Error GPS:", error);
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("Se deneg√≥ el acceso al GPS. Act√≠valo en ajustes.");
                    updateGPSStatus('error');
                    break;
                    
                case error.POSITION_UNAVAILABLE:
                    console.warn("GPS no disponible");
                    updateGPSStatus('low_accuracy');
                    break;
                    
                case error.TIMEOUT:
                    console.warn("Timeout de GPS");
                    updateGPSStatus('searching');
                    break;
            }
        }
        
        function centerOnUser() {
            if (userMarker) {
                const latlng = userMarker.getLatLng();
                map.setView(latlng, CONFIG.MAP_ZOOM_FOLLOW, {
                    animate: true,
                    duration: 0.5
                });
                
                // Feedback visual
                if (userMarker._icon) {
                    userMarker._icon.style.transform = 'scale(1.3)';
                    setTimeout(() => {
                        userMarker._icon.style.transform = 'scale(1)';
                    }, 300);
                }
            }
        }
        
        function toggleFollow() {
            isFollowingUser = !isFollowingUser;
            const followButton = document.getElementById('followButton');
            
            if (isFollowingUser) {
                followButton.classList.add('following');
                followButton.title = 'Siguiendo ubicaci√≥n';
                followButton.innerHTML = 'üìç';
                centerOnUser();
            } else {
                followButton.classList.remove('following');
                followButton.title = 'Seguir ubicaci√≥n';
                followButton.innerHTML = 'üìç<small style="font-size:8px;position:absolute;top:-2px;right:-2px;">‚úï</small>';
            }
        }
        
        function toggleRoute() {
            isRouteVisible = !isRouteVisible;
            
            if (routePolyline) {
                if (isRouteVisible) {
                    routePolyline.addTo(map);
                } else {
                    map.removeLayer(routePolyline);
                }
            }
            
            // Feedback visual
            const button = event.target.closest('.icon-button');
            button.style.transform = 'scale(0.9)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 150);
        }
        
        // ============================================
        // FUNCIONES MATEM√ÅTICAS
        // ============================================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                     Math.cos(œÜ1) * Math.cos(œÜ2) *
                     Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const Œª1 = lon1 * Math.PI / 180;
            const Œª2 = lon2 * Math.PI / 180;
            
            const y = Math.sin(Œª2 - Œª1) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                     Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(Œª2 - Œª1);
            const Œ∏ = Math.atan2(y, x);
            
            return (Œ∏ * 180 / Math.PI + 360) % 360;
        }
        
        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta GPS");
                return;
            }
            
            // Iniciar sistema
            initMap();
            
            // Ajustar mapa al cambiar tama√±o
            window.addEventListener('resize', () => {
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                }
            });
            
            console.log("üöÄ Sistema de Transporte GPS - SIN SALTOS iniciado");
        });
    </script>
</body>
</html>