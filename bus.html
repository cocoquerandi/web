<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Transporte Inteligente</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: #0f1419;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* Panel izquierdo */
        .sidebar {
            width: 380px;
            background: #1a1f2e;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #2a3142;
            overflow-y: auto;
        }
        
        .section {
            padding: 20px;
            border-bottom: 1px solid #2a3142;
        }
        
        .section-title {
            color: #4dabf7;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 20px;
        }
        
        /* Mapa */
        .map-area {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Controles del mapa */
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            background: #2a3142;
            border: 1px solid #3a4255;
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #4dabf7;
            transform: translateY(-2px);
        }
        
        /* Información de ubicación */
        .location-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .info-item {
            background: #2a3142;
            padding: 12px;
            border-radius: 8px;
        }
        
        .info-label {
            font-size: 12px;
            color: #8a9ba8;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        
        .speed-display {
            font-size: 32px;
            font-weight: 700;
            color: #4dabf7;
            text-align: center;
            margin: 10px 0;
        }
        
        .speed-unit {
            font-size: 14px;
            color: #8a9ba8;
        }
        
        /* Selección de transporte */
        .transport-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .transport-btn {
            flex: 1;
            min-width: 70px;
            padding: 12px;
            background: #2a3142;
            border: 2px solid transparent;
            border-radius: 8px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .transport-btn:hover {
            background: #3a4255;
        }
        
        .transport-btn.active {
            border-color: #4dabf7;
            background: rgba(77, 171, 247, 0.1);
        }
        
        .transport-btn i {
            font-size: 24px;
        }
        
        .transport-btn.train { color: #ff6b6b; }
        .transport-btn.bus { color: #51cf66; }
        .transport-btn.subway { color: #cc5de8; }
        .transport-btn.tram { color: #ffa94d; }
        .transport-btn.walking { color: #a9e34b; }
        .transport-btn.bike { color: #22b8cf; }
        .transport-btn.car { color: #748ffc; }
        
        /* Sugerencias */
        .suggestion-card {
            background: linear-gradient(135deg, rgba(77, 171, 247, 0.1), rgba(77, 171, 247, 0.05));
            border: 1px solid rgba(77, 171, 247, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .suggestion-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #4dabf7;
        }
        
        .suggestion-text {
            color: #c1d1e0;
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* Líneas disponibles */
        .lines-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .line-card {
            background: #2a3142;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #4dabf7;
        }
        
        .line-card:hover {
            background: #3a4255;
            transform: translateX(5px);
        }
        
        .line-card.selected {
            background: rgba(77, 171, 247, 0.15);
            border-left-color: #4dabf7;
        }
        
        .line-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: white;
        }
        
        .line-details {
            font-size: 13px;
            color: #8a9ba8;
            display: flex;
            justify-content: space-between;
        }
        
        /* Compañeros de viaje */
        .companions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .companion-card {
            background: #2a3142;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .companion-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4dabf7, #228be6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }
        
        .companion-info {
            flex: 1;
        }
        
        .companion-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .companion-status {
            font-size: 12px;
            color: #8a9ba8;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .companion-status.online {
            color: #51cf66;
        }
        
        /* Estadísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-card {
            background: #2a3142;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #4dabf7;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8a9ba8;
        }
        
        /* Tendencias */
        .trend-badge {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(77, 171, 247, 0.2);
            color: #4dabf7;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .trend-up {
            background: rgba(81, 207, 102, 0.2);
            color: #51cf66;
        }
        
        .trend-down {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        /* Permisos */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: #1a1f2e;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            border: 1px solid #4dabf7;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        .modal-icon {
            font-size: 64px;
            color: #4dabf7;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 28px;
            margin-bottom: 15px;
            color: white;
        }
        
        .modal-text {
            color: #c1d1e0;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .permission-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .permission-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .permission-btn.allow {
            background: #4dabf7;
            color: white;
        }
        
        .permission-btn.allow:hover {
            background: #228be6;
            transform: translateY(-2px);
        }
        
        .permission-btn.deny {
            background: #2a3142;
            color: white;
            border: 1px solid #3a4255;
        }
        
        .permission-btn.deny:hover {
            background: #3a4255;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
            }
            
            .map-area {
                height: 60vh;
            }
            
            .location-info {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .location-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .transport-options {
                justify-content: center;
            }
            
            .permission-buttons {
                flex-direction: column;
            }
        }
        
        /* Ocultar elementos */
        .hidden {
            display: none !important;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1f2e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #4dabf7;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #228be6;
        }
    </style>
</head>
<body>
    <!-- Modal de permisos -->
    <div id="permissionModal" class="permission-modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-map-marked-alt"></i>
            </div>
            <h2 class="modal-title">Permiso de Ubicación Requerido</h2>
            <p class="modal-text">
                Esta aplicación necesita acceso a tu ubicación en tiempo real para:
                <br><br>
                • Detectar tu medio de transporte automáticamente<br>
                • Sugerir líneas y recorridos cercanos<br>
                • Mostrar estaciones y paradas en tu ubicación<br>
                • Conectar con otros viajeros en la misma ruta<br>
                • Registrar estadísticas precisas de tu viaje
            </p>
            <div class="permission-buttons">
                <button id="allowPermission" class="permission-btn allow">
                    <i class="fas fa-check-circle"></i> Permitir Ubicación
                </button>
                <button id="denyPermission" class="permission-btn deny">
                    <i class="fas fa-times-circle"></i> Denegar
                </button>
            </div>
        </div>
    </div>

    <!-- Aplicación principal -->
    <div id="appContainer" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Ubicación y velocidad -->
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-location-dot"></i> Ubicación Actual
                </h3>
                <div class="location-info">
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-globe-americas"></i> Latitud
                        </div>
                        <div class="info-value" id="latitude">--.--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-globe-americas"></i> Longitud
                        </div>
                        <div class="info-value" id="longitude">--.--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-bullseye"></i> Precisión
                        </div>
                        <div class="info-value" id="accuracy">-- m</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-clock"></i> Actualizado
                        </div>
                        <div class="info-value" id="timestamp">--:--:--</div>
                    </div>
                </div>
                
                <div class="speed-display">
                    <span id="speedValue">0</span>
                    <span class="speed-unit">km/h</span>
                </div>
            </div>
            
            <!-- Selección de transporte -->
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-car-side"></i> Medio de Transporte
                </h3>
                
                <div id="suggestionContainer" class="suggestion-card hidden">
                    <div class="suggestion-header">
                        <i class="fas fa-lightbulb"></i>
                        <span>Sugerencia del Sistema</span>
                    </div>
                    <p class="suggestion-text" id="suggestionText">
                        Basado en tu velocidad actual de <span id="detectedSpeed">0</span> km/h, 
                        el sistema sugiere que estás viajando en 
                        <strong id="detectedTransport">--</strong>.
                    </p>
                </div>
                
                <div class="transport-options">
                    <button class="transport-btn train" data-type="train">
                        <i class="fas fa-train"></i>
                        <span>Tren</span>
                    </button>
                    <button class="transport-btn bus" data-type="bus">
                        <i class="fas fa-bus"></i>
                        <span>Colectivo</span>
                    </button>
                    <button class="transport-btn subway" data-type="subway">
                        <i class="fas fa-subway"></i>
                        <span>Subte</span>
                    </button>
                    <button class="transport-btn tram" data-type="tram">
                        <i class="fas fa-tram"></i>
                        <span>Tranvía</span>
                    </button>
                    <button class="transport-btn walking" data-type="walking">
                        <i class="fas fa-walking"></i>
                        <span>Caminando</span>
                    </button>
                    <button class="transport-btn bike" data-type="bike">
                        <i class="fas fa-bicycle"></i>
                        <span>Bicicleta</span>
                    </button>
                    <button class="transport-btn car" data-type="car">
                        <i class="fas fa-car"></i>
                        <span>Auto</span>
                    </button>
                </div>
            </div>
            
            <!-- Líneas y recorridos -->
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-route"></i> Líneas Disponibles
                </h3>
                <div class="lines-container" id="linesContainer">
                    <!-- Las líneas se cargarán aquí dinámicamente -->
                </div>
            </div>
            
            <!-- Compañeros de viaje -->
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-users"></i> Compañeros de Viaje
                </h3>
                <div class="companions-list" id="companionsList">
                    <!-- Los compañeros se cargarán aquí dinámicamente -->
                </div>
            </div>
            
            <!-- Estadísticas -->
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-chart-line"></i> Estadísticas de Viaje
                </h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="avgSpeed">0</div>
                        <div class="stat-label">
                            Velocidad Promedio
                            <span class="trend-badge" id="avgSpeedTrend">→</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maxSpeed">0</div>
                        <div class="stat-label">Velocidad Máxima</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="travelTime">0</div>
                        <div class="stat-label">Tiempo de Viaje (min)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="distance">0</div>
                        <div class="stat-label">Distancia (km)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mapa -->
        <div class="map-area">
            <div id="map"></div>
            
            <div class="map-controls">
                <button class="control-btn" id="zoomIn" title="Acercar">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="control-btn" id="zoomOut" title="Alejar">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="control-btn" id="centerMap" title="Centrar en mi ubicación">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="control-btn" id="toggleStations" title="Mostrar/ocultar estaciones">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales
        let watchId = null;
        let map = null;
        let userMarker = null;
        let accuracyCircle = null;
        let stationMarkers = [];
        let companionMarkers = [];
        
        // Variables de estado
        let currentPosition = null;
        let lastPosition = null;
        let lastUpdate = null;
        let currentSpeed = 0;
        let selectedTransport = null;
        let selectedLine = null;
        let isTracking = false;
        
        // Variables para estadísticas
        let stats = {
            startTime: null,
            totalDistance: 0,
            speedHistory: [],
            maxSpeed: 0,
            transportHistory: [],
            previousAvgSpeed: 0
        };
        
        // Base de datos de transporte
        const transportDB = {
            train: {
                name: "Tren",
                icon: "fas fa-train",
                color: "#ff6b6b",
                lines: [
                    {
                        id: "sarmiento",
                        name: "Línea Sarmiento",
                        description: "Once - Moreno",
                        color: "#ff6b6b",
                        stations: [
                            { name: "Once", coords: [-34.6091, -58.4086] },
                            { name: "Caballito", coords: [-34.6105, -58.4203] },
                            { name: "Flores", coords: [-34.6182, -58.4357] },
                            { name: "Floresta", coords: [-34.6358, -58.4772] },
                            { name: "Liniers", coords: [-34.6405, -58.5278] },
                            { name: "Villa Luro", coords: [-34.6489, -58.5658] },
                            { name: "Ramos Mejía", coords: [-34.6605, -58.6047] },
                            { name: "Haedo", coords: [-34.6647, -58.6314] },
                            { name: "Morón", coords: [-34.6689, -58.6569] },
                            { name: "Castelar", coords: [-34.6758, -58.7008] },
                            { name: "Ituzaingó", coords: [-34.6819, -58.7283] },
                            { name: "San Antonio", coords: [-34.6900, -58.7600] },
                            { name: "Merlo", coords: [-34.6975, -58.7883] },
                            { name: "Paso del Rey", coords: [-34.7031, -58.8158] },
                            { name: "Moreno", coords: [-34.7089, -58.8464] }
                        ]
                    },
                    {
                        id: "mitre",
                        name: "Línea Mitre",
                        description: "Retiro - Tigre",
                        color: "#4dabf7",
                        stations: [
                            { name: "Retiro", coords: [-34.5905, -58.3731] },
                            { name: "Lisandro de la Torre", coords: [-34.5950, -58.4019] },
                            { name: "Belgrano C", coords: [-34.5983, -58.4250] },
                            { name: "Núñez", coords: [-34.6025, -58.4486] },
                            { name: "Rivadavia", coords: [-34.5458, -58.4719] },
                            { name: "Coghlan", coords: [-34.5572, -58.4958] },
                            { name: "Saavedra", coords: [-34.5669, -58.5156] },
                            { name: "Villa Urquiza", coords: [-34.5767, -58.5375] },
                            { name: "Villa Pueyrredón", coords: [-34.5864, -58.5597] },
                            { name: "Devoto", coords: [-34.5956, -58.5808] },
                            { name: "Beccar", coords: [-34.6067, -58.6067] },
                            { name: "San Martín", coords: [-34.5336, -58.6181] },
                            { name: "San Andrés", coords: [-34.5436, -58.6389] },
                            { name: "Miguelete", coords: [-34.5517, -58.6603] },
                            { name: "José León Suárez", coords: [-34.5611, -58.6811] },
                            { name: "Tigre", coords: [-34.4108, -58.6408] }
                        ]
                    }
                ]
            },
            bus: {
                name: "Colectivo",
                icon: "fas fa-bus",
                color: "#51cf66",
                lines: [
                    {
                        id: "152",
                        name: "Línea 152",
                        description: "Retiro - Lugano",
                        color: "#51cf66",
                        stations: [
                            { name: "Retiro", coords: [-34.5905, -58.3731] },
                            { name: "Parque Patricios", coords: [-34.6408, -58.3914] },
                            { name: "Barracas", coords: [-34.6564, -58.4108] },
                            { name: "Avellaneda", coords: [-34.6708, -58.4292] },
                            { name: "Sarandí", coords: [-34.6861, -58.4494] },
                            { name: "Wilde", coords: [-34.7019, -58.4700] },
                            { name: "Don Bosco", coords: [-34.7164, -58.4900] },
                            { name: "Bernal", coords: [-34.7325, -58.5111] },
                            { name: "Quilmes", coords: [-34.7469, -58.5314] },
                            { name: "Lugano", coords: [-34.6700, -58.4700] }
                        ]
                    },
                    {
                        id: "39",
                        name: "Línea 39",
                        description: "Retiro - Villa Soldati",
                        color: "#94d82d",
                        stations: [
                            { name: "Retiro", coords: [-34.5905, -58.3731] },
                            { name: "Constitución", coords: [-34.6275, -58.3792] },
                            { name: "San Telmo", coords: [-34.6205, -58.3715] },
                            { name: "Monserrat", coords: [-34.6102, -58.3783] },
                            { name: "Balvanera", coords: [-34.6095, -58.4080] },
                            { name: "Almagro", coords: [-34.6100, -58.4200] },
                            { name: "Caballito", coords: [-34.6180, -58.4450] },
                            { name: "Flores", coords: [-34.6250, -58.4650] },
                            { name: "Parque Avellaneda", coords: [-34.6500, -58.4800] },
                            { name: "Villa Soldati", coords: [-34.6700, -58.5000] }
                        ]
                    }
                ]
            }
        };
        
        // Base de datos de compañeros (simulada)
        let companionsDB = [
            { id: 1, name: "Ana", initial: "A", transport: "train", line: "sarmiento", coords: [-34.6405, -58.5278] },
            { id: 2, name: "Carlos", initial: "C", transport: "train", line: "sarmiento", coords: [-34.6605, -58.6047] },
            { id: 3, name: "María", initial: "M", transport: "bus", line: "152", coords: [-34.6564, -58.4108] },
            { id: 4, name: "Pedro", initial: "P", transport: "bus", line: "39", coords: [-34.6102, -58.3783] },
            { id: 5, name: "Laura", initial: "L", transport: "train", line: "mitre", coords: [-34.5950, -58.4019] }
        ];
        
        // Umbrales de velocidad para detección (km/h)
        const SPEED_THRESHOLDS = {
            walking: 6,
            bike: 20,
            car: 60,
            bus: 80,
            train: 100
        };
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadStatsFromStorage();
        });
        
        // Configurar event listeners
        function setupEventListeners() {
            // Botones de permisos
            document.getElementById('allowPermission').addEventListener('click', requestPermission);
            document.getElementById('denyPermission').addEventListener('click', denyPermission);
            
            // Botones del mapa
            document.getElementById('zoomIn').addEventListener('click', () => map && map.zoomIn());
            document.getElementById('zoomOut').addEventListener('click', () => map && map.zoomOut());
            document.getElementById('centerMap').addEventListener('click', centerOnUser);
            document.getElementById('toggleStations').addEventListener('click', toggleStations);
            
            // Botones de transporte
            document.querySelectorAll('.transport-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectTransport(this.dataset.type);
                });
            });
        }
        
        // Solicitar permiso de ubicación
        function requestPermission() {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta geolocalización");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    permissionGranted();
                },
                (error) => {
                    handlePermissionError(error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        // Permiso concedido
        function permissionGranted() {
            const modal = document.getElementById('permissionModal');
            const app = document.getElementById('appContainer');
            
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.classList.add('hidden');
                app.classList.remove('hidden');
                
                initApp();
            }, 500);
        }
        
        // Denegar permiso
        function denyPermission() {
            const modalContent = document.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-icon" style="color: #ff6b6b;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2 class="modal-title">Permiso Denegado</h2>
                <p class="modal-text">
                    Esta aplicación requiere acceso a tu ubicación para funcionar correctamente.
                    <br><br>
                    Puedes actualizar los permisos en la configuración de tu navegador.
                </p>
                <div class="permission-buttons">
                    <button id="retryPermission" class="permission-btn allow">
                        <i class="fas fa-redo"></i> Intentar Nuevamente
                    </button>
                </div>
            `;
            
            document.getElementById('retryPermission').addEventListener('click', requestPermission);
        }
        
        // Manejar error de permisos
        function handlePermissionError(error) {
            let message = "";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Permiso de ubicación denegado por el usuario";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "La información de ubicación no está disponible";
                    break;
                case error.TIMEOUT:
                    message = "La solicitud de ubicación ha expirado";
                    break;
                case error.UNKNOWN_ERROR:
                    message = "Ocurrió un error desconocido";
                    break;
            }
            
            const modalContent = document.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-icon" style="color: #ffa94d;">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <h2 class="modal-title">Error de Permisos</h2>
                <p class="modal-text">${message}</p>
                <div class="permission-buttons">
                    <button id="retryPermission" class="permission-btn allow">
                        <i class="fas fa-redo"></i> Reintentar
                    </button>
                </div>
            `;
            
            document.getElementById('retryPermission').addEventListener('click', requestPermission);
        }
        
        // Inicializar aplicación
        function initApp() {
            // Inicializar mapa
            initMap();
            
            // Inicializar estadísticas
            initStats();
            
            // Iniciar seguimiento de ubicación
            startTracking();
            
            // Mostrar compañeros iniciales
            updateCompanionsList();
            
            // Mostrar líneas iniciales
            updateLinesList();
        }
        
        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-34.6037, -58.3816], 13);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Añadir capa de tráfico (simulada)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                opacity: 0.3,
                maxZoom: 19
            }).addTo(map);
        }
        
        // Iniciar seguimiento de ubicación
        function startTracking() {
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            // Obtener posición inicial
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updatePosition(position);
                    centerOnUser();
                    
                    // Iniciar seguimiento continuo
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            updatePosition(position);
                            detectTransport();
                            updateSuggestions();
                            updateStats();
                            updateCompanionsList();
                        },
                        (error) => {
                            handleLocationError(error);
                        },
                        options
                    );
                    
                    isTracking = true;
                },
                (error) => {
                    handleLocationError(error);
                },
                options
            );
        }
        
        // Actualizar posición
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const timestamp = new Date(position.timestamp);
            
            currentPosition = { lat, lng };
            
            // Actualizar interfaz
            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = `${accuracy.toFixed(1)} m`;
            document.getElementById('timestamp').textContent = timestamp.toLocaleTimeString();
            
            // Calcular velocidad
            if (lastPosition && lastUpdate) {
                const timeDiff = (Date.now() - lastUpdate) / 1000; // segundos
                if (timeDiff > 0) {
                    const distance = calculateDistance(
                        lastPosition.lat, lastPosition.lng,
                        lat, lng
                    );
                    
                    // Velocidad en km/h
                    currentSpeed = (distance / timeDiff) * 3.6;
                    
                    // Filtrar valores atípicos
                    if (currentSpeed < 300) {
                        document.getElementById('speedValue').textContent = currentSpeed.toFixed(1);
                        document.getElementById('detectedSpeed').textContent = currentSpeed.toFixed(1);
                        
                        // Actualizar estadísticas
                        stats.speedHistory.push(currentSpeed);
                        if (currentSpeed > stats.maxSpeed) {
                            stats.maxSpeed = currentSpeed;
                            document.getElementById('maxSpeed').textContent = currentSpeed.toFixed(1);
                        }
                        
                        // Actualizar distancia total
                        stats.totalDistance += distance / 1000;
                        document.getElementById('distance').textContent = stats.totalDistance.toFixed(2);
                    }
                }
            }
            
            // Guardar para próximo cálculo
            lastPosition = { lat, lng };
            lastUpdate = Date.now();
            
            // Actualizar marcador en mapa
            updateUserMarker(lat, lng, accuracy);
        }
        
        // Calcular distancia (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Actualizar marcador en mapa
        function updateUserMarker(lat, lng, accuracy) {
            const userPos = [lat, lng];
            
            if (!userMarker) {
                userMarker = L.marker(userPos, {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background:#4dabf7; color:white; border-radius:50%; width:35px; height:35px; display:flex; align-items:center; justify-content:center; font-size:16px; border:3px solid white; box-shadow:0 0 10px rgba(77,171,247,0.5);"><i class="fas fa-user"></i></div>',
                        iconSize: [35, 35],
                        iconAnchor: [17, 35]
                    })
                }).addTo(map);
                
                accuracyCircle = L.circle(userPos, {
                    color: '#4dabf7',
                    fillColor: '#4dabf7',
                    fillOpacity: 0.1,
                    radius: accuracy
                }).addTo(map);
            } else {
                userMarker.setLatLng(userPos);
                accuracyCircle.setLatLng(userPos);
                accuracyCircle.setRadius(accuracy);
            }
        }
        
        // Centrar mapa en usuario
        function centerOnUser() {
            if (currentPosition) {
                map.setView([currentPosition.lat, currentPosition.lng], 15);
            }
        }
        
        // Alternar visibilidad de estaciones
        function toggleStations() {
            const btn = document.getElementById('toggleStations');
            const isVisible = stationMarkers.length > 0 && map.hasLayer(stationMarkers[0]);
            
            if (isVisible) {
                stationMarkers.forEach(marker => map.removeLayer(marker));
                btn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                btn.title = "Mostrar estaciones";
            } else if (selectedLine) {
                showStations(selectedLine);
                btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                btn.title = "Ocultar estaciones";
            }
        }
        
        // Detectar transporte basado en velocidad
        function detectTransport() {
            let detectedType = "walking";
            
            if (currentSpeed < SPEED_THRESHOLDS.walking) {
                detectedType = "walking";
            } else if (currentSpeed < SPEED_THRESHOLDS.bike) {
                detectedType = "bike";
            } else if (currentSpeed < SPEED_THRESHOLDS.car) {
                detectedType = "car";
            } else if (currentSpeed < SPEED_THRESHOLDS.bus) {
                detectedType = "bus";
            } else {
                detectedType = "train";
            }
            
            // Mostrar sugerencia
            updateSuggestion(detectedType);
            
            // Registrar en historial
            stats.transportHistory.push({
                type: detectedType,
                speed: currentSpeed,
                timestamp: new Date().toISOString()
            });
            
            // Guardar estadísticas
            saveStatsToStorage();
        }
        
        // Actualizar sugerencia del sistema
        function updateSuggestion(detectedType) {
            const suggestionContainer = document.getElementById('suggestionContainer');
            const suggestionText = document.getElementById('suggestionText');
            const detectedTransport = document.getElementById('detectedTransport');
            
            const transportNames = {
                walking: "caminando",
                bike: "bicicleta",
                car: "auto",
                bus: "colectivo",
                train: "tren"
            };
            
            detectedTransport.textContent = transportNames[detectedType] || "vehículo";
            
            // Mostrar sugerencia si no hay transporte seleccionado
            if (!selectedTransport) {
                suggestionContainer.classList.remove('hidden');
                
                // Sugerir líneas basadas en la ubicación
                suggestLinesByLocation(detectedType);
            }
        }
        
        // Sugerir líneas basadas en la ubicación
        function suggestLinesByLocation(transportType) {
            if (!currentPosition || !transportDB[transportType]) return;
            
            const linesContainer = document.getElementById('linesContainer');
            linesContainer.innerHTML = '';
            
            // Filtrar líneas cercanas (simulación)
            const nearbyLines = transportDB[transportType].lines.filter(line => {
                // En una implementación real, aquí calcularíamos la distancia a la línea
                return true;
            });
            
            if (nearbyLines.length > 0) {
                nearbyLines.forEach(line => {
                    const lineCard = document.createElement('div');
                    lineCard.className = 'line-card';
                    lineCard.dataset.lineId = line.id;
                    lineCard.dataset.transportType = transportType;
                    
                    lineCard.innerHTML = `
                        <div class="line-name">${line.name}</div>
                        <div class="line-details">
                            <span>${line.description}</span>
                            <span>${line.stations.length} estaciones</span>
                        </div>
                    `;
                    
                    lineCard.addEventListener('click', () => {
                        selectLine(transportType, line);
                    });
                    
                    linesContainer.appendChild(lineCard);
                });
            }
        }
        
        // Seleccionar transporte
        function selectTransport(type) {
            // Remover selección anterior
            document.querySelectorAll('.transport-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Agregar selección nueva
            document.querySelector(`.transport-btn[data-type="${type}"]`).classList.add('active');
            
            selectedTransport = type;
            
            // Ocultar sugerencia
            document.getElementById('suggestionContainer').classList.add('hidden');
            
            // Actualizar lista de líneas
            updateLinesList();
            
            // Actualizar compañeros
            updateCompanionsList();
        }
        
        // Actualizar lista de líneas
        function updateLinesList() {
            const linesContainer = document.getElementById('linesContainer');
            linesContainer.innerHTML = '';
            
            if (selectedTransport && transportDB[selectedTransport]) {
                transportDB[selectedTransport].lines.forEach(line => {
                    const lineCard = document.createElement('div');
                    lineCard.className = 'line-card';
                    lineCard.dataset.lineId = line.id;
                    lineCard.dataset.transportType = selectedTransport;
                    
                    lineCard.innerHTML = `
                        <div class="line-name">${line.name}</div>
                        <div class="line-details">
                            <span>${line.description}</span>
                            <span>${line.stations.length} ${selectedTransport === 'bus' ? 'paradas' : 'estaciones'}</span>
                        </div>
                    `;
                    
                    lineCard.addEventListener('click', () => {
                        selectLine(selectedTransport, line);
                    });
                    
                    linesContainer.appendChild(lineCard);
                });
            } else {
                linesContainer.innerHTML = `
                    <div style="text-align: center; color: #8a9ba8; padding: 20px;">
                        <i class="fas fa-route" style="font-size: 32px; margin-bottom: 10px;"></i>
                        <p>Selecciona un medio de transporte para ver las líneas disponibles</p>
                    </div>
                `;
            }
        }
        
        // Seleccionar línea
        function selectLine(transportType, line) {
            // Remover selección anterior
            document.querySelectorAll('.line-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Agregar selección nueva
            document.querySelector(`.line-card[data-line-id="${line.id}"]`).classList.add('selected');
            
            selectedLine = { ...line, transportType };
            
            // Mostrar estaciones en el mapa
            showStations(line);
            
            // Actualizar botón de estaciones
            document.getElementById('toggleStations').innerHTML = '<i class="fas fa-eye-slash"></i>';
            document.getElementById('toggleStations').title = "Ocultar estaciones";
            
            // Actualizar compañeros
            updateCompanionsList();
        }
        
        // Mostrar estaciones en el mapa
        function showStations(line) {
            // Limpiar estaciones anteriores
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
            
            // Crear polyline de la ruta
            const routeCoords = line.stations.map(station => station.coords);
            const routeLine = L.polyline(routeCoords, {
                color: line.color,
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            
            stationMarkers.push(routeLine);
            
            // Agregar marcadores de estaciones
            line.stations.forEach((station, index) => {
                const marker = L.marker(station.coords, {
                    icon: L.divIcon({
                        className: 'station-marker',
                        html: `
                            <div style="
                                background: ${line.color};
                                color: white;
                                border-radius: 50%;
                                width: 25px;
                                height: 25px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                font-size: 12px;
                                border: 2px solid white;
                                box-shadow: 0 0 8px rgba(0,0,0,0.5);
                            ">
                                ${index + 1}
                            </div>
                        `,
                        iconSize: [25, 25],
                        iconAnchor: [12, 25]
                    })
                }).addTo(map);
                
                marker.bindTooltip(`
                    <strong>${station.name}</strong><br>
                    ${line.name}<br>
                    Estación ${index + 1} de ${line.stations.length}
                `);
                
                stationMarkers.push(marker);
            });
            
            // Ajustar vista del mapa
            const bounds = L.latLngBounds(routeCoords);
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        // Actualizar lista de compañeros
        function updateCompanionsList() {
            const companionsList = document.getElementById('companionsList');
            companionsList.innerHTML = '';
            
            // Filtrar compañeros por transporte y línea seleccionados
            let filteredCompanions = [];
            
            if (selectedTransport && selectedLine) {
                filteredCompanions = companionsDB.filter(companion => 
                    companion.transport === selectedTransport && 
                    companion.line === selectedLine.id
                );
            } else if (selectedTransport) {
                filteredCompanions = companionsDB.filter(companion => 
                    companion.transport === selectedTransport
                );
            } else {
                filteredCompanions = companionsDB.slice(0, 3); // Mostrar algunos compañeros por defecto
            }
            
            // Actualizar marcadores en el mapa
            updateCompanionMarkers(filteredCompanions);
            
            if (filteredCompanions.length > 0) {
                filteredCompanions.forEach(companion => {
                    const companionCard = document.createElement('div');
                    companionCard.className = 'companion-card';
                    
                    companionCard.innerHTML = `
                        <div class="companion-avatar" style="background: linear-gradient(135deg, ${transportDB[companion.transport]?.color || '#4dabf7'}, #228be6)">
                            ${companion.initial}
                        </div>
                        <div class="companion-info">
                            <div class="companion-name">${companion.name}</div>
                            <div class="companion-status online">
                                <i class="fas fa-circle"></i>
                                Viajando en ${transportDB[companion.transport]?.name || 'transporte'}
                            </div>
                        </div>
                    `;
                    
                    companionsList.appendChild(companionCard);
                });
            } else {
                companionsList.innerHTML = `
                    <div style="text-align: center; color: #8a9ba8; padding: 20px;">
                        <i class="fas fa-user-friends" style="font-size: 32px; margin-bottom: 10px;"></i>
                        <p>No hay otros viajeros en esta ruta</p>
                        <p style="font-size: 12px; margin-top: 5px;">Selecciona otra línea o medio de transporte</p>
                    </div>
                `;
            }
        }
        
        // Actualizar marcadores de compañeros en el mapa
        function updateCompanionMarkers(companions) {
            // Limpiar marcadores anteriores
            companionMarkers.forEach(marker => map.removeLayer(marker));
            companionMarkers = [];
            
            // Agregar nuevos marcadores
            companions.forEach(companion => {
                const transportColor = transportDB[companion.transport]?.color || '#4dabf7';
                
                const marker = L.marker(companion.coords, {
                    icon: L.divIcon({
                        className: 'companion-marker',
                        html: `
                            <div style="
                                background: ${transportColor};
                                color: white;
                                border-radius: 50%;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                font-size: 14px;
                                border: 2px solid white;
                                box-shadow: 0 0 10px ${transportColor};
                            ">
                                ${companion.initial}
                            </div>
                        `,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(map);
                
                marker.bindTooltip(`
                    <strong>${companion.name}</strong><br>
                    ${transportDB[companion.transport]?.name || 'Viajero'} - 
                    ${companionsDB.find(c => c.id === companion.id)?.line || ''}
                `);
                
                companionMarkers.push(marker);
            });
        }
        
        // Inicializar estadísticas
        function initStats() {
            stats.startTime = new Date();
            
            // Actualizar estadísticas cada 5 segundos
            setInterval(updateStats, 5000);
        }
        
        // Actualizar estadísticas
        function updateStats() {
            // Calcular tiempo de viaje
            if (stats.startTime) {
                const now = new Date();
                const diffMs = now - stats.startTime;
                const diffMins = Math.floor(diffMs / 60000);
                document.getElementById('travelTime').textContent = diffMins;
            }
            
            // Calcular velocidad promedio
            if (stats.speedHistory.length > 0) {
                const avgSpeed = stats.speedHistory.reduce((a, b) => a + b, 0) / stats.speedHistory.length;
                document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1);
                
                // Calcular tendencia
                const trendElement = document.getElementById('avgSpeedTrend');
                if (stats.previousAvgSpeed > 0) {
                    const diff = avgSpeed - stats.previousAvgSpeed;
                    if (diff > 1) {
                        trendElement.textContent = '↗';
                        trendElement.className = 'trend-badge trend-up';
                    } else if (diff < -1) {
                        trendElement.textContent = '↘';
                        trendElement.className = 'trend-badge trend-down';
                    } else {
                        trendElement.textContent = '→';
                        trendElement.className = 'trend-badge';
                    }
                }
                stats.previousAvgSpeed = avgSpeed;
            }
            
            // Mostrar velocidad máxima
            document.getElementById('maxSpeed').textContent = stats.maxSpeed.toFixed(1);
        }
        
        // Cargar estadísticas desde localStorage
        function loadStatsFromStorage() {
            try {
                const savedStats = localStorage.getItem('transportStats');
                if (savedStats) {
                    const parsed = JSON.parse(savedStats);
                    stats = { ...stats, ...parsed };
                }
            } catch (e) {
                console.error("Error al cargar estadísticas:", e);
            }
        }
        
        // Guardar estadísticas en localStorage
        function saveStatsToStorage() {
            try {
                localStorage.setItem('transportStats', JSON.stringify({
                    totalDistance: stats.totalDistance,
                    maxSpeed: stats.maxSpeed,
                    speedHistory: stats.speedHistory.slice(-100), // Guardar solo las últimas 100
                    transportHistory: stats.transportHistory.slice(-50) // Guardar solo las últimas 50
                }));
            } catch (e) {
                console.error("Error al guardar estadísticas:", e);
            }
        }
        
        // Manejar error de geolocalización
        function handleLocationError(error) {
            console.error("Error de geolocalización:", error.message);
        }
    </script>
</body>
</html>