<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transporte Inteligente</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2196f3;
            --primary-dark: #0d47a1;
            --secondary: #ff9800;
            --secondary-dark: #ef6c00;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --dark: #121212;
            --darker: #0a0a0a;
            --gray: #2d2d2d;
            --light-gray: #424242;
            --light: #e0e0e0;
            --train: #ff5252;
            --bus: #4caf50;
            --subway: #9c27b0;
            --bike: #00bcd4;
            --walking: #795548;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--darker);
            color: var(--light);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            display: flex;
            overflow: hidden;
        }
        
        /* Pantalla de permisos */
        #permissionPrompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            text-align: center;
            padding: 30px;
            transition: opacity 0.5s ease;
        }
        
        .permission-content {
            max-width: 500px;
            background-color: var(--dark);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary);
            animation: fadeIn 0.8s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .permission-icon {
            font-size: 5rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .permission-content h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .permission-content p {
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.5;
            color: #ccc;
        }
        
        .permission-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .permission-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        
        .permission-btn.allow {
            background-color: var(--primary);
            color: white;
        }
        
        .permission-btn.allow:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(33, 150, 243, 0.3);
        }
        
        .permission-btn.deny {
            background-color: var(--light-gray);
            color: white;
        }
        
        .permission-btn.deny:hover {
            background-color: var(--gray);
            transform: translateY(-3px);
        }
        
        /* Aplicación principal */
        #appContainer {
            display: flex;
            width: 100vw;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        #appContainer.active {
            opacity: 1;
        }
        
        /* Panel izquierdo */
        .left-panel {
            width: 380px;
            background-color: var(--dark);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--gray);
            overflow: hidden;
        }
        
        /* Panel principal - Mapa */
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Controles del mapa */
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-btn {
            background-color: var(--dark);
            color: white;
            border: 1px solid var(--gray);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .map-btn:hover {
            background-color: var(--primary);
            transform: scale(1.1);
        }
        
        /* Secciones del panel izquierdo */
        .panel-section {
            padding: 20px;
            border-bottom: 1px solid var(--gray);
        }
        
        .section-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Información de ubicación */
        .location-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            font-family: monospace;
        }
        
        /* Detección de transporte */
        .transport-detection {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 15px;
        }
        
        .transport-icon {
            font-size: 3.5rem;
            color: var(--primary);
        }
        
        .transport-name {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .speed-display {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }
        
        .speed-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .speed-unit {
            font-size: 1rem;
            color: #aaa;
        }
        
        /* Selector de transporte */
        .transport-selector {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .transport-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .transport-option {
            flex: 1;
            min-width: 80px;
            background-color: var(--gray);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .transport-option:hover {
            background-color: var(--light-gray);
            transform: translateY(-3px);
        }
        
        .transport-option.active {
            border-color: var(--primary);
            background-color: rgba(33, 150, 243, 0.1);
        }
        
        .transport-option.train {
            border-color: var(--train);
        }
        
        .transport-option.bus {
            border-color: var(--bus);
        }
        
        .transport-option.subway {
            border-color: var(--subway);
        }
        
        .transport-option.bike {
            border-color: var(--bike);
        }
        
        .transport-option.walking {
            border-color: var(--walking);
        }
        
        .transport-option i {
            font-size: 1.8rem;
        }
        
        .transport-option.train i {
            color: var(--train);
        }
        
        .transport-option.bus i {
            color: var(--bus);
        }
        
        .transport-option.subway i {
            color: var(--subway);
        }
        
        .transport-option.bike i {
            color: var(--bike);
        }
        
        .transport-option.walking i {
            color: var(--walking);
        }
        
        /* Sugerencias */
        .suggestions {
            background-color: rgba(33, 150, 243, 0.1);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .suggestion-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .suggestion-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .suggestion-item {
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .suggestion-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .suggestion-icon {
            font-size: 1.2rem;
        }
        
        /* Líneas de transporte */
        .lines-container {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .line-item {
            padding: 12px;
            background-color: var(--gray);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid var(--primary);
        }
        
        .line-item:hover {
            background-color: var(--light-gray);
        }
        
        .line-item.active {
            background-color: rgba(33, 150, 243, 0.2);
        }
        
        .line-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .line-description {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        /* Otros usuarios */
        .other-users {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background-color: var(--gray);
            border-radius: 8px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .user-transport {
            font-size: 0.85rem;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Estadísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background-color: var(--gray);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #aaa;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            body {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid var(--gray);
            }
            
            .main-panel {
                height: 50vh;
            }
            
            .location-info {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .location-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .transport-options {
                justify-content: center;
            }
            
            .transport-option {
                min-width: 70px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Ocultar elementos */
        .hidden {
            display: none !important;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <!-- Pantalla de permisos -->
    <div id="permissionPrompt">
        <div class="permission-content">
            <div class="permission-icon">
                <i class="fas fa-map-marked-alt"></i>
            </div>
            <h2>Bienvenido al Sistema de Transporte Inteligente</h2>
            <p>Para una experiencia personalizada, necesitamos acceder a tu ubicación en tiempo real. Esto nos permitirá:</p>
            <ul style="text-align: left; margin: 20px 0; padding-left: 20px; line-height: 1.8;">
                <li><i class="fas fa-map-marker-alt" style="color: var(--primary); margin-right: 10px;"></i> Sugerir medios de transporte cercanos</li>
                <li><i class="fas fa-tachometer-alt" style="color: var(--primary); margin-right: 10px;"></i> Registrar estadísticas de velocidad</li>
                <li><i class="fas fa-users" style="color: var(--primary); margin-right: 10px;"></i> Mostrar otros viajeros cerca</li>
                <li><i class="fas fa-route" style="color: var(--primary); margin-right: 10px;"></i> Mostrar estaciones y paradas cercanas</li>
            </ul>
            <p style="background-color: rgba(33, 150, 243, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary);">
                <i class="fas fa-shield-alt" style="color: var(--primary); margin-right: 10px;"></i>
                <strong>Tu privacidad es importante:</strong> Todo se procesa localmente en tu navegador.
            </p>
            <div class="permission-buttons">
                <button id="allowPermission" class="permission-btn allow">
                    <i class="fas fa-check-circle"></i> Permitir Ubicación
                </button>
                <button id="denyPermission" class="permission-btn deny">
                    <i class="fas fa-times-circle"></i> Denegar
                </button>
            </div>
        </div>
    </div>

    <!-- Aplicación principal -->
    <div id="appContainer" class="hidden">
        <!-- Panel izquierdo -->
        <div class="left-panel">
            <!-- Información de ubicación -->
            <div class="panel-section">
                <h3 class="section-title"><i class="fas fa-location-dot"></i> Ubicación Actual</h3>
                <div class="location-info">
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-globe-americas"></i> Latitud</div>
                        <div class="info-value" id="latitude">--.--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-globe-americas"></i> Longitud</div>
                        <div class="info-value" id="longitude">--.--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-tachometer-alt"></i> Velocidad</div>
                        <div class="info-value" id="speed">0 <span style="font-size: 0.9rem;">km/h</span></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-bullseye"></i> Precisión</div>
                        <div class="info-value" id="accuracy">-- m</div>
                    </div>
                </div>
            </div>
            
            <!-- Detección y selección de transporte -->
            <div class="panel-section">
                <h3 class="section-title"><i class="fas fa-car-side"></i> Medio de Transporte</h3>
                <div class="transport-detection">
                    <div class="transport-icon" id="detectedIcon">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <div class="transport-name" id="detectedTransport">
                        Detectando...
                    </div>
                    <div class="speed-display">
                        <div class="speed-value" id="currentSpeed">0</div>
                        <div class="speed-unit">km/h</div>
                    </div>
                </div>
                
                <div class="transport-selector">
                    <h4 style="margin: 15px 0 10px 0; color: #ccc;">Selecciona tu transporte:</h4>
                    <div class="transport-options">
                        <div class="transport-option train" data-type="train">
                            <i class="fas fa-train"></i>
                            <span>Tren</span>
                        </div>
                        <div class="transport-option bus" data-type="bus">
                            <i class="fas fa-bus"></i>
                            <span>Colectivo</span>
                        </div>
                        <div class="transport-option subway" data-type="subway">
                            <i class="fas fa-subway"></i>
                            <span>Subte</span>
                        </div>
                        <div class="transport-option bike" data-type="bike">
                            <i class="fas fa-bicycle"></i>
                            <span>Bicicleta</span>
                        </div>
                        <div class="transport-option walking" data-type="walking">
                            <i class="fas fa-walking"></i>
                            <span>Caminando</span>
                        </div>
                    </div>
                </div>
                
                <!-- Sugerencias del sistema -->
                <div id="suggestionsContainer" class="suggestions hidden">
                    <div class="suggestion-title">
                        <i class="fas fa-lightbulb"></i> Sugerencias del sistema:
                    </div>
                    <div class="suggestion-list" id="suggestionsList">
                        <!-- Las sugerencias se cargarán aquí -->
                    </div>
                </div>
            </div>
            
            <!-- Líneas disponibles -->
            <div class="panel-section">
                <h3 class="section-title"><i class="fas fa-route"></i> Líneas Disponibles</h3>
                <div class="lines-container" id="linesContainer">
                    <!-- Las líneas se cargarán aquí -->
                </div>
            </div>
            
            <!-- Otros viajeros -->
            <div class="panel-section">
                <h3 class="section-title"><i class="fas fa-users"></i> Otros Viajeros</h3>
                <div class="other-users" id="otherUsers">
                    <!-- Los otros usuarios se cargarán aquí -->
                </div>
            </div>
            
            <!-- Estadísticas -->
            <div class="panel-section">
                <h3 class="section-title"><i class="fas fa-chart-line"></i> Estadísticas</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="avgSpeed">0</div>
                        <div class="stat-label">Velocidad promedio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maxSpeed">0</div>
                        <div class="stat-label">Velocidad máxima</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="travelTime">0</div>
                        <div class="stat-label">Tiempo de viaje</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="distance">0</div>
                        <div class="stat-label">Distancia (km)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel principal - Mapa -->
        <div class="main-panel">
            <div class="map-container">
                <div id="map"></div>
                
                <div class="map-controls">
                    <button class="map-btn" id="zoomIn" title="Acercar">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="map-btn" id="zoomOut" title="Alejar">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="map-btn" id="centerMap" title="Centrar en mi ubicación">
                        <i class="fas fa-crosshairs"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales
        let watchId = null;
        let map = null;
        let userMarker = null;
        let userCircle = null;
        let transportLine = null;
        let stations = [];
        let otherUsersMarkers = [];
        
        // Variables de seguimiento
        let lastPosition = null;
        let lastTime = null;
        let currentSpeed = 0;
        let selectedTransport = null;
        let selectedLine = null;
        
        // Variables para estadísticas
        let stats = {
            startTime: null,
            totalDistance: 0,
            speedSamples: [],
            maxSpeed: 0,
            transportHistory: []
        };
        
        // Base de datos simulada
        const transportData = {
            train: {
                name: "Tren",
                icon: "fas fa-train",
                color: "#ff5252",
                lines: [
                    { id: "sarmiento", name: "Línea Sarmiento", description: "Once - Moreno", color: "#ff5252", 
                      stations: 17, distance: 35.5, coordinates: [
                        [-34.6091, -58.4086], [-34.6105, -58.4203], [-34.6182, -58.4357],
                        [-34.6358, -58.4772], [-34.6405, -58.5278], [-34.6489, -58.5658],
                        [-34.6605, -58.6047], [-34.6647, -58.6314], [-34.6689, -58.6569],
                        [-34.6758, -58.7008], [-34.6819, -58.7283], [-34.6900, -58.7600],
                        [-34.6975, -58.7883], [-34.7031, -58.8158], [-34.7089, -58.8464]
                      ] },
                    { id: "mitre", name: "Línea Mitre", description: "Retiro - Tigre", color: "#2196f3",
                      stations: 21, distance: 28.2, coordinates: [
                        [-34.5905, -58.3731], [-34.5950, -58.4019], [-34.5983, -58.4250],
                        [-34.6025, -58.4486], [-34.5572, -58.4958], [-34.5669, -58.5156],
                        [-34.5767, -58.5375], [-34.5864, -58.5597], [-34.5956, -58.5808],
                        [-34.6067, -58.6067], [-34.5336, -58.6181], [-34.5436, -58.6389],
                        [-34.5517, -58.6603], [-34.5611, -58.6811], [-34.4108, -58.6408]
                      ] }
                ]
            },
            bus: {
                name: "Colectivo",
                icon: "fas fa-bus",
                color: "#4caf50",
                lines: [
                    { id: "152", name: "Línea 152", description: "Retiro - Lugano", color: "#4caf50",
                      stops: 42, distance: 18.7, coordinates: [
                        [-34.5905, -58.3731], [-34.5950, -58.4019], [-34.5983, -58.4250],
                        [-34.6025, -58.4486], [-34.6067, -58.4719], [-34.6109, -58.4952],
                        [-34.6151, -58.5185], [-34.6193, -58.5418], [-34.6235, -58.5651]
                      ] },
                    { id: "39", name: "Línea 39", description: "Retiro - Villa Soldati", color: "#4caf50",
                      stops: 38, distance: 16.3, coordinates: [
                        [-34.5905, -58.3731], [-34.5950, -58.4019], [-34.5983, -58.4250],
                        [-34.6016, -58.4483], [-34.6049, -58.4716], [-34.6082, -58.4949],
                        [-34.6115, -58.5182], [-34.6148, -58.5415], [-34.6181, -58.5648]
                      ] }
                ]
            },
            subway: {
                name: "Subte",
                icon: "fas fa-subway",
                color: "#9c27b0",
                lines: [
                    { id: "A", name: "Línea A", description: "Plaza de Mayo - San Pedrito", color: "#9c27b0",
                      stations: 18, distance: 10.7, coordinates: [
                        [-34.6086, -58.3736], [-34.6112, -58.3931], [-34.6138, -58.4126],
                        [-34.6164, -58.4321], [-34.6190, -58.4516], [-34.6216, -58.4711],
                        [-34.6242, -58.4906], [-34.6268, -58.5101], [-34.6294, -58.5296]
                      ] }
                ]
            }
        };
        
        // Usuarios simulados
        const simulatedUsers = [
            { id: 1, name: "Ana", transport: "train", line: "sarmiento", color: "#ff5252", position: [-34.6405, -58.5278] },
            { id: 2, name: "Carlos", transport: "bus", line: "152", color: "#4caf50", position: [-34.6025, -58.4486] },
            { id: 3, name: "Laura", transport: "subway", line: "A", color: "#9c27b0", position: [-34.6112, -58.3931] },
            { id: 4, name: "Miguel", transport: "train", line: "mitre", color: "#2196f3", position: [-34.5950, -58.4019] }
        ];
        
        // Umbrales de velocidad para detección (km/h)
        const speedThresholds = {
            walking: 6,
            bike: 20,
            bus: 60,
            train: 100
        };
        
        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadStatsFromStorage();
        });
        
        // Configurar event listeners
        function setupEventListeners() {
            // Botones de permisos
            document.getElementById('allowPermission').addEventListener('click', requestPermission);
            document.getElementById('denyPermission').addEventListener('click', denyPermission);
            
            // Botones del mapa
            document.getElementById('zoomIn').addEventListener('click', () => map.zoomIn());
            document.getElementById('zoomOut').addEventListener('click', () => map.zoomOut());
            document.getElementById('centerMap').addEventListener('click', centerOnUser);
            
            // Selector de transporte
            document.querySelectorAll('.transport-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectTransport(this.dataset.type);
                });
            });
        }
        
        // Solicitar permiso de ubicación
        function requestPermission() {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta geolocalización");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    permissionGranted();
                },
                (error) => {
                    handlePermissionError(error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        // Permiso concedido
        function permissionGranted() {
            const permissionPrompt = document.getElementById('permissionPrompt');
            const appContainer = document.getElementById('appContainer');
            
            permissionPrompt.style.opacity = '0';
            setTimeout(() => {
                permissionPrompt.classList.add('hidden');
                appContainer.classList.remove('hidden');
                setTimeout(() => {
                    appContainer.classList.add('active');
                }, 50);
                
                initApp();
            }, 500);
        }
        
        // Denegar permiso
        function denyPermission() {
            const permissionContent = document.querySelector('.permission-content');
            permissionContent.innerHTML = `
                <div class="permission-icon" style="color: #f44336;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2>Permiso Denegado</h2>
                <p>Has denegado el permiso de ubicación. Esta aplicación no puede funcionar sin acceso a tu ubicación.</p>
                <div class="permission-buttons">
                    <button id="retryPermission" class="permission-btn allow">
                        <i class="fas fa-redo"></i> Intentar Nuevamente
                    </button>
                </div>
            `;
            
            document.getElementById('retryPermission').addEventListener('click', requestPermission);
        }
        
        // Manejar error de permisos
        function handlePermissionError(error) {
            let message = "";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Permiso de ubicación denegado por el usuario";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "La información de ubicación no está disponible";
                    break;
                case error.TIMEOUT:
                    message = "La solicitud de ubicación ha expirado";
                    break;
                case error.UNKNOWN_ERROR:
                    message = "Ocurrió un error desconocido";
                    break;
            }
            
            const permissionContent = document.querySelector('.permission-content');
            permissionContent.innerHTML = `
                <div class="permission-icon" style="color: #ff9800;">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <h2>Error de Permisos</h2>
                <p>${message}</p>
                <div class="permission-buttons">
                    <button id="retryPermission" class="permission-btn allow">
                        <i class="fas fa-redo"></i> Reintentar
                    </button>
                </div>
            `;
            
            document.getElementById('retryPermission').addEventListener('click', requestPermission);
        }
        
        // Inicializar aplicación
        function initApp() {
            // Inicializar mapa
            initMap();
            
            // Inicializar estadísticas
            initStats();
            
            // Cargar usuarios simulados
            loadSimulatedUsers();
            
            // Iniciar seguimiento de ubicación
            startTracking();
            
            // Actualizar sugerencias iniciales
            updateSuggestions();
        }
        
        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-34.6037, -58.3816], 13);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
        }
        
        // Iniciar seguimiento de ubicación
        function startTracking() {
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            // Obtener posición inicial
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updatePosition(position);
                    centerOnUser();
                    
                    // Iniciar seguimiento continuo
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            updatePosition(position);
                            detectTransport();
                            updateSuggestions();
                            updateStats();
                        },
                        (error) => {
                            handleLocationError(error);
                        },
                        options
                    );
                },
                (error) => {
                    handleLocationError(error);
                },
                options
            );
        }
        
        // Actualizar posición
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            // Actualizar interfaz
            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = `${accuracy.toFixed(1)} m`;
            
            // Calcular velocidad
            if (lastPosition && lastTime) {
                const timeDiff = (position.timestamp - lastTime) / 1000; // segundos
                if (timeDiff > 0) {
                    const distance = calculateDistance(
                        lastPosition.lat, lastPosition.lng,
                        lat, lng
                    );
                    
                    // Velocidad en km/h
                    currentSpeed = (distance / timeDiff) * 3.6;
                    
                    // Filtrar valores atípicos
                    if (currentSpeed < 300) {
                        document.getElementById('speed').innerHTML = `${currentSpeed.toFixed(1)} <span style="font-size: 0.9rem;">km/h</span>`;
                        document.getElementById('currentSpeed').textContent = currentSpeed.toFixed(1);
                        
                        // Actualizar estadísticas
                        stats.speedSamples.push(currentSpeed);
                        if (currentSpeed > stats.maxSpeed) {
                            stats.maxSpeed = currentSpeed;
                        }
                        
                        // Actualizar distancia total
                        stats.totalDistance += distance / 1000; // Convertir a km
                    }
                }
            }
            
            // Guardar para próximo cálculo
            lastPosition = { lat, lng };
            lastTime = position.timestamp;
            
            // Actualizar marcador en mapa
            updateUserMarker(lat, lng, accuracy);
        }
        
        // Calcular distancia (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Actualizar marcador en mapa
        function updateUserMarker(lat, lng, accuracy) {
            const userPos = [lat, lng];
            
            if (!userMarker) {
                userMarker = L.marker(userPos, {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background-color:#2196f3; color:white; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; font-size:16px;"><i class="fas fa-user"></i></div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(map);
                
                userCircle = L.circle(userPos, {
                    color: '#2196f3',
                    fillColor: '#2196f3',
                    fillOpacity: 0.1,
                    radius: accuracy
                }).addTo(map);
            } else {
                userMarker.setLatLng(userPos);
                userCircle.setLatLng(userPos);
                userCircle.setRadius(accuracy);
            }
        }
        
        // Centrar mapa en usuario
        function centerOnUser() {
            if (lastPosition) {
                map.setView([lastPosition.lat, lastPosition.lng], 15);
            }
        }
        
        // Detectar transporte basado en velocidad
        function detectTransport() {
            let detectedType = "walking";
            let confidence = "Alta";
            
            if (currentSpeed < speedThresholds.walking) {
                detectedType = "walking";
            } else if (currentSpeed < speedThresholds.bike) {
                detectedType = "bike";
            } else if (currentSpeed < speedThresholds.bus) {
                detectedType = "bus";
            } else {
                detectedType = "train";
            }
            
            // Actualizar interfaz si es diferente al seleccionado
            if (!selectedTransport || selectedTransport !== detectedType) {
                updateDetectedTransport(detectedType);
            }
        }
        
        // Actualizar transporte detectado
        function updateDetectedTransport(type) {
            const transport = {
                walking: { name: "Caminando", icon: "fas fa-walking", color: "#795548" },
                bike: { name: "Bicicleta", icon: "fas fa-bicycle", color: "#00bcd4" },
                bus: { name: "Colectivo", icon: "fas fa-bus", color: "#4caf50" },
                train: { name: "Tren", icon: "fas fa-train", color: "#ff5252" }
            }[type];
            
            document.getElementById('detectedIcon').innerHTML = `<i class="${transport.icon}"></i>`;
            document.getElementById('detectedTransport').textContent = transport.name;
            
            // Registrar en historial
            stats.transportHistory.push({
                type: type,
                name: transport.name,
                timestamp: new Date().toISOString(),
                speed: currentSpeed
            });
            
            // Guardar estadísticas
            saveStatsToStorage();
        }
        
        // Seleccionar transporte manualmente
        function selectTransport(type) {
            // Remover clase activa de todos
            document.querySelectorAll('.transport-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Agregar clase activa al seleccionado
            document.querySelector(`.transport-option[data-type="${type}"]`).classList.add('active');
            
            selectedTransport = type;
            
            // Actualizar interfaz
            updateDetectedTransport(type);
            
            // Mostrar/ocultar sugerencias
            updateSuggestions();
            
            // Cargar líneas disponibles
            loadTransportLines(type);
        }
        
        // Actualizar sugerencias del sistema
        function updateSuggestions() {
            const suggestionsContainer = document.getElementById('suggestionsContainer');
            const suggestionsList = document.getElementById('suggestionsList');
            
            // Limpiar lista
            suggestionsList.innerHTML = '';
            
            // Solo mostrar sugerencias si no hay transporte seleccionado
            if (!selectedTransport && lastPosition) {
                suggestionsContainer.classList.remove('hidden');
                
                // Sugerir basado en velocidad y ubicación
                if (currentSpeed > speedThresholds.bus) {
                    addSuggestion("train", "Por tu velocidad, podrías estar en tren");
                } else if (currentSpeed > speedThresholds.bike) {
                    addSuggestion("bus", "Por tu velocidad, podrías estar en colectivo");
                } else if (currentSpeed > speedThresholds.walking) {
                    addSuggestion("bike", "Por tu velocidad, podrías estar en bicicleta");
                }
                
                // Sugerir basado en proximidad a estaciones
                if (isNearTrainStation()) {
                    addSuggestion("train", "Estás cerca de una estación de tren");
                }
                
                if (isNearBusStop()) {
                    addSuggestion("bus", "Estás cerca de una parada de colectivo");
                }
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        }
        
        // Agregar sugerencia a la lista
        function addSuggestion(type, text) {
            const suggestionsList = document.getElementById('suggestionsList');
            const transport = {
                train: { icon: "fas fa-train", color: "#ff5252" },
                bus: { icon: "fas fa-bus", color: "#4caf50" },
                bike: { icon: "fas fa-bicycle", color: "#00bcd4" },
                walking: { icon: "fas fa-walking", color: "#795548" }
            }[type];
            
            const suggestionItem = document.createElement('div');
            suggestionItem.className = 'suggestion-item';
            suggestionItem.innerHTML = `
                <i class="${transport.icon} suggestion-icon" style="color: ${transport.color};"></i>
                <span>${text}</span>
            `;
            
            suggestionItem.addEventListener('click', () => {
                selectTransport(type);
            });
            
            suggestionsList.appendChild(suggestionItem);
        }
        
        // Verificar si está cerca de estación de tren
        function isNearTrainStation() {
            if (!lastPosition) return false;
            
            // Simulación: siempre devuelve true si está en Buenos Aires
            const buenosAiresBounds = {
                latMin: -34.70,
                latMax: -34.50,
                lngMin: -58.50,
                lngMax: -58.30
            };
            
            return lastPosition.lat >= buenosAiresBounds.latMin && 
                   lastPosition.lat <= buenosAiresBounds.latMax &&
                   lastPosition.lng >= buenosAiresBounds.lngMin && 
                   lastPosition.lng <= buenosAiresBounds.lngMax;
        }
        
        // Verificar si está cerca de parada de colectivo
        function isNearBusStop() {
            // Simulación: siempre devuelve true en área urbana
            return true;
        }
        
        // Cargar líneas de transporte
        function loadTransportLines(transportType) {
            const linesContainer = document.getElementById('linesContainer');
            linesContainer.innerHTML = '';
            
            if (transportData[transportType]) {
                transportData[transportType].lines.forEach(line => {
                    const lineItem = document.createElement('div');
                    lineItem.className = 'line-item';
                    lineItem.dataset.lineId = line.id;
                    lineItem.dataset.transportType = transportType;
                    
                    lineItem.innerHTML = `
                        <div class="line-name">${line.name}</div>
                        <div class="line-description">${line.description}</div>
                    `;
                    
                    lineItem.addEventListener('click', () => {
                        selectLine(transportType, line);
                    });
                    
                    linesContainer.appendChild(lineItem);
                });
            }
        }
        
        // Seleccionar línea de transporte
        function selectLine(transportType, line) {
            selectedLine = line;
            
            // Remover clase activa de todas las líneas
            document.querySelectorAll('.line-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Agregar clase activa a la línea seleccionada
            document.querySelector(`.line-item[data-line-id="${line.id}"]`).classList.add('active');
            
            // Mostrar línea en el mapa
            showTransportLine(transportType, line);
            
            // Actualizar otros usuarios
            updateOtherUsers(transportType, line.id);
        }
        
        // Mostrar línea de transporte en el mapa
        function showTransportLine(transportType, line) {
            // Eliminar línea anterior
            if (transportLine) {
                map.removeLayer(transportLine);
            }
            
            // Eliminar estaciones anteriores
            stations.forEach(station => map.removeLayer(station));
            stations = [];
            
            // Crear nueva línea
            if (line.coordinates) {
                transportLine = L.polyline(line.coordinates, {
                    color: line.color,
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);
                
                // Añadir estaciones/paradas
                line.coordinates.forEach((coord, index) => {
                    let iconHtml = '';
                    if (transportType === 'train' || transportType === 'subway') {
                        iconHtml = `<div style="background-color:${line.color}; color:white; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold;">${index + 1}</div>`;
                    } else {
                        iconHtml = `<div style="background-color:${line.color}; color:white; border-radius:50%; width:15px; height:15px; display:flex; align-items:center; justify-content:center; font-size:10px;"><i class="fas fa-map-marker-alt"></i></div>`;
                    }
                    
                    const station = L.marker(coord, {
                        icon: L.divIcon({
                            className: 'station-marker',
                            html: iconHtml,
                            iconSize: transportType === 'train' ? [20, 20] : [15, 15],
                            iconAnchor: transportType === 'train' ? [10, 10] : [7, 7]
                        })
                    }).addTo(map);
                    
                    let stationName = '';
                    if (transportType === 'train') {
                        stationName = `Estación ${index + 1}`;
                    } else if (transportType === 'bus') {
                        stationName = `Parada ${index + 1}`;
                    } else {
                        stationName = `Estación ${index + 1}`;
                    }
                    
                    station.bindTooltip(stationName);
                    stations.push(station);
                });
                
                // Ajustar vista del mapa
                if (line.coordinates.length > 0) {
                    const bounds = L.latLngBounds(line.coordinates);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        // Cargar usuarios simulados
        function loadSimulatedUsers() {
            const otherUsersContainer = document.getElementById('otherUsers');
            otherUsersContainer.innerHTML = '';
            
            simulatedUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                userItem.innerHTML = `
                    <div class="user-avatar" style="background-color: ${user.color}">
                        ${user.name.charAt(0)}
                    </div>
                    <div class="user-info">
                        <div class="user-name">${user.name}</div>
                        <div class="user-transport">
                            <i class="${transportData[user.transport].icon}"></i>
                            ${transportData[user.transport].name} - 
                            ${transportData[user.transport].lines.find(l => l.id === user.line)?.name || ''}
                        </div>
                    </div>
                `;
                
                otherUsersContainer.appendChild(userItem);
            });
            
            // Agregar marcadores al mapa
            updateOtherUsersMarkers();
        }
        
        // Actualizar marcadores de otros usuarios
        function updateOtherUsersMarkers() {
            // Eliminar marcadores anteriores
            otherUsersMarkers.forEach(marker => map.removeLayer(marker));
            otherUsersMarkers = [];
            
            // Agregar nuevos marcadores
            simulatedUsers.forEach(user => {
                const marker = L.marker(user.position, {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: `<div style="background-color:${user.color}; color:white; border-radius:50%; width:25px; height:25px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold;">${user.name.charAt(0)}</div>`,
                        iconSize: [25, 25],
                        iconAnchor: [12, 25]
                    })
                }).addTo(map);
                
                marker.bindTooltip(`${user.name} - ${transportData[user.transport].name}`);
                otherUsersMarkers.push(marker);
            });
        }
        
        // Actualizar otros usuarios según el transporte seleccionado
        function updateOtherUsers(transportType, lineId) {
            const otherUsersContainer = document.getElementById('otherUsers');
            otherUsersContainer.innerHTML = '';
            
            // Filtrar usuarios por transporte y línea
            const filteredUsers = simulatedUsers.filter(user => 
                user.transport === transportType && user.line === lineId
            );
            
            if (filteredUsers.length > 0) {
                filteredUsers.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    userItem.innerHTML = `
                        <div class="user-avatar" style="background-color: ${user.color}">
                            ${user.name.charAt(0)}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-transport">
                                <i class="${transportData[user.transport].icon}"></i>
                                Viajando contigo en ${transportData[user.transport].lines.find(l => l.id === user.line)?.name || ''}
                            </div>
                        </div>
                    `;
                    
                    otherUsersContainer.appendChild(userItem);
                });
            } else {
                otherUsersContainer.innerHTML = `
                    <div style="text-align: center; color: #aaa; padding: 20px;">
                        <i class="fas fa-user-friends" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>No hay otros viajeros en esta línea en este momento</p>
                    </div>
                `;
            }
        }
        
        // Inicializar estadísticas
        function initStats() {
            stats.startTime = new Date();
            
            // Actualizar estadísticas cada segundo
            setInterval(updateStats, 1000);
        }
        
        // Actualizar estadísticas
        function updateStats() {
            // Calcular tiempo de viaje
            if (stats.startTime) {
                const now = new Date();
                const diffMs = now - stats.startTime;
                const diffMins = Math.floor(diffMs / 60000);
                document.getElementById('travelTime').textContent = `${diffMins}m`;
            }
            
            // Calcular velocidad promedio
            if (stats.speedSamples.length > 0) {
                const avgSpeed = stats.speedSamples.reduce((a, b) => a + b, 0) / stats.speedSamples.length;
                document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1);
            }
            
            // Mostrar velocidad máxima
            document.getElementById('maxSpeed').textContent = stats.maxSpeed.toFixed(1);
            
            // Mostrar distancia
            document.getElementById('distance').textContent = stats.totalDistance.toFixed(2);
        }
        
        // Cargar estadísticas desde localStorage
        function loadStatsFromStorage() {
            const savedStats = localStorage.getItem('transportStats');
            if (savedStats) {
                try {
                    const parsedStats = JSON.parse(savedStats);
                    stats = { ...stats, ...parsedStats };
                } catch (e) {
                    console.error("Error al cargar estadísticas:", e);
                }
            }
        }
        
        // Guardar estadísticas en localStorage
        function saveStatsToStorage() {
            try {
                localStorage.setItem('transportStats', JSON.stringify(stats));
            } catch (e) {
                console.error("Error al guardar estadísticas:", e);
            }
        }
        
        // Manejar error de geolocalización
        function handleLocationError(error) {
            let message = "";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Permiso de ubicación denegado";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Ubicación no disponible";
                    break;
                case error.TIMEOUT:
                    message = "Tiempo de espera agotado";
                    break;
                case error.UNKNOWN_ERROR:
                    message = "Error desconocido";
                    break;
            }
            
            console.error("Error de geolocalización:", message);
        }
    </script>
</body>
</html>