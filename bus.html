<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seguimiento en Tiempo Real</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            color: white;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* ===== HUD SUPERIOR TRANSPARENTE ===== */
        .top-hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }
        
        .stats-container {
            background: rgba(0, 0, 0, 0.85);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            width: 100%;
            max-width: 400px;
            pointer-events: auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px;
            border-left: 3px solid #007AFF;
        }
        
        .stat-card.speed {
            border-left-color: #FF3B30;
        }
        
        .stat-card.direction {
            border-left-color: #34C759;
        }
        
        .stat-card.distance {
            border-left-color: #5856D6;
        }
        
        .stat-card.accuracy {
            border-left-color: #FF9500;
        }
        
        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-weight: 700;
            font-size: 18px;
            font-variant-numeric: tabular-nums;
        }
        
        .stat-unit {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 2px;
        }
        
        .transport-selector {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .transport-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .transport-btn.active {
            background: #007AFF;
        }
        
        /* ===== HUD INFERIOR TRANSPARENTE ===== */
        .bottom-hud {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            pointer-events: none;
        }
        
        .direction-container {
            background: rgba(0, 0, 0, 0.85);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            pointer-events: auto;
            margin-bottom: 10px;
        }
        
        .direction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .direction-arrow {
            font-size: 24px;
            color: #34C759;
            transition: transform 0.3s;
        }
        
        .direction-text {
            font-weight: 600;
            font-size: 16px;
        }
        
        .stations-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .station-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
        }
        
        .station-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .station-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .station-distance {
            font-size: 11px;
            opacity: 0.7;
        }
        
        /* ===== SELECTOR DE LÍNEA ===== */
        .line-selector {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            max-height: 70vh;
            overflow-y: auto;
            display: none;
            pointer-events: auto;
        }
        
        .line-selector.show {
            display: block;
        }
        
        .line-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .line-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .close-lines {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        
        .line-buttons {
            display: grid;
            gap: 8px;
        }
        
        .line-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .line-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .line-btn.active {
            background: #007AFF;
        }
        
        /* ===== MARCADORES ANIMADOS ===== */
        .user-marker {
            background: #007AFF;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            border: 3px solid white;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
            position: relative;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .user-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        .user-marker.moving {
            animation: pulse 1s infinite;
        }
        
        .station-marker {
            background: #34C759;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.3);
        }
        
        .next-station-marker {
            background: #FF3B30;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.3);
            animation: pulse-red 1.5s infinite;
        }
        
        /* ===== LÍNEA DE DIRECCIÓN ANIMADA ===== */
        .direction-line {
            stroke: #007AFF;
            stroke-width: 4;
            stroke-dasharray: 10, 5;
            animation: dash 1s linear infinite;
            stroke-linecap: round;
        }
        
        .accuracy-circle {
            fill: rgba(0, 122, 255, 0.1);
            stroke: rgba(0, 122, 255, 0.3);
            stroke-width: 1;
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.7);
            }
            50% { 
                transform: scale(1.05);
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(0, 122, 255, 0);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0);
            }
        }
        
        @keyframes pulse-red {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes dash {
            to { stroke-dashoffset: 15; }
        }
        
        /* ===== EFECTO DE VELOCIDAD ===== */
        .speed-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .speed-effect.active {
            opacity: 0.1;
        }
        
        /* ===== CONTADOR DE TIEMPO REAL ===== */
        .live-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 10px;
            padding: 8px 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 1000;
            font-size: 12px;
            font-weight: 600;
            color: #34C759;
            display: flex;
            align-items: center;
            gap: 6px;
            pointer-events: auto;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: #34C759;
            border-radius: 50%;
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stations-info {
                grid-template-columns: 1fr;
            }
            
            .top-hud {
                flex-direction: column;
                gap: 10px;
            }
            
            .stats-container {
                max-width: none;
            }
            
            .line-selector {
                left: 10px;
                right: 10px;
                top: auto;
                bottom: 10px;
                transform: none;
                max-height: 50vh;
            }
        }
        
        @media (max-width: 480px) {
            .stat-value {
                font-size: 16px;
            }
            
            .transport-btn {
                font-size: 10px;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <!-- Mapa a pantalla completa -->
    <div id="map"></div>
    
    <!-- Efecto de velocidad -->
    <div class="speed-effect" id="speedEffect"></div>
    
    <!-- Indicador en vivo -->
    <div class="live-counter" id="liveCounter">
        <div class="live-dot"></div>
        <span>EN VIVO</span>
    </div>
    
    <!-- HUD Superior -->
    <div class="top-hud">
        <div class="stats-container">
            <div class="stats-grid">
                <div class="stat-card speed">
                    <div class="stat-label">Velocidad</div>
                    <div class="stat-value">
                        <span id="speedValue">0.0</span>
                        <span class="stat-unit">km/h</span>
                    </div>
                </div>
                
                <div class="stat-card direction">
                    <div class="stat-label">Dirección</div>
                    <div class="stat-value">
                        <span id="directionValue">-</span>
                    </div>
                </div>
                
                <div class="stat-card distance">
                    <div class="stat-label">Distancia</div>
                    <div class="stat-value">
                        <span id="distanceValue">0.00</span>
                        <span class="stat-unit">km</span>
                    </div>
                </div>
                
                <div class="stat-card accuracy">
                    <div class="stat-label">Precisión</div>
                    <div class="stat-value">
                        <span id="accuracyValue">-</span>
                        <span class="stat-unit">m</span>
                    </div>
                </div>
            </div>
            
            <div class="transport-selector">
                <button class="transport-btn active" onclick="selectTransport('train')">
                    <i class="fas fa-train"></i>
                    <span>Tren</span>
                </button>
                <button class="transport-btn" onclick="selectTransport('subte')">
                    <i class="fas fa-subway"></i>
                    <span>Subte</span>
                </button>
                <button class="transport-btn" onclick="selectTransport('bus')">
                    <i class="fas fa-bus"></i>
                    <span>Colectivo</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- HUD Inferior -->
    <div class="bottom-hud">
        <div class="direction-container">
            <div class="direction-header">
                <div class="direction-arrow" id="directionArrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
                <div class="direction-text" id="directionText">Selecciona una línea</div>
            </div>
            
            <div class="stations-info">
                <div class="station-info">
                    <div class="station-label">Estación actual</div>
                    <div class="station-name" id="currentStationName">-</div>
                    <div class="station-distance" id="currentStationDistance">-</div>
                </div>
                
                <div class="station-info">
                    <div class="station-label">Próxima estación</div>
                    <div class="station-name" id="nextStationName">-</div>
                    <div class="station-distance" id="nextStationDistance">-</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Selector de línea (oculto por defecto) -->
    <div class="line-selector" id="lineSelector">
        <div class="line-header">
            <div class="line-title">Selecciona línea</div>
            <button class="close-lines" onclick="toggleLineSelector()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="line-buttons" id="lineButtons">
            <!-- Líneas cargadas dinámicamente -->
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACIÓN INICIAL
        // ============================================
        
        // Inicializar mapa con vista de Buenos Aires
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            inertia: true,
            inertiaDeceleration: 3000,
            inertiaMaxSpeed: 1500
        }).setView([-34.6037, -58.3816], 14);
        
        // Capa base oscura de alto contraste
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);
        
        // Variables de estado
        let userMarker = null;
        let userCircle = null;
        let stationMarkers = [];
        let nextStationMarker = null;
        let directionLine = null;
        let watchId = null;
        let animationFrameId = null;
        
        // Estado del seguimiento
        let currentTransport = 'train';
        let currentLine = null;
        let currentStations = [];
        let currentStationIndex = -1;
        let travelDirection = null;
        
        // Variables de movimiento con alta precisión
        let lastPosition = null;
        let positionHistory = [];
        let totalDistance = 0;
        let currentSpeed = 0;
        let currentBearing = 0;
        let accuracy = 0;
        
        // Para cálculos de aceleración
        let lastSpeeds = [];
        let acceleration = 0;
        let maxSpeed = 0;
        
        // Base de datos mejorada con más estaciones
        const stationDatabase = {
            train: {
                sarmiento: [
                    { name: 'Once', lat: -34.609722, lng: -58.408889, order: 0 },
                    { name: 'Caballito', lat: -34.618611, lng: -58.441944, order: 1 },
                    { name: 'Flores', lat: -34.629167, lng: -58.463056, order: 2 },
                    { name: 'Floresta', lat: -34.634444, lng: -58.480278, order: 3 },
                    { name: 'Villa Luro', lat: -34.637778, lng: -58.502222, order: 4 },
                    { name: 'Liniers', lat: -34.641667, lng: -58.523889, order: 5 },
                    { name: 'Ciudadela', lat: -34.646111, lng: -58.535833, order: 6 },
                    { name: 'Ramos Mejía', lat: -34.648333, lng: -58.561389, order: 7 },
                    { name: 'Haedo', lat: -34.650833, lng: -58.591111, order: 8 },
                    { name: 'Morón', lat: -34.650833, lng: -58.621111, order: 9 },
                    { name: 'Castelar', lat: -34.656944, lng: -58.6525, order: 10 },
                    { name: 'Ituzaingó', lat: -34.659167, lng: -58.671944, order: 11 },
                    { name: 'San Antonio de Padua', lat: -34.6625, lng: -58.701111, order: 12 },
                    { name: 'Merlo', lat: -34.665833, lng: -58.728056, order: 13 },
                    { name: 'Paso del Rey', lat: -34.656944, lng: -58.761111, order: 14 },
                    { name: 'Moreno', lat: -34.635, lng: -58.791111, order: 15 }
                ],
                mitre: [
                    { name: 'Retiro', lat: -34.591389, lng: -58.373889, order: 0 },
                    { name: 'Lisandro de la Torre', lat: -34.595833, lng: -58.4075, order: 1 },
                    { name: 'Migueletes', lat: -34.556667, lng: -58.462778, order: 2 },
                    { name: 'Vicente López', lat: -34.530833, lng: -58.474722, order: 3 },
                    { name: 'Olivos', lat: -34.5075, lng: -58.4875, order: 4 },
                    { name: 'La Lucila', lat: -34.495833, lng: -58.493889, order: 5 },
                    { name: 'Martínez', lat: -34.488889, lng: -58.504167, order: 6 },
                    { name: 'Acassuso', lat: -34.476667, lng: -58.509167, order: 7 },
                    { name: 'San Isidro', lat: -34.470556, lng: -58.521389, order: 8 },
                    { name: 'Beccar', lat: -34.461944, lng: -58.535556, order: 9 },
                    { name: 'Victoria', lat: -34.4525, lng: -58.556111, order: 10 },
                    { name: 'Virreyes', lat: -34.450556, lng: -58.570556, order: 11 },
                    { name: 'San Fernando', lat: -34.444722, lng: -58.588889, order: 12 },
                    { name: 'Carupá', lat: -34.436667, lng: -58.610833, order: 13 },
                    { name: 'Tigre', lat: -34.420556, lng: -58.579722, order: 14 }
                ],
                roca: [
                    { name: 'Constitución', lat: -34.628056, lng: -58.381111, order: 0 },
                    { name: 'Parque Patricios', lat: -34.640833, lng: -58.404444, order: 1 },
                    { name: 'Avellaneda', lat: -34.663611, lng: -58.367222, order: 2 },
                    { name: 'Sarandí', lat: -34.678889, lng: -58.331944, order: 3 },
                    { name: 'Wilde', lat: -34.696944, lng: -58.316944, order: 4 },
                    { name: 'Don Bosco', lat: -34.705278, lng: -58.299444, order: 5 },
                    { name: 'Bernal', lat: -34.714722, lng: -58.281667, order: 6 },
                    { name: 'Quilmes', lat: -34.7225, lng: -58.267222, order: 7 },
                    { name: 'Ezpeleta', lat: -34.751667, lng: -58.234722, order: 8 },
                    { name: 'Berazategui', lat: -34.765, lng: -58.212778, order: 9 },
                    { name: 'Plátanos', lat: -34.779722, lng: -58.195833, order: 10 },
                    { name: 'Hudson', lat: -34.793056, lng: -58.178889, order: 11 },
                    { name: 'Pereyra', lat: -34.805, lng: -58.089722, order: 12 },
                    { name: 'La Plata', lat: -34.910556, lng: -57.956389, order: 13 }
                ]
            },
            subte: {
                linea_a: [
                    { name: 'Plaza de Mayo', lat: -34.6086, lng: -58.3713, order: 0 },
                    { name: 'Perú', lat: -34.6094, lng: -58.3738, order: 1 },
                    { name: 'Piedras', lat: -34.6100, lng: -58.3762, order: 2 },
                    { name: 'Lima', lat: -34.6107, lng: -58.3790, order: 3 },
                    { name: 'Sáenz Peña', lat: -34.6112, lng: -58.3818, order: 4 },
                    { name: 'Congreso', lat: -34.6097, lng: -58.3888, order: 5 },
                    { name: 'Pasco', lat: -34.6086, lng: -58.3931, order: 6 },
                    { name: 'Alberti', lat: -34.6075, lng: -58.3969, order: 7 },
                    { name: 'Plaza Miserere', lat: -34.6089, lng: -58.4075, order: 8 },
                    { name: 'Loria', lat: -34.6106, lng: -58.4108, order: 9 },
                    { name: 'Castro Barros', lat: -34.6122, lng: -58.4142, order: 10 },
                    { name: 'Río de Janeiro', lat: -34.6139, lng: -58.4175, order: 11 },
                    { name: 'Acoyte', lat: -34.6156, lng: -58.4208, order: 12 },
                    { name: 'Primera Junta', lat: -34.6172, lng: -58.4242, order: 13 },
                    { name: 'Puán', lat: -34.6189, lng: -58.4275, order: 14 },
                    { name: 'Carabobo', lat: -34.6206, lng: -58.4308, order: 15 },
                    { name: 'San José de Flores', lat: -34.6222, lng: -58.4342, order: 16 },
                    { name: 'San Pedrito', lat: -34.6239, lng: -58.4375, order: 17 }
                ]
            }
        };
        
        // Líneas disponibles
        const transportLines = {
            train: [
                { id: 'sarmiento', name: 'Sarmiento', color: '#007AFF' },
                { id: 'mitre', name: 'Mitre', color: '#5856D6' },
                { id: 'roca', name: 'Roca', color: '#34C759' }
            ],
            subte: [
                { id: 'linea_a', name: 'Línea A', color: '#00A3E0' }
            ],
            bus: [
                { id: 'linea_1', name: 'Línea 1', color: '#FF9500' }
            ]
        };
        
        // ============================================
        // FUNCIONES DE INTERFAZ Y ANIMACIÓN
        // ============================================
        
        function toggleLineSelector() {
            const selector = document.getElementById('lineSelector');
            selector.classList.toggle('show');
        }
        
        function updateLiveStats() {
            // Actualizar valores en HUD con formato
            document.getElementById('speedValue').textContent = currentSpeed.toFixed(1);
            document.getElementById('directionValue').textContent = getDirectionFromBearing(currentBearing);
            document.getElementById('distanceValue').textContent = (totalDistance / 1000).toFixed(2);
            document.getElementById('accuracyValue').textContent = Math.round(accuracy);
            
            // Efecto visual según velocidad
            const speedEffect = document.getElementById('speedEffect');
            if (currentSpeed > 30) {
                speedEffect.classList.add('active');
                speedEffect.style.background = `radial-gradient(circle at center, 
                    rgba(255, 59, 48, 0.2) 0%, 
                    rgba(255, 59, 48, 0.1) 50%, 
                    transparent 70%)`;
            } else if (currentSpeed > 10) {
                speedEffect.classList.add('active');
                speedEffect.style.background = `radial-gradient(circle at center, 
                    rgba(0, 122, 255, 0.1) 0%, 
                    rgba(0, 122, 255, 0.05) 50%, 
                    transparent 70%)`;
            } else {
                speedEffect.classList.remove('active');
            }
            
            // Actualizar animación del marcador
            if (userMarker) {
                const icon = userMarker.options.icon;
                if (currentSpeed > 1) {
                    icon.options.className = 'user-marker moving';
                } else {
                    icon.options.className = 'user-marker';
                }
                userMarker.setIcon(icon);
            }
            
            // Actualizar cada frame
            animationFrameId = requestAnimationFrame(updateLiveStats);
        }
        
        function getDirectionFromBearing(bearing) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                               'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];
            const index = Math.round(bearing / 22.5) % 16;
            return directions[index];
        }
        
        // ============================================
        // SEGUIMIENTO EN TIEMPO REAL
        // ============================================
        
        function startRealTimeTracking() {
            if (!navigator.geolocation) {
                alert('GPS no disponible en este dispositivo');
                return;
            }
            
            // Configurar para máxima precisión
            const options = {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            };
            
            // Obtener posición inicial
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    handlePositionUpdate(position);
                    map.setView([position.coords.latitude, position.coords.longitude], 15);
                    
                    // Iniciar animaciones
                    animationFrameId = requestAnimationFrame(updateLiveStats);
                },
                (error) => {
                    console.error('Error GPS:', error);
                    // Usar ubicación por defecto
                    handlePositionUpdate({
                        coords: {
                            latitude: -34.6037,
                            longitude: -58.3816,
                            accuracy: 50,
                            speed: 0,
                            heading: 0
                        },
                        timestamp: Date.now()
                    });
                },
                options
            );
            
            // Seguimiento continuo con alta frecuencia
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    handlePositionUpdate(position);
                    
                    // Análisis automático si hay línea seleccionada
                    if (currentLine) {
                        analyzeMovement(position);
                        checkProximityToStations();
                        updateDirection();
                    }
                },
                (error) => {
                    console.error('Error seguimiento:', error);
                },
                options
            );
        }
        
        function handlePositionUpdate(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            accuracy = position.coords.accuracy;
            
            // Guardar en historial para cálculos
            const newPosition = {
                lat: lat,
                lng: lng,
                timestamp: position.timestamp || Date.now(),
                speed: position.coords.speed || 0,
                heading: position.coords.heading || 0
            };
            
            // Calcular velocidad si está disponible del GPS
            if (position.coords.speed !== null && position.coords.speed > 0) {
                currentSpeed = position.coords.speed * 3.6; // m/s a km/h
            }
            
            // Usar heading del GPS si está disponible
            if (position.coords.heading !== null) {
                currentBearing = position.coords.heading;
            }
            
            // Guardar posición anterior para cálculos
            if (lastPosition) {
                const distance = calculateDistance(
                    lastPosition.lat, lastPosition.lng,
                    lat, lng
                );
                
                const timeDiff = (newPosition.timestamp - lastPosition.timestamp) / 1000;
                
                // Calcular velocidad si no viene del GPS
                if (position.coords.speed === null && timeDiff > 0) {
                    currentSpeed = (distance / timeDiff) * 3.6;
                    
                    // Calcular rumbo
                    if (distance > 1) { // Evitar errores con distancias mínimas
                        currentBearing = calculateBearing(
                            lastPosition.lat, lastPosition.lng,
                            lat, lng
                        );
                    }
                }
                
                totalDistance += distance;
            }
            
            lastPosition = newPosition;
            positionHistory.push(newPosition);
            
            // Limitar historial
            if (positionHistory.length > 50) {
                positionHistory.shift();
            }
            
            // Actualizar marcador en el mapa
            updateUserMarker(lat, lng);
            
            // Actualizar círculo de precisión
            updateAccuracyCircle(lat, lng, accuracy);
            
            // Seguir al usuario con el mapa
            followUser(lat, lng);
        }
        
        function updateUserMarker(lat, lng) {
            // Interpolación suave para movimiento continuo
            if (userMarker) {
                const currentLatLng = userMarker.getLatLng();
                const newLatLng = L.latLng(lat, lng);
                
                // Interpolación lineal para movimiento suave
                const steps = 10;
                let currentStep = 0;
                
                function animateMove() {
                    if (currentStep <= steps) {
                        const t = currentStep / steps;
                        const easedT = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                        
                        const interpolatedLat = currentLatLng.lat + (newLatLng.lat - currentLatLng.lat) * easedT;
                        const interpolatedLng = currentLatLng.lng + (newLatLng.lng - currentLatLng.lng) * easedT;
                        
                        userMarker.setLatLng([interpolatedLat, interpolatedLng]);
                        
                        if (directionLine) {
                            updateDirectionLine();
                        }
                        
                        currentStep++;
                        requestAnimationFrame(animateMove);
                    }
                }
                
                animateMove();
            } else {
                // Primer marcador
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
            }
        }
        
        function updateAccuracyCircle(lat, lng, radius) {
            if (userCircle) {
                userCircle.setLatLng([lat, lng]);
                userCircle.setRadius(radius);
            } else {
                userCircle = L.circle([lat, lng], {
                    radius: radius,
                    color: '#007AFF',
                    fillColor: '#007AFF',
                    fillOpacity: 0.1,
                    className: 'accuracy-circle'
                }).addTo(map);
            }
        }
        
        function followUser(lat, lng) {
            // Seguir al usuario suavemente
            const currentCenter = map.getCenter();
            const targetCenter = L.latLng(lat, lng);
            
            // Solo ajustar si está lejos del centro
            const distanceToCenter = currentCenter.distanceTo(targetCenter);
            if (distanceToCenter > 100) { // Más de 100 metros
                const newCenter = L.latLng(
                    currentCenter.lat + (targetCenter.lat - currentCenter.lat) * 0.1,
                    currentCenter.lng + (targetCenter.lng - currentCenter.lng) * 0.1
                );
                map.panTo(newCenter, { animate: true, duration: 0.5 });
            }
        }
        
        function analyzeMovement(position) {
            if (positionHistory.length < 2) return;
            
            // Calcular aceleración
            if (lastSpeeds.length > 0) {
                const timeDiff = (position.timestamp - positionHistory[positionHistory.length - 2].timestamp) / 1000;
                if (timeDiff > 0) {
                    const speedDiff = currentSpeed - lastSpeeds[lastSpeeds.length - 1];
                    acceleration = speedDiff / timeDiff; // km/h/s
                }
            }
            
            // Guardar velocidad para cálculos futuros
            lastSpeeds.push(currentSpeed);
            if (lastSpeeds.length > 10) {
                lastSpeeds.shift();
            }
            
            // Actualizar velocidad máxima
            if (currentSpeed > maxSpeed) {
                maxSpeed = currentSpeed;
            }
        }
        
        // ============================================
        // TRANSPORTE Y DIRECCIÓN
        // ============================================
        
        function selectTransport(type) {
            currentTransport = type;
            
            // Actualizar botones
            document.querySelectorAll('.transport-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.transport-btn.${type}`).classList.add('active');
            
            // Mostrar selector de línea
            loadLineButtons(type);
            toggleLineSelector();
        }
        
        function loadLineButtons(type) {
            const lineButtons = document.getElementById('lineButtons');
            const lines = transportLines[type];
            
            lineButtons.innerHTML = '';
            
            lines.forEach(line => {
                const button = document.createElement('button');
                button.className = 'line-btn';
                button.innerHTML = `
                    <i class="fas ${type === 'train' ? 'fa-train' : type === 'subte' ? 'fa-subway' : 'fa-bus'}"></i>
                    <span>${line.name}</span>
                `;
                button.onclick = () => {
                    selectLine(line.id, line.name, line.color);
                    toggleLineSelector();
                };
                lineButtons.appendChild(button);
            });
        }
        
        function selectLine(lineId, lineName, lineColor) {
            currentLine = lineId;
            
            // Cargar estaciones
            loadStationsForLine(lineId, lineName);
            
            // Actualizar UI
            document.getElementById('directionText').textContent = `Línea ${lineName}`;
            document.getElementById('directionArrow').style.color = lineColor;
        }
        
        function loadStationsForLine(lineId, lineName) {
            if (!currentTransport || !stationDatabase[currentTransport][lineId]) {
                alert('Datos no disponibles para esta línea');
                return;
            }
            
            currentStations = stationDatabase[currentTransport][lineId];
            currentStations.sort((a, b) => a.order - b.order);
            
            // Limpiar marcadores anteriores
            clearStationMarkers();
            
            // Agregar estaciones al mapa
            currentStations.forEach((station, index) => {
                const marker = L.marker([station.lat, station.lng], {
                    icon: L.divIcon({
                        className: 'station-marker',
                        iconSize: [20, 20]
                    })
                })
                .bindPopup(`
                    <div style="text-align: center; padding: 8px;">
                        <strong style="font-size: 14px;">${station.name}</strong><br>
                        <small style="opacity: 0.7;">${lineName}</small><br>
                        <small style="opacity: 0.5;">Orden: ${station.order + 1}</small>
                    </div>
                `)
                .addTo(map);
                
                stationMarkers.push(marker);
            });
            
            // Encontrar estación más cercana
            if (userMarker) {
                const userLatLng = userMarker.getLatLng();
                findNearestStation(userLatLng.lat, userLatLng.lng);
            }
        }
        
        function findNearestStation(userLat, userLng) {
            if (currentStations.length === 0) return;
            
            let nearestIndex = 0;
            let nearestDistance = Infinity;
            
            currentStations.forEach((station, index) => {
                const distance = calculateDistance(userLat, userLng, station.lat, station.lng);
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestIndex = index;
                }
            });
            
            currentStationIndex = nearestIndex;
            
            // Determinar dirección automáticamente
            determineTravelDirection();
            
            updateStationInfo();
        }
        
        function determineTravelDirection() {
            if (!currentBearing || currentStationIndex < 0) return;
            
            // Lógica por línea
            if (currentLine === 'sarmiento') {
                if (currentBearing >= 225 && currentBearing <= 315) {
                    travelDirection = 'west'; // Hacia Moreno
                } else if (currentBearing >= 45 && currentBearing <= 135) {
                    travelDirection = 'east'; // Hacia Once
                } else {
                    // Por defecto basado en posición
                    const currentStation = currentStations[currentStationIndex];
                    if (currentStationIndex < currentStations.length - 1) {
                        const nextStation = currentStations[currentStationIndex + 1];
                        travelDirection = nextStation.lng < currentStation.lng ? 'west' : 'east';
                    } else {
                        travelDirection = 'west';
                    }
                }
            } else if (currentLine === 'mitre') {
                if (currentBearing >= 315 || currentBearing < 45) {
                    travelDirection = 'north'; // Hacia Tigre
                } else if (currentBearing >= 135 && currentBearing < 225) {
                    travelDirection = 'south'; // Hacia Retiro
                } else {
                    travelDirection = 'north';
                }
            } else if (currentLine === 'roca') {
                if (currentBearing >= 135 && currentBearing < 225) {
                    travelDirection = 'south'; // Hacia La Plata
                } else if (currentBearing >= 315 || currentBearing < 45) {
                    travelDirection = 'north'; // Hacia Constitución
                } else {
                    travelDirection = 'south';
                }
            }
            
            updateDirectionDisplay();
        }
        
        function updateDirection() {
            if (currentStationIndex < 0 || !travelDirection) return;
            
            // Actualizar estación más cercana
            if (userMarker) {
                const userLatLng = userMarker.getLatLng();
                findNearestStation(userLatLng.lat, userLatLng.lng);
            }
            
            // Actualizar línea de dirección
            updateDirectionLine();
        }
        
        function updateDirectionDisplay() {
            const arrow = document.getElementById('directionArrow');
            
            if (!travelDirection) return;
            
            // Rotar flecha según dirección
            const rotations = {
                'east': 'rotate(0deg)',
                'west': 'rotate(180deg)',
                'north': 'rotate(-90deg)',
                'south': 'rotate(90deg)'
            };
            
            arrow.style.transform = rotations[travelDirection] || 'rotate(0deg)';
            
            // Actualizar texto de dirección
            if (currentLine === 'sarmiento') {
                document.getElementById('directionText').textContent = 
                    travelDirection === 'west' ? 'Hacia Moreno (Oeste)' : 'Hacia Once (Este)';
            } else if (currentLine === 'mitre') {
                document.getElementById('directionText').textContent = 
                    travelDirection === 'north' ? 'Hacia Tigre (Norte)' : 'Hacia Retiro (Sur)';
            } else if (currentLine === 'roca') {
                document.getElementById('directionText').textContent = 
                    travelDirection === 'south' ? 'Hacia La Plata (Sur)' : 'Hacia Constitución (Norte)';
            }
            
            updateStationInfo();
        }
        
        function updateStationInfo() {
            if (currentStationIndex < 0 || currentStations.length === 0) return;
            
            const currentStation = currentStations[currentStationIndex];
            let nextIndex;
            
            if (travelDirection === 'east' || travelDirection === 'south') {
                nextIndex = Math.min(currentStationIndex + 1, currentStations.length - 1);
            } else {
                nextIndex = Math.max(currentStationIndex - 1, 0);
            }
            
            const nextStation = currentStations[nextIndex];
            
            // Actualizar UI
            document.getElementById('currentStationName').textContent = currentStation.name;
            document.getElementById('nextStationName').textContent = nextStation.name;
            
            // Calcular y mostrar distancias
            if (userMarker) {
                const userLatLng = userMarker.getLatLng();
                
                const currentDistance = calculateDistance(
                    userLatLng.lat, userLatLng.lng,
                    currentStation.lat, currentStation.lng
                );
                
                const nextDistance = calculateDistance(
                    userLatLng.lat, userLatLng.lng,
                    nextStation.lat, nextStation.lng
                );
                
                document.getElementById('currentStationDistance').textContent = 
                    `${(currentDistance).toFixed(0)} metros`;
                document.getElementById('nextStationDistance').textContent = 
                    `${(nextDistance).toFixed(0)} metros`;
                
                // Actualizar marcador de próxima estación
                updateNextStationMarker(nextStation);
            }
        }
        
        function updateNextStationMarker(station) {
            // Eliminar marcador anterior
            if (nextStationMarker) {
                map.removeLayer(nextStationMarker);
            }
            
            // Crear nuevo marcador
            nextStationMarker = L.marker([station.lat, station.lng], {
                icon: L.divIcon({
                    className: 'next-station-marker',
                    iconSize: [26, 26]
                })
            })
            .bindPopup(`<strong>Próxima estación: ${station.name}</strong>`)
            .addTo(map);
            
            // Actualizar línea de dirección
            updateDirectionLine();
        }
        
        function updateDirectionLine() {
            if (!userMarker || !nextStationMarker) return;
            
            const userLatLng = userMarker.getLatLng();
            const stationLatLng = nextStationMarker.getLatLng();
            
            // Eliminar línea anterior
            if (directionLine) {
                map.removeLayer(directionLine);
            }
            
            // Crear nueva línea con animación
            directionLine = L.polyline([userLatLng, stationLatLng], {
                color: '#007AFF',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 5',
                className: 'direction-line'
            }).addTo(map);
        }
        
        function checkProximityToStations() {
            if (!userMarker || currentStationIndex < 0) return;
            
            const userLatLng = userMarker.getLatLng();
            const currentStation = currentStations[currentStationIndex];
            
            const distance = calculateDistance(
                userLatLng.lat, userLatLng.lng,
                currentStation.lat, currentStation.lng
            );
            
            // Notificar llegada si está cerca
            if (distance < 50) {
                // Avanzar a siguiente estación
                if (travelDirection === 'east' || travelDirection === 'south') {
                    if (currentStationIndex < currentStations.length - 1) {
                        currentStationIndex++;
                    }
                } else {
                    if (currentStationIndex > 0) {
                        currentStationIndex--;
                    }
                }
                
                updateStationInfo();
            }
        }
        
        function clearStationMarkers() {
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
            
            if (nextStationMarker) {
                map.removeLayer(nextStationMarker);
                nextStationMarker = null;
            }
            
            if (directionLine) {
                map.removeLayer(directionLine);
                directionLine = null;
            }
        }
        
        // ============================================
        // FUNCIONES UTILITARIAS
        // ============================================
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            const θ = Math.atan2(y, x);
            
            return (θ * 180 / Math.PI + 360) % 360;
        }
        
        // ============================================
        // INICIALIZACIÓN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Iniciar seguimiento inmediatamente
            startRealTimeTracking();
            
            // Cargar línea por defecto
            setTimeout(() => {
                loadLineButtons('train');
            }, 1000);
            
            // Ocultar selector de línea al tocar fuera
            document.addEventListener('click', function(e) {
                const selector = document.getElementById('lineSelector');
                const transportBtns = document.querySelectorAll('.transport-btn');
                
                if (!selector.contains(e.target) && 
                    !Array.from(transportBtns).some(btn => btn.contains(e.target)) &&
                    selector.classList.contains('show')) {
                    selector.classList.remove('show');
                }
            });
        });
        
        // Limpiar animaciones al cerrar
        window.addEventListener('beforeunload', function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        });
    </script>
</body>
</html>