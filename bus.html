<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Tren - Precisi√≥n Militar</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #000; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            touch-action: pan-x pan-y;
        }
        
        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        /* ===== BARRA SUPERIOR ===== */
        .top-bar {
            position: fixed;
            top: env(safe-area-inset-top, 10px);
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            height: 65px;
        }
        
        .gps-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .gps-indicator {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #34C759, #28A745);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }
        
        .gps-info {
            display: flex;
            flex-direction: column;
        }
        
        .gps-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .gps-subtitle {
            color: #34C759;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .top-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon-button {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .icon-button:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* ===== INDICADOR DE VELOCIDAD PRECISO ===== */
        .speed-indicator {
            position: fixed;
            top: 85px;
            right: 15px;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(40px);
            border-radius: 20px;
            padding: 18px 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 999;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            min-width: 150px;
            animation: slideInRight 0.3s ease;
        }
        
        .speed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .speed-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .gps-accuracy {
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .speed-value {
            color: #34C759;
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(52, 199, 89, 0.7);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }
        
        .speed-direction {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .direction-arrow {
            font-size: 16px;
        }
        
        /* ===== PANEL DE CONTROL INFERIOR ===== */
        .control-panel {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 10px);
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 1000;
            padding: 20px;
            box-shadow: 0 -15px 60px rgba(0, 0, 0, 0.7);
        }
        
        .line-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .line-name {
            color: white;
            font-size: 18px;
            font-weight: 700;
        }
        
        .line-status {
            color: #34C759;
            font-size: 12px;
            background: rgba(52, 199, 89, 0.15);
            padding: 6px 12px;
            border-radius: 12px;
        }
        
        .station-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .station-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 15px;
            border-left: 4px solid transparent;
        }
        
        .station-item.current {
            border-left-color: #007AFF;
            background: rgba(0, 122, 255, 0.1);
        }
        
        .station-item.next {
            border-left-color: #34C759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .station-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        
        .station-name {
            color: white;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .station-distance {
            color: #34C759;
            font-size: 13px;
            font-weight: 600;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .control-button {
            padding: 14px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        
        .control-button:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .control-button.active {
            background: rgba(0, 122, 255, 0.2);
            border-color: #007AFF;
            color: #007AFF;
        }
        
        .button-icon {
            font-size: 18px;
        }
        
        .button-text {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        /* ===== MARCADORES ===== */
        .user-marker {
            border: 3px solid white;
            box-shadow: 0 0 30px rgba(0, 122, 255, 0.9);
            animation: gpsPulse 2s infinite;
        }
        
        .station-marker {
            border: 3px solid white;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.4);
        }
        
        .station-marker.current {
            border-color: #007AFF;
            box-shadow: 0 0 30px rgba(0, 122, 255, 0.8);
            animation: stationPulse 1.5s infinite;
        }
        
        .station-marker.next {
            border-color: #34C759;
            box-shadow: 0 0 30px rgba(52, 199, 89, 0.8);
            animation: stationPulse 1.5s infinite;
        }
        
        /* ===== RUTA CORREGIDA ===== */
        .route-line {
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(1.05);
            }
        }
        
        @keyframes gpsPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(0, 122, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0);
            }
        }
        
        @keyframes stationPulse {
            0%, 100% { 
                transform: scale(1);
            }
            50% { 
                transform: scale(1.1);
            }
        }
        
        @keyframes slideInRight {
            from { 
                opacity: 0;
                transform: translateX(20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (min-width: 768px) {
            .speed-indicator {
                top: 90px;
                right: 25px;
                padding: 20px 24px;
                min-width: 160px;
            }
            
            .control-panel {
                left: 20px;
                right: 20px;
                padding: 24px;
            }
            
            .top-bar {
                padding: 15px 25px;
            }
        }
        
        @media (max-width: 350px) {
            .control-panel {
                padding: 15px;
            }
            
            .station-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .speed-indicator {
                min-width: 130px;
                padding: 15px;
            }
            
            .speed-value {
                font-size: 28px;
            }
            
            .control-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ===== HIDDEN ===== */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Barra Superior -->
    <div class="top-bar" id="topBar">
        <div class="gps-status">
            <div class="gps-indicator" id="gpsIndicator">üì°</div>
            <div class="gps-info">
                <div class="gps-title">GPS TREN CORREGIDO</div>
                <div class="gps-subtitle" id="gpsSubtitle">SIN SALTOS - SIN RETROCESOS</div>
            </div>
        </div>
        
        <div class="top-actions">
            <button class="icon-button" onclick="centerOnUser()" title="Centrar en mi ubicaci√≥n">
                üìç
            </button>
            <button class="icon-button" onclick="toggleRoute()" title="Mostrar/ocultar ruta">
                üõ§Ô∏è
            </button>
        </div>
    </div>
    
    <!-- Indicador de Velocidad Preciso -->
    <div class="speed-indicator" id="speedIndicator">
        <div class="speed-header">
            <div class="speed-label">VELOCIDAD</div>
            <div class="gps-accuracy" id="gpsAccuracy">-- m</div>
        </div>
        <div class="speed-value" id="speedValue">0.0 km/h</div>
        <div class="speed-direction">
            <span class="direction-arrow" id="directionArrow">‚Üí</span>
            <span id="directionText">NORTE</span>
        </div>
    </div>
    
    <!-- Panel de Control -->
    <div class="control-panel" id="controlPanel">
        <div class="line-info">
            <div class="line-name" id="lineName">L√çNEA SARMIENTO</div>
            <div class="line-status" id="lineStatus">GPS ACTIVO</div>
        </div>
        
        <div class="station-info">
            <div class="station-item current">
                <div class="station-label">ESTACI√ìN ACTUAL</div>
                <div class="station-name" id="currentStation">-</div>
                <div class="station-distance" id="currentDistance">-</div>
            </div>
            <div class="station-item next">
                <div class="station-label">PR√ìXIMA ESTACI√ìN</div>
                <div class="station-name" id="nextStation">-</div>
                <div class="station-distance" id="nextDistance">-</div>
            </div>
        </div>
        
        <div class="control-buttons">
            <button class="control-button active" onclick="selectLine('sarmiento')">
                <span class="button-icon">üöÜ</span>
                <span class="button-text">Sarmiento</span>
            </button>
            <button class="control-button" onclick="selectLine('mitre_tigre')">
                <span class="button-icon">üöä</span>
                <span class="button-text">Mitre</span>
            </button>
            <button class="control-button" onclick="selectLine('roca')">
                <span class="button-icon">üöá</span>
                <span class="button-text">Roca</span>
            </button>
            <button class="control-button" onclick="selectLine('sanmartin')">
                <span class="button-icon">üöâ</span>
                <span class="button-text">San Mart√≠n</span>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN CORREGIDA - SIN SALTOS
        // ============================================
        const CONFIG = {
            // GPS CON FILTRADO
            GPS_UPDATE_INTERVAL: 1000,           // 1 segundo entre actualizaciones
            GPS_HIGH_ACCURACY: true,
            GPS_TIMEOUT: 10000,
            GPS_MAX_AGE: 0,
            GPS_MIN_ACCURACY: 50,               // Filtra posiciones con error > 50m
            
            // FILTRO DE POSICI√ìN
            POSITION_FILTER: true,              // Activar filtro de posici√≥n
            MIN_DISTANCE_MOVEMENT: 10,          // Movimiento m√≠nimo para registrar (metros)
            MAX_JUMP_DISTANCE: 100,             // M√°ximo salto permitido (metros)
            
            // VELOCIDAD REALISTA
            SPEED_SMOOTHING_SAMPLES: 3,         // Muestras para suavizar velocidad
            MIN_REAL_SPEED: 5,                  // Velocidad m√≠nima realista para tren (km/h)
            MAX_REAL_SPEED: 120,                // Velocidad m√°xima realista (km/h)
            
            // RUTA INTELIGENTE
            SNAP_TO_LINE: true,                 // Ajustar posici√≥n a la l√≠nea de tren
            SNAP_DISTANCE: 30,                  // Radio de ajuste (metros)
            REMOVE_JUMP_POINTS: true,           // Eliminar puntos con saltos
            
            // DETECCI√ìN DE ESTACIONES
            STATION_DETECTION_RADIUS: 150,
            STATION_PASS_THRESHOLD: 30,
            
            // MAPA
            MAP_ZOOM_FOLLOW: 16,
            MAP_ZOOM_DEFAULT: 14
        };
        
        // ============================================
        // BASE DE DATOS CORREGIDA
        // ============================================
        const stationsDB = {
            sarmiento: [
                {name: 'Once', lat: -34.607928, lng: -58.406481, order: 1},
                {name: 'Caballito', lat: -34.618532, lng: -58.441491, order: 2},
                {name: 'Flores', lat: -34.628981, lng: -58.463018, order: 3},
                {name: 'Floresta', lat: -34.634481, lng: -58.480512, order: 4},
                {name: 'Villa Luro', lat: -34.637815, lng: -58.502224, order: 5},
                {name: 'Liniers', lat: -34.641487, lng: -58.523894, order: 6},
                {name: 'Ciudadela', lat: -34.645981, lng: -58.535812, order: 7},
                {name: 'Ramos Mej√≠a', lat: -34.648312, lng: -58.561418, order: 8},
                {name: 'Haedo', lat: -34.650801, lng: -58.591105, order: 9},
                {name: 'Mor√≥n', lat: -34.650812, lng: -58.621105, order: 10},
                {name: 'Castelar', lat: -34.656914, lng: -58.652518, order: 11},
                {name: 'Ituzaing√≥', lat: -34.659214, lng: -58.671912, order: 12},
                {name: 'San Antonio', lat: -34.662487, lng: -58.701105, order: 13},
                {name: 'Merlo', lat: -34.665812, lng: -58.728118, order: 14},
                {name: 'Paso del Rey', lat: -34.656914, lng: -58.761105, order: 15},
                {name: 'Moreno', lat: -34.634987, lng: -58.791118, order: 16}
            ],
            
            mitre_tigre: [
                {name: 'Retiro', lat: -34.591487, lng: -58.374012, order: 1},
                {name: 'Lisandro de la Torre', lat: -34.595801, lng: -58.407518, order: 2},
                {name: 'Migueletes', lat: -34.556724, lng: -58.462812, order: 3},
                {name: 'Vicente L√≥pez', lat: -34.530801, lng: -58.474724, order: 4},
                {name: 'Olivos', lat: -34.507487, lng: -58.487518, order: 5},
                {name: 'La Lucila', lat: -34.495801, lng: -58.493924, order: 6},
                {name: 'Mart√≠nez', lat: -34.488924, lng: -58.504218, order: 7},
                {name: 'Acassuso', lat: -34.476724, lng: -58.509218, order: 8},
                {name: 'San Isidro', lat: -34.470601, lng: -58.521418, order: 9},
                {name: 'Beccar', lat: -34.461924, lng: -58.535601, order: 10},
                {name: 'Victoria', lat: -34.452487, lng: -58.556105, order: 11},
                {name: 'Virreyes', lat: -34.450601, lng: -58.570601, order: 12},
                {name: 'San Fernando', lat: -34.444724, lng: -58.588924, order: 13},
                {name: 'Carup√°', lat: -34.436724, lng: -58.610801, order: 14},
                {name: 'Tigre', lat: -34.420601, lng: -58.579724, order: 15}
            ],
            
            roca: [
                {name: 'Constituci√≥n', lat: -34.628118, lng: -58.381105, order: 1},
                {name: 'Parque Patricios', lat: -34.640801, lng: -58.404418, order: 2},
                {name: 'Avellaneda', lat: -34.663601, lng: -58.367218, order: 3},
                {name: 'Gerli', lat: -34.686105, lng: -58.384218, order: 4},
                {name: 'Lan√∫s', lat: -34.699724, lng: -58.392518, order: 5},
                {name: 'Banfield', lat: -34.743105, lng: -58.392218, order: 6},
                {name: 'Lomas de Zamora', lat: -34.758924, lng: -58.404418, order: 7},
                {name: 'Temperley', lat: -34.768105, lng: -58.394724, order: 8},
                {name: 'Adrogu√©', lat: -34.803924, lng: -58.391418, order: 9},
                {name: 'Burzaco', lat: -34.828312, lng: -58.391924, order: 10},
                {name: 'Longchamps', lat: -34.857518, lng: -58.385801, order: 11},
                {name: 'Glew', lat: -34.889218, lng: -58.380601, order: 12}
            ],
            
            sanmartin: [
                {name: 'Retiro', lat: -34.591487, lng: -58.374012, order: 1},
                {name: 'Palermo', lat: -34.579218, lng: -58.421105, order: 2},
                {name: 'Villa del Parque', lat: -34.598924, lng: -58.469418, order: 3},
                {name: 'Devoto', lat: -34.603601, lng: -58.512518, order: 4},
                {name: 'Santos Lugares', lat: -34.602218, lng: -58.545601, order: 5},
                {name: 'Caseros', lat: -34.609218, lng: -58.560012, order: 6},
                {name: 'El Palomar', lat: -34.596418, lng: -58.583601, order: 7},
                {name: 'Haedo', lat: -34.650801, lng: -58.591105, order: 8},
                {name: 'Mor√≥n', lat: -34.650812, lng: -58.621105, order: 9},
                {name: 'Castelar', lat: -34.656914, lng: -58.652518, order: 10},
                {name: 'Ituzaing√≥', lat: -34.659214, lng: -58.671912, order: 11},
                {name: 'San Miguel', lat: -34.541724, lng: -58.723601, order: 12}
            ]
        };
        
        // ============================================
        // SISTEMA CORREGIDO - SIN SALTOS
        // ============================================
        let map = null;
        let userMarker = null;
        let routePolyline = null;
        let stationMarkers = [];
        
        // Variables de estado
        let currentLine = 'sarmiento';
        let currentStationIndex = -1;
        let nextStationIndex = -1;
        let isRouteVisible = true;
        
        // Historial para filtrado
        let positionHistory = [];
        let speedHistory = [];
        let lastValidPosition = null;
        let lastProcessedPosition = null;
        let lastDirection = null;
        
        // Datos actuales
        let currentSpeed = 0;
        let currentBearing = 0;
        let currentAccuracy = 0;
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            
            // Vista inicial centrada en Buenos Aires
            map.setView([-34.6037, -58.3816], CONFIG.MAP_ZOOM_DEFAULT);
            
            // Cargar l√≠nea por defecto
            loadStations(currentLine);
            
            // Iniciar GPS
            startGPS();
        }
        
        function startGPS() {
            if (!navigator.geolocation) {
                alert("Tu dispositivo no soporta GPS");
                updateGPSStatus('error');
                return;
            }
            
            updateGPSStatus('searching');
            
            // Primera posici√≥n
            navigator.geolocation.getCurrentPosition(
                position => {
                    handleNewPosition(position);
                    map.setView([position.coords.latitude, position.coords.longitude], CONFIG.MAP_ZOOM_FOLLOW);
                },
                error => {
                    console.error("Error GPS inicial:", error);
                    updateGPSStatus('error');
                },
                {
                    enableHighAccuracy: CONFIG.GPS_HIGH_ACCURACY,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
            
            // Seguimiento continuo
            navigator.geolocation.watchPosition(
                position => handleNewPosition(position),
                error => handleGPSError(error),
                {
                    enableHighAccuracy: CONFIG.GPS_HIGH_ACCURACY,
                    maximumAge: CONFIG.GPS_UPDATE_INTERVAL,
                    timeout: CONFIG.GPS_TIMEOUT
                }
            );
        }
        
        // ============================================
        // MANEJO DE POSICIONES CON FILTRADO
        // ============================================
        function handleNewPosition(position) {
            if (!position || !position.coords) return;
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed;
            const heading = position.coords.heading;
            
            // Actualizar precisi√≥n
            updateGPSAccuracy(accuracy);
            
            // 1. FILTRAR POR PRECISI√ìN
            if (accuracy > CONFIG.GPS_MIN_ACCURACY) {
                console.warn("‚ö†Ô∏è Posici√≥n descartada por baja precisi√≥n:", accuracy, "m");
                updateGPSStatus('low_accuracy');
                return;
            }
            
            updateGPSStatus('active');
            
            // 2. FILTRAR SALTOS (si hay posici√≥n previa)
            if (lastValidPosition) {
                const distance = calculateDistance(
                    lastValidPosition.coords.latitude,
                    lastValidPosition.coords.longitude,
                    lat,
                    lng
                );
                
                // Si es un salto imposible (> 100m en 1 segundo = 360 km/h)
                if (distance > CONFIG.MAX_JUMP_DISTANCE) {
                    console.warn("‚ö†Ô∏è Salto GPS detectado:", distance.toFixed(1), "m - DESCARTADO");
                    return;
                }
                
                // Si es muy peque√±o (< 10m), posible ruido
                if (distance < CONFIG.MIN_DISTANCE_MOVEMENT) {
                    console.log("üìç Movimiento m√≠nimo ignorado:", distance.toFixed(1), "m");
                    return;
                }
            }
            
            // 3. AJUSTAR A L√çNEA (SNAP)
            let finalLat = lat;
            let finalLng = lng;
            
            if (CONFIG.SNAP_TO_LINE && currentLine && stationsDB[currentLine]) {
                const snapped = snapToLine(lat, lng, currentLine);
                if (snapped) {
                    finalLat = snapped.lat;
                    finalLng = snapped.lng;
                }
            }
            
            // 4. CALCULAR VELOCIDAD REAL
            calculateRealSpeed(position, finalLat, finalLng);
            
            // 5. ACTUALIZAR DIRECCI√ìN
            if (heading !== null && heading !== undefined) {
                currentBearing = heading;
                updateDirectionDisplay(heading, currentSpeed);
            } else if (lastValidPosition) {
                // Calcular direcci√≥n desde el movimiento
                const bearing = calculateBearing(
                    lastValidPosition.coords.latitude,
                    lastValidPosition.coords.longitude,
                    finalLat,
                    finalLng
                );
                currentBearing = bearing;
                updateDirectionDisplay(bearing, currentSpeed);
            }
            
            // 6. ACTUALIZAR MARCADOR
            updateUserMarker(finalLat, finalLng);
            
            // 7. ACTUALIZAR RUTA (sin retrocesos)
            updateRoute(finalLat, finalLng);
            
            // 8. DETECTAR ESTACIONES
            detectStations(finalLat, finalLng);
            
            // 9. GUARDAR POSICI√ìN V√ÅLIDA
            lastValidPosition = position;
            lastProcessedPosition = { lat: finalLat, lng: finalLng };
            
            // 10. ACTUALIZAR INTERFAZ
            updateSpeedDisplay();
        }
        
        function calculateRealSpeed(currentPos, finalLat, finalLng) {
            if (!lastValidPosition) {
                currentSpeed = 0;
                return;
            }
            
            const timeDiff = (currentPos.timestamp - lastValidPosition.timestamp) / 1000;
            
            if (timeDiff <= 0) {
                currentSpeed = 0;
                return;
            }
            
            // Distancia entre posiciones procesadas
            const distance = calculateDistance(
                lastValidPosition.coords.latitude,
                lastValidPosition.coords.longitude,
                finalLat,
                finalLng
            );
            
            // Velocidad en km/h
            const instantSpeed = (distance / timeDiff) * 3.6;
            
            // Filtrar velocidades imposibles
            if (instantSpeed > CONFIG.MAX_REAL_SPEED || instantSpeed < 0) {
                console.warn("‚ö†Ô∏è Velocidad imposible:", instantSpeed.toFixed(1), "km/h");
                return;
            }
            
            // Suavizar con promedio m√≥vil
            speedHistory.push(instantSpeed);
            if (speedHistory.length > CONFIG.SPEED_SMOOTHING_SAMPLES) {
                speedHistory.shift();
            }
            
            const sum = speedHistory.reduce((a, b) => a + b, 0);
            currentSpeed = sum / speedHistory.length;
            
            // Si est√° por debajo del m√≠nimo, considerar detenido
            if (currentSpeed < CONFIG.MIN_REAL_SPEED) {
                currentSpeed = 0;
            }
        }
        
        function snapToLine(lat, lng, lineId) {
            const stations = stationsDB[lineId];
            if (!stations || stations.length < 2) return null;
            
            let closestPoint = null;
            let minDistance = Infinity;
            
            // Buscar el segmento m√°s cercano
            for (let i = 0; i < stations.length - 1; i++) {
                const point = getClosestPointOnSegment(
                    lat, lng,
                    stations[i].lat, stations[i].lng,
                    stations[i + 1].lat, stations[i + 1].lng
                );
                
                const distance = calculateDistance(lat, lng, point.lat, point.lng);
                
                if (distance < minDistance && distance <= CONFIG.SNAP_DISTANCE) {
                    minDistance = distance;
                    closestPoint = point;
                }
            }
            
            return closestPoint;
        }
        
        function getClosestPointOnSegment(px, py, x1, y1, x2, y2) {
            // Convertir a coordenadas planas (simplificaci√≥n para distancias cortas)
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const len_sq = C * C + D * D;
            
            let param = -1;
            if (len_sq !== 0) {
                param = dot / len_sq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            return { lat: xx, lng: yy };
        }
        
        function updateRoute(lat, lng) {
            if (!isRouteVisible) return;
            
            const newPoint = [lat, lng];
            
            // Si no hay puntos, agregar
            if (positionHistory.length === 0) {
                positionHistory.push(newPoint);
                updateRouteLine();
                return;
            }
            
            const lastPoint = positionHistory[positionHistory.length - 1];
            const distance = calculateDistance(lastPoint[0], lastPoint[1], lat, lng);
            
            // Solo agregar si hay movimiento significativo
            if (distance >= CONFIG.MIN_DISTANCE_MOVEMENT) {
                
                // Verificar direcci√≥n (evitar retrocesos)
                if (positionHistory.length >= 2) {
                    const direction = calculateDirectionConsistency(positionHistory, newPoint);
                    
                    if (!direction.consistent && CONFIG.REMOVE_JUMP_POINTS) {
                        console.warn("‚ö†Ô∏è Retroceso detectado, limpiando ruta");
                        positionHistory = [newPoint]; // Reiniciar ruta
                    } else {
                        positionHistory.push(newPoint);
                    }
                } else {
                    positionHistory.push(newPoint);
                }
                
                // Limitar historial
                if (positionHistory.length > 50) {
                    positionHistory.shift();
                }
                
                updateRouteLine();
            }
        }
        
        function calculateDirectionConsistency(history, newPoint) {
            if (history.length < 2) return { consistent: true, direction: null };
            
            // Calcular direcci√≥n promedio de los √∫ltimos puntos
            let totalBearing = 0;
            for (let i = 1; i < history.length; i++) {
                const bearing = calculateBearing(
                    history[i-1][0], history[i-1][1],
                    history[i][0], history[i][1]
                );
                totalBearing += bearing;
            }
            const avgBearing = totalBearing / (history.length - 1);
            
            // Calcular direcci√≥n del nuevo punto
            const newBearing = calculateBearing(
                history[history.length - 1][0],
                history[history.length - 1][1],
                newPoint[0],
                newPoint[1]
            );
            
            // Calcular diferencia
            const diff = Math.abs(newBearing - avgBearing);
            const normalizedDiff = Math.min(diff, 360 - diff);
            
            return {
                consistent: normalizedDiff < 45, // Menos de 45 grados de diferencia
                direction: newBearing
            };
        }
        
        function updateRouteLine() {
            if (positionHistory.length < 2) return;
            
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            routePolyline = L.polyline(positionHistory, {
                color: '#007AFF',
                weight: 3,
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round',
                className: 'route-line'
            }).addTo(map);
        }
        
        // ============================================
        // FUNCIONES DE DETECCI√ìN INTELIGENTE
        // ============================================
        function detectStations(lat, lng) {
            if (!currentLine || !stationsDB[currentLine]) return;
            
            const stations = stationsDB[currentLine];
            let closestStation = null;
            let closestDistance = Infinity;
            let closestIndex = -1;
            
            // Encontrar estaci√≥n m√°s cercana
            stations.forEach((station, index) => {
                const distance = calculateDistance(lat, lng, station.lat, station.lng);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestStation = station;
                    closestIndex = index;
                }
            });
            
            if (!closestStation || closestDistance > CONFIG.STATION_DETECTION_RADIUS) return;
            
            // Actualizar √≠ndices
            currentStationIndex = closestIndex;
            
            // Determinar pr√≥xima estaci√≥n (siempre hacia adelante en el orden)
            if (closestIndex < stations.length - 1) {
                nextStationIndex = closestIndex + 1;
            } else {
                nextStationIndex = -1;
            }
            
            // Actualizar marcadores
            updateStationMarkers();
            
            // Actualizar informaci√≥n
            updateStationInfo(closestDistance);
            
            // Detectar pasaje por estaci√≥n
            if (closestDistance < CONFIG.STATION_PASS_THRESHOLD) {
                markStationPassed(closestStation.name);
            }
        }
        
        function markStationPassed(stationName) {
            console.log(`üöâ Pas√≥ por: ${stationName}`);
            
            // Feedback visual
            if (userMarker) {
                userMarker._icon.style.animation = 'none';
                setTimeout(() => {
                    userMarker._icon.style.animation = 'gpsPulse 2s infinite';
                }, 100);
            }
        }
        
        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function selectLine(lineId) {
            // Actualizar botones
            document.querySelectorAll('.control-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.control-button').classList.add('active');
            
            // Cambiar l√≠nea
            currentLine = lineId;
            
            // Cargar estaciones
            loadStations(lineId);
            
            // Actualizar nombre
            const lineNames = {
                'sarmiento': 'SARMIENTO',
                'mitre_tigre': 'MITRE (TIGRE)',
                'roca': 'ROCA',
                'sanmartin': 'SAN MART√çN'
            };
            
            document.getElementById('lineName').textContent = lineNames[lineId] || lineId.toUpperCase();
            
            // Limpiar ruta anterior
            positionHistory = [];
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            console.log(`üöä L√≠nea cambiada a: ${lineId}`);
        }
        
        function loadStations(lineId) {
            // Limpiar estaciones anteriores
            stationMarkers.forEach(marker => {
                map.removeLayer(marker.marker);
            });
            stationMarkers = [];
            
            const stations = stationsDB[lineId];
            if (!stations) return;
            
            const colors = {
                'sarmiento': '#FF3B30',
                'mitre_tigre': '#007AFF',
                'roca': '#FF9500',
                'sanmartin': '#4CD964'
            };
            
            const lineColor = colors[lineId] || '#007AFF';
            
            stations.forEach((station, index) => {
                const marker = L.marker([station.lat, station.lng], {
                    icon: L.divIcon({
                        className: 'station-marker',
                        html: `<div style="background:${lineColor};width:16px;height:16px;border-radius:50%;border:3px solid white;"></div>`,
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    }),
                    zIndexOffset: 500
                })
                .bindTooltip(`<b>${station.name}</b><br>Orden: ${index + 1}`, {
                    permanent: false,
                    direction: 'top'
                })
                .addTo(map);
                
                stationMarkers.push({
                    marker: marker,
                    index: index,
                    data: station
                });
            });
        }
        
        function updateStationMarkers() {
            stationMarkers.forEach(item => {
                const marker = item.marker;
                marker._icon.classList.remove('current', 'next');
                
                if (item.index === currentStationIndex) {
                    marker._icon.classList.add('current');
                } else if (item.index === nextStationIndex) {
                    marker._icon.classList.add('next');
                }
            });
        }
        
        function updateStationInfo(distance) {
            if (!currentLine || !stationsDB[currentLine]) return;
            
            const stations = stationsDB[currentLine];
            
            // Estaci√≥n actual
            if (currentStationIndex >= 0 && currentStationIndex < stations.length) {
                const currentStation = stations[currentStationIndex];
                document.getElementById('currentStation').textContent = currentStation.name;
                
                if (distance !== undefined) {
                    document.getElementById('currentDistance').textContent = 
                        Math.round(distance) + ' m';
                }
            }
            
            // Pr√≥xima estaci√≥n
            if (nextStationIndex >= 0 && nextStationIndex < stations.length) {
                const nextStation = stations[nextStationIndex];
                document.getElementById('nextStation').textContent = nextStation.name;
                
                if (lastProcessedPosition) {
                    const nextDistance = calculateDistance(
                        lastProcessedPosition.lat,
                        lastProcessedPosition.lng,
                        nextStation.lat,
                        nextStation.lng
                    );
                    document.getElementById('nextDistance').textContent = 
                        Math.round(nextDistance) + ' m';
                }
            } else {
                document.getElementById('nextStation').textContent = '-';
                document.getElementById('nextDistance').textContent = '-';
            }
        }
        
        function updateUserMarker(lat, lng) {
            if (userMarker) {
                userMarker.setLatLng([lat, lng]);
            } else {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background:linear-gradient(135deg, #007AFF, #0056CC);width:28px;height:28px;border-radius:50%;border:4px solid white;box-shadow:0 0 40px rgba(0,122,255,0.9);"></div>',
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    }),
                    zIndexOffset: 1000
                }).addTo(map);
            }
            
            // Centrar suavemente
            map.panTo([lat, lng], {
                animate: true,
                duration: 0.5,
                easeLinearity: 0.25
            });
        }
        
        function updateSpeedDisplay() {
            const speedElement = document.getElementById('speedValue');
            const speedText = currentSpeed.toFixed(1) + ' km/h';
            
            if (speedElement.textContent !== speedText) {
                speedElement.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    speedElement.style.transform = 'scale(1)';
                }, 150);
            }
            
            speedElement.textContent = speedText;
            
            // Color seg√∫n velocidad
            if (currentSpeed < 10) {
                speedElement.style.color = '#8E8E93';
            } else if (currentSpeed < 40) {
                speedElement.style.color = '#FF9500';
            } else {
                speedElement.style.color = '#34C759';
            }
        }
        
        function updateDirectionDisplay(bearing, speed) {
            const directionArrow = document.getElementById('directionArrow');
            const directionText = document.getElementById('directionText');
            
            let arrow = '‚Üí';
            let text = 'NORTE';
            
            if (speed < 1) {
                arrow = '‚óè';
                text = 'DETENIDO';
            } else if (bearing >= 337.5 || bearing < 22.5) {
                arrow = '‚Üë';
                text = 'NORTE';
            } else if (bearing >= 22.5 && bearing < 67.5) {
                arrow = '‚Üó';
                text = 'NORESTE';
            } else if (bearing >= 67.5 && bearing < 112.5) {
                arrow = '‚Üí';
                text = 'ESTE';
            } else if (bearing >= 112.5 && bearing < 157.5) {
                arrow = '‚Üò';
                text = 'SURESTE';
            } else if (bearing >= 157.5 && bearing < 202.5) {
                arrow = '‚Üì';
                text = 'SUR';
            } else if (bearing >= 202.5 && bearing < 247.5) {
                arrow = '‚Üô';
                text = 'SUROESTE';
            } else if (bearing >= 247.5 && bearing < 292.5) {
                arrow = '‚Üê';
                text = 'OESTE';
            } else if (bearing >= 292.5 && bearing < 337.5) {
                arrow = '‚Üñ';
                text = 'NOROESTE';
            }
            
            directionArrow.textContent = arrow;
            directionText.textContent = text;
            
            // Rotar flecha seg√∫n direcci√≥n
            directionArrow.style.transform = `rotate(${bearing}deg)`;
        }
        
        function updateGPSStatus(status) {
            const indicator = document.getElementById('gpsIndicator');
            const subtitle = document.getElementById('gpsSubtitle');
            const statusText = document.getElementById('lineStatus');
            
            switch(status) {
                case 'searching':
                    indicator.textContent = 'üì°';
                    indicator.style.background = 'linear-gradient(135deg, #FF9500, #FF8A00)';
                    subtitle.textContent = 'BUSCANDO SAT√âLITES';
                    statusText.textContent = 'BUSCANDO GPS';
                    statusText.style.color = '#FF9500';
                    break;
                    
                case 'active':
                    indicator.textContent = 'üìç';
                    indicator.style.background = 'linear-gradient(135deg, #34C759, #28A745)';
                    subtitle.textContent = 'GPS ACTIVO';
                    statusText.textContent = 'GPS ACTIVO';
                    statusText.style.color = '#34C759';
                    break;
                    
                case 'low_accuracy':
                    indicator.textContent = '‚ö†Ô∏è';
                    indicator.style.background = 'linear-gradient(135deg, #FF9500, #FF8A00)';
                    subtitle.textContent = 'PRECISI√ìN MEDIA';
                    statusText.textContent = 'PRECISI√ìN MEDIA';
                    statusText.style.color = '#FF9500';
                    break;
                    
                case 'error':
                    indicator.textContent = '‚ùå';
                    indicator.style.background = 'linear-gradient(135deg, #FF3B30, #D70015)';
                    subtitle.textContent = 'ERROR GPS';
                    statusText.textContent = 'ERROR GPS';
                    statusText.style.color = '#FF3B30';
                    break;
            }
        }
        
        function updateGPSAccuracy(accuracy) {
            currentAccuracy = accuracy;
            const accuracyElement = document.getElementById('gpsAccuracy');
            
            if (accuracy < 20) {
                accuracyElement.textContent = '¬±' + Math.round(accuracy) + ' m';
                accuracyElement.style.color = '#34C759';
                accuracyElement.style.background = 'rgba(52, 199, 89, 0.15)';
            } else if (accuracy < 50) {
                accuracyElement.textContent = '¬±' + Math.round(accuracy) + ' m';
                accuracyElement.style.color = '#FF9500';
                accuracyElement.style.background = 'rgba(255, 149, 0, 0.15)';
            } else {
                accuracyElement.textContent = '¬±' + Math.round(accuracy) + ' m';
                accuracyElement.style.color = '#FF3B30';
                accuracyElement.style.background = 'rgba(255, 59, 48, 0.15)';
            }
        }
        
        function handleGPSError(error) {
            console.error("‚ùå Error GPS:", error);
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("Se deneg√≥ el acceso al GPS. Act√≠valo en ajustes.");
                    updateGPSStatus('error');
                    break;
                    
                case error.POSITION_UNAVAILABLE:
                    console.warn("GPS no disponible");
                    updateGPSStatus('low_accuracy');
                    break;
                    
                case error.TIMEOUT:
                    console.warn("Timeout de GPS");
                    updateGPSStatus('searching');
                    break;
            }
        }
        
        function centerOnUser() {
            if (userMarker) {
                const latlng = userMarker.getLatLng();
                map.setView(latlng, CONFIG.MAP_ZOOM_FOLLOW);
                
                // Feedback visual
                userMarker._icon.style.transform = 'scale(1.3)';
                setTimeout(() => {
                    userMarker._icon.style.transform = 'scale(1)';
                }, 300);
            }
        }
        
        function toggleRoute() {
            isRouteVisible = !isRouteVisible;
            
            if (routePolyline) {
                if (isRouteVisible) {
                    routePolyline.addTo(map);
                } else {
                    map.removeLayer(routePolyline);
                }
            }
            
            // Feedback visual
            const button = event.target.closest('.icon-button');
            button.style.transform = 'scale(0.9)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 150);
        }
        
        // ============================================
        // FUNCIONES MATEM√ÅTICAS
        // ============================================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                     Math.cos(œÜ1) * Math.cos(œÜ2) *
                     Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const Œª1 = lon1 * Math.PI / 180;
            const Œª2 = lon2 * Math.PI / 180;
            
            const y = Math.sin(Œª2 - Œª1) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                     Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(Œª2 - Œª1);
            const Œ∏ = Math.atan2(y, x);
            
            return (Œ∏ * 180 / Math.PI + 360) % 360;
        }
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta GPS");
                return;
            }
            
            // Iniciar sistema
            initMap();
            
            // Ajustar mapa al cambiar tama√±o
            window.addEventListener('resize', () => {
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                }
            });
            
            console.log("üöÄ Sistema GPS Tren iniciado");
        });
    </script>
</body>
</html>