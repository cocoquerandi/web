<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Estaciones de Transporte - Datos Reales</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 320px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .logo {
            color: #1a73e8;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .station-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        .station-item {
            padding: 8px;
            margin-bottom: 5px;
            border-left: 4px solid #007bff;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .station-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }
        
        .station-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }
        
        .station-line {
            font-size: 0.8rem;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .leaflet-popup-content {
            min-width: 200px;
        }
        
        .line-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 200px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .control-panel {
                width: 280px;
                top: 10px;
                left: 10px;
            }
            
            .legend {
                bottom: 10px;
                right: 10px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Panel de Control -->
    <div class="control-panel">
        <div class="logo">
            <i class="fas fa-map-marker-alt"></i> Mapa de Transporte - Datos Reales
        </div>
        
        <!-- Selector de Tipo de Transporte -->
        <div class="filter-section">
            <label class="form-label fw-bold">Tipo de Transporte:</label>
            <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-outline-primary active" data-type="train">
                    <i class="fas fa-train"></i> Tren
                </button>
                <button type="button" class="btn btn-outline-success" data-type="subte">
                    <i class="fas fa-subway"></i> Subte
                </button>
                <button type="button" class="btn btn-outline-warning" data-type="bus">
                    <i class="fas fa-bus"></i> Colectivos
                </button>
            </div>
        </div>
        
        <!-- Selector de Línea -->
        <div class="filter-section">
            <label class="form-label fw-bold">Línea:</label>
            <select id="line-select" class="form-select">
                <option value="">Seleccione una línea...</option>
                <!-- Las opciones se cargan dinámicamente -->
            </select>
        </div>
        
        <!-- Botón para cargar datos -->
        <div class="filter-section">
            <button id="load-data" class="btn btn-primary w-100">
                <i class="fas fa-sync-alt"></i> Cargar Estaciones
            </button>
        </div>
        
        <!-- Lista de Estaciones -->
        <div class="station-list" id="station-list">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i><br>
                Seleccione transporte y línea
            </div>
        </div>
    </div>
    
    <!-- Leyenda -->
    <div class="legend">
        <div class="legend-item">
            <span class="line-color" style="background-color: #007bff;"></span>
            Tren
        </div>
        <div class="legend-item">
            <span class="line-color" style="background-color: #28a745;"></span>
            Subte
        </div>
        <div class="legend-item">
            <span class="line-color" style="background-color: #ffc107;"></span>
            Colectivo
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Axios para peticiones HTTP -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // Inicializar mapa centrado en Buenos Aires
        const map = L.map('map').setView([-34.6037, -58.3816], 12);
        
        // Capa base de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Capa para los marcadores
        let markersLayer = L.layerGroup().addTo(map);
        
        // Configuración de APIs reales
        const apiConfig = {
            // API de datos abiertos de Buenos Aires (Subtes)
            subte: {
                url: 'https://datosabiertos-transporte-apis.buenosaires.gob.ar:443/subtes/estaciones',
                token: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6Imd1aWxsZXJtby5ib2RhcnRAb3V0bG9vay5jb20ifQ.0PTxlmzK9UZ0eH6W6X-JnN3FJp3qBpL2Trg0P3qK1vY',
                dataField: 'result'
            },
            
            // API de transporte de Buenos Aires (Colectivos)
            bus: {
                url: 'https://datosabiertos-transporte-apis.buenosaires.gob.ar:443/colectivos/paradas',
                token: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6Imd1aWxsZXJtby5ib2RhcnRAb3V0bG9vay5jb20ifQ.0PTxlmzK9UZ0eH6W6X-JnN3FJp3qBpL2Trg0P3qK1vY',
                dataField: 'result'
            },
            
            // Para trenes usaremos Overpass API de OpenStreetMap (datos reales)
            train: {
                url: 'https://overpass-api.de/api/interpreter',
                method: 'POST'
            }
        };
        
        // Definición de líneas de transporte
        const transportLines = {
            train: [
                { id: 'Sarmiento', name: 'Línea Sarmiento', color: '#1E88E5' },
                { id: 'Roca', name: 'Línea Roca', color: '#43A047' },
                { id: 'Mitre', name: 'Línea Mitre', color: '#8E24AA' },
                { id: 'SanMartín', name: 'Línea San Martín', color: '#F4511E' },
                { id: 'Urquiza', name: 'Línea Urquiza', color: '#00ACC1' },
                { id: 'BelgranoSur', name: 'Línea Belgrano Sur', color: '#FFB300' },
                { id: 'BelgranoNorte', name: 'Línea Belgrano Norte', color: '#5D4037' }
            ],
            subte: [
                { id: 'A', name: 'Línea A', color: '#00A3E0' },
                { id: 'B', name: 'Línea B', color: '#D70206' },
                { id: 'C', name: 'Línea C', color: '#00A74A' },
                { id: 'D', name: 'Línea D', color: '#008EAA' },
                { id: 'E', name: 'Línea E', color: '#6B3B90' },
                { id: 'H', name: 'Línea H', color: '#FCE300' }
            ],
            bus: [
                { id: 'all', name: 'Todas las paradas', color: '#FFC107' }
            ]
        };
        
        // Variables de estado
        let currentTransportType = 'train';
        let currentLine = '';
        
        // Inicializar select de líneas
        function initializeLineSelect() {
            const lineSelect = document.getElementById('line-select');
            const lines = transportLines[currentTransportType];
            
            lineSelect.innerHTML = '<option value="">Seleccione una línea...</option>';
            
            lines.forEach(line => {
                const option = document.createElement('option');
                option.value = line.id;
                option.textContent = line.name;
                lineSelect.appendChild(option);
            });
            
            // Actualizar botones de transporte
            updateTransportButtons();
        }
        
        // Actualizar botones de transporte activos
        function updateTransportButtons() {
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-type') === currentTransportType) {
                    btn.classList.add('active');
                }
            });
        }
        
        // Obtener color de la línea
        function getLineColor(lineId) {
            const lines = transportLines[currentTransportType];
            const line = lines.find(l => l.id === lineId);
            return line ? line.color : '#007bff';
        }
        
        // Limpiar marcadores del mapa
        function clearMarkers() {
            markersLayer.clearLayers();
        }
        
        // Mostrar estaciones en la lista
        function showStationsList(stations) {
            const stationList = document.getElementById('station-list');
            
            if (stations.length === 0) {
                stationList.innerHTML = '<div class="loading">No se encontraron estaciones</div>';
                return;
            }
            
            let html = '<h6 class="fw-bold mb-3">Estaciones encontradas:</h6>';
            
            stations.forEach((station, index) => {
                html += `
                    <div class="station-item" data-index="${index}">
                        <div class="station-name">
                            <i class="fas fa-map-pin"></i> ${station.name}
                        </div>
                        <div class="station-line">
                            Línea: ${station.line}
                        </div>
                    </div>
                `;
            });
            
            stationList.innerHTML = html;
            
            // Agregar eventos a los items de la lista
            document.querySelectorAll('.station-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    const station = stations[index];
                    
                    // Centrar mapa en la estación
                    map.setView([station.lat, station.lng], 16);
                    
                    // Abrir popup del marcador
                    if (station.marker) {
                        station.marker.openPopup();
                    }
                });
            });
        }
        
        // Cargar estaciones de tren desde Overpass API
        async function loadTrainStations(lineName) {
            const lineQueries = {
                'Sarmiento': `"name"~"Sarmiento"`,
                'Roca': `"name"~"Roca"`,
                'Mitre': `"name"~"Mitre"`,
                'SanMartín': `"name"~"San Martín"`,
                'Urquiza': `"name"~"Urquiza"`,
                'BelgranoSur': `"name"~"Belgrano Sur"`,
                'BelgranoNorte': `"name"~"Belgrano Norte"`
            };
            
            const query = `
                [out:json];
                area["name"="Buenos Aires"]->.ba;
                (
                    node["railway"="station"]${lineQueries[lineName] ? `[${lineQueries[lineName]}]` : ''}(area.ba);
                    node["railway"="halt"]${lineQueries[lineName] ? `[${lineQueries[lineName]}]` : ''}(area.ba);
                );
                out body;
            `;
            
            try {
                const response = await axios({
                    method: 'post',
                    url: apiConfig.train.url,
                    data: `data=${encodeURIComponent(query)}`,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                return response.data.elements.map(element => ({
                    name: element.tags.name || 'Estación sin nombre',
                    lat: element.lat,
                    lng: element.lon,
                    line: lineName
                }));
            } catch (error) {
                console.error('Error cargando estaciones de tren:', error);
                return [];
            }
        }
        
        // Cargar estaciones de subte
        async function loadSubteStations(lineId) {
            try {
                const response = await axios.get(`${apiConfig.subte.url}?Linea=${lineId}`, {
                    headers: {
                        'Authorization': `Bearer ${apiConfig.subte.token}`
                    }
                });
                
                const data = response.data[apiConfig.subte.dataField];
                return data.map(station => ({
                    name: station.nombre,
                    lat: station.latitud,
                    lng: station.longitud,
                    line: `Línea ${lineId}`
                }));
            } catch (error) {
                console.error('Error cargando estaciones de subte:', error);
                // Datos de respaldo si falla la API
                return getBackupSubteData(lineId);
            }
        }
        
        // Datos de respaldo para subtes
        function getBackupSubteData(lineId) {
            const backupData = {
                'A': [
                    { name: 'Plaza de Mayo', lat: -34.6083, lng: -58.3712, line: 'Línea A' },
                    { name: 'Perú', lat: -34.6092, lng: -58.3736, line: 'Línea A' },
                    { name: 'Piedras', lat: -34.6100, lng: -58.3761, line: 'Línea A' },
                    { name: 'Lima', lat: -34.6106, lng: -58.3789, line: 'Línea A' },
                    { name: 'Sáenz Peña', lat: -34.6111, lng: -58.3817, line: 'Línea A' }
                ],
                'B': [
                    { name: 'Leandro N. Alem', lat: -34.5969, lng: -58.3708, line: 'Línea B' },
                    { name: 'Florida', lat: -34.5983, lng: -58.3736, line: 'Línea B' },
                    { name: 'Carlos Pellegrini', lat: -34.5997, lng: -58.3764, line: 'Línea B' },
                    { name: 'Uruguay', lat: -34.6011, lng: -58.3792, line: 'Línea B' },
                    { name: 'Callao', lat: -34.6025, lng: -58.3920, line: 'Línea B' }
                ]
            };
            
            return backupData[lineId] || [];
        }
        
        // Cargar paradas de colectivo
        async function loadBusStations() {
            try {
                const response = await axios.get(apiConfig.bus.url, {
                    headers: {
                        'Authorization': `Bearer ${apiConfig.bus.token}`
                    }
                });
                
                const data = response.data[apiConfig.bus.dataField];
                // Limitar a 50 estaciones para no saturar
                return data.slice(0, 50).map(station => ({
                    name: station.nombre || 'Parada de colectivo',
                    lat: station.latitud,
                    lng: station.longitud,
                    line: 'Colectivo'
                }));
            } catch (error) {
                console.error('Error cargando paradas de colectivo:', error);
                return [];
            }
        }
        
        // Añadir marcadores al mapa
        function addMarkersToMap(stations) {
            const lineColor = getLineColor(currentLine);
            
            stations.forEach((station, index) => {
                // Crear marcador
                const marker = L.circleMarker([station.lat, station.lng], {
                    radius: 8,
                    fillColor: lineColor,
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(markersLayer);
                
                // Agregar popup
                marker.bindPopup(`
                    <strong>${station.name}</strong><br>
                    <em>${station.line}</em><br>
                    <small>Coordenadas: ${station.lat.toFixed(6)}, ${station.lng.toFixed(6)}</small>
                `);
                
                // Guardar referencia al marcador
                station.marker = marker;
                
                // Agregar evento al marcador
                marker.on('click', function() {
                    this.openPopup();
                });
            });
            
            // Ajustar vista del mapa para mostrar todos los marcadores
            if (stations.length > 0) {
                const bounds = L.latLngBounds(stations.map(s => [s.lat, s.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Cargar datos
        async function loadData() {
            const lineSelect = document.getElementById('line-select');
            const selectedLine = lineSelect.value;
            
            if (!selectedLine) {
                alert('Por favor, seleccione una línea');
                return;
            }
            
            currentLine = selectedLine;
            
            // Mostrar loading
            document.getElementById('station-list').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i><br>
                    Cargando estaciones...
                </div>
            `;
            
            clearMarkers();
            
            let stations = [];
            
            try {
                switch (currentTransportType) {
                    case 'train':
                        stations = await loadTrainStations(selectedLine);
                        break;
                    case 'subte':
                        stations = await loadSubteStations(selectedLine);
                        break;
                    case 'bus':
                        stations = await loadBusStations();
                        break;
                }
                
                if (stations.length > 0) {
                    addMarkersToMap(stations);
                    showStationsList(stations);
                } else {
                    document.getElementById('station-list').innerHTML = `
                        <div class="loading">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            No se encontraron estaciones
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('station-list').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-circle"></i><br>
                        Error al cargar datos
                    </div>
                `;
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar select de líneas
            initializeLineSelect();
            
            // Botones de tipo de transporte
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentTransportType = this.getAttribute('data-type');
                    initializeLineSelect();
                    clearMarkers();
                    document.getElementById('station-list').innerHTML = `
                        <div class="loading">
                            <i class="fas fa-info-circle"></i><br>
                            Seleccione una línea y cargue datos
                        </div>
                    `;
                });
            });
            
            // Botón de cargar datos
            document.getElementById('load-data').addEventListener('click', loadData);
            
            // Evento en select de línea
            document.getElementById('line-select').addEventListener('change', function() {
                clearMarkers();
                document.getElementById('station-list').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-info-circle"></i><br>
                        Haga clic en "Cargar Estaciones"
                    </div>
                `;
            });
            
            // Cargar algunas estaciones por defecto al iniciar
            setTimeout(() => {
                document.getElementById('line-select').value = 'Sarmiento';
                loadData();
            }, 1000);
        });
    </script>
</body>
</html>