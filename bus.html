<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor√≠a GPS Transporte - Google Sheets</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            overflow: hidden;
            height: 100vh;
        }
        
        /* HEADER SIMPLE */
        .header {
            background: #16213e;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0f3460;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            height: 60px;
        }
        
        .header h1 {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            background: #0f3460;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #1a5fb4;
        }
        
        .btn.recording {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* MAPA */
        #map {
            height: calc(100vh - 60px);
            width: 100%;
        }
        
        /* PANEL LATERAL */
        .panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 320px;
            background: rgba(22, 33, 62, 0.98);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            border: 1px solid #0f3460;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 10px;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* ESTADOS */
        .status {
            background: rgba(15, 52, 96, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .status-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .status-label {
            color: #a0a0c0;
        }
        
        .status-value {
            font-weight: bold;
        }
        
        /* VELOC√çMETRO */
        .speedometer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(22, 33, 62, 0.98);
            padding: 12px;
            border-radius: 10px;
            min-width: 140px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 1px solid #0f3460;
            z-index: 1000;
        }
        
        .speed-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            text-align: center;
            margin: 5px 0;
        }
        
        /* CONTROLES DE GRABACI√ìN */
        .recording-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        /* FORMULARIOS */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #a0a0c0;
            font-size: 13px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #0f3460;
            background: #0d1930;
            color: white;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        /* MENSAJES */
        .message {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #27ae60;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            display: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        
        .message.error {
            background: #e74c3c;
        }
        
        .message.warning {
            background: #f39c12;
        }
        
        /* LISTA DE DATOS */
        .data-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border-top: 1px solid #0f3460;
            padding-top: 10px;
        }
        
        .data-item {
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .panel {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .header h1 span {
                display: none;
            }
            
            .speedometer {
                bottom: 80px;
                left: 10px;
                min-width: 120px;
            }
            
            .recording-controls {
                bottom: 20px;
                right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .btn span {
                display: none;
            }
            
            .btn {
                padding: 8px;
                width: 40px;
                height: 40px;
                justify-content: center;
            }
            
            .header h1 {
                font-size: 14px;
            }
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(15, 52, 96, 0.3);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1><i class="fas fa-bus"></i> <span>AUDITOR√çA GPS - GOOGLE SHEETS</span></h1>
        <div class="header-buttons">
            <button class="btn" onclick="togglePanel('status')" title="Estado">
                <i class="fas fa-info-circle"></i> <span>Estado</span>
            </button>
            <button class="btn" onclick="togglePanel('config')" title="Configuraci√≥n">
                <i class="fas fa-cog"></i> <span>Config</span>
            </button>
            <button class="btn" id="recordBtn" onclick="toggleRecording()" title="Iniciar/Detener Grabaci√≥n">
                <i class="fas fa-circle" id="recordIcon"></i>
                <span id="recordText">INICIAR</span>
            </button>
        </div>
    </div>
    
    <!-- MAPA -->
    <div id="map"></div>
    
    <!-- VELOC√çMETRO -->
    <div class="speedometer">
        <div style="text-align: center; font-size: 11px; color: #a0a0c0;">
            <i class="fas fa-tachometer-alt"></i> VELOCIDAD
        </div>
        <div class="speed-value" id="speedValue">0.0 km/h</div>
        <div style="text-align: center; font-size: 11px; color: #a0a0c0;" id="gpsStatusText">
            <i class="fas fa-satellite"></i> GPS ACTIVO
        </div>
    </div>
    
    <!-- PANEL ESTADO -->
    <div class="panel" id="panelStatus">
        <div class="panel-header">
            <h3><i class="fas fa-chart-line"></i> Estado del Sistema</h3>
            <button class="close-btn" onclick="togglePanel('status')" title="Cerrar">&times;</button>
        </div>
        
        <div class="status">
            <div class="status-item">
                <span class="status-label">GPS:</span>
                <span class="status-value" id="gpsStatus">ACTIVO</span>
            </div>
            <div class="status-item">
                <span class="status-label">Grabaci√≥n:</span>
                <span class="status-value" id="recordingStatus">INACTIVA</span>
            </div>
            <div class="status-item">
                <span class="status-label">Puntos registrados:</span>
                <span class="status-value" id="dataCount">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">√öltimo env√≠o:</span>
                <span class="status-value" id="lastSend">--:--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Duraci√≥n:</span>
                <span class="status-value" id="duration">00:00:00</span>
            </div>
            <div class="status-item">
                <span class="status-label">Puntos pendientes:</span>
                <span class="status-value" id="pendingCount">0</span>
            </div>
        </div>
        
        <button class="btn" style="width:100%; margin-top:5px; margin-bottom:10px;" onclick="exportToCSV()">
            <i class="fas fa-download"></i> DESCARGAR CSV LOCAL
        </button>
        
        <button class="btn" style="width:100%; margin-bottom:10px;" onclick="forceSendToSheets()">
            <i class="fas fa-paper-plane"></i> ENVIAR A SHEETS AHORA
        </button>
        
        <div class="data-list" id="recentData">
            <!-- √öltimos datos se mostrar√°n aqu√≠ -->
        </div>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #0f3460;">
            <p style="font-size: 12px; color: #a0a0c0;">
                <i class="fas fa-info-circle"></i>
                Los datos se env√≠an autom√°ticamente cada 10 puntos
            </p>
        </div>
    </div>
    
    <!-- PANEL CONFIG -->
    <div class="panel" id="panelConfig">
        <div class="panel-header">
            <h3><i class="fas fa-cog"></i> Configuraci√≥n</h3>
            <button class="close-btn" onclick="togglePanel('config')" title="Cerrar">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-bus"></i> N√∫mero de L√≠nea:
            </label>
            <input type="text" id="lineNumber" class="form-input"
                   placeholder="Ej: 152, 64, 39..." value="152">
        </div>
        
        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-clock"></i> Intervalo de grabaci√≥n:
            </label>
            <select id="interval" class="form-input">
                <option value="5000">5 segundos</option>
                <option value="10000">10 segundos</option>
                <option value="30000">30 segundos</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-car"></i> Tipo de Veh√≠culo:
            </label>
            <select id="vehicleType" class="form-input">
                <option value="COLECTIVO">Colectivo</option>
                <option value="TREN">Tren</option>
                <option value="SUBTE">Subte</option>
                <option value="TREN_METROPOLITANO">Tren Metropolitano</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-route"></i> Sentido del Viaje:
            </label>
            <select id="direction" class="form-input">
                <option value="IDA">Ida</option>
                <option value="VUELTA">Vuelta</option>
                <option value="CIRCULAR">Circular</option>
            </select>
        </div>
        
        <button class="btn" style="width:100%; margin-bottom:10px;" onclick="saveConfig()">
            <i class="fas fa-save"></i> GUARDAR CONFIGURACI√ìN
        </button>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #0f3460;">
            <p style="font-size: 12px; color: #a0a0c0;">
                <strong>Configuraci√≥n actual:</strong><br>
                <span id="currentConfig">L√≠nea: 152, Intervalo: 5s</span>
            </p>
        </div>
    </div>
    
    <!-- MENSAJES -->
    <div class="message" id="message"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN FIJA - GAS PRE-CONFIGURADO
        // ============================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzAzsJk8BpemD3DIJ9HxprxqqHClLJaFkXeUfOxs8tNjKP_6zA2ln21igM7G80pZBvOgQ/exec';
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map = null;
        let userMarker = null;
        let routePolyline = null;
        
        // Estado de grabaci√≥n
        let isRecording = false;
        let recordingStart = null;
        let recordingInterval = null;
        let durationInterval = null;
        
        // Datos GPS actuales
        let currentPos = null;
        let currentSpeed = 0;
        let currentHeading = 0;
        let currentAccuracy = 0;
        
        // Datos locales
        let localData = [];
        let dataCount = 0;
        let sentDataCount = 0;
        let pendingData = [];
        
        // Detecci√≥n de paradas
        let isStopped = false;
        let stopStart = null;
        let stopDuration = 0;
        let totalStopTime = 0;
        let stopCount = 0;
        
        // Configuraci√≥n del usuario
        let config = {
            lineNumber: '152',
            interval: 5000,
            vehicleType: 'COLECTIVO',
            direction: 'IDA',
            lastSend: null,
            totalPoints: 0
        };
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando sistema de auditor√≠a GPS');
            console.log('üì° URL GAS configurada:', GAS_URL);
            
            initMap();
            loadConfig();
            startGPS();
            updateConfigDisplay();
            
            showMessage('‚úÖ Sistema listo - GAS configurado', 'success');
            
            // Mostrar estado del GAS
            testGASConnection();
        });
        
        // ============================================
        // FUNCIONES DEL MAPA
        // ============================================
        function initMap() {
            map = L.map('map').setView([-34.6037, -58.3816], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            console.log('üó∫Ô∏è Mapa inicializado');
        }
        
        function updateMapPosition(lat, lng) {
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background:#3498db; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow:0 0 10px #3498db;"></div>'
                    })
                }).addTo(map);
                
                routePolyline = L.polyline([[lat, lng]], {
                    color: '#3498db',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
                let path = routePolyline.getLatLngs();
                path.push([lat, lng]);
                routePolyline.setLatLngs(path);
            }
            
            map.setView([lat, lng], 16);
        }
        
        // ============================================
        // SISTEMA GPS
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                showMessage('‚ùå Tu navegador no soporta GPS', 'error');
                return;
            }
            
            console.log('üì° Iniciando seguimiento GPS...');
            
            navigator.geolocation.watchPosition(
                position => handlePosition(position),
                error => handleGPSError(error),
                {
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 10000
                }
            );
        }
        
        function handlePosition(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const speed = pos.coords.speed;
            const heading = pos.coords.heading;
            const accuracy = pos.coords.accuracy;
            
            currentPos = { lat, lng };
            currentSpeed = speed ? speed * 3.6 : 0;
            currentHeading = heading || 0;
            currentAccuracy = accuracy || 0;
            
            // Actualizar UI
            document.getElementById('speedValue').textContent = currentSpeed.toFixed(1) + ' km/h';
            document.getElementById('gpsStatus').textContent = 'ACTIVO';
            document.getElementById('gpsStatusText').innerHTML = '<i class="fas fa-satellite"></i> GPS: ' + Math.round(accuracy) + 'm';
            
            // Actualizar mapa
            updateMapPosition(lat, lng);
            
            // Detectar paradas
            detectStop(currentSpeed, lat, lng, Date.now());
            
            // Si est√° grabando, registrar punto
            if (isRecording) {
                recordCurrentPoint();
            }
        }
        
        function detectStop(speed, lat, lng, timestamp) {
            const stopped = speed < 1; // Menos de 1 km/h = parado
            
            if (stopped && !isStopped) {
                // Inicio de parada
                isStopped = true;
                stopStart = timestamp;
                console.log('üõë Inicio de parada detectado');
            } else if (!stopped && isStopped) {
                // Fin de parada
                isStopped = false;
                stopDuration = timestamp - stopStart;
                
                if (stopDuration >= 5000) { // 5 segundos m√≠nimo para registrar
                    // Registrar evento de parada
                    const stopEvent = {
                        timestamp: timestamp,
                        date: new Date().toLocaleDateString('es-AR'),
                        time: new Date().toLocaleTimeString('es-AR'),
                        lat: lat,
                        lng: lng,
                        speed: 0,
                        eventType: 'PARADA',
                        stopDuration: stopDuration,
                        line: config.lineNumber,
                        vehicleType: config.vehicleType,
                        direction: config.direction
                    };
                    
                    localData.push(stopEvent);
                    pendingData.push(stopEvent);
                    dataCount++;
                    totalStopTime += stopDuration;
                    stopCount++;
                    
                    updateDataCount();
                    updateRecentData(stopEvent);
                    showMessage(`üõë Parada detectada: ${Math.round(stopDuration/1000)} segundos`, 'warning');
                }
                
                stopStart = null;
                stopDuration = 0;
            }
        }
        
        function handleGPSError(error) {
            console.error('GPS Error:', error);
            document.getElementById('gpsStatus').textContent = 'ERROR';
            document.getElementById('gpsStatusText').innerHTML = '<i class="fas fa-exclamation-triangle"></i> GPS ERROR';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    showMessage('‚ùå Permiso de GPS denegado', 'error');
                    break;
                case error.POSITION_UNAVAILABLE:
                    showMessage('‚ùå Posici√≥n no disponible', 'error');
                    break;
                case error.TIMEOUT:
                    showMessage('‚ùå Tiempo de espera agotado', 'error');
                    break;
            }
        }
        
        // ============================================
        // SISTEMA DE GRABACI√ìN
        // ============================================
        function toggleRecording() {
            if (!currentPos) {
                showMessage('‚ö†Ô∏è Esperando se√±al GPS...', 'warning');
                return;
            }
            
            isRecording = !isRecording;
            const btn = document.getElementById('recordBtn');
            const icon = document.getElementById('recordIcon');
            const text = document.getElementById('recordText');
            
            if (isRecording) {
                // INICIAR GRABACI√ìN
                recordingStart = Date.now();
                localData = [];
                pendingData = [];
                dataCount = 0;
                sentDataCount = 0;
                totalStopTime = 0;
                stopCount = 0;
                
                btn.classList.add('recording');
                icon.className = 'fas fa-square';
                text.textContent = 'GRABANDO';
                
                document.getElementById('recordingStatus').textContent = 'ACTIVA';
                document.getElementById('recordingStatus').style.color = '#e74c3c';
                
                // Iniciar intervalo de grabaci√≥n
                const interval = parseInt(config.interval);
                recordingInterval = setInterval(() => {
                    if (currentPos) {
                        recordCurrentPoint();
                    }
                }, interval);
                
                // Grabar primer punto inmediatamente
                recordCurrentPoint();
                
                // Iniciar contador de duraci√≥n
                startDurationCounter();
                
                showMessage('üé• Grabaci√≥n iniciada - Enviando a Google Sheets', 'success');
                console.log('‚è∫Ô∏è Grabaci√≥n iniciada, intervalo:', interval + 'ms');
                
            } else {
                // DETENER GRABACI√ìN
                btn.classList.remove('recording');
                icon.className = 'fas fa-circle';
                text.textContent = 'INICIAR';
                
                document.getElementById('recordingStatus').textContent = 'INACTIVA';
                document.getElementById('recordingStatus').style.color = '#2ecc71';
                
                if (recordingInterval) {
                    clearInterval(recordingInterval);
                    recordingInterval = null;
                }
                
                if (durationInterval) {
                    clearInterval(durationInterval);
                    durationInterval = null;
                }
                
                // Enviar datos restantes
                if (pendingData.length > 0) {
                    sendToGoogleSheets();
                }
                
                // Guardar datos localmente
                saveLocalBackup();
                
                showMessage('‚èπÔ∏è Grabaci√≥n detenida - Datos guardados', 'info');
                console.log('‚èπÔ∏è Grabaci√≥n detenida, puntos totales:', dataCount);
            }
        }
        
        function recordCurrentPoint() {
            if (!currentPos) return;
            
            const dataPoint = {
                timestamp: Date.now(),
                date: new Date().toLocaleDateString('es-AR'),
                time: new Date().toLocaleTimeString('es-AR'),
                lat: currentPos.lat,
                lng: currentPos.lng,
                speed: currentSpeed,
                heading: currentHeading,
                accuracy: Math.round(currentAccuracy),
                eventType: isStopped ? 'PARADA' : 'MOVIMIENTO',
                line: config.lineNumber,
                vehicleType: config.vehicleType,
                direction: config.direction,
                stopDuration: isStopped ? (Date.now() - stopStart) : 0
            };
            
            localData.push(dataPoint);
            pendingData.push(dataPoint);
            dataCount++;
            config.totalPoints = dataCount;
            
            updateDataCount();
            updateRecentData(dataPoint);
            
            // Enviar a Google Sheets cada 10 puntos
            if (pendingData.length >= 10) {
                sendToGoogleSheets();
            }
            
            // Guardar en localStorage cada 5 puntos
            if (dataCount % 5 === 0) {
                saveLocalBackup();
            }
            
            return dataPoint;
        }
        
        function startDurationCounter() {
            durationInterval = setInterval(() => {
                if (!isRecording) {
                    clearInterval(durationInterval);
                    return;
                }
                
                const elapsed = Date.now() - recordingStart;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('duration').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function updateDataCount() {
            document.getElementById('dataCount').textContent = dataCount;
            document.getElementById('pendingCount').textContent = pendingData.length;
        }
        
        function updateRecentData(dataPoint) {
            const recentList = document.getElementById('recentData');
            const item = document.createElement('div');
            item.className = 'data-item';
            
            const time = dataPoint.time.split(':').slice(0, 2).join(':');
            const type = dataPoint.eventType === 'PARADA' ? 'üõë' : 'üöå';
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <span>${type} ${time}</span>
                    <span>${dataPoint.speed.toFixed(1)} km/h</span>
                </div>
                <div style="font-size: 10px; color: #8080a0;">
                    ${dataPoint.lat.toFixed(5)}, ${dataPoint.lng.toFixed(5)}
                </div>
            `;
            
            recentList.insertBefore(item, recentList.firstChild);
            
            // Mantener solo √∫ltimos 10 items
            if (recentList.children.length > 10) {
                recentList.removeChild(recentList.lastChild);
            }
        }
        
        // ============================================
        // GOOGLE APPS SCRIPT INTEGRATION
        // ============================================
        async function sendToGoogleSheets() {
            if (pendingData.length === 0) {
                return;
            }
            
            try {
                showMessage('üì§ Enviando datos a Google Sheets...', 'info');
                console.log('üì§ Enviando', pendingData.length, 'puntos a GAS');
                
                const dataToSend = [...pendingData];
                
                // Enviar datos al GAS
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'saveData',
                        data: dataToSend
                    })
                });
                
                // Actualizar contadores
                sentDataCount += dataToSend.length;
                pendingData = [];
                
                // Actualizar UI
                config.lastSend = new Date().toLocaleTimeString('es-AR');
                document.getElementById('lastSend').textContent = config.lastSend;
                document.getElementById('pendingCount').textContent = '0';
                
                // Guardar configuraci√≥n
                saveConfig();
                
                showMessage(`‚úÖ ${dataToSend.length} puntos enviados a Sheets`, 'success');
                console.log('‚úÖ Datos enviados a GAS');
                
            } catch (error) {
                console.error('‚ùå Error enviando datos:', error);
                showMessage('‚ùå Error al enviar datos - Guardando localmente', 'error');
                
                // Guardar backup local en caso de error
                saveLocalBackup();
            }
        }
        
        async function forceSendToSheets() {
            if (pendingData.length === 0) {
                showMessage('No hay datos pendientes para enviar', 'warning');
                return;
            }
            
            await sendToGoogleSheets();
        }
        
        async function testGASConnection() {
            try {
                console.log('üîó Probando conexi√≥n con GAS...');
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'test',
                        message: 'Test connection'
                    })
                });
                
                console.log('‚úÖ Conexi√≥n GAS establecida');
                showMessage('‚úÖ Conexi√≥n con Google Sheets establecida', 'success');
                
            } catch (error) {
                console.log('‚ö†Ô∏è No se pudo verificar conexi√≥n GAS (modo no-cors)');
            }
        }
        
        // ============================================
        // CONFIGURACI√ìN LOCAL
        // ============================================
        function loadConfig() {
            const saved = localStorage.getItem('auditoriaConfig');
            if (saved) {
                try {
                    config = JSON.parse(saved);
                    
                    // Actualizar campos del formulario
                    document.getElementById('lineNumber').value = config.lineNumber || '152';
                    document.getElementById('interval').value = config.interval || 5000;
                    document.getElementById('vehicleType').value = config.vehicleType || 'COLECTIVO';
                    document.getElementById('direction').value = config.direction || 'IDA';
                    
                    updateConfigDisplay();
                    console.log('‚öôÔ∏è Configuraci√≥n cargada:', config);
                } catch (e) {
                    console.error('Error cargando configuraci√≥n:', e);
                }
            }
        }
        
        function saveConfig() {
            // Obtener valores del formulario
            config.lineNumber = document.getElementById('lineNumber').value.trim() || '152';
            config.interval = parseInt(document.getElementById('interval').value) || 5000;
            config.vehicleType = document.getElementById('vehicleType').value;
            config.direction = document.getElementById('direction').value;
            
            // Guardar en localStorage
            localStorage.setItem('auditoriaConfig', JSON.stringify(config));
            
            // Actualizar display
            updateConfigDisplay();
            
            console.log('üíæ Configuraci√≥n guardada:', config);
        }
        
        function updateConfigDisplay() {
            let display = '';
            
            display += `‚úì L√≠nea: ${config.lineNumber}<br>`;
            display += `‚úì Intervalo: ${config.interval/1000} segundos<br>`;
            display += `‚úì Veh√≠culo: ${config.vehicleType}<br>`;
            display += `‚úì Sentido: ${config.direction}`;
            
            if (config.lastSend) {
                display += `<br>‚úì √öltimo env√≠o: ${config.lastSend}`;
            }
            
            if (config.totalPoints) {
                display += `<br>‚úì Total puntos: ${config.totalPoints}`;
            }
            
            document.getElementById('currentConfig').innerHTML = display;
        }
        
        function saveLocalBackup() {
            if (localData.length === 0) return;
            
            const backup = {
                timestamp: Date.now(),
                data: localData,
                config: config,
                totalPoints: dataCount,
                totalStopTime: totalStopTime,
                stopCount: stopCount
            };
            
            localStorage.setItem('auditoriaBackup', JSON.stringify(backup));
            console.log('üíæ Backup local guardado:', localData.length, 'puntos');
        }
        
        // ============================================
        // EXPORTACI√ìN LOCAL
        // ============================================
        function exportToCSV() {
            if (localData.length === 0) {
                showMessage('No hay datos para exportar', 'warning');
                return;
            }
            
            let csv = 'Fecha,Hora,Latitud,Longitud,Velocidad (km/h),Direcci√≥n,Precisi√≥n (m),Tipo Evento,Duraci√≥n Parada (ms),L√≠nea,Veh√≠culo,Sentido\n';
            
            localData.forEach(item => {
                const row = [
                    `"${item.date}"`,
                    `"${item.time}"`,
                    item.lat,
                    item.lng,
                    item.speed?.toFixed(1) || '0.0',
                    item.heading || '',
                    item.accuracy || '',
                    `"${item.eventType}"`,
                    item.stopDuration || '',
                    `"${item.line || ''}"`,
                    `"${item.vehicleType || ''}"`,
                    `"${item.direction || ''}"`
                ];
                
                csv += row.join(',') + '\n';
            });
            
            // Agregar metadatos
            csv += '\nMETADATOS\n';
            csv += `Fecha exportaci√≥n,${new Date().toLocaleString()}\n`;
            csv += `Total puntos,${localData.length}\n`;
            csv += `Paradas detectadas,${stopCount}\n`;
            csv += `Tiempo total paradas,${totalStopTime}ms\n`;
            csv += `L√≠nea,${config.lineNumber}\n`;
            csv += `Veh√≠culo,${config.vehicleType}\n`;
            csv += `Sentido,${config.direction}\n`;
            
            // Crear archivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `auditoria_${config.lineNumber}_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage(`üì• CSV descargado: ${localData.length} puntos`, 'success');
            console.log('üìÅ CSV exportado:', localData.length, 'puntos');
        }
        
        // ============================================
        // INTERFAZ DE USUARIO
        // ============================================
        function togglePanel(panelId) {
            const panels = ['panelStatus', 'panelConfig'];
            
            panels.forEach(id => {
                const panel = document.getElementById(id);
                if (id === panelId) {
                    panel.classList.toggle('active');
                } else {
                    panel.classList.remove('active');
                }
            });
        }
        
        function showMessage(text, type = 'info') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            
            // Auto-ocultar
            setTimeout(() => {
                msg.style.display = 'none';
            }, 3000);
        }
        
        // ============================================
        // MANEJO DE SEGUNDO PLANO Y CIERRE
        // ============================================
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isRecording) {
                console.log('üì± App en segundo plano - Grabaci√≥n continua');
                showMessage('üì± Grabando en segundo plano...', 'info');
            }
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (isRecording && localData.length > 0) {
                e.preventDefault();
                e.returnValue = 'Hay una grabaci√≥n en progreso. ¬øEst√°s seguro de salir?';
                
                // Intentar enviar datos antes de salir
                sendToGoogleSheets();
                saveLocalBackup();
                
                return e.returnValue;
            }
        });
        
        // ============================================
        // FUNCIONES GLOBALES PARA DESARROLLO
        // ============================================
        // Exponer funciones para la consola
        window.debug = {
            getData: () => localData,
            getConfig: () => config,
            getStats: () => ({
                totalPoints: dataCount,
                pendingPoints: pendingData.length,
                sentPoints: sentDataCount,
                stopCount: stopCount,
                totalStopTime: totalStopTime,
                isRecording: isRecording
            }),
            clearData: () => {
                localData = [];
                pendingData = [];
                dataCount = 0;
                updateDataCount();
                console.log('Datos limpiados');
            },
            simulatePoint: () => {
                if (!currentPos) {
                    currentPos = { lat: -34.6037 + (Math.random() - 0.5) * 0.01, lng: -58.3816 + (Math.random() - 0.5) * 0.01 };
                }
                return recordCurrentPoint();
            }
        };
        
        console.log('‚úÖ Sistema de auditor√≠a GPS listo');
        console.log('üîó GAS URL:', GAS_URL);
        console.log('üí° Usa window.debug en la consola para funciones de desarrollo');
    </script>
</body>
</html>