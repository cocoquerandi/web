<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento en Tiempo Real</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* HUD simple y minimalista */
        .hud-top {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            pointer-events: none;
        }
        
        .hud-top > div {
            pointer-events: auto;
        }
        
        .speed-box {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 120px;
        }
        
        .speed-label {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .controls {
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            gap: 8px;
        }
        
        .transport-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .transport-btn.active {
            background: #007AFF;
        }
        
        .line-selector {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 70vh;
            overflow-y: auto;
            display: none;
        }
        
        .line-selector.show {
            display: block;
        }
        
        .line-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
        }
        
        .line-btn.active {
            background: #007AFF;
        }
        
        .info-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .station-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .station-item {
            flex: 1;
            padding: 8px;
        }
        
        .station-label {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: bold;
        }
        
        .station-distance {
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* Marcador de usuario */
        .user-marker {
            background: #007AFF;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
        }
        
        .user-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }
        
        /* Marcadores de estaciones */
        .station-marker {
            background: #34C759;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            border: 2px solid white;
        }
        
        .next-station-marker {
            background: #FF3B30;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            border: 3px solid white;
        }
        
        /* Indicador en vivo */
        .live-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #34C759;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: #34C759;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        /* Para móvil */
        @media (max-width: 768px) {
            .hud-top {
                flex-direction: column;
                top: 10px;
                left: 10px;
                right: 10px;
            }
            
            .info-box {
                bottom: 10px;
                left: 10px;
                right: 10px;
            }
            
            .station-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Mapa a pantalla completa -->
    <div id="map"></div>
    
    <!-- HUD Superior -->
    <div class="hud-top">
        <div class="speed-box">
            <div class="speed-label">VELOCIDAD</div>
            <div id="speedValue">0.0 km/h</div>
        </div>
        
        <div class="controls">
            <button class="transport-btn active" onclick="selectTransport('train')">Tren</button>
            <button class="transport-btn" onclick="selectTransport('subte')">Subte</button>
            <button class="transport-btn" onclick="selectTransport('bus')">Colectivo</button>
        </div>
    </div>
    
    <!-- Indicador en vivo -->
    <div class="live-indicator">
        <div class="live-dot"></div>
        <span>EN VIVO</span>
    </div>
    
    <!-- Selector de línea -->
    <div class="line-selector" id="lineSelector">
        <button class="line-btn" onclick="selectLine('sarmiento', 'Sarmiento')">Sarmiento</button>
        <button class="line-btn" onclick="selectLine('mitre', 'Mitre')">Mitre</button>
        <button class="line-btn" onclick="selectLine('roca', 'Roca')">Roca</button>
        <button class="line-btn" onclick="selectLine('urquiza', 'Urquiza')">Urquiza</button>
        <button class="line-btn" onclick="selectLine('sanmartin', 'San Martín')">San Martín</button>
    </div>
    
    <!-- Información de estaciones -->
    <div class="info-box">
        <div class="station-info">
            <div class="station-item">
                <div class="station-label">ESTACIÓN ACTUAL</div>
                <div class="station-name" id="currentStation">-</div>
                <div class="station-distance" id="currentDistance">-</div>
            </div>
            <div class="station-item">
                <div class="station-label">PRÓXIMA ESTACIÓN</div>
                <div class="station-name" id="nextStation">-</div>
                <div class="station-distance" id="nextDistance">-</div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACIÓN INICIAL SIMPLE
        // ============================================
        
        // 1. Inicializar mapa
        const map = L.map('map').setView([-34.6037, -58.3816], 13);
        
        // 2. Capa base de OpenStreetMap (como Google Maps)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);
        
        // 3. Variables principales
        let userMarker = null;
        let stationMarkers = [];
        let nextStationMarker = null;
        let watchId = null;
        
        // 4. Estado actual
        let currentTransport = 'train';
        let currentLine = null;
        let lastPosition = null;
        let currentSpeed = 0;
        let totalDistance = 0;
        
        // 5. Base de datos simple de estaciones
        const stations = {
            sarmiento: [
                {name: 'Once', lat: -34.609722, lng: -58.408889},
                {name: 'Caballito', lat: -34.618611, lng: -58.441944},
                {name: 'Flores', lat: -34.629167, lng: -58.463056},
                {name: 'Liniers', lat: -34.641667, lng: -58.523889},
                {name: 'Morón', lat: -34.650833, lng: -58.621111},
                {name: 'Castelar', lat: -34.656944, lng: -58.6525},
                {name: 'Ituzaingó', lat: -34.659167, lng: -58.671944},
                {name: 'Merlo', lat: -34.665833, lng: -58.728056},
                {name: 'Moreno', lat: -34.635, lng: -58.791111}
            ],
            mitre: [
                {name: 'Retiro', lat: -34.591389, lng: -58.373889},
                {name: 'Lisandro de la Torre', lat: -34.595833, lng: -58.4075},
                {name: 'Vicente López', lat: -34.530833, lng: -58.474722},
                {name: 'Olivos', lat: -34.5075, lng: -58.4875},
                {name: 'San Isidro', lat: -34.470556, lng: -58.521389},
                {name: 'Tigre', lat: -34.420556, lng: -58.579722}
            ],
            roca: [
                {name: 'Constitución', lat: -34.628056, lng: -58.381111},
                {name: 'Avellaneda', lat: -34.663611, lng: -58.367222},
                {name: 'Lanús', lat: -34.699722, lng: -58.3925},
                {name: 'Banfield', lat: -34.743056, lng: -58.392222},
                {name: 'Temperley', lat: -34.768056, lng: -58.394722},
                {name: 'Glew', lat: -34.889167, lng: -58.380556}
            ]
        };
        
        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        
        // 1. Iniciar seguimiento GPS
        function startGPS() {
            if (!navigator.geolocation) {
                alert('Tu navegador no soporta GPS');
                return;
            }
            
            // Obtener posición inicial
            navigator.geolocation.getCurrentPosition(position => {
                updatePosition(position);
                map.setView([position.coords.latitude, position.coords.longitude], 15);
            });
            
            // Seguimiento continuo
            watchId = navigator.geolocation.watchPosition(position => {
                updatePosition(position);
                
                // Seguir al usuario automáticamente
                map.panTo([position.coords.latitude, position.coords.longitude], {
                    animate: true,
                    duration: 1
                });
                
                // Actualizar datos
                updateStats(position);
                
                // Si hay línea seleccionada, buscar estaciones cercanas
                if (currentLine) {
                    findNearestStations(position.coords.latitude, position.coords.longitude);
                }
            }, null, {
                enableHighAccuracy: true,
                maximumAge: 1000,
                timeout: 5000
            });
        }
        
        // 2. Actualizar posición del usuario
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Crear o mover marcador
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        iconSize: [26, 26]
                    })
                }).addTo(map);
            } else {
                // Movimiento suave como Google Maps
                userMarker.setLatLng([lat, lng]);
            }
            
            lastPosition = position;
        }
        
        // 3. Actualizar estadísticas
        function updateStats(position) {
            if (!lastPosition) return;
            
            // Calcular velocidad
            const lat1 = lastPosition.coords.latitude;
            const lng1 = lastPosition.coords.longitude;
            const lat2 = position.coords.latitude;
            const lng2 = position.coords.longitude;
            
            const distance = getDistance(lat1, lng1, lat2, lng2);
            const timeDiff = (position.timestamp - lastPosition.timestamp) / 1000;
            
            if (timeDiff > 0) {
                currentSpeed = (distance / timeDiff) * 3.6; // km/h
                totalDistance += distance;
                
                // Actualizar display
                document.getElementById('speedValue').textContent = 
                    currentSpeed.toFixed(1) + ' km/h';
            }
        }
        
        // 4. Seleccionar transporte
        function selectTransport(type) {
            currentTransport = type;
            
            // Actualizar botones
            document.querySelectorAll('.transport-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mostrar selector de línea
            document.getElementById('lineSelector').classList.add('show');
        }
        
        // 5. Seleccionar línea
        function selectLine(lineId, lineName) {
            currentLine = lineId;
            
            // Actualizar botones
            document.querySelectorAll('.line-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Ocultar selector
            document.getElementById('lineSelector').classList.remove('show');
            
            // Cargar estaciones
            loadStations(lineId);
            
            // Buscar estación más cercana si tenemos posición
            if (lastPosition) {
                findNearestStations(
                    lastPosition.coords.latitude, 
                    lastPosition.coords.longitude
                );
            }
        }
        
        // 6. Cargar estaciones en el mapa
        function loadStations(lineId) {
            // Limpiar estaciones anteriores
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
            
            if (stations[lineId]) {
                stations[lineId].forEach(station => {
                    const marker = L.marker([station.lat, station.lng], {
                        icon: L.divIcon({
                            className: 'station-marker',
                            iconSize: [16, 16]
                        })
                    })
                    .bindPopup(station.name)
                    .addTo(map);
                    
                    stationMarkers.push(marker);
                });
            }
        }
        
        // 7. Encontrar estaciones más cercanas
        function findNearestStations(userLat, userLng) {
            if (!currentLine || !stations[currentLine]) return;
            
            const lineStations = stations[currentLine];
            let nearestStation = null;
            let nearestDistance = Infinity;
            let nearestIndex = -1;
            
            // Encontrar estación más cercana
            lineStations.forEach((station, index) => {
                const distance = getDistance(userLat, userLng, station.lat, station.lng);
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestStation = station;
                    nearestIndex = index;
                }
            });
            
            if (!nearestStation) return;
            
            // Determinar próxima estación
            let nextStation = null;
            if (nearestIndex < lineStations.length - 1) {
                nextStation = lineStations[nearestIndex + 1];
            } else if (nearestIndex > 0) {
                nextStation = lineStations[nearestIndex - 1];
            }
            
            // Actualizar marcador de próxima estación
            updateNextStationMarker(nextStation);
            
            // Actualizar información
            updateStationInfo(nearestStation, nextStation, userLat, userLng);
        }
        
        // 8. Actualizar marcador de próxima estación
        function updateNextStationMarker(station) {
            // Eliminar marcador anterior
            if (nextStationMarker) {
                map.removeLayer(nextStationMarker);
            }
            
            if (!station) return;
            
            // Crear nuevo marcador
            nextStationMarker = L.marker([station.lat, station.lng], {
                icon: L.divIcon({
                    className: 'next-station-marker',
                    iconSize: [22, 22]
                })
            })
            .bindPopup('Próxima: ' + station.name)
            .addTo(map);
        }
        
        // 9. Actualizar información de estaciones
        function updateStationInfo(currentStation, nextStation, userLat, userLng) {
            if (!currentStation) return;
            
            // Actualizar estación actual
            document.getElementById('currentStation').textContent = currentStation.name;
            const currentDist = getDistance(userLat, userLng, currentStation.lat, currentStation.lng);
            document.getElementById('currentDistance').textContent = 
                Math.round(currentDist) + ' metros';
            
            // Actualizar próxima estación
            if (nextStation) {
                document.getElementById('nextStation').textContent = nextStation.name;
                const nextDist = getDistance(userLat, userLng, nextStation.lat, nextStation.lng);
                document.getElementById('nextDistance').textContent = 
                    Math.round(nextDist) + ' metros';
            } else {
                document.getElementById('nextStation').textContent = '-';
                document.getElementById('nextDistance').textContent = '-';
            }
        }
        
        // 10. Función para calcular distancia
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radio de la Tierra en metros
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // 11. Cerrar selectores al hacer clic fuera
        document.addEventListener('click', function(e) {
            const selector = document.getElementById('lineSelector');
            const controls = document.querySelector('.controls');
            
            if (!selector.contains(e.target) && 
                !controls.contains(e.target) &&
                selector.classList.contains('show')) {
                selector.classList.remove('show');
            }
        });
        
        // ============================================
        // INICIAR TODO
        // ============================================
        
        // Iniciar GPS cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            startGPS();
            
            // Seleccionar Sarmiento por defecto
            setTimeout(() => {
                selectLine('sarmiento', 'Sarmiento');
            }, 1000);
        });
        
        // Manejar cambios de pantalla
        window.addEventListener('resize', function() {
            map.invalidateSize();
        });
    </script>
</body>
</html>