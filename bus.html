<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detección de Transporte - Sandbox</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;700&family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0e14;
            color: #c7c7c7;
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            background: #0a0e14;
            overflow: hidden;
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas: 
                "header header"
                "main console";
            height: 100vh;
            gap: 0;
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 2fr 1fr;
                grid-template-areas: 
                    "header"
                    "main"
                    "console";
            }
        }
        
        header {
            grid-area: header;
            padding: 20px 30px;
            background: rgba(20, 25, 35, 0.95);
            border-bottom: 1px solid #1e2532;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 700;
            color: #64b5f6;
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: 'Roboto Mono', monospace;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.8;
            font-weight: 300;
            max-width: 800px;
            margin: 0;
            color: #8a9ba8;
        }
        
        .main-content {
            grid-area: main;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
            background: #0f1319;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                overflow: auto;
            }
        }
        
        .panel-left {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        
        .panel-right {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .info-card {
            background: #1a202c;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2d3748;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .info-card h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #64b5f6;
            font-family: 'Roboto Mono', monospace;
        }
        
        .coordinates {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .coordinate-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #2d3748;
        }
        
        .coordinate-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #8a9ba8;
        }
        
        .coordinate-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #64b5f6;
            font-family: 'Roboto Mono', monospace;
        }
        
        .transport-detection {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .transport-icon {
            font-size: 3.5rem;
            text-align: center;
            margin: 5px 0;
            color: #64b5f6;
        }
        
        .transport-name {
            font-size: 1.6rem;
            text-align: center;
            font-weight: 700;
            margin-bottom: 10px;
            color: #64b5f6;
            font-family: 'Roboto Mono', monospace;
        }
        
        .transport-confidence {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .confidence-bar {
            flex: 1;
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
            margin-right: 15px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #64b5f6, #42a5f5);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .confidence-value {
            font-weight: 600;
            font-size: 1rem;
            color: #64b5f6;
            font-family: 'Roboto Mono', monospace;
        }
        
        .speed-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #2d3748;
        }
        
        .speed-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #64b5f6;
            font-family: 'Roboto Mono', monospace;
        }
        
        .speed-unit {
            font-size: 0.9rem;
            opacity: 0.8;
            color: #8a9ba8;
        }
        
        .map-container {
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: relative;
            border: 1px solid #2d3748;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 1000;
        }
        
        .map-controls {
            background: rgba(10, 14, 20, 0.9);
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            pointer-events: auto;
            border: 1px solid #2d3748;
        }
        
        .map-btn {
            background: #2d3748;
            color: #64b5f6;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .map-btn:hover {
            background: #64b5f6;
            color: #0a0e14;
            transform: scale(1.1);
        }
        
        .line-selector {
            background: rgba(10, 14, 20, 0.9);
            border-radius: 8px;
            padding: 8px 12px;
            pointer-events: auto;
            border: 1px solid #2d3748;
        }
        
        .line-selector select {
            background: #2d3748;
            color: #c7c7c7;
            border: 1px solid #4a5568;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 200px;
            font-family: 'Roboto Mono', monospace;
        }
        
        .line-selector option {
            background: #1a202c;
            color: #c7c7c7;
        }
        
        .line-info {
            margin-top: 20px;
        }
        
        .line-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
        }
        
        .line-detail {
            flex: 1;
            min-width: 100px;
            background: #2d3748;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .detail-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #64b5f6;
            margin-bottom: 5px;
            font-family: 'Roboto Mono', monospace;
        }
        
        .detail-label {
            font-size: 0.85rem;
            opacity: 0.8;
            color: #8a9ba8;
        }
        
        /* Consola Sandbox */
        .console-sandbox {
            grid-area: console;
            background: #0a0e14;
            border-top: 1px solid #1e2532;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .console-header {
            padding: 15px 20px;
            background: rgba(20, 25, 35, 0.95);
            border-bottom: 1px solid #1e2532;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #64b5f6;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Roboto Mono', monospace;
        }
        
        .console-controls {
            display: flex;
            gap: 10px;
        }
        
        .console-btn {
            background: #2d3748;
            color: #c7c7c7;
            border: 1px solid #4a5568;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-family: 'Roboto Mono', monospace;
        }
        
        .console-btn:hover {
            background: #4a5568;
            color: #64b5f6;
        }
        
        .console-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            background: #0a0e14;
        }
        
        .console-line {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 5px;
            background: rgba(20, 25, 35, 0.5);
            border-left: 3px solid #64b5f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-line.warning {
            border-left-color: #ffb74d;
            background: rgba(255, 183, 77, 0.1);
        }
        
        .console-line.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        
        .console-line.success {
            border-left-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .console-line.info {
            border-left-color: #64b5f6;
            background: rgba(100, 181, 246, 0.1);
        }
        
        .console-timestamp {
            font-size: 0.8rem;
            color: #8a9ba8;
            min-width: 100px;
            text-align: right;
        }
        
        .console-message {
            flex: 1;
            margin-right: 15px;
            word-break: break-word;
        }
        
        .console-data {
            color: #64b5f6;
            font-weight: 500;
        }
        
        /* Animaciones */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0f1319;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #2d3748;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4a5568;
        }
        
        /* Footer */
        footer {
            grid-area: footer;
            text-align: center;
            padding: 15px;
            font-size: 0.8rem;
            opacity: 0.7;
            color: #8a9ba8;
            border-top: 1px solid #1e2532;
            background: rgba(20, 25, 35, 0.95);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            .map-overlay {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .line-selector select {
                min-width: 100%;
            }
            
            .console-line {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .console-timestamp {
                text-align: left;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-terminal"></i> Detección de Transporte - Sandbox de Consola</h1>
            <p class="subtitle">Sistema que detecta tu medio de transporte en tiempo real y muestra datos de depuración en la consola</p>
        </header>
        
        <div class="main-content">
            <div class="panel-left">
                <!-- Coordenadas y datos de ubicación -->
                <div class="info-card">
                    <h2><i class="fas fa-location-dot"></i> Ubicación Actual</h2>
                    <div class="coordinates">
                        <div class="coordinate-row">
                            <div class="coordinate-label">
                                <i class="fas fa-globe-americas"></i> Latitud
                            </div>
                            <div class="coordinate-value" id="latitude">--</div>
                        </div>
                        <div class="coordinate-row">
                            <div class="coordinate-label">
                                <i class="fas fa-globe-americas"></i> Longitud
                            </div>
                            <div class="coordinate-value" id="longitude">--</div>
                        </div>
                        <div class="coordinate-row">
                            <div class="coordinate-label">
                                <i class="fas fa-bullseye"></i> Precisión
                            </div>
                            <div class="coordinate-value" id="accuracy">-- m</div>
                        </div>
                        <div class="coordinate-row">
                            <div class="coordinate-label">
                                <i class="fas fa-clock"></i> Última actualización
                            </div>
                            <div class="coordinate-value" id="timestamp">--:--:--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Detección de transporte -->
                <div class="info-card">
                    <h2><i class="fas fa-car-side"></i> Medio Detectado</h2>
                    <div class="transport-detection">
                        <div class="transport-icon" id="transportIcon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="transport-name" id="transportName">
                            Detectando...
                        </div>
                        <div class="transport-confidence">
                            <div class="confidence-label">Probabilidad:</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                            </div>
                            <div class="confidence-value" id="confidenceValue">0%</div>
                        </div>
                        
                        <div class="speed-indicator">
                            <div class="speed-label">Velocidad:</div>
                            <div class="speed-value" id="speedValue">0 <span class="speed-unit">km/h</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Información de la línea -->
                <div class="info-card" id="lineInfoCard" style="display: none;">
                    <h2><i class="fas fa-subway"></i> Información de Línea</h2>
                    <div class="line-info">
                        <h3 id="lineName">Línea Sarmiento</h3>
                        <p id="lineDescription" style="margin-bottom: 15px; color: #8a9ba8;">Recorrido Once - Moreno</p>
                        
                        <div class="line-details">
                            <div class="line-detail">
                                <div class="detail-value" id="lineStations">17</div>
                                <div class="detail-label">Estaciones</div>
                            </div>
                            <div class="line-detail">
                                <div class="detail-value" id="lineDistance">35.5</div>
                                <div class="detail-label">km</div>
                            </div>
                            <div class="line-detail">
                                <div class="detail-value" id="lineDuration">55</div>
                                <div class="detail-label">minutos</div>
                            </div>
                            <div class="line-detail">
                                <div class="detail-value" id="lineFrequency">10</div>
                                <div class="detail-label">min. frecuencia</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mapa -->
            <div class="panel-right">
                <div class="map-container">
                    <div id="map"></div>
                    
                    <div class="map-overlay">
                        <div class="map-controls">
                            <button class="map-btn" id="zoomIn" title="Acercar">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="map-btn" id="zoomOut" title="Alejar">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="map-btn" id="centerMap" title="Centrar en mi ubicación">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                            <button class="map-btn" id="toggleTracking" title="Alternar seguimiento">
                                <i class="fas fa-play" id="trackingIcon"></i>
                            </button>
                        </div>
                        
                        <div class="line-selector">
                            <select id="lineSelector">
                                <option value="sarmiento">Línea Sarmiento (Once - Moreno)</option>
                                <option value="mitre">Línea Mitre (Retiro - Tigre)</option>
                                <option value="roca">Línea Roca (Constitución - Ezeiza)</option>
                                <option value="belgrano">Línea Belgrano Norte (Retiro - Villa Rosa)</option>
                                <option value="sanmartin">Línea San Martín (Retiro - Pilar)</option>
                                <option value="urquiza">Línea Urquiza (Federico Lacroze - General Lemos)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Consola Sandbox -->
        <div class="console-sandbox">
            <div class="console-header">
                <div class="console-title">
                    <i class="fas fa-code"></i> Consola de Depuración
                </div>
                <div class="console-controls">
                    <button class="console-btn" id="clearConsole">
                        <i class="fas fa-trash"></i> Limpiar
                    </button>
                    <button class="console-btn" id="toggleConsole">
                        <i class="fas fa-eye"></i> Ocultar
                    </button>
                    <button class="console-btn" id="exportConsole">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>
            <div class="console-content" id="consoleContent">
                <div class="console-line info">
                    <div class="console-message">
                        <span class="console-data">[SISTEMA]</span> Inicializando consola de depuración...
                    </div>
                    <div class="console-timestamp" id="currentTime">00:00:00</div>
                </div>
                <div class="console-line info">
                    <div class="console-message">
                        <span class="console-data">[GEOLOCALIZACIÓN]</span> Esperando permisos de ubicación...
                    </div>
                    <div class="console-timestamp">00:00:00</div>
                </div>
                <div class="console-line">
                    <div class="console-message">
                        <span class="console-data">[CONFIGURACIÓN]</span> Umbrales de velocidad: Caminar (0-6 km/h), Bicicleta (6-15 km/h), Auto (15-40 km/h), Colectivo (40-80 km/h), Tren (>80 km/h)
                    </div>
                    <div class="console-timestamp">00:00:00</div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Sistema de Detección de Transporte con Sandbox de Consola &copy; 2023 | Modo oscuro activado</p>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales
        let watchId = null;
        let isTracking = false;
        let map = null;
        let userMarker = null;
        let userCircle = null;
        let trainLine = null;
        let trainStations = [];
        let lastPosition = null;
        let lastTime = null;
        let currentSpeed = 0;
        let currentTransport = "unknown";
        let consoleVisible = true;
        let consoleLog = [];
        
        // Datos de las líneas de tren (coordenadas aproximadas)
        const trainLines = {
            sarmiento: {
                name: "Línea Sarmiento",
                description: "Recorrido Once - Moreno",
                color: "#FF5252",
                stations: 17,
                distance: 35.5,
                duration: 55,
                frequency: 10,
                coordinates: [
                    [-34.6091, -58.4086], // Once
                    [-34.6105, -58.4203], // Caballito
                    [-34.6182, -58.4357], // Flores
                    [-34.6358, -58.4772], // Floresta
                    [-34.6405, -58.5278], // Liniers
                    [-34.6489, -58.5658], // Villa Luro
                    [-34.6605, -58.6047], // Ramos Mejía
                    [-34.6647, -58.6314], // Haedo
                    [-34.6689, -58.6569], // Morón
                    [-34.6758, -58.7008], // Castelar
                    [-34.6819, -58.7283], // Ituzaingó
                    [-34.6900, -58.7600], // San Antonio de Padua
                    [-34.6975, -58.7883], // Merlo
                    [-34.7031, -58.8158], // Paso del Rey
                    [-34.7089, -58.8464], // Moreno
                ],
                stationNames: [
                    "Once", "Caballito", "Flores", "Floresta", "Liniers",
                    "Villa Luro", "Ramos Mejía", "Haedo", "Morón", "Castelar",
                    "Ituzaingó", "San Antonio de Padua", "Merlo", "Paso del Rey", "Moreno"
                ]
            },
            mitre: {
                name: "Línea Mitre",
                description: "Recorrido Retiro - Tigre",
                color: "#64b5f6",
                stations: 21,
                distance: 28.2,
                duration: 45,
                frequency: 8,
                coordinates: [
                    [-34.5905, -58.3731], // Retiro
                    [-34.5950, -58.4019], // Lisandro de la Torre
                    [-34.5983, -58.4250], // Belgrano C
                    [-34.6025, -58.4486], // Núñez
                    [-34.5458, -58.4719], // Rivadavia
                    [-34.5572, -58.4958], // Coghlan
                    [-34.5669, -58.5156], // Saavedra
                    [-34.5767, -58.5375], // Villa Urquiza
                    [-34.5864, -58.5597], // Villa Pueyrredón
                    [-34.5956, -58.5808], // Devoto
                    [-34.6067, -58.6067], // Beccar
                    [-34.5336, -58.6181], // San Martín
                    [-34.5436, -58.6389], // San Andrés
                    [-34.5517, -58.6603], // Miguelete
                    [-34.5611, -58.6811], // José León Suárez
                    [-34.4108, -58.6408], // Tigre
                ]
            },
            roca: {
                name: "Línea Roca",
                description: "Recorrido Constitución - Ezeiza",
                color: "#4caf50",
                stations: 24,
                distance: 42.3,
                duration: 65,
                frequency: 12,
                coordinates: [
                    [-34.6275, -58.3792], // Constitución
                    [-34.6408, -58.3914], // Parque Patricios
                    [-34.6564, -58.4108], // Barracas
                    [-34.6708, -58.4292], // Avellaneda
                    [-34.6861, -58.4494], // Sarandí
                    [-34.7019, -58.4700], // Wilde
                    [-34.7164, -58.4900], // Don Bosco
                    [-34.7325, -58.5111], // Bernal
                    [-34.7469, -58.5314], // Quilmes
                    [-34.7628, -58.5533], // Ezpeleta
                    [-34.7772, -58.5739], // Berazategui
                    [-34.7922, -58.5958], // Hudson
                    [-34.8067, -58.6164], // Punta Lara
                    [-34.8219, -58.6383], // La Plata
                ]
            },
            belgrano: {
                name: "Línea Belgrano Norte",
                description: "Recorrido Retiro - Villa Rosa",
                color: "#9c27b0",
                stations: 19,
                distance: 33.8,
                duration: 50,
                frequency: 15,
                coordinates: [
                    [-34.5905, -58.3731], // Retiro
                    [-34.5617, -58.4606], // Villa Pueyrredón
                    [-34.5519, -58.4953], // Coghlan
                    [-34.5458, -58.5236], // Belgrano R
                    [-34.5400, -58.5519], // Núñez
                    [-34.5342, -58.5806], // Saavedra
                    [-34.5275, -58.6081], // Villa Urquiza
                    [-34.5214, -58.6369], // Devoto
                    [-34.5150, -58.6658], // Beccar
                    [-34.5086, -58.6947], // San Martín
                    [-34.5022, -58.7236], // San Andrés
                    [-34.4958, -58.7525], // Miguelete
                    [-34.4892, -58.7817], // José León Suárez
                ]
            },
            sanmartin: {
                name: "Línea San Martín",
                description: "Recorrido Retiro - Pilar",
                color: "#ff9800",
                stations: 18,
                distance: 38.7,
                duration: 60,
                frequency: 12,
                coordinates: [
                    [-34.5905, -58.3731], // Retiro
                    [-34.5981, -58.4314], // Palermo
                    [-34.6061, -58.4900], // Villa del Parque
                    [-34.6136, -58.5486], // Devoto
                    [-34.6211, -58.6069], // San Martín
                    [-34.6289, -58.6658], // José C. Paz
                    [-34.6364, -58.7244], // Del Viso
                    [-34.6442, -58.7831], // Pilar
                ]
            },
            urquiza: {
                name: "Línea Urquiza",
                description: "Recorrido Federico Lacroze - General Lemos",
                color: "#795548",
                stations: 16,
                distance: 26.4,
                duration: 40,
                frequency: 8,
                coordinates: [
                    [-34.5800, -58.4397], // Federico Lacroze
                    [-34.6033, -58.4714], // Villa Borges
                    [-34.6267, -58.5031], // Drago
                    [-34.6500, -58.5347], // Santos Lugares
                    [-34.6733, -58.5664], // Caseros
                    [-34.6967, -58.5981], // Hurlingham
                    [-34.7200, -58.6297], // William Morris
                ]
            }
        };
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', () => {
            // Actualizar hora actual
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Inicializar el mapa
            initMap();
            
            // Configurar event listeners
            setupEventListeners();
            
            // Iniciar seguimiento automáticamente
            toggleTracking();
            
            // Añadir mensaje inicial a la consola
            logToConsole("[SISTEMA] Aplicación inicializada correctamente", "success");
            logToConsole("[GEOLOCALIZACIÓN] Solicitando permisos de ubicación...", "info");
        });
        
        // Actualizar hora actual en consola
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // Inicializar el mapa
        function initMap() {
            // Crear mapa centrado en Buenos Aires
            map = L.map('map', {
                preferCanvas: true,
                zoomControl: false
            }).setView([-34.6037, -58.3816], 12);
            
            // Agregar capa de OpenStreetMap con estilo oscuro
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Cargar la línea Sarmiento por defecto
            loadTrainLine('sarmiento');
            
            logToConsole("[MAPA] Mapa inicializado con estilo oscuro", "success");
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Botones del mapa
            document.getElementById('zoomIn').addEventListener('click', () => {
                map.zoomIn();
                logToConsole("[MAPA] Zoom aumentado", "info");
            });
            document.getElementById('zoomOut').addEventListener('click', () => {
                map.zoomOut();
                logToConsole("[MAPA] Zoom reducido", "info");
            });
            document.getElementById('centerMap').addEventListener('click', centerOnUser);
            document.getElementById('toggleTracking').addEventListener('click', toggleTracking);
            
            // Selector de línea
            document.getElementById('lineSelector').addEventListener('change', (e) => {
                loadTrainLine(e.target.value);
                logToConsole(`[MAPA] Línea cambiada a: ${trainLines[e.target.value].name}`, "info");
            });
            
            // Controles de consola
            document.getElementById('clearConsole').addEventListener('click', clearConsole);
            document.getElementById('toggleConsole').addEventListener('click', toggleConsole);
            document.getElementById('exportConsole').addEventListener('click', exportConsole);
        }
        
        // Alternar seguimiento de ubicación
        function toggleTracking() {
            if (isTracking) {
                stopTracking();
                document.getElementById('trackingIcon').className = 'fas fa-play';
                logToConsole("[SEGUIMIENTO] Seguimiento detenido", "warning");
            } else {
                startTracking();
                document.getElementById('trackingIcon').className = 'fas fa-pause';
                logToConsole("[SEGUIMIENTO] Seguimiento activado", "success");
            }
            isTracking = !isTracking;
        }
        
        // Iniciar seguimiento de ubicación
        function startTracking() {
            if (!navigator.geolocation) {
                logToConsole("[ERROR] Tu navegador no soporta geolocalización", "error");
                return;
            }
            
            // Opciones para alta precisión
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            // Obtener posición inicial
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updatePosition(position);
                    centerOnUser();
                    logToConsole("[GEOLOCALIZACIÓN] Posición inicial obtenida", "success");
                    
                    // Iniciar seguimiento continuo
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            updatePosition(position);
                            detectTransport();
                        },
                        (error) => {
                            handleLocationError(error);
                        },
                        options
                    );
                },
                (error) => {
                    handleLocationError(error);
                },
                options
            );
        }
        
        // Detener seguimiento de ubicación
        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }
        
        // Actualizar posición en el mapa
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const altitude = position.coords.altitude;
            const heading = position.coords.heading;
            const timestamp = new Date(position.timestamp);
            
            // Actualizar interfaz
            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = `${accuracy.toFixed(1)} m`;
            document.getElementById('timestamp').textContent = timestamp.toLocaleTimeString();
            
            // Calcular velocidad si tenemos posición anterior
            if (lastPosition && lastTime) {
                const timeDiff = (position.timestamp - lastTime) / 1000; // en segundos
                if (timeDiff > 0) {
                    // Calcular distancia en metros usando fórmula Haversine
                    const distance = calculateDistance(
                        lastPosition.lat, lastPosition.lng,
                        lat, lng
                    );
                    
                    // Calcular velocidad en m/s y convertir a km/h
                    currentSpeed = (distance / timeDiff) * 3.6;
                    
                    // Filtrar valores atípicos (más de 300 km/h probablemente es error)
                    if (currentSpeed < 300) {
                        document.getElementById('speedValue').innerHTML = `${currentSpeed.toFixed(1)} <span class="speed-unit">km/h</span>`;
                        
                        // Registrar en consola si hay cambio significativo
                        if (Math.abs(currentSpeed - lastPosition.lastSpeed) > 2) {
                            logToConsole(`[VELOCIDAD] ${currentSpeed.toFixed(1)} km/h`, "info");
                        }
                    }
                }
            }
            
            // Guardar posición actual para próximo cálculo
            lastPosition = { lat, lng, lastSpeed: currentSpeed };
            lastTime = position.timestamp;
            
            // Actualizar marcador en el mapa
            updateUserMarker(lat, lng, accuracy);
            
            // Registrar datos de posición en consola (cada 10 actualizaciones)
            if (positionUpdateCount % 10 === 0) {
                logToConsole(`[POSICIÓN] Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}, Precisión: ${accuracy.toFixed(1)}m`, "info");
            }
            positionUpdateCount++;
        }
        
        let positionUpdateCount = 0;
        
        // Calcular distancia entre dos puntos (fórmula Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Actualizar marcador del usuario en el mapa
        function updateUserMarker(lat, lng, accuracy) {
            const userPos = [lat, lng];
            
            // Crear o actualizar marcador
            if (!userMarker) {
                userMarker = L.marker(userPos, {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div class="pulse"><i class="fas fa-user" style="color:#64b5f6; font-size:24px;"></i></div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(map);
                
                // Crear círculo de precisión
                userCircle = L.circle(userPos, {
                    color: '#64b5f6',
                    fillColor: '#64b5f6',
                    fillOpacity: 0.1,
                    radius: accuracy
                }).addTo(map);
            } else {
                userMarker.setLatLng(userPos);
                userCircle.setLatLng(userPos);
                userCircle.setRadius(accuracy);
            }
        }
        
        // Centrar mapa en la ubicación del usuario
        function centerOnUser() {
            if (lastPosition) {
                map.setView([lastPosition.lat, lastPosition.lng], 15);
                logToConsole("[MAPA] Centrado en ubicación del usuario", "info");
            }
        }
        
        // Detectar medio de transporte basado en la velocidad
        function detectTransport() {
            let transport = "unknown";
            let confidence = 0;
            let icon = "fas fa-question-circle";
            
            // Umbrales de velocidad en km/h
            if (currentSpeed < 1) {
                transport = "caminando";
                confidence = 95;
                icon = "fas fa-walking";
            } else if (currentSpeed >= 1 && currentSpeed < 6) {
                transport = "caminando rápido";
                confidence = 80;
                icon = "fas fa-walking";
            } else if (currentSpeed >= 6 && currentSpeed < 15) {
                transport = "bicicleta";
                confidence = 75;
                icon = "fas fa-bicycle";
            } else if (currentSpeed >= 15 && currentSpeed < 40) {
                transport = "auto";
                confidence = 85;
                icon = "fas fa-car";
            } else if (currentSpeed >= 40 && currentSpeed < 80) {
                transport = "colectivo";
                confidence = 70;
                icon = "fas fa-bus";
            } else if (currentSpeed >= 80) {
                transport = "tren";
                confidence = 90;
                icon = "fas fa-train";
                
                // Mostrar información de la línea de tren
                showLineInfo();
            }
            
            // Actualizar interfaz si el transporte cambió
            if (transport !== currentTransport) {
                currentTransport = transport;
                
                // Actualizar icono y nombre
                document.getElementById('transportIcon').innerHTML = `<i class="${icon}"></i>`;
                document.getElementById('transportName').textContent = transport.charAt(0).toUpperCase() + transport.slice(1);
                
                // Ocultar información de línea si no es tren
                if (transport !== "tren") {
                    document.getElementById('lineInfoCard').style.display = 'none';
                }
                
                // Registrar en consola
                logToConsole(`[TRANSPORTE] Detectado: ${transport} (${confidence}% confianza)`, "success");
            }
            
            // Actualizar barra de confianza
            document.getElementById('confidenceFill').style.width = `${confidence}%`;
            document.getElementById('confidenceValue').textContent = `${confidence}%`;
        }
        
        // Mostrar información de la línea de tren
        function showLineInfo() {
            const lineCard = document.getElementById('lineInfoCard');
            const lineSelector = document.getElementById('lineSelector');
            const selectedLine = trainLines[lineSelector.value];
            
            // Actualizar información
            document.getElementById('lineName').textContent = selectedLine.name;
            document.getElementById('lineDescription').textContent = selectedLine.description;
            document.getElementById('lineStations').textContent = selectedLine.stations;
            document.getElementById('lineDistance').textContent = selectedLine.distance;
            document.getElementById('lineDuration').textContent = selectedLine.duration;
            document.getElementById('lineFrequency').textContent = selectedLine.frequency;
            
            // Mostrar tarjeta
            lineCard.style.display = 'block';
        }
        
        // Cargar línea de tren en el mapa
        function loadTrainLine(lineId) {
            const line = trainLines[lineId];
            
            // Eliminar línea anterior si existe
            if (trainLine) {
                map.removeLayer(trainLine);
            }
            
            // Eliminar estaciones anteriores si existen
            trainStations.forEach(station => map.removeLayer(station));
            trainStations = [];
            
            // Verificar si la línea tiene coordenadas definidas
            if (line.coordinates) {
                // Crear polyline para la vía del tren
                trainLine = L.polyline(line.coordinates, {
                    color: line.color,
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);
                
                // Añadir marcadores para estaciones
                line.coordinates.forEach((coord, index) => {
                    const stationName = line.stationNames ? line.stationNames[index] : `Estación ${index + 1}`;
                    
                    const station = L.marker(coord, {
                        icon: L.divIcon({
                            className: 'station-marker',
                            html: `<div style="background-color:${line.color}; color:white; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold;">${index + 1}</div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    
                    // Tooltip con nombre de estación
                    station.bindTooltip(stationName);
                    
                    trainStations.push(station);
                });
                
                // Ajustar vista del mapa para mostrar toda la línea
                if (line.coordinates.length > 0) {
                    const bounds = L.latLngBounds(line.coordinates);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
            
            // Actualizar información si el usuario está en tren
            if (currentTransport === "tren") {
                showLineInfo();
            }
        }
        
        // Manejar errores de geolocalización
        function handleLocationError(error) {
            let message = "";
            let errorType = "error";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Permiso de ubicación denegado. Por favor, habilita los permisos de ubicación en tu navegador.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "La información de ubicación no está disponible.";
                    errorType = "warning";
                    break;
                case error.TIMEOUT:
                    message = "La solicitud de ubicación ha expirado.";
                    errorType = "warning";
                    break;
                case error.UNKNOWN_ERROR:
                    message = "Ocurrió un error desconocido al obtener la ubicación.";
                    break;
            }
            
            logToConsole(`[ERROR] ${message}`, errorType);
            
            // Detener seguimiento
            if (isTracking) {
                toggleTracking();
            }
        }
        
        // Funciones de consola
        function logToConsole(message, type = "info") {
            const consoleContent = document.getElementById('consoleContent');
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            // Crear elemento de línea de consola
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            
            line.innerHTML = `
                <div class="console-message">${message}</div>
                <div class="console-timestamp">${timeString}</div>
            `;
            
            // Añadir al inicio (para que los mensajes nuevos aparezcan arriba)
            consoleContent.prepend(line);
            
            // Guardar en el log
            consoleLog.unshift({
                message,
                type,
                timestamp: now.toISOString()
            });
            
            // Limitar a 100 mensajes
            if (consoleLog.length > 100) {
                consoleLog.pop();
                // Eliminar el último elemento visual si hay más de 100
                if (consoleContent.children.length > 100) {
                    consoleContent.removeChild(consoleContent.lastChild);
                }
            }
            
            // Auto-scroll al principio
            consoleContent.scrollTop = 0;
        }
        
        function clearConsole() {
            const consoleContent = document.getElementById('consoleContent');
            consoleContent.innerHTML = '';
            consoleLog = [];
            
            // Añadir mensaje de consola limpia
            logToConsole("[CONSOLA] Consola limpiada", "info");
        }
        
        function toggleConsole() {
            const consoleSection = document.querySelector('.console-sandbox');
            const toggleBtn = document.getElementById('toggleConsole');
            
            if (consoleVisible) {
                consoleSection.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Mostrar';
                logToConsole("[CONSOLA] Consola ocultada", "warning");
            } else {
                consoleSection.style.display = 'flex';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar';
                logToConsole("[CONSOLA] Consola mostrada", "success");
            }
            
            consoleVisible = !consoleVisible;
        }
        
        function exportConsole() {
            // Crear contenido para exportar
            let exportContent = "Log de Consola - Detección de Transporte\n";
            exportContent += "==========================================\n\n";
            
            consoleLog.forEach(log => {
                exportContent += `[${new Date(log.timestamp).toLocaleString()}] ${log.message}\n`;
            });
            
            // Crear blob y descargar
            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `consola_transporte_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logToConsole("[CONSOLA] Log exportado como archivo de texto", "success");
        }
    </script>
</body>
</html>