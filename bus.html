<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Transporte - Sistema Funcional</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #000; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            touch-action: pan-x pan-y;
        }
        
        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        .top-bar {
            position: fixed;
            top: env(safe-area-inset-top, 10px);
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            height: 65px;
        }
        
        .gps-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .gps-indicator {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #34C759, #28A745);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }
        
        .gps-info {
            display: flex;
            flex-direction: column;
        }
        
        .gps-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .gps-subtitle {
            color: #34C759;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .top-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon-button {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .icon-button:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .icon-button.active {
            background: rgba(0, 122, 255, 0.3);
            color: #007AFF;
        }
        
        .icon-button.following {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
        }
        
        .speed-indicator {
            position: fixed;
            top: 85px;
            right: 15px;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(40px);
            border-radius: 20px;
            padding: 18px 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 999;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            min-width: 150px;
            animation: slideInRight 0.3s ease;
        }
        
        .speed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .speed-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .gps-accuracy {
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .speed-value {
            color: #34C759;
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(52, 199, 89, 0.7);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            transition: all 0.2s ease;
        }
        
        .speed-direction {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .direction-arrow {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .control-panel {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 10px);
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.97);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 1000;
            padding: 20px;
            box-shadow: 0 -15px 60px rgba(0, 0, 0, 0.7);
        }
        
        .line-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .line-name {
            color: white;
            font-size: 18px;
            font-weight: 700;
        }
        
        .line-status {
            color: #34C759;
            font-size: 12px;
            background: rgba(52, 199, 89, 0.15);
            padding: 6px 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .station-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .station-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 15px;
            border-left: 4px solid transparent;
        }
        
        .station-item.current {
            border-left-color: #007AFF;
            background: rgba(0, 122, 255, 0.1);
        }
        
        .station-item.next {
            border-left-color: #34C759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .station-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        
        .station-name {
            color: white;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .station-distance {
            color: #34C759;
            font-size: 13px;
            font-weight: 600;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        
        .control-button {
            padding: 14px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        
        .control-button:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .control-button.active {
            background: rgba(0, 122, 255, 0.2);
            border-color: #007AFF;
            color: #007AFF;
        }
        
        .button-icon {
            font-size: 18px;
        }
        
        .button-text {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        .user-marker {
            border: 3px solid white;
            box-shadow: 0 0 30px rgba(0, 122, 255, 0.9);
            transition: all 0.3s ease;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }
        
        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #34C759;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(1.05);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideInRight {
            from { 
                opacity: 0;
                transform: translateX(20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @media (max-width: 350px) {
            .control-panel {
                padding: 15px;
            }
            
            .station-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .speed-indicator {
                min-width: 130px;
                padding: 15px;
            }
            
            .speed-value {
                font-size: 28px;
            }
            
            .control-buttons {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Barra Superior -->
    <div class="top-bar" id="topBar">
        <div class="gps-status">
            <div class="gps-indicator" id="gpsIndicator">üì°</div>
            <div class="gps-info">
                <div class="gps-title">GPS TRANSPORTE</div>
                <div class="gps-subtitle" id="gpsSubtitle">INICIANDO GPS...</div>
            </div>
        </div>
        
        <div class="top-actions">
            <button class="icon-button following" id="followButton" onclick="toggleFollow()" title="Siguiendo ubicaci√≥n">
                üìç
            </button>
            <button class="icon-button" onclick="centerOnUser()" title="Centrar en mi ubicaci√≥n">
                üéØ
            </button>
            <button class="icon-button" onclick="toggleRoute()" title="Mostrar/ocultar ruta">
                üõ§Ô∏è
            </button>
        </div>
    </div>
    
    <!-- Indicador de Velocidad -->
    <div class="speed-indicator" id="speedIndicator">
        <div class="speed-header">
            <div class="speed-label">VELOCIDAD</div>
            <div class="gps-accuracy" id="gpsAccuracy">-- m</div>
        </div>
        <div class="speed-value" id="speedValue">0.0 km/h</div>
        <div class="speed-direction">
            <span class="direction-arrow" id="directionArrow">‚Üí</span>
            <span id="directionText">NORTE</span>
        </div>
    </div>
    
    <!-- Panel de Control -->
    <div class="control-panel" id="controlPanel">
        <div class="line-info">
            <div class="line-name" id="lineName">L√çNEA SARMIENTO</div>
            <div class="line-status" id="lineStatus">GPS ACTIVO</div>
        </div>
        
        <div class="station-info">
            <div class="station-item current">
                <div class="station-label">ESTACI√ìN ACTUAL</div>
                <div class="station-name" id="currentStation">-</div>
                <div class="station-distance" id="currentDistance">-</div>
            </div>
            <div class="station-item next">
                <div class="station-label">PR√ìXIMA ESTACI√ìN</div>
                <div class="station-name" id="nextStation">-</div>
                <div class="station-distance" id="nextDistance">-</div>
            </div>
        </div>
        
        <div class="control-buttons">
            <button class="control-button active" onclick="selectLine('sarmiento')">
                <span class="button-icon">üöÜ</span>
                <span class="button-text">Sarmiento</span>
            </button>
            <button class="control-button" onclick="selectLine('mitre_tigre')">
                <span class="button-icon">üöä</span>
                <span class="button-text">Mitre</span>
            </button>
            <button class="control-button" onclick="selectLine('roca')">
                <span class="button-icon">üöá</span>
                <span class="button-text">Roca</span>
            </button>
            <button class="control-button" onclick="selectLine('sanmartin')">
                <span class="button-icon">üöâ</span>
                <span class="button-text">San Mart√≠n</span>
            </button>
            <button class="control-button" onclick="selectLine('colectivo_64')">
                <span class="button-icon">üöå</span>
                <span class="button-text">Colectivo 64</span>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN SIMPLE Y FUNCIONAL
        // ============================================
        const CONFIG = {
            GPS_UPDATE_INTERVAL: 1000,
            GPS_HIGH_ACCURACY: true,
            GPS_MIN_ACCURACY: 50,
            MAP_ZOOM_FOLLOW: 16,
            MAP_ZOOM_DEFAULT: 14
        };
        
        // ============================================
        // BASE DE DATOS
        // ============================================
        let stationsDB = {
            sarmiento: [
                {name: 'ONCE', lat: -34.608544, lng: -58.406341, order: 1},
                {name: 'CABALLITO', lat: -34.618507, lng: -58.441615, order: 2},
                {name: 'FLORES', lat: -34.629034, lng: -58.462815, order: 3},
                {name: 'FLORESTA', lat: -34.634674, lng: -58.480412, order: 4},
                {name: 'VILLA LURO', lat: -34.637842, lng: -58.502378, order: 5},
                {name: 'LINIERS', lat: -34.641462, lng: -58.523724, order: 6},
                {name: 'CIUDADELA', lat: -34.645924, lng: -58.535891, order: 7},
                {name: 'RAMOS MEJ√çA', lat: -34.648357, lng: -58.561212, order: 8},
                {name: 'HAEDO', lat: -34.650714, lng: -58.590891, order: 9},
                {name: 'MOR√ìN', lat: -34.650798, lng: -58.620964, order: 10},
                {name: 'CASTELAR', lat: -34.656792, lng: -58.652451, order: 11},
                {name: 'ITUZAING√ì', lat: -34.659167, lng: -58.671745, order: 12},
                {name: 'SAN ANTONIO', lat: -34.662394, lng: -58.701127, order: 13},
                {name: 'MERLO', lat: -34.665734, lng: -58.727978, order: 14},
                {name: 'PASO DEL REY', lat: -34.656921, lng: -58.761024, order: 15},
                {name: 'MORENO', lat: -34.635012, lng: -58.791045, order: 16}
            ]
        };
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map = null;
        let userMarker = null;
        let routePolyline = null;
        let currentLine = 'sarmiento';
        let isFollowingUser = true;
        let currentPosition = null;
        
        // Variables de estado
        let currentSpeed = 0;
        let currentBearing = 0;
        let currentAccuracy = 0;
        let positionHistory = [];
        
        // ============================================
        // INICIALIZACI√ìN DEL MAPA
        // ============================================
        function initMap() {
            console.log("Iniciando mapa...");
            
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true,
                inertia: true
            });
            
            // Capa de mapa
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19,
                minZoom: 10
            }).addTo(map);
            
            // Vista inicial en Buenos Aires
            map.setView([-34.6037, -58.3816], CONFIG.MAP_ZOOM_DEFAULT);
            
            // Cargar estaciones iniciales
            loadStops(currentLine);
            
            // Iniciar GPS
            startGPS();
            
            // Ocultar loading
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
            }, 500);
        }
        
        // ============================================
        // SISTEMA DE GEOLOCALIZACI√ìN FUNCIONAL
        // ============================================
        function startGPS() {
            console.log("Solicitando permisos de GPS...");
            
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta geolocalizaci√≥n");
                updateGPSStatus('error');
                return;
            }
            
            // Solicitar permisos primero
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log("Permisos concedidos, posici√≥n obtenida:", position);
                    updateGPSStatus('active');
                    
                    // Centrar mapa en posici√≥n inicial
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], CONFIG.MAP_ZOOM_FOLLOW);
                    
                    // Crear marcador inicial
                    createUserMarker(lat, lng);
                    
                    // Iniciar seguimiento continuo
                    startWatchingPosition();
                },
                function(error) {
                    console.error("Error obteniendo posici√≥n inicial:", error);
                    handleGPSError(error);
                },
                {
                    enableHighAccuracy: CONFIG.GPS_HIGH_ACCURACY,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        function startWatchingPosition() {
            console.log("Iniciando seguimiento continuo de posici√≥n...");
            
            navigator.geolocation.watchPosition(
                function(position) {
                    handleNewPosition(position);
                },
                function(error) {
                    handleGPSError(error);
                },
                {
                    enableHighAccuracy: CONFIG.GPS_HIGH_ACCURACY,
                    maximumAge: 0,
                    timeout: 5000
                }
            );
        }
        
        function handleNewPosition(position) {
            if (!position || !position.coords) return;
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed;
            const heading = position.coords.heading;
            
            // Guardar posici√≥n actual
            currentPosition = {
                lat: lat,
                lng: lng,
                accuracy: accuracy,
                speed: speed,
                heading: heading,
                timestamp: Date.now()
            };
            
            // Actualizar indicadores
            updateGPSAccuracy(accuracy);
            updateSpeedAndDirection(speed, heading);
            
            // Actualizar marcador
            updateUserMarker(lat, lng);
            
            // Actualizar ruta
            updateRoute(lat, lng);
            
            // Actualizar estaciones cercanas
            updateNearbyStations(lat, lng);
            
            // Seguir al usuario si est√° activo
            if (isFollowingUser) {
                centerOnUser(lat, lng);
            }
            
            // Actualizar historial
            positionHistory.push({lat, lng, timestamp: Date.now()});
            if (positionHistory.length > 100) {
                positionHistory.shift();
            }
            
            console.log("Posici√≥n actualizada:", lat.toFixed(6), lng.toFixed(6), "Precisi√≥n:", accuracy.toFixed(1) + "m");
        }
        
        function createUserMarker(lat, lng) {
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            userMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: getMarkerHTML(),
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                }),
                zIndexOffset: 1000
            }).addTo(map);
        }
        
        function updateUserMarker(lat, lng) {
            if (!userMarker) {
                createUserMarker(lat, lng);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
        }
        
        function getMarkerHTML() {
            return `<div style="
                background:linear-gradient(135deg, #007AFF, #007AFF99);
                width:32px;
                height:32px;
                border-radius:50%;
                border:3px solid white;
                box-shadow:0 0 20px rgba(0, 122, 255, 0.8);
            "></div>`;
        }
        
        function updateRoute(lat, lng) {
            if (positionHistory.length === 0) {
                positionHistory.push({lat, lng});
                return;
            }
            
            // Crear o actualizar polil√≠nea
            const points = positionHistory.map(p => [p.lat, p.lng]);
            points.push([lat, lng]);
            
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            routePolyline = L.polyline(points, {
                color: '#007AFF',
                weight: 4,
                opacity: 0.7,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
        }
        
        function updateNearbyStations(lat, lng) {
            const stations = stationsDB[currentLine];
            if (!stations) return;
            
            // Encontrar estaci√≥n m√°s cercana
            let closestStation = null;
            let closestDistance = Infinity;
            let closestIndex = -1;
            
            stations.forEach((station, index) => {
                const distance = calculateDistance(lat, lng, station.lat, station.lng);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestStation = station;
                    closestIndex = index;
                }
            });
            
            if (!closestStation) return;
            
            // Actualizar interfaz
            document.getElementById('currentStation').textContent = closestStation.name;
            
            if (closestDistance < 100) {
                document.getElementById('currentDistance').textContent = 'EN ESTACI√ìN';
            } else {
                document.getElementById('currentDistance').textContent = Math.round(closestDistance) + ' m';
            }
            
            // Pr√≥xima estaci√≥n
            if (closestIndex < stations.length - 1) {
                const nextStation = stations[closestIndex + 1];
                const nextDistance = calculateDistance(lat, lng, nextStation.lat, nextStation.lng);
                document.getElementById('nextStation').textContent = nextStation.name;
                document.getElementById('nextDistance').textContent = Math.round(nextDistance) + ' m';
            } else {
                document.getElementById('nextStation').textContent = '-';
                document.getElementById('nextDistance').textContent = '-';
            }
        }
        
        function updateSpeedAndDirection(speed, heading) {
            // Actualizar velocidad (convertir m/s a km/h)
            const speedKmh = speed ? (speed * 3.6) : 0;
            currentSpeed = speedKmh;
            
            const speedElement = document.getElementById('speedValue');
            speedElement.textContent = speedKmh.toFixed(1) + ' km/h';
            
            // Color seg√∫n velocidad
            if (speedKmh < 1) {
                speedElement.style.color = '#8E8E93';
            } else if (speedKmh < 20) {
                speedElement.style.color = '#FF9500';
            } else {
                speedElement.style.color = '#34C759';
            }
            
            // Actualizar direcci√≥n
            if (heading !== null && heading !== undefined && heading >= 0) {
                currentBearing = heading;
                updateDirectionDisplay(heading, speedKmh);
            }
        }
        
        function updateDirectionDisplay(bearing, speed) {
            const directionArrow = document.getElementById('directionArrow');
            const directionText = document.getElementById('directionText');
            
            let arrow = '‚Üí';
            let text = 'NORTE';
            
            if (speed < 1) {
                arrow = '‚óè';
                text = 'DETENIDO';
            } else if (bearing >= 337.5 || bearing < 22.5) {
                arrow = '‚Üë';
                text = 'NORTE';
            } else if (bearing >= 22.5 && bearing < 67.5) {
                arrow = '‚Üó';
                text = 'NORESTE';
            } else if (bearing >= 67.5 && bearing < 112.5) {
                arrow = '‚Üí';
                text = 'ESTE';
            } else if (bearing >= 112.5 && bearing < 157.5) {
                arrow = '‚Üò';
                text = 'SURESTE';
            } else if (bearing >= 157.5 && bearing < 202.5) {
                arrow = '‚Üì';
                text = 'SUR';
            } else if (bearing >= 202.5 && bearing < 247.5) {
                arrow = '‚Üô';
                text = 'SUROESTE';
            } else if (bearing >= 247.5 && bearing < 292.5) {
                arrow = '‚Üê';
                text = 'OESTE';
            } else if (bearing >= 292.5 && bearing < 337.5) {
                arrow = '‚Üñ';
                text = 'NOROESTE';
            }
            
            directionArrow.textContent = arrow;
            directionText.textContent = text;
            
            if (speed >= 1) {
                directionArrow.style.transform = `rotate(${bearing}deg)`;
            } else {
                directionArrow.style.transform = 'rotate(0deg)';
            }
        }
        
        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function updateGPSStatus(status) {
            const indicator = document.getElementById('gpsIndicator');
            const subtitle = document.getElementById('gpsSubtitle');
            const statusText = document.getElementById('lineStatus');
            
            switch(status) {
                case 'searching':
                    indicator.textContent = 'üì°';
                    indicator.style.background = 'linear-gradient(135deg, #FF9500, #FF8A00)';
                    subtitle.textContent = 'BUSCANDO GPS...';
                    statusText.textContent = 'BUSCANDO GPS';
                    statusText.style.color = '#FF9500';
                    break;
                    
                case 'active':
                    indicator.textContent = 'üìç';
                    indicator.style.background = 'linear-gradient(135deg, #34C759, #28A745)';
                    subtitle.textContent = 'GPS ACTIVO';
                    statusText.textContent = 'GPS ACTIVO';
                    statusText.style.color = '#34C759';
                    break;
                    
                case 'error':
                    indicator.textContent = '‚ùå';
                    indicator.style.background = 'linear-gradient(135deg, #FF3B30, #D70015)';
                    subtitle.textContent = 'ERROR GPS';
                    statusText.textContent = 'ERROR GPS';
                    statusText.style.color = '#FF3B30';
                    break;
            }
        }
        
        function updateGPSAccuracy(accuracy) {
            currentAccuracy = accuracy;
            const accuracyElement = document.getElementById('gpsAccuracy');
            
            if (accuracy < 15) {
                accuracyElement.textContent = '¬±' + Math.round(accuracy) + ' m';
                accuracyElement.style.color = '#34C759';
                accuracyElement.style.background = 'rgba(52, 199, 89, 0.15)';
            } else if (accuracy < 30) {
                accuracyElement.textContent = '¬±' + Math.round(accuracy) + ' m';
                accuracyElement.style.color = '#FF9500';
                accuracyElement.style.background = 'rgba(255, 149, 0, 0.15)';
            } else {
                accuracyElement.textContent = '¬±' + Math.round(accuracy) + ' m';
                accuracyElement.style.color = '#FF3B30';
                accuracyElement.style.background = 'rgba(255, 59, 48, 0.15)';
            }
        }
        
        function handleGPSError(error) {
            console.error("Error GPS:", error);
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("Permiso de ubicaci√≥n denegado. Por favor, permite el acceso a la ubicaci√≥n en la configuraci√≥n de tu navegador.");
                    updateGPSStatus('error');
                    break;
                    
                case error.POSITION_UNAVAILABLE:
                    console.warn("GPS no disponible");
                    updateGPSStatus('error');
                    break;
                    
                case error.TIMEOUT:
                    console.warn("Timeout de GPS");
                    updateGPSStatus('error');
                    break;
            }
        }
        
        function centerOnUser(lat, lng) {
            if (isFollowingUser && map) {
                map.setView([lat, lng], CONFIG.MAP_ZOOM_FOLLOW, {
                    animate: true,
                    duration: 0.5
                });
            }
        }
        
        function toggleFollow() {
            isFollowingUser = !isFollowingUser;
            const followButton = document.getElementById('followButton');
            
            if (isFollowingUser) {
                followButton.classList.add('following');
                followButton.title = 'Siguiendo ubicaci√≥n';
                followButton.innerHTML = 'üìç';
                
                // Centrar en usuario actual si hay posici√≥n
                if (currentPosition) {
                    centerOnUser(currentPosition.lat, currentPosition.lng);
                }
            } else {
                followButton.classList.remove('following');
                followButton.title = 'Seguir ubicaci√≥n';
                followButton.innerHTML = 'üìç<small style="font-size:8px;position:absolute;top:-2px;right:-2px;">‚úï</small>';
            }
        }
        
        function centerOnUser() {
            if (currentPosition) {
                centerOnUser(currentPosition.lat, currentPosition.lng);
            } else {
                alert("Esperando posici√≥n GPS...");
            }
        }
        
        function toggleRoute() {
            if (routePolyline) {
                if (map.hasLayer(routePolyline)) {
                    map.removeLayer(routePolyline);
                } else {
                    routePolyline.addTo(map);
                }
            }
        }
        
        function selectLine(lineId) {
            // Actualizar botones
            document.querySelectorAll('.control-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.control-button').classList.add('active');
            
            // Cambiar l√≠nea
            currentLine = lineId;
            
            // Cargar estaciones
            loadStops(lineId);
            
            // Actualizar nombre
            const lineNames = {
                'sarmiento': 'SARMIENTO',
                'mitre_tigre': 'MITRE (TIGRE)',
                'roca': 'ROCA',
                'sanmartin': 'SAN MART√çN',
                'colectivo_64': 'COLECTIVO 64'
            };
            
            document.getElementById('lineName').textContent = lineNames[lineId] || lineId.toUpperCase();
        }
        
        function loadStops(lineId) {
            const stations = stationsDB[lineId];
            if (!stations) return;
            
            // Limpiar marcadores anteriores
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker && layer !== userMarker) {
                    map.removeLayer(layer);
                }
            });
            
            // Eliminar ruta
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            // Agregar marcadores de estaciones
            stations.forEach(station => {
                L.marker([station.lat, station.lng], {
                    icon: L.divIcon({
                        className: 'station-marker',
                        html: `<div style="background:#FF3B30;width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                })
                .bindTooltip(station.name)
                .addTo(map);
            });
        }
        
        // ============================================
        // FUNCIONES MATEM√ÅTICAS
        // ============================================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                     Math.cos(œÜ1) * Math.cos(œÜ2) *
                     Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Documento cargado, iniciando aplicaci√≥n...");
            initMap();
            
            // Ajustar mapa al cambiar tama√±o
            window.addEventListener('resize', () => {
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                }
            });
        });
    </script>
</body>
</html>