<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auditor√≠a GPS - Sistema de Transporte P√∫blico</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome para iconos profesionales -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== RESET Y BASE ===== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #0f172a; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            touch-action: pan-x pan-y;
            color: #e2e8f0;
        }
        
        /* ===== MAPA ===== */
        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        /* ===== HEADER PROFESIONAL ===== */
        .audit-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 12px 20px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .audit-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .audit-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .audit-info h1 {
            font-size: 16px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 2px;
        }
        
        .audit-info p {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 500;
        }
        
        .audit-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-bottom: 4px;
        }
        
        .status-dot.active {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }
        
        .status-dot.inactive {
            background: #ef4444;
        }
        
        .status-dot.recording {
            background: #f59e0b;
            box-shadow: 0 0 10px #f59e0b;
            animation: pulse 2s infinite;
        }
        
        .status-label {
            font-size: 10px;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ===== PANEL DE CONTROL DERECHO ===== */
        .control-sidebar {
            position: fixed;
            top: 80px;
            right: 15px;
            width: 320px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* Tarjeta de Velocidad */
        .metric-card {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 18px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .metric-title {
            font-size: 12px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 800;
            color: #3b82f6;
            margin-bottom: 4px;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }
        
        .metric-subtitle {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Indicador de Direcci√≥n */
        .direction-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px solid rgba(100, 116, 139, 0.2);
            margin-top: 10px;
        }
        
        .direction-arrow {
            font-size: 24px;
            color: #3b82f6;
            transition: transform 0.5s ease;
        }
        
        .direction-text {
            font-size: 12px;
            font-weight: 600;
            color: #cbd5e1;
        }
        
        /* Tarjeta de Estaciones */
        .stations-card {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .station-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 4px solid transparent;
            background: rgba(30, 41, 59, 0.5);
            transition: all 0.3s ease;
        }
        
        .station-item.current {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .station-item.next {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .station-name {
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
        }
        
        .station-metrics {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        
        .station-distance {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .station-eta {
            color: #94a3b8;
        }
        
        /* ===== PANEL INFERIOR DE AUDITOR√çA ===== */
        .audit-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(100, 116, 139, 0.3);
            z-index: 1000;
            padding: 16px 20px;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        
        .audit-panel.collapsed {
            transform: translateY(calc(100% - 60px));
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            cursor: pointer;
        }
        
        .panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-panel {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
        }
        
        /* Selector de L√≠nea */
        .line-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        
        .line-button {
            padding: 10px 16px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 10px;
            color: #cbd5e1;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .line-button:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        
        .line-button.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        /* Controles de Auditor√≠a */
        .audit-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .audit-button {
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 10px;
            color: #cbd5e1;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .audit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .audit-button.primary {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .audit-button.warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .audit-button.danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .audit-button.success {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #10b981;
        }
        
        /* ===== MARCADORES PROFESIONALES ===== */
        .audit-marker {
            border: 3px solid white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
            transition: all 0.3s ease;
        }
        
        .station-marker-audit {
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .station-marker-audit.current {
            border-color: #3b82f6;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.9);
            animation: pulseBlue 2s infinite;
        }
        
        .station-marker-audit.next {
            border-color: #10b981;
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.9);
            animation: pulseGreen 2s infinite;
        }
        
        /* ===== MODALES MEJORADOS ===== */
        .audit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .audit-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: rgba(100, 116, 139, 0.2);
            border: none;
            color: #94a3b8;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        /* ===== TABLAS DE DATOS ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .data-table th {
            text-align: left;
            padding: 12px;
            background: rgba(30, 41, 59, 0.5);
            color: #94a3b8;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.2);
            font-size: 13px;
        }
        
        .data-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        /* ===== INDICADORES DE ESTADO ===== */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .status-inactive {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(1.05);
            }
        }
        
        @keyframes pulseBlue {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% { 
                box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
            }
        }
        
        @keyframes pulseGreen {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% { 
                box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
            }
        }
        
        @keyframes recordingPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
            }
        }
        
        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            transition: opacity 0.5s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-container {
            text-align: center;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 32px;
        }
        
        .loading-text {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .loading-bar {
            width: 200px;
            height: 3px;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 3px;
            margin: 20px auto 0;
            overflow: hidden;
        }
        
        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ===== SCROLLBAR PERSONALIZADO ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .control-sidebar {
                width: calc(100% - 30px);
                max-width: 320px;
            }
            
            .audit-controls {
                grid-template-columns: 1fr 1fr;
            }
            
            .audit-panel {
                padding: 14px 16px;
            }
            
            .line-selector {
                gap: 6px;
            }
            
            .line-button {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .control-sidebar {
                width: calc(100% - 20px);
            }
            
            .audit-header {
                padding: 10px 16px;
            }
            
            .audit-info h1 {
                font-size: 14px;
            }
            
            .audit-info p {
                font-size: 10px;
            }
            
            .audit-controls {
                grid-template-columns: 1fr;
            }
            
            .metric-card {
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="loading-logo">
                <i class="fas fa-clipboard-check"></i>
            </div>
            <div class="loading-text">SISTEMA DE AUDITOR√çA</div>
            <div class="loading-text" style="font-size: 12px; margin-top: 5px;">Inicializando monitoreo...</div>
            <div class="loading-bar">
                <div class="loading-progress" id="loadingProgress"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Auditor√≠a -->
    <div class="audit-modal" id="auditModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-chart-bar"></i>
                    <span id="modalTitle">Informe de Auditor√≠a</span>
                </div>
                <button class="modal-close" onclick="closeAuditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalContent">
                <!-- Contenido din√°mico del modal -->
            </div>
        </div>
    </div>
    
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Header de Auditor√≠a -->
    <div class="audit-header">
        <div class="audit-brand">
            <div class="audit-logo">
                <i class="fas fa-clipboard-check"></i>
            </div>
            <div class="audit-info">
                <h1>AUDITOR√çA DE TRANSPORTE P√öBLICO</h1>
                <p>Sistema de Monitoreo en Tiempo Real</p>
            </div>
        </div>
        
        <div class="audit-status">
            <div class="status-indicator">
                <div class="status-dot active" id="gpsStatus"></div>
                <div class="status-label">GPS</div>
            </div>
            <div class="status-indicator">
                <div class="status-dot inactive" id="recordStatus"></div>
                <div class="status-label">GRABACI√ìN</div>
            </div>
            <div class="status-indicator">
                <div class="status-dot inactive" id="auditStatus"></div>
                <div class="status-label">AUDITOR√çA</div>
            </div>
        </div>
    </div>
    
    <!-- Panel de Control Derecho -->
    <div class="control-sidebar">
        <!-- Tarjeta de Velocidad -->
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">
                    <i class="fas fa-tachometer-alt"></i>
                    VELOCIDAD
                </div>
                <div class="status-badge status-active" id="speedAccuracy">ALTA</div>
            </div>
            <div class="metric-value" id="speedValue">0.0 km/h</div>
            <div class="metric-subtitle">
                <i class="fas fa-crosshairs"></i>
                <span id="gpsAccuracy">Precisi√≥n: -- m</span>
            </div>
            <div class="direction-indicator">
                <div class="direction-arrow" id="directionArrow">‚Üí</div>
                <div class="direction-text" id="directionText">NORTE</div>
            </div>
        </div>
        
        <!-- Tarjeta de Estaciones -->
        <div class="metric-card stations-card">
            <div class="metric-header">
                <div class="metric-title">
                    <i class="fas fa-map-marker-alt"></i>
                    ESTACIONES
                </div>
                <div class="status-badge" id="stationCount">0</div>
            </div>
            <div id="stationsList">
                <!-- Lista din√°mica de estaciones -->
                <div class="station-item current">
                    <div class="station-name">CARGANDO...</div>
                    <div class="station-metrics">
                        <span class="station-distance">-- m</span>
                        <span class="station-eta">--:--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tarjeta de Estad√≠sticas -->
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">
                    <i class="fas fa-chart-line"></i>
                    ESTAD√çSTICAS
                </div>
                <div class="status-badge status-inactive" id="statsStatus">OFF</div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px;">
                <div>
                    <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">DISTANCIA</div>
                    <div style="font-size: 16px; font-weight: 700; color: #10b981;" id="totalDistance">0 km</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">TIEMPO</div>
                    <div style="font-size: 16px; font-weight: 700; color: #3b82f6;" id="totalTime">00:00</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">VEL. MEDIA</div>
                    <div style="font-size: 16px; font-weight: 700; color: #f59e0b;" id="avgSpeed">0 km/h</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #94a3b8; margin-bottom: 4px;">INCIDENCIAS</div>
                    <div style="font-size: 16px; font-weight: 700; color: #ef4444;" id="incidentCount">0</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel Inferior de Auditor√≠a -->
    <div class="audit-panel" id="auditPanel">
        <div class="panel-header" onclick="togglePanel()">
            <div class="panel-title">
                <i class="fas fa-sliders-h"></i>
                CONTROLES DE AUDITOR√çA
            </div>
            <button class="toggle-panel">
                <i class="fas fa-chevron-up" id="panelToggleIcon"></i>
            </button>
        </div>
        
        <!-- Selector de L√≠nea -->
        <div class="line-selector">
            <button class="line-button active" onclick="selectLine('sarmiento')">
                <i class="fas fa-train"></i>
                SARMIENTO
            </button>
            <button class="line-button" onclick="selectLine('mitre_tigre')">
                <i class="fas fa-subway"></i>
                MITRE
            </button>
            <button class="line-button" onclick="selectLine('roca')">
                <i class="fas fa-train"></i>
                ROCA
            </button>
            <button class="line-button" onclick="selectLine('sanmartin')">
                <i class="fas fa-subway"></i>
                SAN MART√çN
            </button>
            <button class="line-button" onclick="selectLine('colectivo_64')">
                <i class="fas fa-bus"></i>
                COLECTIVO 64
            </button>
        </div>
        
        <!-- Controles de Auditor√≠a -->
        <div class="audit-controls">
            <button class="audit-button primary" onclick="toggleRecording()">
                <i class="fas fa-circle" id="recordIcon"></i>
                <span id="recordText">INICIAR GRABACI√ìN</span>
            </button>
            <button class="audit-button" onclick="centerOnUser()">
                <i class="fas fa-crosshairs"></i>
                CENTRAR MAPA
            </button>
            <button class="audit-button warning" onclick="reportIncident()">
                <i class="fas fa-exclamation-triangle"></i>
                REPORTAR INCIDENCIA
            </button>
            <button class="audit-button success" onclick="generateReport()">
                <i class="fas fa-file-export"></i>
                GENERAR INFORME
            </button>
            <button class="audit-button" onclick="openCalibration()">
                <i class="fas fa-cog"></i>
                CALIBRAR
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN OPTIMIZADA
        // ============================================
        const CONFIG = {
            // GPS OPTIMIZADO
            GPS_UPDATE_INTERVAL: 3000,
            GPS_HIGH_ACCURACY: true,
            GPS_TIMEOUT: 10000,
            GPS_MIN_ACCURACY: 30,
            
            // DETECCI√ìN DE MOVIMIENTO
            MIN_MOVEMENT_DISTANCE: 8,
            STATIONARY_THRESHOLD: 0.5,
            STATIONARY_TIME: 8000,
            
            // GRABACI√ìN
            RECORDING_INTERVAL: 2000,
            STOP_DETECTION_THRESHOLD: 0.5,
            STOP_MIN_DURATION: 4000,
            STATION_PROXIMITY: 60,
            
            // OPTIMIZACIONES
            POSITION_HISTORY_SIZE: 20,
            SPEED_FILTER_WINDOW: 4,
            MAX_JUMP_DISTANCE: 20,
            
            // MAPA
            MAP_ZOOM_FOLLOW: 16,
            MAP_ZOOM_DEFAULT: 14,
            
            // INTERVALOS DE ACTUALIZACI√ìN DE UI
            UI_UPDATE_INTERVAL: 1000,
            STATIONS_UPDATE_INTERVAL: 3000
        };
        
        // ============================================
        // VARIABLES GLOBALES OPTIMIZADAS
        // ============================================
        let map = null;
        let userMarker = null;
        let routePolyline = null;
        let stopMarkers = [];
        
        // Estado del sistema
        let currentLine = 'sarmiento';
        let isFollowingUser = true;
        let isRecording = false;
        let isAuditActive = false;
        let auditData = [];
        
        // Datos GPS
        let positionHistory = [];
        let currentSpeed = 0;
        let currentBearing = 0;
        let currentAccuracy = 0;
        let lastProcessedPosition = null;
        
        // Estad√≠sticas
        let totalDistance = 0;
        let totalTime = 0;
        let avgSpeed = 0;
        let incidentCount = 0;
        
        // Temporizadores
        let uiUpdateTimer = null;
        let stationsUpdateTimer = null;
        
        // Base de datos optimizada
        const stationsDB = {
            sarmiento: [
                {name: 'ONCE', lat: -34.608544, lng: -58.406341, order: 1},
                {name: 'CABALLITO', lat: -34.618507, lng: -58.441615, order: 2},
                {name: 'FLORES', lat: -34.629034, lng: -58.462815, order: 3},
                {name: 'FLORESTA', lat: -34.634674, lng: -58.480412, order: 4},
                {name: 'VILLA LURO', lat: -34.637842, lng: -58.502378, order: 5},
                {name: 'LINIERS', lat: -34.641462, lng: -58.523724, order: 6}
            ],
            mitre_tigre: [
                {name: 'RETIRO', lat: -34.591428, lng: -58.373978, order: 1},
                {name: 'LISANDRO DE LA TORRE', lat: -34.595748, lng: -58.407421, order: 2},
                {name: 'VICENTE L√ìPEZ', lat: -34.530748, lng: -58.474678, order: 3}
            ],
            roca: [
                {name: 'CONSTITUCI√ìN', lat: -34.628045, lng: -58.381045, order: 1},
                {name: 'PARQUE PATRICIOS', lat: -34.640748, lng: -58.404358, order: 2}
            ],
            sanmartin: [
                {name: 'RETIRO', lat: -34.591428, lng: -58.373978, order: 1},
                {name: 'PALERMO', lat: -34.579158, lng: -58.421045, order: 2}
            ],
            colectivo_64: [
                {name: 'PUNTO INICIAL', lat: -34.608723, lng: -58.406254, order: 1},
                {name: 'PARADA 1', lat: -34.615000, lng: -58.415000, order: 2},
                {name: 'PARADA 2', lat: -34.620000, lng: -58.425000, order: 3}
            ]
        };
        
        // ============================================
        // INICIALIZACI√ìN OPTIMIZADA
        // ============================================
        function initMap() {
            // Simular progreso de carga
            simulateLoading();
            
            // Inicializar mapa
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true,
                inertia: true,
                inertiaDeceleration: 3000,
                inertiaMaxSpeed: 2000
            });
            
            // Capa de mapa profesional
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CARTO',
                maxZoom: 19,
                minZoom: 10
            }).addTo(map);
            
            // Vista inicial
            map.setView([-34.6037, -58.3816], CONFIG.MAP_ZOOM_DEFAULT);
            
            // Cargar estaciones iniciales
            loadStops(currentLine);
            
            // Iniciar sistema GPS despu√©s de carga
            setTimeout(() => {
                startGPS();
                initUIUpdates();
                hideLoading();
            }, 1500);
        }
        
        function simulateLoading() {
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                document.getElementById('loadingProgress').style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                }
            }, 50);
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        // ============================================
        // SISTEMA GPS OPTIMIZADO
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                alert("Tu dispositivo no soporta GPS");
                updateStatus('gps', 'error');
                return;
            }
            
            updateStatus('gps', 'searching');
            
            // Seguimiento continuo optimizado
            navigator.geolocation.watchPosition(
                position => handleGPSPosition(position),
                error => handleGPSError(error),
                {
                    enableHighAccuracy: CONFIG.GPS_HIGH_ACCURACY,
                    maximumAge: CONFIG.GPS_UPDATE_INTERVAL,
                    timeout: CONFIG.GPS_TIMEOUT
                }
            );
        }
        
        function handleGPSPosition(position) {
            if (!position || !position.coords) return;
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed;
            const heading = position.coords.heading;
            
            // Verificar precisi√≥n
            if (accuracy > CONFIG.GPS_MIN_ACCURACY) {
                updateStatus('gps', 'low_accuracy');
                return;
            }
            
            updateStatus('gps', 'active');
            updateGPSAccuracy(accuracy);
            
            // Actualizar velocidad
            if (speed !== null && speed >= 0) {
                currentSpeed = speed * 3.6; // Convertir a km/h
            }
            
            // Actualizar direcci√≥n
            if (heading !== null && heading >= 0) {
                currentBearing = heading;
            }
            
            // Actualizar posici√≥n
            updateUserPosition(lat, lng);
            
            // Registrar para estad√≠sticas
            recordPosition(lat, lng);
        }
        
        function updateUserPosition(lat, lng) {
            // Actualizar marcador
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'audit-marker',
                        html: '<div style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 0 20px rgba(59, 130, 246, 0.9);"></div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    }),
                    zIndexOffset: 1000
                }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
            
            // Centrar si est√° activo
            if (isFollowingUser) {
                map.panTo([lat, lng], {
                    animate: true,
                    duration: 0.5
                });
            }
            
            // Actualizar ruta
            updateRoute(lat, lng);
            
            lastProcessedPosition = { lat, lng };
        }
        
        function updateRoute(lat, lng) {
            positionHistory.push([lat, lng]);
            
            // Limitar historial
            if (positionHistory.length > 50) {
                positionHistory.shift();
            }
            
            // Actualizar polil√≠nea
            if (positionHistory.length > 1) {
                if (!routePolyline) {
                    routePolyline = L.polyline(positionHistory, {
                        color: '#3b82f6',
                        weight: 4,
                        opacity: 0.7,
                        lineCap: 'round',
                        lineJoin: 'round'
                    }).addTo(map);
                } else {
                    routePolyline.setLatLngs(positionHistory);
                }
            }
        }
        
        function recordPosition(lat, lng) {
            // Calcular distancia desde √∫ltima posici√≥n
            if (positionHistory.length > 1) {
                const prevPos = positionHistory[positionHistory.length - 2];
                const distance = calculateDistance(prevPos[0], prevPos[1], lat, lng);
                totalDistance += distance;
            }
            
            // Actualizar tiempo
            totalTime += CONFIG.GPS_UPDATE_INTERVAL / 1000;
            
            // Actualizar velocidad promedio
            if (totalTime > 0) {
                avgSpeed = (totalDistance / totalTime) * 3.6;
            }
        }
        
        // ============================================
        // INTERFAZ DE USUARIO OPTIMIZADA
        // ============================================
        function initUIUpdates() {
            // Actualizar UI peri√≥dicamente
            uiUpdateTimer = setInterval(() => {
                updateSpeedDisplay();
                updateDirectionDisplay();
                updateStatsDisplay();
            }, CONFIG.UI_UPDATE_INTERVAL);
            
            // Actualizar estaciones menos frecuentemente
            stationsUpdateTimer = setInterval(() => {
                updateStationsDisplay();
            }, CONFIG.STATIONS_UPDATE_INTERVAL);
        }
        
        function updateSpeedDisplay() {
            document.getElementById('speedValue').textContent = currentSpeed.toFixed(1) + ' km/h';
            
            // Color seg√∫n velocidad
            const speedElement = document.getElementById('speedValue');
            if (currentSpeed < 5) {
                speedElement.style.color = '#94a3b8';
            } else if (currentSpeed < 30) {
                speedElement.style.color = '#3b82f6';
            } else {
                speedElement.style.color = '#10b981';
            }
        }
        
        function updateDirectionDisplay() {
            const arrow = document.getElementById('directionArrow');
            const text = document.getElementById('directionText');
            
            if (currentSpeed < 1) {
                arrow.textContent = '‚óè';
                text.textContent = 'DETENIDO';
                arrow.style.transform = 'rotate(0deg)';
                return;
            }
            
            let direction = 'NORTE';
            let arrowChar = '‚Üë';
            
            if (currentBearing >= 337.5 || currentBearing < 22.5) {
                direction = 'NORTE'; arrowChar = '‚Üë';
            } else if (currentBearing >= 22.5 && currentBearing < 67.5) {
                direction = 'NORESTE'; arrowChar = '‚Üó';
            } else if (currentBearing >= 67.5 && currentBearing < 112.5) {
                direction = 'ESTE'; arrowChar = '‚Üí';
            } else if (currentBearing >= 112.5 && currentBearing < 157.5) {
                direction = 'SURESTE'; arrowChar = '‚Üò';
            } else if (currentBearing >= 157.5 && currentBearing < 202.5) {
                direction = 'SUR'; arrowChar = '‚Üì';
            } else if (currentBearing >= 202.5 && currentBearing < 247.5) {
                direction = 'SUROESTE'; arrowChar = '‚Üô';
            } else if (currentBearing >= 247.5 && currentBearing < 292.5) {
                direction = 'OESTE'; arrowChar = '‚Üê';
            } else if (currentBearing >= 292.5 && currentBearing < 337.5) {
                direction = 'NOROESTE'; arrowChar = '‚Üñ';
            }
            
            arrow.textContent = arrowChar;
            text.textContent = direction;
            arrow.style.transform = `rotate(${currentBearing}deg)`;
        }
        
        function updateStatsDisplay() {
            document.getElementById('totalDistance').textContent = 
                (totalDistance / 1000).toFixed(2) + ' km';
            
            const hours = Math.floor(totalTime / 3600);
            const minutes = Math.floor((totalTime % 3600) / 60);
            document.getElementById('totalTime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            
            document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1) + ' km/h';
            document.getElementById('incidentCount').textContent = incidentCount;
            
            // Actualizar estado de estad√≠sticas
            document.getElementById('statsStatus').textContent = 
                isRecording ? 'REC' : 'ON';
            document.getElementById('statsStatus').className = 
                `status-badge ${isRecording ? 'status-warning' : 'status-active'}`;
        }
        
        function updateStationsDisplay() {
            if (!lastProcessedPosition) return;
            
            const stations = stationsDB[currentLine];
            if (!stations) return;
            
            const stationsList = document.getElementById('stationsList');
            stationsList.innerHTML = '';
            
            // Encontrar estaciones cercanas
            stations.forEach((station, index) => {
                const distance = calculateDistance(
                    lastProcessedPosition.lat, lastProcessedPosition.lng,
                    station.lat, station.lng
                );
                
                // Solo mostrar estaciones cercanas
                if (distance < 2000) {
                    const div = document.createElement('div');
                    div.className = `station-item ${index === 0 ? 'current' : index === 1 ? 'next' : ''}`;
                    
                    // Calcular ETA aproximada
                    const eta = distance / (currentSpeed > 5 ? currentSpeed / 3.6 : 10);
                    const etaMinutes = Math.round(eta / 60);
                    
                    div.innerHTML = `
                        <div class="station-name">${station.name}</div>
                        <div class="station-metrics">
                            <span class="station-distance">${Math.round(distance)} m</span>
                            <span class="station-eta">${etaMinutes > 0 ? etaMinutes + ' min' : '<1 min'}</span>
                        </div>
                    `;
                    
                    stationsList.appendChild(div);
                }
            });
            
            // Actualizar contador
            document.getElementById('stationCount').textContent = 
                stationsList.children.length;
        }
        
        function updateGPSAccuracy(accuracy) {
            document.getElementById('gpsAccuracy').textContent = 
                `Precisi√≥n: ${Math.round(accuracy)} m`;
            
            const badge = document.getElementById('speedAccuracy');
            if (accuracy < 15) {
                badge.textContent = 'ALTA';
                badge.className = 'status-badge status-active';
            } else if (accuracy < 30) {
                badge.textContent = 'MEDIA';
                badge.className = 'status-badge status-warning';
            } else {
                badge.textContent = 'BAJA';
                badge.className = 'status-badge status-inactive';
            }
        }
        
        function updateStatus(type, status) {
            const element = document.getElementById(type + 'Status');
            
            switch(status) {
                case 'searching':
                    element.className = 'status-dot inactive';
                    break;
                case 'active':
                    element.className = 'status-dot active';
                    break;
                case 'low_accuracy':
                    element.className = 'status-dot warning';
                    break;
                case 'error':
                    element.className = 'status-dot inactive';
                    break;
                case 'recording':
                    element.className = 'status-dot recording';
                    break;
            }
        }
        
        // ============================================
        // FUNCIONALIDADES DE AUDITOR√çA
        // ============================================
        function toggleRecording() {
            isRecording = !isRecording;
            
            const recordIcon = document.getElementById('recordIcon');
            const recordText = document.getElementById('recordText');
            const recordStatus = document.getElementById('recordStatus');
            
            if (isRecording) {
                recordIcon.className = 'fas fa-square';
                recordText.textContent = 'DETENER GRABACI√ìN';
                recordStatus.className = 'status-dot recording';
                updateStatus('record', 'recording');
                
                // Iniciar auditor√≠a
                startAudit();
            } else {
                recordIcon.className = 'fas fa-circle';
                recordText.textContent = 'INICIAR GRABACI√ìN';
                recordStatus.className = 'status-dot inactive';
                updateStatus('record', 'inactive');
                
                // Detener auditor√≠a
                stopAudit();
            }
        }
        
        function startAudit() {
            isAuditActive = true;
            updateStatus('audit', 'active');
            
            // Inicializar datos de auditor√≠a
            auditData = [{
                timestamp: new Date(),
                action: 'AUDITOR√çA INICIADA',
                line: currentLine,
                location: lastProcessedPosition
            }];
        }
        
        function stopAudit() {
            isAuditActive = false;
            updateStatus('audit', 'inactive');
            
            // Registrar fin de auditor√≠a
            auditData.push({
                timestamp: new Date(),
                action: 'AUDITOR√çA FINALIZADA',
                line: currentLine,
                location: lastProcessedPosition
            });
            
            // Mostrar resumen
            showAuditSummary();
        }
        
        function reportIncident() {
            const incidentTypes = [
                'Demora excesiva',
                'Servicio interrumpido',
                'Veh√≠culo en mal estado',
                'Falta de unidades',
                'Conducta inapropiada',
                'Problema de seguridad',
                'Otro'
            ];
            
            const type = prompt('Tipo de incidencia:\n' + incidentTypes.join('\n'));
            if (type) {
                const details = prompt('Detalles de la incidencia:');
                if (details !== null) {
                    incidentCount++;
                    
                    // Registrar incidencia
                    const incident = {
                        timestamp: new Date(),
                        type: type,
                        details: details,
                        location: lastProcessedPosition,
                        line: currentLine,
                        speed: currentSpeed
                    };
                    
                    auditData.push({
                        timestamp: new Date(),
                        action: 'INCIDENCIA REPORTADA',
                        data: incident
                    });
                    
                    alert('‚úÖ Incidencia registrada en el sistema');
                    
                    // Actualizar UI
                    updateStatsDisplay();
                }
            }
        }
        
        function generateReport() {
            if (auditData.length === 0) {
                alert('No hay datos de auditor√≠a para generar informe');
                return;
            }
            
            // Generar contenido del informe
            let report = '<h3 style="color: #3b82f6; margin-bottom: 15px;">üìä INFORME DE AUDITOR√çA</h3>';
            report += '<table class="data-table">';
            report += '<thead><tr><th>HORA</th><th>ACCI√ìN</th><th>DETALLES</th></tr></thead><tbody>';
            
            auditData.forEach(item => {
                const time = new Date(item.timestamp).toLocaleTimeString('es-AR');
                report += `<tr>
                    <td>${time}</td>
                    <td><strong>${item.action}</strong></td>
                    <td>${item.data ? JSON.stringify(item.data) : '-'}</td>
                </tr>`;
            });
            
            report += '</tbody></table>';
            
            // Mostrar en modal
            document.getElementById('modalTitle').textContent = 'Informe de Auditor√≠a';
            document.getElementById('modalContent').innerHTML = report;
            document.getElementById('auditModal').classList.add('active');
        }
        
        function showAuditSummary() {
            const duration = auditData.length > 1 ? 
                (new Date(auditData[auditData.length-1].timestamp) - new Date(auditData[0].timestamp)) / 60000 : 0;
            
            let summary = '<div style="text-align: center; margin-bottom: 20px;">';
            summary += '<div style="font-size: 48px; color: #3b82f6; margin-bottom: 10px;">üìã</div>';
            summary += '<h3 style="color: #3b82f6; margin-bottom: 10px;">AUDITOR√çA COMPLETADA</h3>';
            summary += '</div>';
            
            summary += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">';
            summary += `<div style="background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 10px;">
                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">DURACI√ìN</div>
                <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">${duration.toFixed(1)} min</div>
            </div>`;
            summary += `<div style="background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 10px;">
                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">INCIDENCIAS</div>
                <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${incidentCount}</div>
            </div>`;
            summary += `<div style="background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 10px;">
                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">DISTANCIA</div>
                <div style="font-size: 20px; font-weight: 700; color: #10b981;">${(totalDistance/1000).toFixed(2)} km</div>
            </div>`;
            summary += `<div style="background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 10px;">
                <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">VEL. MEDIA</div>
                <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${avgSpeed.toFixed(1)} km/h</div>
            </div>`;
            summary += '</div>';
            
            document.getElementById('modalTitle').textContent = 'Resumen de Auditor√≠a';
            document.getElementById('modalContent').innerHTML = summary;
            document.getElementById('auditModal').classList.add('active');
        }
        
        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function selectLine(lineId) {
            // Actualizar botones
            document.querySelectorAll('.line-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.line-button').classList.add('active');
            
            // Cambiar l√≠nea
            currentLine = lineId;
            loadStops(lineId);
            
            // Reiniciar estad√≠sticas si hay auditor√≠a activa
            if (isAuditActive) {
                auditData.push({
                    timestamp: new Date(),
                    action: 'CAMBIO DE L√çNEA',
                    from: currentLine,
                    to: lineId
                });
            }
        }
        
        function loadStops(lineId) {
            // Limpiar marcadores anteriores
            stopMarkers.forEach(marker => map.removeLayer(marker));
            stopMarkers = [];
            
            const stations = stationsDB[lineId];
            if (!stations) return;
            
            // Agregar nuevos marcadores
            stations.forEach((station, index) => {
                const isCurrent = index === 0;
                const isNext = index === 1;
                
                const marker = L.marker([station.lat, station.lng], {
                    icon: L.divIcon({
                        className: `station-marker-audit ${isCurrent ? 'current' : isNext ? 'next' : ''}`,
                        html: `<div style="background:${isCurrent ? '#3b82f6' : isNext ? '#10b981' : '#64748b'};width:16px;height:16px;border-radius:50%;border:3px solid white;"></div>`,
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    })
                })
                .bindTooltip(`<b>${station.name}</b><br>${station.order}¬∞ ${lineId.includes('colectivo') ? 'Parada' : 'Estaci√≥n'}`, {
                    permanent: false,
                    direction: 'top'
                })
                .addTo(map);
                
                stopMarkers.push(marker);
            });
        }
        
        function centerOnUser() {
            if (userMarker) {
                const latlng = userMarker.getLatLng();
                map.setView(latlng, CONFIG.MAP_ZOOM_FOLLOW, {
                    animate: true,
                    duration: 0.5
                });
                isFollowingUser = true;
            }
        }
        
        function togglePanel() {
            const panel = document.getElementById('auditPanel');
            const icon = document.getElementById('panelToggleIcon');
            
            panel.classList.toggle('collapsed');
            icon.className = panel.classList.contains('collapsed') ? 
                'fas fa-chevron-down' : 'fas fa-chevron-up';
        }
        
        function openCalibration() {
            alert('M√≥dulo de calibraci√≥n en desarrollo');
        }
        
        function closeAuditModal() {
            document.getElementById('auditModal').classList.remove('active');
        }
        
        function handleGPSError(error) {
            console.error('Error GPS:', error);
            updateStatus('gps', 'error');
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert('Se deneg√≥ el acceso al GPS. Act√≠valo en ajustes.');
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert('GPS no disponible. Verifica la conexi√≥n.');
                    break;
                case error.TIMEOUT:
                    alert('Timeout de GPS. Intenta nuevamente.');
                    break;
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                     Math.cos(œÜ1) * Math.cos(œÜ2) *
                     Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Manejar redimensionamiento
            window.addEventListener('resize', () => {
                if (map) {
                    setTimeout(() => map.invalidateSize(), 100);
                }
            });
            
            console.log('üöÄ Sistema de Auditor√≠a de Transporte inicializado');
        });
    </script>
</body>
</html>