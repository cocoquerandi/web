<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seguimiento Automático de Transporte</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            color: white;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* ===== MINIMALIST HUD ===== */
        .hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        
        .hud > * {
            pointer-events: auto;
        }
        
        .transport-selector {
            background: rgba(0, 0, 0, 0.85);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 300px;
        }
        
        .transport-buttons {
            display: flex;
            gap: 8px;
        }
        
        .transport-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .transport-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .transport-btn.active {
            background: #007AFF;
            transform: scale(1.05);
        }
        
        .line-selector {
            margin-top: 10px;
            display: none;
        }
        
        .line-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .line-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .line-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .line-btn.active {
            background: #34C759;
            transform: scale(1.05);
        }
        
        /* ===== INFO PANEL - APARECE SOLO AL PASAR EL DEDO ===== */
        .info-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 16px;
            padding: 15px;
            z-index: 1000;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(calc(100% + 20px));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 40vh;
            overflow: hidden;
        }
        
        .info-panel.visible {
            transform: translateY(0);
        }
        
        .info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-title {
            font-weight: 600;
            font-size: 16px;
            color: #007AFF;
        }
        
        .close-info {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
        }
        
        .status-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-value {
            font-weight: 600;
            font-size: 14px;
        }
        
        .direction-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #007AFF;
        }
        
        .direction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .direction-arrow {
            font-size: 20px;
            color: #34C759;
        }
        
        .direction-text {
            font-weight: 600;
            font-size: 14px;
        }
        
        .station-info {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .next-stations {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .station-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 6px;
        }
        
        .station-item.current {
            background: rgba(52, 199, 89, 0.1);
            border-left: 3px solid #34C759;
        }
        
        .station-index {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .station-details {
            flex: 1;
        }
        
        .station-name {
            font-weight: 600;
            font-size: 13px;
        }
        
        .station-distance {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 2px;
        }
        
        /* ===== FLOATING ACTION BUTTON ===== */
        .fab {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #007AFF;
            border: none;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.4);
            transition: all 0.2s;
        }
        
        .fab:active {
            transform: scale(0.9);
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            padding: 15px 20px;
            z-index: 10000;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            max-width: 80%;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: all;
        }
        
        .toast-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: #34C759;
        }
        
        /* ===== CUSTOM MARKERS ===== */
        .user-marker {
            background: #007AFF;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            border: 3px solid white;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
            animation: pulse 2s infinite;
            position: relative;
        }
        
        .user-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        .station-marker {
            background: #34C759;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.3);
        }
        
        .next-station-marker {
            background: #FF3B30;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.3);
            animation: pulse-red 1.5s infinite;
        }
        
        .direction-line {
            stroke: #007AFF;
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            animation: dash 20s linear infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 122, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0); }
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
        }
        
        @keyframes dash {
            to { stroke-dashoffset: 1000; }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .hud {
                top: 5px;
                left: 5px;
                right: 5px;
            }
            
            .transport-selector {
                max-width: none;
            }
            
            .info-panel {
                bottom: 5px;
                left: 5px;
                right: 5px;
            }
            
            .fab {
                bottom: 80px;
                right: 20px;
            }
        }
        
        @media (min-width: 1024px) {
            .transport-selector {
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Mapa ocupa toda la pantalla -->
    <div id="map"></div>
    
    <!-- HUD minimalista en esquina superior -->
    <div class="hud">
        <div class="transport-selector">
            <div class="transport-buttons">
                <button class="transport-btn train" onclick="selectTransport('train')">
                    <i class="fas fa-train"></i>
                    <span>Tren</span>
                </button>
                <button class="transport-btn subte" onclick="selectTransport('subte')">
                    <i class="fas fa-subway"></i>
                    <span>Subte</span>
                </button>
                <button class="transport-btn bus" onclick="selectTransport('bus')">
                    <i class="fas fa-bus"></i>
                    <span>Colectivo</span>
                </button>
            </div>
            
            <div class="line-selector" id="lineSelector">
                <div class="line-buttons" id="lineButtons">
                    <!-- Líneas cargadas dinámicamente -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de información (oculto por defecto) -->
    <div class="info-panel" id="infoPanel">
        <div class="info-header">
            <div class="info-title">Estado del Viaje</div>
            <button class="close-info" onclick="toggleInfoPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="status-grid">
            <div class="status-item">
                <div class="status-label">Velocidad</div>
                <div class="status-value" id="speedValue">0 km/h</div>
            </div>
            <div class="status-item">
                <div class="status-label">Dirección</div>
                <div class="status-value" id="directionValue">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">Distancia</div>
                <div class="status-value" id="distanceValue">0 km</div>
            </div>
            <div class="status-item">
                <div class="status-label">Precisión</div>
                <div class="status-value" id="accuracyValue">-</div>
            </div>
        </div>
        
        <div class="direction-info">
            <div class="direction-header">
                <div class="direction-arrow" id="directionArrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
                <div class="direction-text" id="directionText">Selecciona una línea</div>
            </div>
            <div class="station-info">
                <div id="currentStationText">Estación actual: -</div>
                <div id="nextStationText">Siguiente estación: -</div>
            </div>
        </div>
        
        <div class="next-stations" id="nextStations">
            <!-- Estaciones cargadas dinámicamente -->
        </div>
    </div>
    
    <!-- Botón flotante para mostrar información -->
    <button class="fab" onclick="toggleInfoPanel()" id="fabButton">
        <i class="fas fa-info"></i>
    </button>
    
    <!-- Notificación toast -->
    <div class="toast" id="toast">
        <div class="toast-icon" id="toastIcon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div id="toastMessage">Mensaje</div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACIÓN INICIAL
        // ============================================
        
        // Inicializar mapa con vista de Buenos Aires
        const map = L.map('map', {
            zoomControl: false, // Quitamos controles para más limpieza
            attributionControl: false
        }).setView([-34.6037, -58.3816], 14);
        
        // Capa base oscura minimalista
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);
        
        // Variables de estado
        let userMarker = null;
        let userCircle = null;
        let stationMarkers = [];
        let nextStationMarker = null;
        let directionLine = null;
        let watchId = null;
        
        // Estado del seguimiento
        let currentTransport = null;
        let currentLine = null;
        let currentStations = [];
        let currentStationIndex = -1;
        let travelDirection = null;
        let isTracking = false;
        
        // Variables de movimiento
        let lastPosition = null;
        let totalDistance = 0;
        let positionHistory = [];
        let currentSpeed = 0;
        let currentBearing = 0;
        let lastUpdateTime = Date.now();
        
        // Base de datos de estaciones
        const stationDatabase = {
            train: {
                sarmiento: [
                    // Once (Este) → Moreno (Oeste)
                    { name: 'Once', lat: -34.609722, lng: -58.408889, order: 0 },
                    { name: 'Caballito', lat: -34.618611, lng: -58.441944, order: 1 },
                    { name: 'Flores', lat: -34.629167, lng: -58.463056, order: 2 },
                    { name: 'Liniers', lat: -34.641667, lng: -58.523889, order: 3 },
                    { name: 'Morón', lat: -34.650833, lng: -58.621111, order: 4 },
                    { name: 'Castelar', lat: -34.656944, lng: -58.6525, order: 5 },
                    { name: 'Ituzaingó', lat: -34.659167, lng: -58.671944, order: 6 },
                    { name: 'Merlo', lat: -34.665833, lng: -58.728056, order: 7 },
                    { name: 'Paso del Rey', lat: -34.656944, lng: -58.761111, order: 8 },
                    { name: 'Moreno', lat: -34.635, lng: -58.791111, order: 9 }
                ],
                mitre: [
                    // Retiro (Sur) → Tigre (Norte)
                    { name: 'Retiro', lat: -34.591389, lng: -58.373889, order: 0 },
                    { name: 'Lisandro de la Torre', lat: -34.595833, lng: -58.4075, order: 1 },
                    { name: 'Migueletes', lat: -34.556667, lng: -58.462778, order: 2 },
                    { name: 'Vicente López', lat: -34.530833, lng: -58.474722, order: 3 },
                    { name: 'Olivos', lat: -34.5075, lng: -58.4875, order: 4 },
                    { name: 'La Lucila', lat: -34.495833, lng: -58.493889, order: 5 },
                    { name: 'Martínez', lat: -34.488889, lng: -58.504167, order: 6 }
                ],
                roca: [
                    // Constitución (Norte) → Glew (Sur)
                    { name: 'Constitución', lat: -34.628056, lng: -58.381111, order: 0 },
                    { name: 'Avellaneda', lat: -34.663611, lng: -58.367222, order: 1 },
                    { name: 'Lanús', lat: -34.699722, lng: -58.3925, order: 2 },
                    { name: 'Banfield', lat: -34.743056, lng: -58.392222, order: 3 },
                    { name: 'Lomas de Zamora', lat: -34.758889, lng: -58.404444, order: 4 },
                    { name: 'Temperley', lat: -34.768056, lng: -58.394722, order: 5 }
                ]
            },
            subte: {
                linea_a: [
                    { name: 'Plaza de Mayo', lat: -34.6086, lng: -58.3713, order: 0 },
                    { name: 'Perú', lat: -34.6094, lng: -58.3738, order: 1 },
                    { name: 'Piedras', lat: -34.6100, lng: -58.3762, order: 2 },
                    { name: 'Lima', lat: -34.6107, lng: -58.3790, order: 3 },
                    { name: 'Sáenz Peña', lat: -34.6112, lng: -58.3818, order: 4 }
                ]
            }
        };
        
        // Líneas disponibles
        const transportLines = {
            train: [
                { id: 'sarmiento', name: 'Sarmiento', icon: 'fas fa-train', color: '#007AFF' },
                { id: 'mitre', name: 'Mitre', icon: 'fas fa-train', color: '#5856D6' },
                { id: 'roca', name: 'Roca', icon: 'fas fa-train', color: '#34C759' }
            ],
            subte: [
                { id: 'linea_a', name: 'Línea A', icon: 'fas fa-subway', color: '#00A3E0' }
            ],
            bus: [
                { id: 'linea_1', name: 'Línea 1', icon: 'fas fa-bus', color: '#FF9500' }
            ]
        };
        
        // ============================================
        // FUNCIONES DE INTERFAZ MINIMALISTA
        // ============================================
        
        function toggleInfoPanel() {
            const panel = document.getElementById('infoPanel');
            const fab = document.getElementById('fabButton');
            
            panel.classList.toggle('visible');
            
            if (panel.classList.contains('visible')) {
                fab.innerHTML = '<i class="fas fa-times"></i>';
            } else {
                fab.innerHTML = '<i class="fas fa-info"></i>';
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const messageEl = document.getElementById('toastMessage');
            const icon = document.getElementById('toastIcon');
            
            messageEl.textContent = message;
            
            // Configurar color según tipo
            const colors = {
                success: '#34C759',
                error: '#FF3B30',
                warning: '#FF9500',
                info: '#007AFF'
            };
            
            icon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' :
                            type === 'error' ? '<i class="fas fa-times-circle"></i>' :
                            type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' :
                            '<i class="fas fa-info-circle"></i>';
            
            icon.style.color = colors[type] || colors.info;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        
        function updateUI() {
            if (!lastPosition) return;
            
            // Actualizar valores en panel
            document.getElementById('speedValue').textContent = `${currentSpeed.toFixed(1)} km/h`;
            document.getElementById('directionValue').textContent = getDirectionFromBearing(currentBearing);
            document.getElementById('distanceValue').textContent = `${(totalDistance / 1000).toFixed(2)} km`;
            document.getElementById('accuracyValue').textContent = `${Math.round(lastPosition.coords.accuracy)} m`;
            
            // Actualizar información de estaciones
            updateStationInfo();
        }
        
        function updateStationInfo() {
            if (currentStationIndex >= 0 && currentStations.length > 0) {
                const currentStation = currentStations[currentStationIndex];
                let nextIndex = travelDirection === 'east' || travelDirection === 'south' 
                    ? currentStationIndex + 1 
                    : currentStationIndex - 1;
                
                nextIndex = Math.max(0, Math.min(nextIndex, currentStations.length - 1));
                const nextStation = currentStations[nextIndex];
                
                document.getElementById('currentStationText').textContent = 
                    `Estación actual: ${currentStation.name}`;
                
                if (userMarker && nextStation) {
                    const userLatLng = userMarker.getLatLng();
                    const distance = calculateDistance(
                        userLatLng.lat, userLatLng.lng,
                        nextStation.lat, nextStation.lng
                    );
                    
                    document.getElementById('nextStationText').textContent = 
                        `Siguiente: ${nextStation.name} (${(distance/1000).toFixed(1)} km)`;
                }
                
                // Actualizar dirección visual
                updateDirectionDisplay();
            }
        }
        
        function updateDirectionDisplay() {
            const arrow = document.getElementById('directionArrow');
            const text = document.getElementById('directionText');
            
            if (!travelDirection) return;
            
            // Rotar flecha según dirección
            arrow.style.transform = travelDirection === 'east' ? 'rotate(0deg)' :
                                  travelDirection === 'west' ? 'rotate(180deg)' :
                                  travelDirection === 'north' ? 'rotate(-90deg)' :
                                  travelDirection === 'south' ? 'rotate(90deg)' : 'rotate(0deg)';
            
            // Texto descriptivo
            if (currentLine === 'sarmiento') {
                text.textContent = travelDirection === 'west' ? 
                    'Hacia Moreno (Oeste)' : 'Hacia Once (Este)';
            } else if (currentLine === 'mitre') {
                text.textContent = travelDirection === 'north' ?
                    'Hacia Tigre (Norte)' : 'Hacia Retiro (Sur)';
            } else if (currentLine === 'roca') {
                text.textContent = travelDirection === 'south' ?
                    'Hacia Glew (Sur)' : 'Hacia Constitución (Norte)';
            }
        }
        
        // ============================================
        // SEGUIMIENTO AUTOMÁTICO
        // ============================================
        
        function startAutomaticTracking() {
            if (!navigator.geolocation) {
                showToast('GPS no disponible', 'error');
                return;
            }
            
            // Iniciar seguimiento inmediato
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateUserPosition(position);
                    map.setView([position.coords.latitude, position.coords.longitude], 15);
                    showToast('Seguimiento automático activado', 'success');
                },
                (error) => {
                    console.error('Error GPS:', error);
                    // Usar ubicación por defecto
                    updateUserPosition({
                        coords: {
                            latitude: -34.6037,
                            longitude: -58.3816,
                            accuracy: 100
                        },
                        timestamp: Date.now()
                    });
                }
            );
            
            // Seguimiento continuo
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    updateUserPosition(position);
                    
                    // Análisis automático de movimiento
                    if (lastPosition) {
                        analyzeMovement(position);
                        
                        // Si hay transporte seleccionado, analizar dirección
                        if (currentTransport && currentLine) {
                            checkProximityToStations();
                            updateDirection();
                        }
                    }
                },
                (error) => {
                    console.error('Error seguimiento:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 5000
                }
            );
        }
        
        function updateUserPosition(position) {
            lastPosition = position;
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            // Guardar en historial
            positionHistory.push({
                lat: lat,
                lng: lng,
                timestamp: Date.now()
            });
            
            // Limitar historial
            if (positionHistory.length > 20) {
                positionHistory.shift();
            }
            
            // Actualizar o crear marcador
            if (userMarker) {
                userMarker.setLatLng([lat, lng]);
            } else {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
            }
            
            // Actualizar círculo de precisión
            if (userCircle) {
                userCircle.setLatLng([lat, lng]);
                userCircle.setRadius(accuracy);
            } else {
                userCircle = L.circle([lat, lng], {
                    radius: accuracy,
                    color: '#007AFF',
                    fillColor: '#007AFF',
                    fillOpacity: 0.1
                }).addTo(map);
            }
            
            // Actualizar UI
            updateUI();
        }
        
        function analyzeMovement(currentPosition) {
            if (positionHistory.length < 2) return;
            
            const previousPosition = positionHistory[positionHistory.length - 2];
            const currentPoint = {
                lat: currentPosition.coords.latitude,
                lng: currentPosition.coords.longitude
            };
            
            const previousPoint = {
                lat: previousPosition.lat,
                lng: previousPosition.lng
            };
            
            // Calcular distancia
            const distance = calculateDistance(
                previousPoint.lat, previousPoint.lng,
                currentPoint.lat, currentPoint.lng
            );
            
            // Calcular tiempo
            const timeDiff = (currentPosition.timestamp - previousPosition.timestamp) / 1000;
            
            if (timeDiff > 0) {
                // Velocidad en km/h
                currentSpeed = (distance / timeDiff) * 3.6;
                totalDistance += distance;
                
                // Calcular rumbo
                currentBearing = calculateBearing(
                    previousPoint.lat, previousPoint.lng,
                    currentPoint.lat, currentPoint.lng
                );
                
                // Mostrar panel si hay movimiento
                if (currentSpeed > 5 && !document.getElementById('infoPanel').classList.contains('visible')) {
                    showToast(`En movimiento: ${currentSpeed.toFixed(0)} km/h`);
                }
            }
        }
        
        function getDirectionFromBearing(bearing) {
            if (bearing >= 337.5 || bearing < 22.5) return 'Norte';
            if (bearing >= 22.5 && bearing < 67.5) return 'Noreste';
            if (bearing >= 67.5 && bearing < 112.5) return 'Este';
            if (bearing >= 112.5 && bearing < 157.5) return 'Sureste';
            if (bearing >= 157.5 && bearing < 202.5) return 'Sur';
            if (bearing >= 202.5 && bearing < 247.5) return 'Suroeste';
            if (bearing >= 247.5 && bearing < 292.5) return 'Oeste';
            if (bearing >= 292.5 && bearing < 337.5) return 'Noroeste';
            return '-';
        }
        
        // ============================================
        // SELECCIÓN DE TRANSPORTE (INICIA AUTOMÁTICAMENTE)
        // ============================================
        
        function selectTransport(type) {
            currentTransport = type;
            
            // Actualizar botones
            document.querySelectorAll('.transport-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.transport-btn.${type}`).classList.add('active');
            
            // Mostrar selector de línea
            document.getElementById('lineSelector').style.display = 'block';
            loadLineButtons(type);
            
            showToast(`Transporte: ${type === 'train' ? 'Tren' : type === 'subte' ? 'Subte' : 'Colectivo'}`);
        }
        
        function loadLineButtons(type) {
            const lineButtons = document.getElementById('lineButtons');
            const lines = transportLines[type];
            
            lineButtons.innerHTML = '';
            
            lines.forEach(line => {
                const button = document.createElement('button');
                button.className = 'line-btn';
                button.innerHTML = `<i class="${line.icon}"></i> ${line.name}`;
                button.onclick = () => selectLine(line.id, line.name, line.color);
                lineButtons.appendChild(button);
            });
        }
        
        function selectLine(lineId, lineName, lineColor) {
            currentLine = lineId;
            
            // Actualizar botones
            document.querySelectorAll('.line-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Cargar estaciones y empezar seguimiento automático
            loadStationsForLine(lineId, lineName);
            
            // Mostrar información
            showToast(`Línea ${lineName} seleccionada. Seguimiento automático iniciado.`, 'success');
            
            // Forzar mostrar panel de información
            if (!document.getElementById('infoPanel').classList.contains('visible')) {
                toggleInfoPanel();
            }
        }
        
        function loadStationsForLine(lineId, lineName) {
            if (!currentTransport || !stationDatabase[currentTransport][lineId]) {
                showToast('Datos no disponibles para esta línea', 'warning');
                return;
            }
            
            currentStations = stationDatabase[currentTransport][lineId];
            currentStations.sort((a, b) => a.order - b.order);
            
            // Limpiar marcadores anteriores
            clearStationMarkers();
            
            // Agregar estaciones al mapa
            currentStations.forEach((station, index) => {
                const marker = L.marker([station.lat, station.lng], {
                    icon: L.divIcon({
                        className: 'station-marker',
                        iconSize: [20, 20]
                    })
                })
                .bindPopup(`
                    <div style="text-align: center; padding: 5px;">
                        <strong>${station.name}</strong><br>
                        <small>${lineName}</small>
                    </div>
                `)
                .addTo(map);
                
                stationMarkers.push(marker);
            });
            
            // Encontrar estación más cercana
            if (userMarker) {
                const userLatLng = userMarker.getLatLng();
                findNearestStation(userLatLng.lat, userLatLng.lng);
            }
            
            // Actualizar lista en panel
            updateStationsList();
        }
        
        function updateStationsList() {
            const nextStations = document.getElementById('nextStations');
            
            if (currentStations.length === 0) {
                nextStations.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.5;">No hay estaciones</div>';
                return;
            }
            
            let html = '';
            
            currentStations.forEach((station, index) => {
                const isCurrent = index === currentStationIndex;
                const distance = userMarker ? calculateDistance(
                    userMarker.getLatLng().lat, userMarker.getLatLng().lng,
                    station.lat, station.lng
                ) : 0;
                
                html += `
                    <div class="station-item ${isCurrent ? 'current' : ''}">
                        <div class="station-index">${station.order + 1}</div>
                        <div class="station-details">
                            <div class="station-name">${station.name}</div>
                            <div class="station-distance">${(distance/1000).toFixed(1)} km</div>
                        </div>
                    </div>
                `;
            });
            
            nextStations.innerHTML = html;
        }
        
        function findNearestStation(userLat, userLng) {
            if (currentStations.length === 0) return;
            
            let nearestIndex = 0;
            let nearestDistance = Infinity;
            
            currentStations.forEach((station, index) => {
                const distance = calculateDistance(userLat, userLng, station.lat, station.lng);
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestIndex = index;
                }
            });
            
            currentStationIndex = nearestIndex;
            
            // Determinar dirección automáticamente
            determineTravelDirection();
            
            updateStationsList();
            updateDestinationInfo();
        }
        
        function determineTravelDirection() {
            if (!currentBearing || currentStationIndex < 0) return;
            
            // Lógica por línea
            if (currentLine === 'sarmiento') {
                // Once (Este) → Moreno (Oeste)
                if (currentBearing >= 225 && currentBearing <= 315) {
                    travelDirection = 'west'; // Hacia Moreno
                } else if (currentBearing >= 45 && currentBearing <= 135) {
                    travelDirection = 'east'; // Hacia Once
                } else {
                    // Por defecto basado en posición
                    travelDirection = currentStationIndex < currentStations.length / 2 ? 'west' : 'east';
                }
            } else if (currentLine === 'mitre') {
                // Retiro (Sur) → Tigre (Norte)
                if (currentBearing >= 315 || currentBearing < 45) {
                    travelDirection = 'north'; // Hacia Tigre
                } else if (currentBearing >= 135 && currentBearing < 225) {
                    travelDirection = 'south'; // Hacia Retiro
                } else {
                    travelDirection = 'north';
                }
            } else if (currentLine === 'roca') {
                // Constitución (Norte) → Glew (Sur)
                if (currentBearing >= 135 && currentBearing < 225) {
                    travelDirection = 'south'; // Hacia Glew
                } else if (currentBearing >= 315 || currentBearing < 45) {
                    travelDirection = 'north'; // Hacia Constitución
                } else {
                    travelDirection = 'south';
                }
            }
            
            updateDirectionDisplay();
        }
        
        function updateDirection() {
            if (currentStationIndex < 0 || !travelDirection) return;
            
            // Actualizar estación más cercana
            if (userMarker) {
                const userLatLng = userMarker.getLatLng();
                findNearestStation(userLatLng.lat, userLatLng.lng);
            }
            
            // Actualizar línea de dirección
            updateDirectionLine();
        }
        
        function updateDestinationInfo() {
            if (currentStationIndex < 0 || !travelDirection) return;
            
            let nextStationIndex;
            
            if (travelDirection === 'east' || travelDirection === 'south') {
                nextStationIndex = Math.min(currentStationIndex + 1, currentStations.length - 1);
            } else {
                nextStationIndex = Math.max(currentStationIndex - 1, 0);
            }
            
            const nextStation = currentStations[nextStationIndex];
            
            // Actualizar marcador
            updateNextStationMarker(nextStation);
        }
        
        function updateNextStationMarker(station) {
            // Eliminar marcador anterior
            if (nextStationMarker) {
                map.removeLayer(nextStationMarker);
            }
            
            if (!station) return;
            
            // Crear nuevo marcador
            nextStationMarker = L.marker([station.lat, station.lng], {
                icon: L.divIcon({
                    className: 'next-station-marker',
                    iconSize: [26, 26]
                })
            })
            .bindPopup(`<strong>Próxima: ${station.name}</strong>`)
            .addTo(map);
            
            // Actualizar línea de dirección
            updateDirectionLine();
        }
        
        function updateDirectionLine() {
            if (!userMarker || !nextStationMarker) return;
            
            const userLatLng = userMarker.getLatLng();
            const stationLatLng = nextStationMarker.getLatLng();
            
            // Eliminar línea anterior
            if (directionLine) {
                map.removeLayer(directionLine);
            }
            
            // Crear nueva línea
            directionLine = L.polyline([userLatLng, stationLatLng], {
                color: '#007AFF',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 5'
            }).addTo(map);
        }
        
        function checkProximityToStations() {
            if (!userMarker || currentStationIndex < 0) return;
            
            const userLatLng = userMarker.getLatLng();
            const currentStation = currentStations[currentStationIndex];
            
            const distance = calculateDistance(
                userLatLng.lat, userLatLng.lng,
                currentStation.lat, currentStation.lng
            );
            
            // Notificar llegada si está cerca
            if (distance < 50) {
                showToast(`Llegando a ${currentStation.name}`, 'success');
                
                // Avanzar a siguiente estación
                if (travelDirection === 'east' || travelDirection === 'south') {
                    if (currentStationIndex < currentStations.length - 1) {
                        currentStationIndex++;
                    }
                } else {
                    if (currentStationIndex > 0) {
                        currentStationIndex--;
                    }
                }
                
                updateStationsList();
                updateDestinationInfo();
            }
        }
        
        function clearStationMarkers() {
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
            
            if (nextStationMarker) {
                map.removeLayer(nextStationMarker);
                nextStationMarker = null;
            }
            
            if (directionLine) {
                map.removeLayer(directionLine);
                directionLine = null;
            }
        }
        
        // ============================================
        // FUNCIONES UTILITARIAS
        // ============================================
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            const θ = Math.atan2(y, x);
            
            return (θ * 180 / Math.PI + 360) % 360;
        }
        
        // ============================================
        // INICIALIZACIÓN AUTOMÁTICA
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Iniciar seguimiento automático inmediatamente
            startAutomaticTracking();
            
            // Configurar eventos táctiles para el panel
            let touchStartY = 0;
            let panelStartY = 0;
            const panel = document.getElementById('infoPanel');
            
            panel.addEventListener('touchstart', function(e) {
                touchStartY = e.touches[0].clientY;
                panelStartY = panel.getBoundingClientRect().bottom;
                e.preventDefault();
            });
            
            panel.addEventListener('touchmove', function(e) {
                if (touchStartY === 0) return;
                
                const currentY = e.touches[0].clientY;
                const diff = currentY - touchStartY;
                
                // Solo permitir arrastrar hacia abajo para cerrar
                if (diff > 20) {
                    panel.classList.remove('visible');
                    document.getElementById('fabButton').innerHTML = '<i class="fas fa-info"></i>';
                }
                
                e.preventDefault();
            });
            
            panel.addEventListener('touchend', function() {
                touchStartY = 0;
                panelStartY = 0;
            });
            
            // Ocultar panel al tocar fuera
            document.addEventListener('touchstart', function(e) {
                if (!panel.contains(e.target) && 
                    !document.querySelector('.transport-selector').contains(e.target) &&
                    panel.classList.contains('visible')) {
                    panel.classList.remove('visible');
                    document.getElementById('fabButton').innerHTML = '<i class="fas fa-info"></i>';
                }
            });
            
            // Auto-seleccionar tren por defecto
            setTimeout(() => {
                selectTransport('train');
            }, 1000);
        });
        
        // Manejar cambios de orientación
        window.addEventListener('resize', function() {
            if (userMarker) {
                const latLng = userMarker.getLatLng();
                map.invalidateSize();
                map.setView(latLng, map.getZoom());
            }
        });
    </script>
</body>
</html>