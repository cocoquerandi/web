<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor√≠a GPS Transporte - Google Sheets</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #0f172a;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Header Fijo */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(15, 23, 42, 0.98);
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #60a5fa;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            background: #1e40af;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn.recording {
            background: #dc2626;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Mapa */
        #map {
            height: calc(100vh - 60px);
            width: 100%;
            margin-top: 60px;
        }
        
        /* Panel Lateral */
        .panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 300px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }
        
        .panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #334155;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* Indicadores */
        .stats {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
        }
        
        .stat-label {
            color: #94a3b8;
        }
        
        .stat-value {
            font-weight: bold;
            color: #60a5fa;
        }
        
        /* Veloc√≠metro */
        .speedometer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 12px 15px;
            min-width: 140px;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        .speed-value {
            font-size: 24px;
            font-weight: bold;
            color: #60a5fa;
            text-align: center;
        }
        
        /* Mensajes */
        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #059669;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .toast.error {
            background: #dc2626;
        }
        
        .toast.warning {
            background: #d97706;
        }
        
        @media (max-width: 768px) {
            .panel {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .speedometer {
                bottom: 80px;
                left: 10px;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <span>üöå AUDITOR√çA GPS</span>
        </div>
        <div class="controls">
            <button class="btn" onclick="togglePanel()" title="Estad√≠sticas">
                üìä
            </button>
            <button class="btn" id="recordBtn" onclick="toggleRecording()">
                <span id="recordIcon">‚óè</span>
                <span id="recordText">INICIAR</span>
            </button>
        </div>
    </div>
    
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Veloc√≠metro -->
    <div class="speedometer">
        <div class="speed-value" id="speedValue">0.0 km/h</div>
        <div style="text-align:center; font-size:12px; color:#94a3b8;" id="gpsStatus">
            GPS: ACTIVO
        </div>
    </div>
    
    <!-- Panel de Estad√≠sticas -->
    <div class="panel" id="panel">
        <div class="panel-header">
            <h3 style="font-size:16px;">üìà Estad√≠sticas</h3>
            <button class="close-btn" onclick="togglePanel()">√ó</button>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Grabaci√≥n:</span>
                <span class="stat-value" id="recordingStatus">INACTIVA</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Puntos:</span>
                <span class="stat-value" id="dataCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">√öltimo env√≠o:</span>
                <span class="stat-value" id="lastSend">--:--</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Duraci√≥n:</span>
                <span class="stat-value" id="duration">00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Paradas:</span>
                <span class="stat-value" id="stopCount">0</span>
            </div>
        </div>
        
        <button class="btn" style="width:100%; margin-top:10px;" onclick="exportToCSV()">
            üì• DESCARGAR CSV
        </button>
        
        <button class="btn" style="width:100%; margin-top:8px; background:#059669;" onclick="forceSend()">
            üì§ ENVIAR A SHEETS
        </button>
        
        <div style="margin-top:15px; padding-top:10px; border-top:1px solid #334155;">
            <div style="font-size:12px; color:#94a3b8;">
                <div>üîó <span id="gasStatus">GAS: Conectado</span></div>
                <div style="margin-top:5px;">üìä <span id="localData">0 puntos locales</span></div>
            </div>
        </div>
    </div>
    
    <!-- Mensajes -->
    <div class="toast" id="toast"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxpPkPjQJpMHTVTrorBqEDUARd6Lkh3Lbf3RT2oI5qCliUy60ilJHMxHkn3l9gfe4Osvw/exec';
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map = null;
        let userMarker = null;
        let isRecording = false;
        let recordingStart = null;
        let recordingInterval = null;
        let currentPos = null;
        let currentSpeed = 0;
        let dataPoints = [];
        let pendingPoints = [];
        let totalPoints = 0;
        let stopCount = 0;
        let lastSendTime = null;
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando sistema de auditor√≠a GPS');
            
            // Inicializar mapa
            initMap();
            
            // Iniciar GPS
            startGPS();
            
            // Cargar datos guardados
            loadLocalData();
            
            // Probar conexi√≥n GAS
            testGAS();
            
            showToast('‚úÖ Sistema listo', 'success');
        });
        
        // ============================================
        // FUNCIONES DEL MAPA
        // ============================================
        function initMap() {
            map = L.map('map').setView([-34.6037, -58.3816], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
        }
        
        function updateMapPosition(lat, lng) {
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="width:20px;height:20px;background:#3b82f6;border-radius:50%;border:3px solid white;box-shadow:0 0 10px #3b82f6;"></div>'
                    })
                }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
            
            map.setView([lat, lng], 16);
        }
        
        // ============================================
        // SISTEMA GPS
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                showToast('Tu dispositivo no soporta GPS', 'error');
                return;
            }
            
            navigator.geolocation.watchPosition(
                position => handlePosition(position),
                error => handleGPSError(error),
                {
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 10000
                }
            );
        }
        
        function handlePosition(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const speed = pos.coords.speed;
            
            currentPos = { lat, lng };
            currentSpeed = speed ? (speed * 3.6) : 0;
            
            // Actualizar UI
            document.getElementById('speedValue').textContent = currentSpeed.toFixed(1) + ' km/h';
            document.getElementById('gpsStatus').textContent = 'GPS: ACTIVO';
            
            // Actualizar mapa
            updateMapPosition(lat, lng);
            
            // Si est√° grabando, registrar punto
            if (isRecording) {
                recordPoint(pos);
            }
        }
        
        function handleGPSError(error) {
            console.error('Error GPS:', error);
            document.getElementById('gpsStatus').textContent = 'GPS: ERROR';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    showToast('Permiso de GPS denegado', 'error');
                    break;
                case error.POSITION_UNAVAILABLE:
                    showToast('Posici√≥n no disponible', 'error');
                    break;
                case error.TIMEOUT:
                    showToast('Tiempo de espera agotado', 'error');
                    break;
            }
        }
        
        // ============================================
        // GRABACI√ìN DE DATOS
        // ============================================
        function toggleRecording() {
            if (!currentPos) {
                showToast('Esperando se√±al GPS...', 'warning');
                return;
            }
            
            isRecording = !isRecording;
            const btn = document.getElementById('recordBtn');
            const icon = document.getElementById('recordIcon');
            const text = document.getElementById('recordText');
            
            if (isRecording) {
                // INICIAR GRABACI√ìN
                recordingStart = Date.now();
                pendingPoints = [];
                
                btn.classList.add('recording');
                icon.textContent = '‚èπ';
                text.textContent = 'GRABANDO';
                document.getElementById('recordingStatus').textContent = 'ACTIVA';
                document.getElementById('recordingStatus').style.color = '#ef4444';
                
                // Intervalo de 5 segundos
                recordingInterval = setInterval(() => {
                    if (currentPos) recordCurrentPoint();
                }, 5000);
                
                // Primer punto inmediato
                recordCurrentPoint();
                
                // Contador de duraci√≥n
                startDurationCounter();
                
                showToast('üé• Grabaci√≥n iniciada', 'success');
                
            } else {
                // DETENER GRABACI√ìN
                btn.classList.remove('recording');
                icon.textContent = '‚óè';
                text.textContent = 'INICIAR';
                document.getElementById('recordingStatus').textContent = 'INACTIVA';
                document.getElementById('recordingStatus').style.color = '#60a5fa';
                
                clearInterval(recordingInterval);
                
                // Enviar datos restantes
                if (pendingPoints.length > 0) {
                    sendToSheets();
                }
                
                showToast('‚èπ Grabaci√≥n detenida', 'info');
            }
        }
        
        function recordPoint(pos) {
            const point = {
                timestamp: Date.now(),
                fecha: new Date().toLocaleDateString('es-AR'),
                hora: new Date().toLocaleTimeString('es-AR'),
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                velocidad: pos.coords.speed ? (pos.coords.speed * 3.6) : 0,
                precision: pos.coords.accuracy || 0,
                evento: currentSpeed < 1 ? 'PARADA' : 'MOVIMIENTO',
                linea: '152'
            };
            
            dataPoints.push(point);
            pendingPoints.push(point);
            totalPoints++;
            
            // Detectar paradas
            if (currentSpeed < 1 && point.evento === 'PARADA') {
                stopCount++;
                document.getElementById('stopCount').textContent = stopCount;
            }
            
            updateStats();
            
            // Enviar cada 5 puntos
            if (pendingPoints.length >= 5) {
                sendToSheets();
            }
            
            // Guardar localmente cada punto
            saveLocalData();
        }
        
        function recordCurrentPoint() {
            if (!currentPos) return;
            
            const point = {
                timestamp: Date.now(),
                fecha: new Date().toLocaleDateString('es-AR'),
                hora: new Date().toLocaleTimeString('es-AR'),
                lat: currentPos.lat,
                lng: currentPos.lng,
                velocidad: currentSpeed,
                precision: 0,
                evento: currentSpeed < 1 ? 'PARADA' : 'MOVIMIENTO',
                linea: '152'
            };
            
            dataPoints.push(point);
            pendingPoints.push(point);
            totalPoints++;
            
            updateStats();
        }
        
        function startDurationCounter() {
            setInterval(() => {
                if (!isRecording) return;
                
                const elapsed = Date.now() - recordingStart;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('duration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function updateStats() {
            document.getElementById('dataCount').textContent = totalPoints;
            document.getElementById('localData').textContent = `${dataPoints.length} puntos locales`;
        }
        
        // ============================================
        // ENV√çO A GOOGLE SHEETS - VERSI√ìN SIMPLIFICADA
        // ============================================
        async function sendToSheets() {
            if (pendingPoints.length === 0) return;
            
            try {
                console.log('üì§ Enviando', pendingPoints.length, 'puntos a GAS');
                
                // Crear FormData (m√°s compatible que JSON)
                const formData = new FormData();
                formData.append('action', 'saveData');
                formData.append('data', JSON.stringify(pendingPoints));
                
                // Enviar con m√©todo que s√≠ funciona
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Importante: no-cors para evitar problemas CORS
                    body: formData
                });
                
                // No podemos leer la respuesta con no-cors, pero asumimos √©xito
                lastSendTime = new Date().toLocaleTimeString('es-AR');
                document.getElementById('lastSend').textContent = lastSendTime;
                
                // Limpiar puntos pendientes
                const sentCount = pendingPoints.length;
                pendingPoints = [];
                
                showToast(`‚úÖ ${sentCount} puntos enviados a Sheets`, 'success');
                
                // Guardar estado
                saveLocalData();
                
            } catch (error) {
                console.error('‚ùå Error enviando datos:', error);
                showToast('‚ö†Ô∏è Error al enviar - Guardando localmente', 'warning');
                
                // Guardar backup local
                saveLocalData();
            }
        }
        
        async function forceSend() {
            if (dataPoints.length === 0) {
                showToast('No hay datos para enviar', 'warning');
                return;
            }
            
            // Enviar todos los datos locales
            pendingPoints = [...dataPoints];
            await sendToSheets();
        }
        
        async function testGAS() {
            try {
                // Enviar solicitud de prueba
                const formData = new FormData();
                formData.append('action', 'test');
                formData.append('test', 'true');
                
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });
                
                document.getElementById('gasStatus').textContent = 'GAS: Conectado ‚úì';
                console.log('‚úÖ GAS conectado');
                
            } catch (error) {
                document.getElementById('gasStatus').textContent = 'GAS: Error ‚úó';
                console.error('‚ùå Error conectando al GAS:', error);
                showToast('‚ö†Ô∏è Error conectando a Google Sheets', 'warning');
            }
        }
        
        // ============================================
        // ALMACENAMIENTO LOCAL
        // ============================================
        function saveLocalData() {
            const data = {
                points: dataPoints,
                total: totalPoints,
                stops: stopCount,
                lastUpdate: Date.now()
            };
            
            localStorage.setItem('gpsAuditData', JSON.stringify(data));
            console.log('üíæ Datos guardados localmente:', dataPoints.length, 'puntos');
        }
        
        function loadLocalData() {
            const saved = localStorage.getItem('gpsAuditData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    dataPoints = data.points || [];
                    totalPoints = data.total || dataPoints.length;
                    stopCount = data.stops || 0;
                    
                    updateStats();
                    console.log('üìÇ Datos cargados:', dataPoints.length, 'puntos');
                } catch (error) {
                    console.error('Error cargando datos:', error);
                }
            }
        }
        
        // ============================================
        // EXPORTACI√ìN CSV
        // ============================================
        function exportToCSV() {
            if (dataPoints.length === 0) {
                showToast('No hay datos para exportar', 'warning');
                return;
            }
            
            let csv = 'Fecha,Hora,Latitud,Longitud,Velocidad (km/h),Precisi√≥n,Tipo Evento,L√≠nea\n';
            
            dataPoints.forEach(point => {
                csv += `"${point.fecha}","${point.hora}",${point.lat},${point.lng},${point.velocidad.toFixed(1)},${point.precision},"${point.evento}","${point.linea}"\n`;
            });
            
            // Agregar resumen
            csv += '\nRESUMEN\n';
            csv += `Total puntos,${dataPoints.length}\n`;
            csv += `Paradas detectadas,${stopCount}\n`;
            csv += `Fecha exportaci√≥n,${new Date().toLocaleString('es-AR')}\n`;
            
            // Descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `auditoria_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast(`üì• CSV descargado: ${dataPoints.length} puntos`, 'success');
        }
        
        // ============================================
        // INTERFAZ DE USUARIO
        // ============================================
        function togglePanel() {
            const panel = document.getElementById('panel');
            panel.classList.toggle('active');
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';
            
            if (type === 'error') toast.classList.add('error');
            if (type === 'warning') toast.classList.add('warning');
            
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // ============================================
        // FUNCIONES DE DEBUG
        // ============================================
        window.debug = {
            getData: () => dataPoints,
            getPending: () => pendingPoints,
            clearData: () => {
                dataPoints = [];
                pendingPoints = [];
                totalPoints = 0;
                stopCount = 0;
                updateStats();
                localStorage.removeItem('gpsAuditData');
                showToast('Datos limpiados', 'info');
            },
            simulate: () => {
                if (!currentPos) currentPos = { lat: -34.6037, lng: -58.3816 };
                recordCurrentPoint();
            }
        };
        
        console.log('‚úÖ Sistema listo - Usa window.debug para funciones de desarrollo');
    </script>
</body>
</html>