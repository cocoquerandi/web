<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auditor√≠a GPS - Sistema de Transporte P√∫blico</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== RESET Y BASE ===== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #0f172a; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            touch-action: pan-x pan-y;
            color: #e2e8f0;
        }
        
        /* ===== MAPA ===== */
        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        /* ===== SOLAPAS LATERALES ===== */
        .tab-container {
            position: fixed;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tab-container.left {
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .tab-container.right {
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .tab-container.bottom {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: row;
        }
        
        .tab-button {
            width: 50px;
            height: 50px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 0 12px 12px 0;
            color: #94a3b8;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .tab-container.left .tab-button {
            border-radius: 0 12px 12px 0;
        }
        
        .tab-container.right .tab-button {
            border-radius: 12px 0 0 12px;
        }
        
        .tab-container.bottom .tab-button {
            border-radius: 12px 12px 0 0;
            width: 50px;
            height: 40px;
        }
        
        .tab-button:hover {
            background: rgba(30, 41, 59, 0.95);
            color: #3b82f6;
            width: 55px;
        }
        
        .tab-button.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
            width: 55px;
        }
        
        .tab-panel {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(100, 116, 139, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 999;
            transition: all 0.3s ease;
            overflow: hidden;
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .tab-panel.left {
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            height: 80vh;
            border-radius: 0 20px 20px 0;
        }
        
        .tab-panel.right {
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            height: 80vh;
            border-radius: 20px 0 0 20px;
        }
        
        .tab-panel.bottom {
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 90vw;
            max-width: 800px;
            height: 300px;
            border-radius: 20px 20px 0 0;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 41, 59, 0.5);
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-content {
            padding: 20px;
            height: calc(100% - 70px);
            overflow-y: auto;
        }
        
        /* ===== CONTENIDO DE PANELES ===== */
        /* Panel de Estado (izquierda) */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-item {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .status-item.gps {
            border-left-color: #3b82f6;
        }
        
        .status-item.recording {
            border-left-color: #ef4444;
        }
        
        .status-item.audit {
            border-left-color: #10b981;
        }
        
        .status-item.network {
            border-left-color: #8b5cf6;
        }
        
        .status-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-value {
            font-size: 20px;
            font-weight: 700;
            color: #f8fafc;
        }
        
        .status-subvalue {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Panel de Estaciones (derecha) */
        .stations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .station-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .station-card:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(5px);
        }
        
        .station-card.current {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }
        
        .station-card.next {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .station-order {
            font-size: 12px;
            color: #94a3b8;
            background: rgba(100, 116, 139, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .station-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .station-metric {
            display: flex;
            flex-direction: column;
        }
        
        .metric-label {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .metric-value {
            font-size: 14px;
            font-weight: 700;
            color: #3b82f6;
        }
        
        /* Panel de Controles (inferior) */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .control-button {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            padding: 15px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .control-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-color: #3b82f6;
        }
        
        .control-button.primary {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .control-button.warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .control-button.danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .control-button.success {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #10b981;
        }
        
        .control-icon {
            font-size: 24px;
        }
        
        .control-label {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        
        /* ===== INDICADOR DE VELOCIDAD FLOTANTE ===== */
        .speed-floating {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 15px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .speed-floating:hover {
            transform: scale(1.05);
        }
        
        .speed-label {
            font-size: 10px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .speed-value {
            font-size: 24px;
            font-weight: 800;
            color: #3b82f6;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        
        .speed-value.low {
            color: #10b981;
        }
        
        .speed-value.high {
            color: #ef4444;
        }
        
        .speed-direction {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ===== MINIMIZAR PANELES ===== */
        .minimize-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.3s ease;
        }
        
        .minimize-btn:hover {
            color: #3b82f6;
            transform: rotate(90deg);
        }
        
        /* ===== MODAL DE GRABACI√ìN ===== */
        .recording-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .recording-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .recording-content {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        /* ===== NOTIFICACI√ìN DE GRABACI√ìN ===== */
        .recording-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 18px;
            z-index: 1001;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.3);
            display: none;
            align-items: center;
            gap: 10px;
            animation: pulseRed 2s infinite;
        }
        
        .recording-notification.active {
            display: flex;
        }
        
        @keyframes pulseRed {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
        
        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 3px;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .tab-panel.left,
            .tab-panel.right {
                width: 90vw;
                max-width: 320px;
                height: 70vh;
            }
            
            .tab-panel.bottom {
                width: 95vw;
                height: 250px;
            }
            
            .controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .speed-floating {
                bottom: 10px;
                left: 10px;
                padding: 10px;
                min-width: 100px;
            }
            
            .speed-value {
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .tab-button {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .tab-panel.left,
            .tab-panel.right {
                width: 95vw;
                height: 80vh;
                top: 10%;
                transform: none;
            }
            
            .tab-panel.left {
                left: 0;
                border-radius: 0 20px 20px 0;
            }
            
            .tab-panel.right {
                right: 0;
                border-radius: 20px 0 0 20px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .panel-content {
                padding: 15px;
            }
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .tab-panel.active {
            animation: slideIn 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Indicador de Velocidad Flotante -->
    <div class="speed-floating" id="speedFloating">
        <div class="speed-label">
            <i class="fas fa-tachometer-alt"></i>
            VELOCIDAD
        </div>
        <div class="speed-value" id="speedValue">0.0 km/h</div>
        <div class="speed-direction">
            <span id="directionArrow">‚Üí</span>
            <span id="directionText">NORTE</span>
        </div>
    </div>
    
    <!-- Notificaci√≥n de Grabaci√≥n -->
    <div class="recording-notification" id="recordingNotification">
        <i class="fas fa-circle"></i>
        <span>GRABANDO ACTIVO</span>
        <span id="recordingTime">00:00</span>
    </div>
    
    <!-- Solapa Izquierda - Estado del Sistema -->
    <div class="tab-container left">
        <button class="tab-button active" onclick="togglePanel('status')" title="Estado del Sistema">
            <i class="fas fa-chart-line"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('lines')" title="L√≠neas">
            <i class="fas fa-route"></i>
        </button>
    </div>
    
    <!-- Solapa Derecha - Estaciones -->
    <div class="tab-container right">
        <button class="tab-button" onclick="togglePanel('stations')" title="Estaciones">
            <i class="fas fa-map-marker-alt"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('incidents')" title="Incidencias">
            <i class="fas fa-exclamation-triangle"></i>
        </button>
    </div>
    
    <!-- Solapa Inferior - Controles -->
    <div class="tab-container bottom">
        <button class="tab-button" onclick="togglePanel('controls')" title="Controles">
            <i class="fas fa-sliders-h"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('reports')" title="Reportes">
            <i class="fas fa-file-alt"></i>
        </button>
    </div>
    
    <!-- Paneles -->
    <!-- Panel de Estado -->
    <div class="tab-panel left active" id="panelStatus">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-chart-line"></i>
                ESTADO DEL SISTEMA
            </div>
            <button class="minimize-btn" onclick="togglePanel('status')">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="status-grid">
                <div class="status-item gps">
                    <div class="status-label">
                        <i class="fas fa-satellite"></i>
                        GPS
                    </div>
                    <div class="status-value" id="gpsStatusValue">ACTIVO</div>
                    <div class="status-subvalue" id="gpsAccuracy">Precisi√≥n: 10m</div>
                </div>
                
                <div class="status-item recording">
                    <div class="status-label">
                        <i class="fas fa-record-vinyl"></i>
                        GRABACI√ìN
                    </div>
                    <div class="status-value" id="recordingStatus">INACTIVA</div>
                    <div class="status-subvalue" id="recordingDuration">00:00:00</div>
                </div>
                
                <div class="status-item audit">
                    <div class="status-label">
                        <i class="fas fa-clipboard-check"></i>
                        AUDITOR√çA
                    </div>
                    <div class="status-value" id="auditStatus">ACTIVA</div>
                    <div class="status-subvalue" id="auditIncidents">0 incidencias</div>
                </div>
                
                <div class="status-item network">
                    <div class="status-label">
                        <i class="fas fa-wifi"></i>
                        CONEXI√ìN
                    </div>
                    <div class="status-value" id="networkStatus">ONLINE</div>
                    <div class="status-subvalue" id="networkLatency">Latencia: 50ms</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="status-label" style="margin-bottom: 10px;">
                    <i class="fas fa-history"></i>
                    √öLTIMOS EVENTOS
                </div>
                <div id="recentEvents" style="max-height: 150px; overflow-y: auto;">
                    <!-- Eventos se insertar√°n aqu√≠ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de L√≠neas -->
    <div class="tab-panel left" id="panelLines">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-route"></i>
                L√çNEAS DE TRANSPORTE
            </div>
            <button class="minimize-btn" onclick="togglePanel('lines')">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="stations-list">
                <div class="station-card current" onclick="selectLine('sarmiento')">
                    <div class="station-header">
                        <div class="station-name">SARMIENTO</div>
                        <div class="station-order">TREN</div>
                    </div>
                    <div class="station-metrics">
                        <div class="station-metric">
                            <div class="metric-label">Estaciones</div>
                            <div class="metric-value">16</div>
                        </div>
                        <div class="station-metric">
                            <div class="metric-label">Estado</div>
                            <div class="metric-value" style="color:#10b981;">OPERATIVO</div>
                        </div>
                    </div>
                </div>
                
                <div class="station-card" onclick="selectLine('mitre_tigre')">
                    <div class="station-header">
                        <div class="station-name">MITRE (TIGRE)</div>
                        <div class="station-order">TREN</div>
                    </div>
                    <div class="station-metrics">
                        <div class="station-metric">
                            <div class="metric-label">Estaciones</div>
                            <div class="metric-value">15</div>
                        </div>
                        <div class="station-metric">
                            <div class="metric-label">Estado</div>
                            <div class="metric-value" style="color:#10b981;">OPERATIVO</div>
                        </div>
                    </div>
                </div>
                
                <div class="station-card" onclick="selectLine('roca')">
                    <div class="station-header">
                        <div class="station-name">ROCA</div>
                        <div class="station-order">TREN</div>
                    </div>
                    <div class="station-metrics">
                        <div class="station-metric">
                            <div class="metric-label">Estaciones</div>
                            <div class="metric-value">12</div>
                        </div>
                        <div class="station-metric">
                            <div class="metric-label">Estado</div>
                            <div class="metric-value" style="color:#f59e0b;">CON DEMORAS</div>
                        </div>
                    </div>
                </div>
                
                <div class="station-card" onclick="selectLine('colectivo_64')">
                    <div class="station-header">
                        <div class="station-name">COLECTIVO 64</div>
                        <div class="station-order">COLECTIVO</div>
                    </div>
                    <div class="station-metrics">
                        <div class="station-metric">
                            <div class="metric-label">Paradas</div>
                            <div class="metric-value">8</div>
                        </div>
                        <div class="station-metric">
                            <div class="metric-label">Estado</div>
                            <div class="metric-value" style="color:#10b981;">OPERATIVO</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de Estaciones -->
    <div class="tab-panel right" id="panelStations">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-map-marker-alt"></i>
                ESTACIONES CERCANAS
            </div>
            <button class="minimize-btn" onclick="togglePanel('stations')">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="stations-list" id="stationsList">
                <!-- Estaciones se cargar√°n din√°micamente -->
                <div class="station-card">
                    <div class="station-header">
                        <div class="station-name">CARGANDO...</div>
                        <div class="station-order">--</div>
                    </div>
                    <div class="station-metrics">
                        <div class="station-metric">
                            <div class="metric-label">Distancia</div>
                            <div class="metric-value">-- m</div>
                        </div>
                        <div class="station-metric">
                            <div class="metric-label">ETA</div>
                            <div class="metric-value">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de Incidencias -->
    <div class="tab-panel right" id="panelIncidents">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-exclamation-triangle"></i>
                INCIDENCIAS
            </div>
            <button class="minimize-btn" onclick="togglePanel('incidents')">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="panel-content">
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; color: #f59e0b; margin-bottom: 10px;">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div style="font-size: 16px; color: #f8fafc; margin-bottom: 20px;">
                    No hay incidencias reportadas
                </div>
                <button class="control-button warning" onclick="reportIncident()">
                    <div class="control-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="control-label">REPORTAR INCIDENCIA</div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Panel de Controles -->
    <div class="tab-panel bottom" id="panelControls">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-sliders-h"></i>
                CONTROLES DE AUDITOR√çA
            </div>
            <button class="minimize-btn" onclick="togglePanel('controls')">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="controls-grid">
                <button class="control-button primary" onclick="toggleRecording()" id="recordingButton">
                    <div class="control-icon">
                        <i class="fas fa-circle" id="recordingIcon"></i>
                    </div>
                    <div class="control-label" id="recordingLabel">INICIAR GRABACI√ìN</div>
                </button>
                
                <button class="control-button" onclick="centerOnUser()">
                    <div class="control-icon">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                    <div class="control-label">CENTRAR MAPA</div>
                </button>
                
                <button class="control-button warning" onclick="openCalibration()">
                    <div class="control-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="control-label">CALIBRAR SISTEMA</div>
                </button>
                
                <button class="control-button success" onclick="generateReport()">
                    <div class="control-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <div class="control-label">GENERAR INFORME</div>
                </button>
                
                <button class="control-button" onclick="toggleBackgroundMode()" id="backgroundButton">
                    <div class="control-icon">
                        <i class="fas fa-mobile-alt" id="backgroundIcon"></i>
                    </div>
                    <div class="control-label" id="backgroundLabel">SEGUNDO PLANO: OFF</div>
                </button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN PARA SEGUNDO PLANO
        // ============================================
        const CONFIG = {
            // GPS
            GPS_UPDATE_INTERVAL: 2000,
            GPS_HIGH_ACCURACY: true,
            GPS_TIMEOUT: 10000,
            GPS_MIN_ACCURACY: 50,
            
            // SEGUNDO PLANO
            BACKGROUND_INTERVAL: 5000,  // 5 segundos en segundo plano
            BACKGROUND_ACCURACY: 100,   // Precisi√≥n reducida en segundo plano
            
            // GRABACI√ìN
            RECORDING_INTERVAL: 3000,
            STOP_DETECTION_THRESHOLD: 1.0,
            
            // UI
            UI_UPDATE_INTERVAL: 1000,
            STATIONS_UPDATE_INTERVAL: 5000
        };
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map = null;
        let userMarker = null;
        let routePolyline = null;
        let stopMarkers = [];
        
        // Estado del sistema
        let currentLine = 'sarmiento';
        let isRecording = false;
        let isBackgroundMode = false;
        let activePanel = 'status';
        
        // Datos GPS
        let currentPosition = null;
        let currentSpeed = 0;
        let currentBearing = 0;
        let currentAccuracy = 0;
        
        // Grabaci√≥n
        let recordingStartTime = null;
        let recordingInterval = null;
        let recordingTimer = null;
        let recordingDuration = 0;
        let recordingData = [];
        
        // Servicio para segundo plano
        let backgroundService = null;
        let wakeLock = null;
        
        // Base de datos de estaciones
        const stationsDB = {
            sarmiento: [
                {name: 'ONCE', lat: -34.608544, lng: -58.406341, order: 1},
                {name: 'CABALLITO', lat: -34.618507, lng: -58.441615, order: 2},
                {name: 'FLORES', lat: -34.629034, lng: -58.462815, order: 3},
                {name: 'FLORESTA', lat: -34.634674, lng: -58.480412, order: 4},
                {name: 'VILLA LURO', lat: -34.637842, lng: -58.502378, order: 5},
                {name: 'LINIERS', lat: -34.641462, lng: -58.523724, order: 6}
            ]
        };
        
        // ============================================
        // INICIALIZACI√ìN DEL SISTEMA
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initBackgroundService();
            setupVisibilityHandler();
            
            // Configurar paneles iniciales
            showPanel('status');
            
            // Iniciar GPS
            setTimeout(() => startGPS(), 1000);
            
            console.log('üöÄ Sistema de Auditor√≠a con Segundo Plano inicializado');
        });
        
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true
            });
            
            // Mapa oscuro profesional
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CARTO',
                maxZoom: 19,
                minZoom: 10
            }).addTo(map);
            
            map.setView([-34.6037, -58.3816], 14);
            
            // Cargar estaciones iniciales
            loadStops(currentLine);
        }
        
        // ============================================
        // SISTEMA DE SEGUNDO PLANO
        // ============================================
        function initBackgroundService() {
            // Verificar si el navegador soporta Service Workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(error => {
                    console.log('Service Worker no disponible:', error);
                });
            }
            
            // Solicitar Wake Lock para mantener el dispositivo activo
            requestWakeLock();
        }
        
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock activado para segundo plano');
                }
            } catch (err) {
                console.log('Wake Lock no disponible:', err);
            }
        }
        
        function setupVisibilityHandler() {
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // P√°gina en segundo plano
                    handleBackgroundMode();
                } else {
                    // P√°gina en primer plano
                    handleForegroundMode();
                }
            });
        }
        
        function handleBackgroundMode() {
            console.log('üì± Aplicaci√≥n en segundo plano');
            
            if (isRecording) {
                // Mostrar notificaci√≥n si est√° grabando
                document.getElementById('recordingNotification').classList.add('active');
                
                // Ajustar intervalos para ahorro de bater√≠a
                if (backgroundService) {
                    clearInterval(backgroundService);
                }
                
                backgroundService = setInterval(() => {
                    updateBackgroundRecording();
                }, CONFIG.BACKGROUND_INTERVAL);
            }
        }
        
        function handleForegroundMode() {
            console.log('üì± Aplicaci√≥n en primer plano');
            
            // Ocultar notificaci√≥n
            document.getElementById('recordingNotification').classList.remove('active');
            
            // Restaurar intervalos normales
            if (backgroundService) {
                clearInterval(backgroundService);
                backgroundService = null;
            }
        }
        
        function toggleBackgroundMode() {
            isBackgroundMode = !isBackgroundMode;
            
            const button = document.getElementById('backgroundButton');
            const icon = document.getElementById('backgroundIcon');
            const label = document.getElementById('backgroundLabel');
            
            if (isBackgroundMode) {
                button.classList.add('success');
                icon.className = 'fas fa-check-circle';
                label.textContent = 'SEGUNDO PLANO: ON';
                
                // Solicitar permiso para notificaciones
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                
                // Activar optimizaciones para segundo plano
                activateBackgroundOptimizations();
            } else {
                button.classList.remove('success');
                icon.className = 'fas fa-mobile-alt';
                label.textContent = 'SEGUNDO PLANO: OFF';
                
                // Desactivar optimizaciones
                deactivateBackgroundOptimizations();
            }
        }
        
        function activateBackgroundOptimizations() {
            // Reducir precisi√≥n GPS para ahorrar bater√≠a
            CONFIG.GPS_MIN_ACCURACY = 100;
            CONFIG.GPS_UPDATE_INTERVAL = 5000;
            
            // Notificar al usuario
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Auditor√≠a GPS', {
                    body: 'Modo segundo plano activado. Grabaci√≥n continua.',
                    icon: '/icon.png'
                });
            }
        }
        
        function deactivateBackgroundOptimizations() {
            // Restaurar configuraci√≥n normal
            CONFIG.GPS_MIN_ACCURACY = 50;
            CONFIG.GPS_UPDATE_INTERVAL = 2000;
        }
        
        function updateBackgroundRecording() {
            if (!currentPosition || !isRecording) return;
            
            // Registrar posici√≥n en segundo plano
            const dataPoint = {
                timestamp: Date.now(),
                lat: currentPosition.lat,
                lng: currentPosition.lng,
                speed: currentSpeed,
                accuracy: currentAccuracy,
                background: true
            };
            
            recordingData.push(dataPoint);
            
            // Actualizar duraci√≥n
            recordingDuration = Date.now() - recordingStartTime;
            updateRecordingDisplay();
            
            // Guardar en almacenamiento local por si se cierra la app
            saveRecordingToStorage();
        }
        
        function saveRecordingToStorage() {
            const recordingSession = {
                startTime: recordingStartTime,
                duration: recordingDuration,
                data: recordingData,
                line: currentLine
            };
            
            localStorage.setItem('lastRecordingSession', JSON.stringify(recordingSession));
        }
        
        // ============================================
        // SISTEMA GPS
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                alert("Tu dispositivo no soporta GPS");
                return;
            }
            
            updateGPSStatus('searching');
            
            navigator.geolocation.watchPosition(
                position => handleGPSPosition(position),
                error => handleGPSError(error),
                {
                    enableHighAccuracy: CONFIG.GPS_HIGH_ACCURACY,
                    maximumAge: CONFIG.GPS_UPDATE_INTERVAL,
                    timeout: CONFIG.GPS_TIMEOUT
                }
            );
        }
        
        function handleGPSPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed;
            const heading = position.coords.heading;
            
            currentPosition = { lat, lng };
            currentAccuracy = accuracy;
            
            // Actualizar velocidad
            if (speed !== null && speed >= 0) {
                currentSpeed = speed * 3.6;
            }
            
            // Actualizar direcci√≥n
            if (heading !== null && heading >= 0) {
                currentBearing = heading;
            }
            
            // Actualizar UI
            updateGPSStatus('active');
            updateSpeedDisplay();
            updateDirectionDisplay();
            updateUserPosition(lat, lng);
            
            // Si est√° grabando, registrar punto
            if (isRecording && !document.hidden) {
                recordPosition(lat, lng, speed);
            }
            
            // Actualizar estaciones cercanas peri√≥dicamente
            updateNearbyStations(lat, lng);
        }
        
        function updateUserPosition(lat, lng) {
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'audit-marker',
                        html: '<div style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 15px rgba(59, 130, 246, 0.9);"></div>',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    })
                }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
            
            // Actualizar ruta
            updateRoute(lat, lng);
        }
        
        function updateRoute(lat, lng) {
            if (!routePolyline) {
                routePolyline = L.polyline([[lat, lng]], {
                    color: '#3b82f6',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
            } else {
                const currentPath = routePolyline.getLatLngs();
                currentPath.push([lat, lng]);
                
                // Limitar a 100 puntos para rendimiento
                if (currentPath.length > 100) {
                    currentPath.shift();
                }
                
                routePolyline.setLatLngs(currentPath);
            }
        }
        
        // ============================================
        // SISTEMA DE GRABACI√ìN
        // ============================================
        function toggleRecording() {
            if (!currentPosition) {
                alert("Esperando se√±al GPS...");
                return;
            }
            
            isRecording = !isRecording;
            
            const button = document.getElementById('recordingButton');
            const icon = document.getElementById('recordingIcon');
            const label = document.getElementById('recordingLabel');
            const status = document.getElementById('recordingStatus');
            
            if (isRecording) {
                // Iniciar grabaci√≥n
                recordingStartTime = Date.now();
                recordingDuration = 0;
                recordingData = [];
                
                button.classList.add('danger');
                icon.className = 'fas fa-square';
                label.textContent = 'DETENER GRABACI√ìN';
                status.textContent = 'ACTIVA';
                
                // Iniciar temporizador
                recordingTimer = setInterval(updateRecordingDisplay, 1000);
                
                // Mostrar notificaci√≥n si est√° en segundo plano
                if (document.hidden) {
                    document.getElementById('recordingNotification').classList.add('active');
                }
                
                // Registrar evento
                addEvent('GRABACI√ìN INICIADA', 'success');
                
                console.log('üé• Grabaci√≥n iniciada');
            } else {
                // Detener grabaci√≥n
                button.classList.remove('danger');
                icon.className = 'fas fa-circle';
                label.textContent = 'INICIAR GRABACI√ìN';
                status.textContent = 'INACTIVA';
                
                // Detener temporizador
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                // Ocultar notificaci√≥n
                document.getElementById('recordingNotification').classList.remove('active');
                
                // Registrar evento
                addEvent('GRABACI√ìN DETENIDA', 'info');
                
                // Guardar grabaci√≥n
                saveRecording();
                
                console.log('üé• Grabaci√≥n detenida');
            }
        }
        
        function recordPosition(lat, lng, speed) {
            const dataPoint = {
                timestamp: Date.now(),
                lat: lat,
                lng: lng,
                speed: currentSpeed,
                accuracy: currentAccuracy,
                bearing: currentBearing,
                line: currentLine
            };
            
            recordingData.push(dataPoint);
        }
        
        function updateRecordingDisplay() {
            if (!isRecording) return;
            
            recordingDuration = Date.now() - recordingStartTime;
            
            const hours = Math.floor(recordingDuration / 3600000);
            const minutes = Math.floor((recordingDuration % 3600000) / 60000);
            const seconds = Math.floor((recordingDuration % 60000) / 1000);
            
            const timeString = 
                hours.toString().padStart(2, '0') + ':' +
                minutes.toString().padStart(2, '0') + ':' +
                seconds.toString().padStart(2, '0');
            
            // Actualizar en panel de estado
            document.getElementById('recordingDuration').textContent = timeString;
            
            // Actualizar en notificaci√≥n
            document.getElementById('recordingTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function saveRecording() {
            const recordingSession = {
                startTime: recordingStartTime,
                endTime: Date.now(),
                duration: recordingDuration,
                data: recordingData,
                line: currentLine,
                totalPoints: recordingData.length
            };
            
            // Guardar en localStorage
            localStorage.setItem('lastRecording', JSON.stringify(recordingSession));
            
            // Tambi√©n guardar en historial
            const history = JSON.parse(localStorage.getItem('recordingHistory') || '[]');
            history.push(recordingSession);
            localStorage.setItem('recordingHistory', JSON.stringify(history.slice(-10))); // Guardar √∫ltimas 10
            
            console.log('üíæ Grabaci√≥n guardada:', recordingData.length, 'puntos');
        }
        
        // ============================================
        // INTERFAZ DE USUARIO
        // ============================================
        function togglePanel(panelId) {
            // Ocultar panel actual si se hace clic en el mismo
            if (activePanel === panelId) {
                document.getElementById('panel' + capitalizeFirstLetter(activePanel)).classList.remove('active');
                document.querySelector(`[onclick="togglePanel('${activePanel}')"]`).classList.remove('active');
                activePanel = null;
                return;
            }
            
            // Ocultar panel anterior
            if (activePanel) {
                document.getElementById('panel' + capitalizeFirstLetter(activePanel)).classList.remove('active');
                document.querySelector(`[onclick="togglePanel('${activePanel}')"]`).classList.remove('active');
            }
            
            // Mostrar nuevo panel
            showPanel(panelId);
        }
        
        function showPanel(panelId) {
            activePanel = panelId;
            document.getElementById('panel' + capitalizeFirstLetter(panelId)).classList.add('active');
            document.querySelector(`[onclick="togglePanel('${panelId}')"]`).classList.add('active');
        }
        
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        function updateSpeedDisplay() {
            const speedElement = document.getElementById('speedValue');
            speedElement.textContent = currentSpeed.toFixed(1) + ' km/h';
            
            // Cambiar color seg√∫n velocidad
            speedElement.className = 'speed-value';
            if (currentSpeed < 5) {
                speedElement.classList.add('low');
            } else if (currentSpeed > 60) {
                speedElement.classList.add('high');
            }
        }
        
        function updateDirectionDisplay() {
            const arrow = document.getElementById('directionArrow');
            const text = document.getElementById('directionText');
            
            if (currentSpeed < 1) {
                arrow.textContent = '‚óè';
                text.textContent = 'DETENIDO';
                arrow.style.transform = 'rotate(0deg)';
                return;
            }
            
            let direction = 'NORTE';
            let arrowChar = '‚Üë';
            
            if (currentBearing >= 337.5 || currentBearing < 22.5) {
                direction = 'NORTE'; arrowChar = '‚Üë';
            } else if (currentBearing >= 22.5 && currentBearing < 67.5) {
                direction = 'NORESTE'; arrowChar = '‚Üó';
            } else if (currentBearing >= 67.5 && currentBearing < 112.5) {
                direction = 'ESTE'; arrowChar = '‚Üí';
            } else if (currentBearing >= 112.5 && currentBearing < 157.5) {
                direction = 'SURESTE'; arrowChar = '‚Üò';
            } else if (currentBearing >= 157.5 && currentBearing < 202.5) {
                direction = 'SUR'; arrowChar = '‚Üì';
            } else if (currentBearing >= 202.5 && currentBearing < 247.5) {
                direction = 'SUROESTE'; arrowChar = '‚Üô';
            } else if (currentBearing >= 247.5 && currentBearing < 292.5) {
                direction = 'OESTE'; arrowChar = '‚Üê';
            } else if (currentBearing >= 292.5 && currentBearing < 337.5) {
                direction = 'NOROESTE'; arrowChar = '‚Üñ';
            }
            
            arrow.textContent = arrowChar;
            text.textContent = direction;
            arrow.style.transform = `rotate(${currentBearing}deg)`;
        }
        
        function updateGPSStatus(status) {
            const element = document.getElementById('gpsStatusValue');
            const accuracyElement = document.getElementById('gpsAccuracy');
            
            switch(status) {
                case 'searching':
                    element.textContent = 'BUSCANDO';
                    element.style.color = '#f59e0b';
                    break;
                case 'active':
                    element.textContent = 'ACTIVO';
                    element.style.color = '#10b981';
                    accuracyElement.textContent = `Precisi√≥n: ${Math.round(currentAccuracy)}m`;
                    break;
                case 'error':
                    element.textContent = 'ERROR';
                    element.style.color = '#ef4444';
                    break;
            }
        }
        
        function updateNearbyStations(lat, lng) {
            const stations = stationsDB[currentLine];
            if (!stations) return;
            
            const stationsList = document.getElementById('stationsList');
            stationsList.innerHTML = '';
            
            // Calcular distancias y ordenar
            const stationsWithDistance = stations.map(station => {
                const distance = calculateDistance(lat, lng, station.lat, station.lng);
                return { ...station, distance };
            }).sort((a, b) => a.distance - b.distance);
            
            // Mostrar solo las 5 m√°s cercanas
            stationsWithDistance.slice(0, 5).forEach((station, index) => {
                const div = document.createElement('div');
                div.className = `station-card ${index === 0 ? 'current' : index === 1 ? 'next' : ''}`;
                div.onclick = () => centerOnStation(station.lat, station.lng);
                
                // Calcular ETA
                const etaMinutes = Math.round((station.distance / (currentSpeed > 5 ? currentSpeed / 3.6 : 10)) / 60);
                
                div.innerHTML = `
                    <div class="station-header">
                        <div class="station-name">${station.name}</div>
                        <div class="station-order">${station.order}</div>
                    </div>
                    <div class="station-metrics">
                        <div class="station-metric">
                            <div class="metric-label">Distancia</div>
                            <div class="metric-value">${Math.round(station.distance)} m</div>
                        </div>
                        <div class="station-metric">
                            <div class="metric-label">ETA</div>
                            <div class="metric-value">${etaMinutes > 0 ? etaMinutes + ' min' : '<1 min'}</div>
                        </div>
                    </div>
                `;
                
                stationsList.appendChild(div);
            });
        }
        
        function addEvent(message, type = 'info') {
            const eventsList = document.getElementById('recentEvents');
            const time = new Date().toLocaleTimeString('es-AR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'error') icon = '‚ùå';
            
            const eventDiv = document.createElement('div');
            eventDiv.style.cssText = `
                padding: 8px 12px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                margin-bottom: 8px;
                font-size: 12px;
                border-left: 3px solid ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            
            eventDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <span>${icon} ${message}</span>
                    <span style="color: #64748b;">${time}</span>
                </div>
            `;
            
            eventsList.insertBefore(eventDiv, eventsList.firstChild);
            
            // Limitar a 5 eventos
            if (eventsList.children.length > 5) {
                eventsList.removeChild(eventsList.lastChild);
            }
        }
        
        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function selectLine(lineId) {
            currentLine = lineId;
            loadStops(lineId);
            addEvent(`L√≠nea cambiada a: ${lineId.toUpperCase()}`, 'info');
        }
        
        function loadStops(lineId) {
            // Limpiar marcadores anteriores
            stopMarkers.forEach(marker => map.removeLayer(marker));
            stopMarkers = [];
            
            const stations = stationsDB[lineId];
            if (!stations) return;
            
            // Agregar nuevos marcadores
            stations.forEach((station, index) => {
                const marker = L.marker([station.lat, station.lng], {
                    icon: L.divIcon({
                        className: 'station-marker-audit',
                        html: `<div style="background:#3b82f6;width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                })
                .bindTooltip(station.name)
                .addTo(map);
                
                stopMarkers.push(marker);
            });
        }
        
        function centerOnUser() {
            if (currentPosition) {
                map.setView([currentPosition.lat, currentPosition.lng], 16, {
                    animate: true,
                    duration: 0.5
                });
                addEvent('Mapa centrado en posici√≥n actual', 'info');
            }
        }
        
        function centerOnStation(lat, lng) {
            map.setView([lat, lng], 18, {
                animate: true,
                duration: 0.5
            });
        }
        
        function reportIncident() {
            const incident = prompt('Describa la incidencia:');
            if (incident) {
                addEvent(`Incidencia reportada: ${incident}`, 'warning');
                alert('Incidencia registrada en el sistema');
            }
        }
        
        function openCalibration() {
            alert('M√≥dulo de calibraci√≥n en desarrollo');
        }
        
        function generateReport() {
            if (recordingData.length === 0) {
                alert('No hay datos de grabaci√≥n para generar informe');
                return;
            }
            
            let report = `INFORME DE AUDITOR√çA\n`;
            report += `====================\n\n`;
            report += `L√≠nea: ${currentLine}\n`;
            report += `Duraci√≥n: ${formatTime(recordingDuration)}\n`;
            report += `Puntos registrados: ${recordingData.length}\n\n`;
            report += `Datos:\n`;
            
            recordingData.forEach((point, index) => {
                if (index % 10 === 0) { // Cada 10 puntos
                    const time = new Date(point.timestamp).toLocaleTimeString();
                    report += `${time} - Lat: ${point.lat.toFixed(6)}, Lng: ${point.lng.toFixed(6)}, Vel: ${point.speed.toFixed(1)} km/h\n`;
                }
            });
            
            // Descargar archivo
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auditoria_${currentLine}_${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            
            addEvent('Informe generado y descargado', 'success');
        }
        
        function formatTime(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function handleGPSError(error) {
            console.error('Error GPS:', error);
            updateGPSStatus('error');
            addEvent('Error en se√±al GPS', 'error');
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                     Math.cos(œÜ1) * Math.cos(œÜ2) *
                     Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
    </script>
</body>
</html>