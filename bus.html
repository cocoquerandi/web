<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auditor√≠a GPS - Transporte P√∫blico Buenos Aires</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== RESET Y BASE ===== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacernelFont, sans-serif; 
            background: #0f172a; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            touch-action: pan-x pan-y;
            color: #e2e8f0;
        }
        
        /* ===== MAPA ===== */
        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        /* ===== SOLAPAS LATERALES ===== */
        .tab-container {
            position: fixed;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tab-container.left {
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .tab-container.right {
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .tab-container.bottom {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: row;
        }
        
        .tab-button {
            width: 50px;
            height: 50px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 0 12px 12px 0;
            color: #94a3b8;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .tab-container.left .tab-button {
            border-radius: 0 12px 12px 0;
        }
        
        .tab-container.right .tab-button {
            border-radius: 12px 0 0 12px;
        }
        
        .tab-container.bottom .tab-button {
            border-radius: 12px 12px 0 0;
            width: 50px;
            height: 40px;
        }
        
        .tab-button:hover {
            background: rgba(30, 41, 59, 0.95);
            color: #3b82f6;
            width: 55px;
        }
        
        .tab-button.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
            width: 55px;
        }
        
        .tab-panel {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(100, 116, 139, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 999;
            transition: all 0.3s ease;
            overflow: hidden;
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .tab-panel.left {
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            height: 80vh;
            border-radius: 0 20px 20px 0;
        }
        
        .tab-panel.right {
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            height: 80vh;
            border-radius: 20px 0 0 20px;
        }
        
        .tab-panel.bottom {
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 90vw;
            max-width: 800px;
            height: 300px;
            border-radius: 20px 20px 0 0;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 41, 59, 0.5);
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-content {
            padding: 20px;
            height: calc(100% - 70px);
            overflow-y: auto;
        }
        
        /* ===== CONTENIDO DE PANELES ===== */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-item {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .status-item.gps {
            border-left-color: #3b82f6;
        }
        
        .status-item.recording {
            border-left-color: #ef4444;
        }
        
        .status-item.audit {
            border-left-color: #10b981;
        }
        
        .status-item.network {
            border-left-color: #8b5cf6;
        }
        
        .status-item.api {
            border-left-color: #f59e0b;
        }
        
        .status-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-value {
            font-size: 20px;
            font-weight: 700;
            color: #f8fafc;
        }
        
        .status-subvalue {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Panel de Estaciones */
        .stations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .station-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .station-card:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(5px);
        }
        
        .station-card.current {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }
        
        .station-card.next {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .station-order {
            font-size: 12px;
            color: #94a3b8;
            background: rgba(100, 116, 139, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .station-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .station-metric {
            display: flex;
            flex-direction: column;
        }
        
        .metric-label {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .metric-value {
            font-size: 14px;
            font-weight: 700;
            color: #3b82f6;
        }
        
        /* Panel de Controles */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .control-button {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            padding: 15px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .control-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-color: #3b82f6;
        }
        
        .control-button.primary {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .control-button.warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .control-button.danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .control-button.success {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #10b981;
        }
        
        .control-icon {
            font-size: 24px;
        }
        
        .control-label {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        
        /* ===== INDICADOR DE VELOCIDAD FLOTANTE ===== */
        .speed-floating {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 15px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .speed-floating:hover {
            transform: scale(1.05);
        }
        
        .speed-label {
            font-size: 10px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .speed-value {
            font-size: 24px;
            font-weight: 800;
            color: #3b82f6;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        
        .speed-value.low {
            color: #10b981;
        }
        
        .speed-value.high {
            color: #ef4444;
        }
        
        .speed-direction {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ===== MODALES ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .modal-logo {
            font-size: 48px;
            color: #3b82f6;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 10px;
        }
        
        .modal-subtitle {
            font-size: 14px;
            color: #94a3b8;
        }
        
        /* ===== FORMULARIOS ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 10px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-input::placeholder {
            color: #64748b;
        }
        
        .form-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .form-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .form-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ===== MENSAJES ===== */
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #10b981;
            display: block;
        }
        
        .message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            display: block;
        }
        
        .recording-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 18px;
            z-index: 1001;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.3);
            display: none;
            align-items: center;
            gap: 10px;
            animation: pulseRed 2s infinite;
        }
        
        .recording-notification.active {
            display: flex;
        }
        
        @keyframes pulseRed {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        
        /* ===== LOADING ===== */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== TABLAS ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .data-table th {
            background: rgba(30, 41, 59, 0.7);
            padding: 10px;
            text-align: left;
            color: #94a3b8;
            font-weight: 600;
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.2);
            color: #e2e8f0;
        }
        
        .data-table tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 3px;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .tab-panel.left,
            .tab-panel.right {
                width: 90vw;
                max-width: 320px;
                height: 70vh;
            }
            
            .tab-panel.bottom {
                width: 95vw;
                height: 250px;
            }
            
            .controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .speed-floating {
                bottom: 10px;
                left: 10px;
                padding: 10px;
                min-width: 100px;
            }
            
            .speed-value {
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .tab-button {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .tab-panel.left,
            .tab-panel.right {
                width: 95vw;
                height: 80vh;
                top: 10%;
                transform: none;
            }
            
            .tab-panel.left {
                left: 0;
                border-radius: 0 20px 20px 0;
            }
            
            .tab-panel.right {
                right: 0;
                border-radius: 20px 0 0 20px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .panel-content {
                padding: 15px;
            }
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .tab-panel.active {
            animation: slideIn 0.3s ease;
        }
        
        /* ===== API CONFIG ===== */
        .api-config {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .config-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .config-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            background: rgba(30, 41, 59, 0.7);
            color: #94a3b8;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .config-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-color: #3b82f6;
        }
        
        /* ===== TOKEN DISPLAY ===== */
        .token-display {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #3b82f6;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            color: #cbd5e1;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Modal de Configuraci√≥n API -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-logo">
                    <i class="fas fa-bus"></i>
                </div>
                <div class="modal-title">API Transporte Buenos Aires</div>
                <div class="modal-subtitle">Configura tu acceso a la API oficial</div>
            </div>
            
            <form id="apiConfigForm">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-user-circle"></i>
                        Client ID
                    </label>
                    <input type="text" 
                           class="form-input" 
                           id="clientId" 
                           placeholder="Ingresa tu Client ID"
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-key"></i>
                        Client Secret
                    </label>
                    <input type="password" 
                           class="form-input" 
                           id="clientSecret" 
                           placeholder="Ingresa tu Client Secret"
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-link"></i>
                        Endpoint de Autenticaci√≥n
                    </label>
                    <input type="text" 
                           class="form-input" 
                           id="authEndpoint" 
                           value="https://apitransporte.buenosaires.gob.ar/auth/token"
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-sync-alt"></i>
                        Intervalo de Actualizaci√≥n
                    </label>
                    <select class="form-input" id="updateInterval">
                        <option value="30000">30 segundos</option>
                        <option value="60000" selected>1 minuto</option>
                        <option value="300000">5 minutos</option>
                        <option value="600000">10 minutos</option>
                    </select>
                </div>
                
                <button type="submit" class="form-button" id="saveApiButton">
                    <span id="saveApiButtonText">GUARDAR CONFIGURACI√ìN</span>
                    <div class="spinner" id="saveApiSpinner" style="display: none;"></div>
                </button>
            </form>
            
            <div class="message" id="apiMessage"></div>
            
            <div class="token-display" id="tokenDisplay" style="display: none;">
                <strong>Token obtenido:</strong>
                <div id="tokenValue"></div>
                <div class="config-actions">
                    <button class="config-btn" onclick="copyTokenToClipboard()">
                        <i class="fas fa-copy"></i> Copiar Token
                    </button>
                    <button class="config-btn" onclick="testApiConnection()">
                        <i class="fas fa-plug"></i> Probar Conexi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Datos en Tiempo Real -->
    <div class="modal" id="dataModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-logo">
                    <i class="fas fa-database"></i>
                </div>
                <div class="modal-title">Datos en Tiempo Real</div>
                <div class="modal-subtitle">Informaci√≥n obtenida de la API</div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="config-btn" onclick="showDataTab('buses')">
                        <i class="fas fa-bus"></i> Colectivos
                    </button>
                    <button class="config-btn" onclick="showDataTab('trains')">
                        <i class="fas fa-train"></i> Trenes
                    </button>
                    <button class="config-btn" onclick="showDataTab('stations')">
                        <i class="fas fa-map-marker-alt"></i> Estaciones
                    </button>
                </div>
                
                <div id="dataTabContent">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>L√≠nea</th>
                                <th>ID</th>
                                <th>Velocidad</th>
                                <th>√öltima Actualizaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #94a3b8;">
                                    Selecciona una categor√≠a para ver datos
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="config-actions">
                <button class="config-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
                <button class="config-btn" onclick="closeDataModal()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Indicador de Velocidad -->
    <div class="speed-floating" id="speedFloating">
        <div class="speed-label">
            <i class="fas fa-tachometer-alt"></i>
            VELOCIDAD
        </div>
        <div class="speed-value" id="speedValue">0.0 km/h</div>
        <div class="speed-direction">
            <span id="directionArrow">‚Üí</span>
            <span id="directionText">NORTE</span>
        </div>
    </div>
    
    <!-- Notificaci√≥n de Grabaci√≥n -->
    <div class="recording-notification" id="recordingNotification">
        <i class="fas fa-circle"></i>
        <span>GRABANDO ACTIVO</span>
        <span id="recordingTime">00:00</span>
    </div>
    
    <!-- Solapas -->
    <div class="tab-container left">
        <button class="tab-button active" onclick="togglePanel('status')" title="Estado del Sistema">
            <i class="fas fa-chart-line"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('lines')" title="L√≠neas">
            <i class="fas fa-route"></i>
        </button>
        <button class="tab-button" onclick="openApiModal()" title="Configurar API">
            <i class="fas fa-database"></i>
        </button>
    </div>
    
    <div class="tab-container right">
        <button class="tab-button" onclick="togglePanel('stations')" title="Estaciones">
            <i class="fas fa-map-marker-alt"></i>
        </button>
        <button class="tab-button" onclick="openDataModal()" title="Datos API">
            <i class="fas fa-table"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('info')" title="Informaci√≥n">
            <i class="fas fa-info-circle"></i>
        </button>
    </div>
    
    <div class="tab-container bottom">
        <button class="tab-button" onclick="togglePanel('controls')" title="Controles">
            <i class="fas fa-sliders-h"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('reports')" title="Reportes">
            <i class="fas fa-file-alt"></i>
        </button>
    </div>
    
    <!-- Paneles -->
    <!-- Panel de Estado -->
    <div class="tab-panel left active" id="panelStatus">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-chart-line"></i>
                ESTADO DEL SISTEMA
            </div>
            <button class="minimize-btn" onclick="togglePanel('status')">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="status-grid">
                <div class="status-item gps">
                    <div class="status-label">
                        <i class="fas fa-satellite"></i>
                        GPS
                    </div>
                    <div class="status-value" id="gpsStatusValue">ACTIVO</div>
                    <div class="status-subvalue" id="gpsAccuracy">Precisi√≥n: 10m</div>
                </div>
                
                <div class="status-item recording">
                    <div class="status-label">
                        <i class="fas fa-record-vinyl"></i>
                        GRABACI√ìN
                    </div>
                    <div class="status-value" id="recordingStatus">INACTIVA</div>
                    <div class="status-subvalue" id="recordingDuration">00:00:00</div>
                </div>
                
                <div class="status-item audit">
                    <div class="status-label">
                        <i class="fas fa-clipboard-check"></i>
                        AUDITOR√çA
                    </div>
                    <div class="status-value" id="auditStatus">ACTIVA</div>
                    <div class="status-subvalue" id="auditIncidents">0 incidencias</div>
                </div>
                
                <div class="status-item network">
                    <div class="status-label">
                        <i class="fas fa-wifi"></i>
                        CONEXI√ìN
                    </div>
                    <div class="status-value" id="networkStatus">ONLINE</div>
                    <div class="status-subvalue" id="networkLatency">Latencia: 50ms</div>
                </div>
                
                <div class="status-item api">
                    <div class="status-label">
                        <i class="fas fa-database"></i>
                        API CABA
                    </div>
                    <div class="status-value" id="apiStatusValue">NO CONFIGURADA</div>
                    <div class="status-subvalue" id="apiEndpointValue">--</div>
                </div>
                
                <div class="status-item" style="border-left-color: #ec4899;">
                    <div class="status-label">
                        <i class="fas fa-bus"></i>
                        VEH√çCULOS ACTIVOS
                    </div>
                    <div class="status-value" id="vehiclesCount">0</div>
                    <div class="status-subvalue" id="lastUpdate">√öltima: --:--</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="status-label" style="margin-bottom: 10px;">
                    <i class="fas fa-history"></i>
                    √öLTIMOS EVENTOS
                </div>
                <div id="recentEvents" style="max-height: 150px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <!-- Panel de L√≠neas -->
    <div class="tab-panel left" id="panelLines">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-route"></i>
                L√çNEAS DE TRANSPORTE
            </div>
            <button class="minimize-btn" onclick="togglePanel('lines')">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="stations-list" id="linesList">
                <!-- L√≠neas se cargar√°n din√°micamente -->
            </div>
        </div>
    </div>
    
    <!-- Panel de Estaciones -->
    <div class="tab-panel right" id="panelStations">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-map-marker-alt"></i>
                ESTACIONES CERCANAS
            </div>
            <button class="minimize-btn" onclick="togglePanel('stations')">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="stations-list" id="stationsList">
                <!-- Estaciones se cargar√°n din√°micamente -->
            </div>
        </div>
    </div>
    
    <!-- Panel de Informaci√≥n -->
    <div class="tab-panel right" id="panelInfo">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-info-circle"></i>
                INFORMACI√ìN DEL SISTEMA
            </div>
            <button class="minimize-btn" onclick="togglePanel('info')">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="panel-content">
            <div style="padding: 10px;">
                <div class="status-label" style="margin-bottom: 10px;">
                    <i class="fas fa-copyright"></i>
                    SISTEMA DE AUDITOR√çA GPS
                </div>
                <div style="color: #94a3b8; font-size: 13px; line-height: 1.5; margin-bottom: 15px;">
                    Versi√≥n 2.0.0<br>
                    Conectado a API Transporte BA
                </div>
                
                <div class="status-label" style="margin-bottom: 10px;">
                    <i class="fas fa-code"></i>
                    DESARROLLADO CON
                </div>
                <div style="color: #94a3b8; font-size: 13px; margin-bottom: 15px;">
                    ‚Ä¢ Leaflet.js - Mapeo<br>
                    ‚Ä¢ API Transporte Buenos Aires<br>
                    ‚Ä¢ Geolocalizaci√≥n HTML5
                </div>
                
                <div class="status-label" style="margin-bottom: 10px;">
                    <i class="fas fa-shield-alt"></i>
                    SEGURIDAD
                </div>
                <div style="color: #94a3b8; font-size: 13px; margin-bottom: 15px;">
                    ‚Ä¢ Tokens OAuth 2.0<br>
                    ‚Ä¢ Cifrado localStorage<br>
                    ‚Ä¢ Sin tracking de usuarios
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="config-btn" onclick="exportAllData()">
                        <i class="fas fa-download"></i> Exportar Datos
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de Controles -->
    <div class="tab-panel bottom" id="panelControls">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-sliders-h"></i>
                CONTROLES DE AUDITOR√çA
            </div>
            <button class="minimize-btn" onclick="togglePanel('controls')">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="controls-grid">
                <button class="control-button primary" onclick="toggleRecording()" id="recordingButton">
                    <div class="control-icon">
                        <i class="fas fa-circle" id="recordingIcon"></i>
                    </div>
                    <div class="control-label" id="recordingLabel">INICIAR GRABACI√ìN</div>
                </button>
                
                <button class="control-button" onclick="centerOnUser()">
                    <div class="control-icon">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                    <div class="control-label">CENTRAR MAPA</div>
                </button>
                
                <button class="control-button success" onclick="fetchTransportData()" id="fetchDataButton">
                    <div class="control-icon">
                        <i class="fas fa-bus" id="fetchDataIcon"></i>
                    </div>
                    <div class="control-label" id="fetchDataLabel">OBTENER DATOS API</div>
                </button>
                
                <button class="control-button warning" onclick="startAutoRefresh()" id="autoRefreshButton">
                    <div class="control-icon">
                        <i class="fas fa-sync-alt" id="autoRefreshIcon"></i>
                    </div>
                    <div class="control-label" id="autoRefreshLabel">AUTO-REFRESH: OFF</div>
                </button>
                
                <button class="control-button" onclick="generateReport()">
                    <div class="control-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <div class="control-label">GENERAR INFORME</div>
                </button>
                
                <button class="control-button" onclick="toggleBackgroundMode()" id="backgroundButton">
                    <div class="control-icon">
                        <i class="fas fa-mobile-alt" id="backgroundIcon"></i>
                    </div>
                    <div class="control-label" id="backgroundLabel">SEGUNDO PLANO: OFF</div>
                </button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN API TRANSPORTE BUENOS AIRES
        // ============================================
        const CABA_API = {
            AUTH_ENDPOINT: "https://apitransporte.buenosaires.gob.ar/auth/token",
            BASE_URL: "https://apitransporte.buenosaires.gob.ar/",
            ENDPOINTS: {
                // Colectivos
                BUSES_POSITIONS: "colectivos/vehiclePositionsSimple",
                BUS_LINES: "colectivos/lineas",
                BUS_ROUTES: "colectivos/recorridos",
                
                // Trenes
                TRAIN_LINES: "trenes/lineas",
                TRAIN_STATIONS: "trenes/estaciones",
                TRAIN_POSITIONS: "trenes/vehiclePositionsSimple",
                
                // Subtes
                SUBTE_LINES: "subtes/lineas",
                SUBTE_STATIONS: "subtes/estaciones",
                
                // Bicicletas
                BICIS_STATIONS: "ecobici/estaciones"
            }
        };
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map = null;
        let userMarker = null;
        let routePolyline = null;
        let busMarkers = [];
        let trainMarkers = [];
        let stationMarkers = [];
        
        // Estado del sistema
        let currentLine = null;
        let isRecording = false;
        let isBackgroundMode = false;
        let isAutoRefresh = false;
        let activePanel = 'status';
        
        // Datos GPS
        let currentPosition = null;
        let currentSpeed = 0;
        let currentBearing = 0;
        let currentAccuracy = 0;
        
        // Grabaci√≥n
        let recordingStartTime = null;
        let recordingTimer = null;
        let recordingDuration = 0;
        let recordingData = [];
        
        // API Transporte BA
        let apiConfig = {
            clientId: '',
            clientSecret: '',
            accessToken: '',
            tokenExpiry: null,
            refreshInterval: 60000,
            connected: false
        };
        
        // Datos en tiempo real
        let realTimeData = {
            buses: [],
            trains: [],
            stations: [],
            lastUpdate: null
        };
        
        // Timers
        let dataRefreshTimer = null;
        
        // Base de datos de l√≠neas (para referencia)
        const TRANSPORT_LINES = {
            buses: [
                {id: '1', name: 'L√≠nea 1', color: '#3b82f6'},
                {id: '2', name: 'L√≠nea 2', color: '#10b981'},
                {id: '4', name: 'L√≠nea 4', color: '#8b5cf6'},
                {id: '5', name: 'L√≠nea 5', color: '#f59e0b'},
                {id: '6', name: 'L√≠nea 6', color: '#ef4444'},
                {id: '7', name: 'L√≠nea 7', color: '#ec4899'},
                {id: '8', name: 'L√≠nea 8', color: '#06b6d4'},
                {id: '9', name: 'L√≠nea 9', color: '#84cc16'},
                {id: '10', name: 'L√≠nea 10', color: '#f97316'}
            ],
            trains: [
                {id: 'sarmiento', name: 'Sarmiento', color: '#ef4444'},
                {id: 'mitre', name: 'Mitre', color: '#3b82f6'},
                {id: 'roca', name: 'Roca', color: '#10b981'},
                {id: 'san_martin', name: 'San Mart√≠n', color: '#8b5cf6'},
                {id: 'urquiza', name: 'Urquiza', color: '#f59e0b'},
                {id: 'belgrano', name: 'Belgrano', color: '#ec4899'}
            ]
        };
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadApiConfig();
            
            // Configurar paneles iniciales
            showPanel('status');
            
            // Iniciar GPS
            setTimeout(() => startGPS(), 1000);
            
            // Cargar l√≠neas en panel
            updateLinesPanel();
            
            // Actualizar estaciones
            updateStationsPanel();
            
            addEvent('Sistema de Auditor√≠a GPS inicializado', 'success');
            console.log('üöÄ Sistema conectado a API Transporte Buenos Aires');
        });
        
        // ============================================
        // SISTEMA DE MAPA
        // ============================================
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true
            });
            
            // Mapa oscuro profesional
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CARTO',
                maxZoom: 19,
                minZoom: 10
            }).addTo(map);
            
            // Vista inicial de Buenos Aires
            map.setView([-34.6037, -58.3816], 13);
            
            // Agregar controles personalizados
            addMapControls();
        }
        
        function addMapControls() {
            // Control de zoom personalizado
            L.control.zoom({
                position: 'topright',
                zoomInTitle: 'Acercar',
                zoomOutTitle: 'Alejar'
            }).addTo(map);
        }
        
        // ============================================
        // CONFIGURACI√ìN API TRANSPORTE BA
        // ============================================
        function loadApiConfig() {
            const savedConfig = localStorage.getItem('caba_api_config');
            if (savedConfig) {
                try {
                    apiConfig = JSON.parse(savedConfig);
                    
                    // Verificar si el token sigue vigente
                    if (apiConfig.tokenExpiry && Date.now() < apiConfig.tokenExpiry) {
                        updateApiStatus('connected');
                        addEvent('Configuraci√≥n API cargada desde almacenamiento local', 'success');
                    } else {
                        updateApiStatus('expired');
                        addEvent('Token API expirado, requiere renovaci√≥n', 'warning');
                    }
                } catch (e) {
                    console.error('Error cargando configuraci√≥n:', e);
                    updateApiStatus('disconnected');
                }
            } else {
                updateApiStatus('disconnected');
            }
        }
        
        function saveApiConfig() {
            localStorage.setItem('caba_api_config', JSON.stringify(apiConfig));
        }
        
        async function authenticateAPI(event) {
            if (event) event.preventDefault();
            
            const clientId = document.getElementById('clientId').value.trim();
            const clientSecret = document.getElementById('clientSecret').value.trim();
            const authEndpoint = document.getElementById('authEndpoint').value.trim();
            const updateInterval = parseInt(document.getElementById('updateInterval').value);
            
            if (!clientId || !clientSecret) {
                showApiMessage('Por favor, completa todos los campos', 'error');
                return;
            }
            
            const button = document.getElementById('saveApiButton');
            const buttonText = document.getElementById('saveApiButtonText');
            const spinner = document.getElementById('saveApiSpinner');
            
            button.disabled = true;
            buttonText.textContent = 'AUTENTICANDO...';
            spinner.style.display = 'inline-block';
            
            try {
                // Preparar datos para autenticaci√≥n OAuth 2.0
                const formData = new URLSearchParams();
                formData.append('grant_type', 'client_credentials');
                formData.append('client_id', clientId);
                formData.append('client_secret', clientSecret);
                formData.append('scope', 'transport');
                
                const response = await fetch(authEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: formData.toString()
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error_description || `Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Guardar configuraci√≥n
                apiConfig.clientId = clientId;
                apiConfig.clientSecret = clientSecret;
                apiConfig.accessToken = data.access_token;
                apiConfig.refreshInterval = updateInterval;
                
                // Calcular expiraci√≥n (normalmente 1 hora = 3600 segundos)
                const expiresIn = data.expires_in || 3600;
                apiConfig.tokenExpiry = Date.now() + (expiresIn * 1000);
                apiConfig.connected = true;
                
                saveApiConfig();
                updateApiStatus('connected');
                
                // Mostrar token
                showTokenDisplay(data.access_token);
                showApiMessage('¬°Autenticaci√≥n exitosa! Conectado a API Transporte BA', 'success');
                addEvent('Autenticaci√≥n API Transporte BA exitosa', 'success');
                
                // Cerrar modal despu√©s de 2 segundos
                setTimeout(() => {
                    closeApiModal();
                }, 2000);
                
            } catch (error) {
                console.error('Error en autenticaci√≥n:', error);
                showApiMessage(`Error: ${error.message}`, 'error');
                addEvent(`Error de autenticaci√≥n: ${error.message}`, 'error');
                updateApiStatus('disconnected');
            } finally {
                button.disabled = false;
                buttonText.textContent = 'GUARDAR CONFIGURACI√ìN';
                spinner.style.display = 'none';
            }
        }
        
        async function testApiConnection() {
            if (!apiConfig.accessToken) {
                showApiMessage('Primero debes configurar la API', 'error');
                return;
            }
            
            try {
                // Probar conexi√≥n con un endpoint simple
                const response = await fetch(`${CABA_API.BASE_URL}${CABA_API.ENDPOINTS.BUS_LINES}?client_id=${apiConfig.clientId}`, {
                    headers: {
                        'Authorization': `Bearer ${apiConfig.accessToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showApiMessage('¬°Conexi√≥n exitosa! La API est√° respondiendo correctamente', 'success');
                    addEvent('Prueba de conexi√≥n API exitosa', 'success');
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showApiMessage(`Error de conexi√≥n: ${error.message}`, 'error');
                addEvent(`Error en prueba de conexi√≥n: ${error.message}`, 'error');
            }
        }
        
        function updateApiStatus(status) {
            const element = document.getElementById('apiStatusValue');
            const endpointElement = document.getElementById('apiEndpointValue');
            
            switch(status) {
                case 'connected':
                    element.textContent = 'CONECTADO';
                    element.style.color = '#10b981';
                    endpointElement.textContent = `Client ID: ${apiConfig.clientId.substring(0, 8)}...`;
                    apiConfig.connected = true;
                    break;
                    
                case 'disconnected':
                    element.textContent = 'NO CONFIGURADA';
                    element.style.color = '#ef4444';
                    endpointElement.textContent = '--';
                    apiConfig.connected = false;
                    break;
                    
                case 'expired':
                    element.textContent = 'TOKEN EXPIRADO';
                    element.style.color = '#f59e0b';
                    endpointElement.textContent = 'Renovar configuraci√≥n';
                    apiConfig.connected = false;
                    break;
            }
        }
        
        // ============================================
        // OBTENCI√ìN DE DATOS EN TIEMPO REAL
        // ============================================
        async function fetchTransportData() {
            if (!apiConfig.connected || !apiConfig.accessToken) {
                showApiMessage('Configura primero la API de Transporte BA', 'error');
                openApiModal();
                return;
            }
            
            // Verificar si el token est√° expirado
            if (Date.now() >= apiConfig.tokenExpiry) {
                showApiMessage('El token ha expirado. Renueva la autenticaci√≥n', 'error');
                updateApiStatus('expired');
                openApiModal();
                return;
            }
            
            const button = document.getElementById('fetchDataButton');
            const icon = document.getElementById('fetchDataIcon');
            const label = document.getElementById('fetchDataLabel');
            
            button.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';
            label.textContent = 'OBTENIENDO...';
            
            try {
                addEvent('Solicitando datos de transporte en tiempo real...', 'info');
                
                // Obtener datos de colectivos
                const busesResponse = await fetch(
                    `${CABA_API.BASE_URL}${CABA_API.ENDPOINTS.BUSES_POSITIONS}?client_id=${apiConfig.clientId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${apiConfig.accessToken}`,
                            'Accept': 'application/json'
                        }
                    }
                );
                
                if (!busesResponse.ok) {
                    throw new Error(`Error en buses: ${busesResponse.status}`);
                }
                
                const busesData = await busesResponse.json();
                realTimeData.buses = Array.isArray(busesData) ? busesData : [];
                
                // Limpiar marcadores anteriores
                clearMapMarkers();
                
                // Procesar y mostrar datos
                processBusesData(realTimeData.buses);
                
                // Actualizar UI
                const totalVehicles = realTimeData.buses.length;
                document.getElementById('vehiclesCount').textContent = totalVehicles;
                document.getElementById('lastUpdate').textContent = 
                    `√öltima: ${new Date().toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'})}`;
                
                realTimeData.lastUpdate = new Date();
                
                addEvent(`Datos obtenidos: ${totalVehicles} veh√≠culos en tiempo real`, 'success');
                
                // Actualizar tabla de datos
                updateDataTable('buses');
                
            } catch (error) {
                console.error('Error obteniendo datos:', error);
                addEvent(`Error al obtener datos: ${error.message}`, 'error');
                showApiMessage('Error al conectar con la API. Verifica tu conexi√≥n.', 'error');
                
                // Fallback a datos de demostraci√≥n
                useDemoData();
            } finally {
                button.disabled = false;
                icon.className = 'fas fa-bus';
                label.textContent = 'OBTENER DATOS API';
            }
        }
        
        function processBusesData(buses) {
            if (!buses || !Array.isArray(buses)) return;
            
            buses.forEach(bus => {
                if (!bus.latitude || !bus.longitude) return;
                
                // Determinar color seg√∫n la l√≠nea
                const lineColor = getLineColor(bus.linea || bus.route_id);
                
                // Crear marcador personalizado
                const icon = L.divIcon({
                    className: 'bus-marker',
                    html: `
                        <div style="
                            background: ${lineColor};
                            width: 16px;
                            height: 16px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 0 10px ${lineColor}80;
                            position: relative;
                        ">
                            <div style="
                                position: absolute;
                                top: -8px;
                                left: 50%;
                                transform: translateX(-50%);
                                background: ${lineColor};
                                color: white;
                                font-size: 9px;
                                font-weight: bold;
                                padding: 1px 3px;
                                border-radius: 3px;
                                white-space: nowrap;
                            ">
                                ${bus.linea || bus.route_id || '?'}
                            </div>
                        </div>
                    `,
                    iconSize: [24, 32],
                    iconAnchor: [12, 16]
                });
                
                // Crear marcador en el mapa
                const marker = L.marker([bus.latitude, bus.longitude], { icon });
                
                // Informaci√≥n para el tooltip
                const speed = bus.velocity ? `${bus.velocity} km/h` : 'N/A';
                const direction = bus.direction ? `${bus.direction}¬∞` : 'N/A';
                
                marker.bindTooltip(`
                    <div style="font-size: 12px; max-width: 200px;">
                        <strong>L√≠nea ${bus.linea || bus.route_id || 'N/A'}</strong><br>
                        ID: ${bus.id || bus.vehicle_id || 'N/A'}<br>
                        Velocidad: ${speed}<br>
                        Direcci√≥n: ${direction}<br>
                        ${bus.timestamp ? `Actualizado: ${new Date(bus.timestamp).toLocaleTimeString()}` : ''}
                    </div>
                `);
                
                marker.addTo(map);
                busMarkers.push(marker);
            });
        }
        
        function getLineColor(lineId) {
            if (!lineId) return '#3b82f6';
            
            // Buscar en buses
            const busLine = TRANSPORT_LINES.buses.find(b => b.id === lineId.toString());
            if (busLine) return busLine.color;
            
            // Buscar en trenes
            const trainLine = TRANSPORT_LINES.trains.find(t => t.id === lineId.toString());
            if (trainLine) return trainLine.color;
            
            // Color por defecto basado en hash del ID
            const hash = Array.from(lineId.toString()).reduce((acc, char) => {
                return char.charCodeAt(0) + ((acc << 5) - acc);
            }, 0);
            
            const colors = [
                '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', 
                '#ef4444', '#ec4899', '#06b6d4', '#84cc16'
            ];
            
            return colors[Math.abs(hash) % colors.length];
        }
        
        function clearMapMarkers() {
            // Limpiar buses
            busMarkers.forEach(marker => map.removeLayer(marker));
            busMarkers = [];
            
            // Limpiar trenes
            trainMarkers.forEach(marker => map.removeLayer(marker));
            trainMarkers = [];
            
            // Limpiar estaciones
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers = [];
        }
        
        function useDemoData() {
            // Datos de demostraci√≥n para cuando la API no est√° disponible
            const demoBuses = [
                {
                    id: 'bus-demo-1',
                    linea: '1',
                    latitude: -34.6037 + (Math.random() - 0.5) * 0.05,
                    longitude: -58.3816 + (Math.random() - 0.5) * 0.05,
                    velocity: Math.floor(Math.random() * 50),
                    direction: Math.floor(Math.random() * 360),
                    timestamp: new Date().toISOString()
                },
                {
                    id: 'bus-demo-2',
                    linea: '2',
                    latitude: -34.6085 + (Math.random() - 0.5) * 0.05,
                    longitude: -58.4063 + (Math.random() - 0.5) * 0.05,
                    velocity: Math.floor(Math.random() * 50),
                    direction: Math.floor(Math.random() * 360),
                    timestamp: new Date().toISOString()
                },
                {
                    id: 'bus-demo-3',
                    linea: '4',
                    latitude: -34.6185 + (Math.random() - 0.5) * 0.05,
                    longitude: -58.4416 + (Math.random() - 0.5) * 0.05,
                    velocity: Math.floor(Math.random() * 50),
                    direction: Math.floor(Math.random() * 360),
                    timestamp: new Date().toISOString()
                }
            ];
            
            realTimeData.buses = demoBuses;
            processBusesData(demoBuses);
            
            document.getElementById('vehiclesCount').textContent = demoBuses.length;
            document.getElementById('lastUpdate').textContent = 
                `√öltima: ${new Date().toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'})} (DEMO)`;
            
            addEvent('Usando datos de demostraci√≥n', 'warning');
        }
        
        // ============================================
        // SISTEMA GPS Y GRABACI√ìN
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                alert("Tu dispositivo no soporta GPS");
                return;
            }
            
            updateGPSStatus('searching');
            
            navigator.geolocation.watchPosition(
                position => handleGPSPosition(position),
                error => handleGPSError(error),
                {
                    enableHighAccuracy: true,
                    maximumAge: 2000,
                    timeout: 10000
                }
            );
        }
        
        function handleGPSPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed;
            const heading = position.coords.heading;
            
            currentPosition = { lat, lng };
            currentAccuracy = accuracy;
            
            if (speed !== null && speed >= 0) {
                currentSpeed = speed * 3.6; // Convertir m/s a km/h
            }
            
            if (heading !== null && heading >= 0) {
                currentBearing = heading;
            }
            
            updateGPSStatus('active');
            updateSpeedDisplay();
            updateDirectionDisplay();
            updateUserPosition(lat, lng);
            
            if (isRecording) {
                recordPosition(lat, lng, speed);
            }
            
            // Actualizar estaciones cercanas
            updateNearbyStations();
        }
        
        function updateUserPosition(lat, lng) {
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: `
                            <div style="
                                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                width: 24px;
                                height: 24px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 0 15px rgba(59, 130, 246, 0.9);
                                position: relative;
                            ">
                                <div style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    width: 8px;
                                    height: 8px;
                                    background: white;
                                    border-radius: 50%;
                                "></div>
                            </div>
                        `,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
            
            updateRoute(lat, lng);
        }
        
        function updateRoute(lat, lng) {
            if (!routePolyline) {
                routePolyline = L.polyline([[lat, lng]], {
                    color: '#3b82f6',
                    weight: 4,
                    opacity: 0.7,
                    lineJoin: 'round'
                }).addTo(map);
            } else {
                const currentPath = routePolyline.getLatLngs();
                currentPath.push([lat, lng]);
                
                // Limitar a 500 puntos para rendimiento
                if (currentPath.length > 500) {
                    currentPath.shift();
                }
                
                routePolyline.setLatLngs(currentPath);
            }
        }
        
        function toggleRecording() {
            if (!currentPosition) {
                alert("Esperando se√±al GPS...");
                return;
            }
            
            isRecording = !isRecording;
            
            const button = document.getElementById('recordingButton');
            const icon = document.getElementById('recordingIcon');
            const label = document.getElementById('recordingLabel');
            const status = document.getElementById('recordingStatus');
            
            if (isRecording) {
                recordingStartTime = Date.now();
                recordingDuration = 0;
                recordingData = [];
                
                button.classList.add('danger');
                icon.className = 'fas fa-square';
                label.textContent = 'DETENER GRABACI√ìN';
                status.textContent = 'ACTIVA';
                
                recordingTimer = setInterval(updateRecordingDisplay, 1000);
                
                if (document.hidden) {
                    document.getElementById('recordingNotification').classList.add('active');
                }
                
                addEvent('GRABACI√ìN DE AUDITOR√çA INICIADA', 'success');
            } else {
                button.classList.remove('danger');
                icon.className = 'fas fa-circle';
                label.textContent = 'INICIAR GRABACI√ìN';
                status.textContent = 'INACTIVA';
                
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                document.getElementById('recordingNotification').classList.remove('active');
                
                addEvent('GRABACI√ìN DETENIDA - Datos guardados', 'info');
                saveRecordingData();
            }
        }
        
        function recordPosition(lat, lng, speed) {
            const dataPoint = {
                timestamp: Date.now(),
                lat: lat,
                lng: lng,
                speed: currentSpeed,
                accuracy: currentAccuracy,
                bearing: currentBearing,
                line: currentLine,
                apiData: realTimeData.buses.length > 0 ? {
                    busesCount: realTimeData.buses.length,
                    lastUpdate: realTimeData.lastUpdate
                } : null
            };
            
            recordingData.push(dataPoint);
        }
        
        function updateRecordingDisplay() {
            if (!isRecording) return;
            
            recordingDuration = Date.now() - recordingStartTime;
            
            const hours = Math.floor(recordingDuration / 3600000);
            const minutes = Math.floor((recordingDuration % 3600000) / 60000);
            const seconds = Math.floor((recordingDuration % 60000) / 1000);
            
            const timeString = 
                hours.toString().padStart(2, '0') + ':' +
                minutes.toString().padStart(2, '0') + ':' +
                seconds.toString().padStart(2, '0');
            
            document.getElementById('recordingDuration').textContent = timeString;
            document.getElementById('recordingTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function saveRecordingData() {
            const recordingSession = {
                startTime: recordingStartTime,
                endTime: Date.now(),
                duration: recordingDuration,
                data: recordingData,
                line: currentLine,
                apiConnected: apiConfig.connected,
                apiData: realTimeData,
                totalPoints: recordingData.length
            };
            
            // Guardar en localStorage
            localStorage.setItem('lastRecording', JSON.stringify(recordingSession));
            
            // Agregar al historial
            const history = JSON.parse(localStorage.getItem('recordingHistory') || '[]');
            history.push({
                id: Date.now(),
                date: new Date().toLocaleString(),
                duration: recordingDuration,
                points: recordingData.length,
                line: currentLine
            });
            
            // Mantener solo las √∫ltimas 20 grabaciones
            localStorage.setItem('recordingHistory', JSON.stringify(history.slice(-20)));
            
            console.log('üíæ Grabaci√≥n guardada:', recordingData.length, 'puntos');
        }
        
        // ============================================
        // INTERFAZ DE USUARIO
        // ============================================
        function togglePanel(panelId) {
            if (activePanel === panelId) {
                document.getElementById('panel' + capitalizeFirstLetter(activePanel)).classList.remove('active');
                document.querySelector(`[onclick="togglePanel('${activePanel}')"]`).classList.remove('active');
                activePanel = null;
                return;
            }
            
            if (activePanel) {
                document.getElementById('panel' + capitalizeFirstLetter(activePanel)).classList.remove('active');
                document.querySelector(`[onclick="togglePanel('${activePanel}')"]`).classList.remove('active');
            }
            
            showPanel(panelId);
        }
        
        function showPanel(panelId) {
            activePanel = panelId;
            document.getElementById('panel' + capitalizeFirstLetter(panelId)).classList.add('active');
            document.querySelector(`[onclick="togglePanel('${panelId}')"]`).classList.add('active');
        }
        
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        function updateGPSStatus(status) {
            const element = document.getElementById('gpsStatusValue');
            const accuracyElement = document.getElementById('gpsAccuracy');
            
            switch(status) {
                case 'searching':
                    element.textContent = 'BUSCANDO';
                    element.style.color = '#f59e0b';
                    accuracyElement.textContent = 'Buscando se√±al...';
                    break;
                case 'active':
                    element.textContent = 'ACTIVO';
                    element.style.color = '#10b981';
                    accuracyElement.textContent = `Precisi√≥n: ${Math.round(currentAccuracy)}m`;
                    break;
                case 'error':
                    element.textContent = 'ERROR';
                    element.style.color = '#ef4444';
                    accuracyElement.textContent = 'Error de conexi√≥n';
                    break;
            }
        }
        
        function updateSpeedDisplay() {
            const speedElement = document.getElementById('speedValue');
            speedElement.textContent = currentSpeed.toFixed(1) + ' km/h';
            
            speedElement.className = 'speed-value';
            if (currentSpeed < 1) {
                speedElement.textContent = '0.0 km/h';
                speedElement.classList.add('low');
            } else if (currentSpeed < 20) {
                speedElement.classList.add('low');
            } else if (currentSpeed > 60) {
                speedElement.classList.add('high');
            }
        }
        
        function updateDirectionDisplay() {
            const arrow = document.getElementById('directionArrow');
            const text = document.getElementById('directionText');
            
            if (currentSpeed < 1) {
                arrow.textContent = '‚óè';
                text.textContent = 'DETENIDO';
                arrow.style.transform = 'rotate(0deg)';
                return;
            }
            
            let direction = 'NORTE';
            let arrowChar = '‚Üë';
            
            if (currentBearing >= 337.5 || currentBearing < 22.5) {
                direction = 'NORTE'; arrowChar = '‚Üë';
            } else if (currentBearing >= 22.5 && currentBearing < 67.5) {
                direction = 'NORESTE'; arrowChar = '‚Üó';
            } else if (currentBearing >= 67.5 && currentBearing < 112.5) {
                direction = 'ESTE'; arrowChar = '‚Üí';
            } else if (currentBearing >= 112.5 && currentBearing < 157.5) {
                direction = 'SURESTE'; arrowChar = '‚Üò';
            } else if (currentBearing >= 157.5 && currentBearing < 202.5) {
                direction = 'SUR'; arrowChar = '‚Üì';
            } else if (currentBearing >= 202.5 && currentBearing < 247.5) {
                direction = 'SUROESTE'; arrowChar = '‚Üô';
            } else if (currentBearing >= 247.5 && currentBearing < 292.5) {
                direction = 'OESTE'; arrowChar = '‚Üê';
            } else if (currentBearing >= 292.5 && currentBearing < 337.5) {
                direction = 'NOROESTE'; arrowChar = '‚Üñ';
            }
            
            arrow.textContent = arrowChar;
            text.textContent = direction;
            arrow.style.transform = `rotate(${currentBearing}deg)`;
        }
        
        function addEvent(message, type = 'info') {
            const eventsList = document.getElementById('recentEvents');
            const time = new Date().toLocaleTimeString('es-AR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'error') icon = '‚ùå';
            
            const eventDiv = document.createElement('div');
            eventDiv.style.cssText = `
                padding: 8px 12px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                margin-bottom: 8px;
                font-size: 12px;
                border-left: 3px solid ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            
            eventDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <span>${icon}</span>
                        <span>${message}</span>
                    </span>
                    <span style="color: #64748b; font-size: 11px;">${time}</span>
                </div>
            `;
            
            eventsList.insertBefore(eventDiv, eventsList.firstChild);
            
            // Limitar a 10 eventos
            if (eventsList.children.length > 10) {
                eventsList.removeChild(eventsList.lastChild);
            }
        }
        
        function updateLinesPanel() {
            const linesList = document.getElementById('linesList');
            linesList.innerHTML = '';
            
            // Agregar l√≠neas de buses
            TRANSPORT_LINES.buses.forEach(line => {
                const lineCard = createTransportCard(line, 'bus');
                linesList.appendChild(lineCard);
            });
            
            // Agregar l√≠neas de trenes
            TRANSPORT_LINES.trains.forEach(line => {
                const lineCard = createTransportCard(line, 'train');
                linesList.appendChild(lineCard);
            });
        }
        
        function createTransportCard(line, type) {
            const div = document.createElement('div');
            div.className = 'station-card';
            div.onclick = () => selectLine(line.id);
            
            const icon = type === 'bus' ? 'fa-bus' : 'fa-train';
            const typeText = type === 'bus' ? 'COLECTIVO' : 'TREN';
            
            div.innerHTML = `
                <div class="station-header">
                    <div class="station-name">${line.name}</div>
                    <div class="station-order">${typeText}</div>
                </div>
                <div class="station-metrics">
                    <div class="station-metric">
                        <div class="metric-label">Estado</div>
                        <div class="metric-value" style="color:#10b981;">OPERATIVO</div>
                    </div>
                    <div class="station-metric">
                        <div class="metric-label">Color</div>
                        <div class="metric-value" style="color:${line.color}">‚óè</div>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        function updateNearbyStations() {
            if (!currentPosition) return;
            
            const stationsList = document.getElementById('stationsList');
            
            // Estaciones de referencia en Buenos Aires
            const referenceStations = [
                {name: 'Plaza de Mayo', lat: -34.6083, lng: -58.3712, type: 'SUBTE'},
                {name: 'Retiro', lat: -34.5911, lng: -58.3747, type: 'TREN'},
                {name: 'Constituci√≥n', lat: -34.6258, lng: -58.3803, type: 'TREN'},
                {name: 'Once', lat: -34.6085, lng: -58.4063, type: 'TREN'},
                {name: 'Caballito', lat: -34.6185, lng: -58.4416, type: 'TREN'},
                {name: 'Palermo', lat: -34.5792, lng: -58.4211, type: 'SUBTE'},
                {name: 'Belgrano', lat: -34.5622, lng: -58.4567, type: 'TREN'}
            ];
            
            // Calcular distancias
            const stationsWithDistance = referenceStations.map(station => {
                const distance = calculateDistance(
                    currentPosition.lat,
                    currentPosition.lng,
                    station.lat,
                    station.lng
                );
                return { ...station, distance };
            }).sort((a, b) => a.distance - b.distance);
            
            // Mostrar solo las 5 m√°s cercanas
            stationsList.innerHTML = '';
            stationsWithDistance.slice(0, 5).forEach((station, index) => {
                const etaMinutes = Math.round((station.distance / (currentSpeed > 5 ? currentSpeed / 3.6 : 10)) / 60);
                
                const div = document.createElement('div');
                div.className = `station-card ${index === 0 ? 'current' : ''}`;
                div.onclick = () => centerOnStation(station.lat, station.lng);
                
                div.innerHTML = `
                    <div class="station-header">
                        <div class="station-name">${station.name}</div>
                        <div class="station-order">${station.type}</div>
                    </div>
                    <div class="station-metrics">
                        <div class="station-metric">
                            <div class="metric-label">Distancia</div>
                            <div class="metric-value">${Math.round(station.distance)} m</div>
                        </div>
                        <div class="station-metric">
                            <div class="metric-label">ETA</div>
                            <div class="metric-value">${etaMinutes > 0 ? etaMinutes + ' min' : '<1 min'}</div>
                        </div>
                    </div>
                `;
                
                stationsList.appendChild(div);
            });
        }
        
        function updateDataTable(category = 'buses') {
            const tableBody = document.getElementById('dataTableBody');
            
            let data = [];
            let columns = [];
            
            switch(category) {
                case 'buses':
                    data = realTimeData.buses.slice(0, 20); // Mostrar m√°ximo 20
                    columns = [
                        { key: 'linea', label: 'L√≠nea' },
                        { key: 'id', label: 'ID' },
                        { key: 'velocity', label: 'Velocidad', formatter: v => v ? `${v} km/h` : 'N/A' },
                        { key: 'timestamp', label: '√öltima Actualizaci√≥n', formatter: v => v ? new Date(v).toLocaleTimeString() : 'N/A' }
                    ];
                    break;
                    
                default:
                    data = [];
                    columns = [];
            }
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${columns.length}" style="text-align: center; color: #94a3b8;">
                            No hay datos disponibles
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = data.map(item => `
                <tr>
                    ${columns.map(col => `
                        <td>${col.formatter ? col.formatter(item[col.key]) : (item[col.key] || 'N/A')}</td>
                    `).join('')}
                </tr>
            `).join('');
        }
        
        // ============================================
        // FUNCIONES DE CONTROL
        // ============================================
        function selectLine(lineId) {
            currentLine = lineId;
            const lineName = TRANSPORT_LINES.buses.find(b => b.id === lineId)?.name || 
                           TRANSPORT_LINES.trains.find(t => t.id === lineId)?.name || 
                           lineId;
            addEvent(`L√≠nea seleccionada para auditor√≠a: ${lineName}`, 'info');
        }
        
        function centerOnUser() {
            if (currentPosition) {
                map.setView([currentPosition.lat, currentPosition.lng], 16, {
                    animate: true,
                    duration: 0.5
                });
                addEvent('Mapa centrado en posici√≥n actual', 'info');
            }
        }
        
        function centerOnStation(lat, lng) {
            map.setView([lat, lng], 17, {
                animate: true,
                duration: 0.5
            });
            addEvent('Mapa centrado en estaci√≥n', 'info');
        }
        
        function startAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            
            const button = document.getElementById('autoRefreshButton');
            const icon = document.getElementById('autoRefreshIcon');
            const label = document.getElementById('autoRefreshLabel');
            
            if (isAutoRefresh) {
                button.classList.add('success');
                icon.className = 'fas fa-sync-alt fa-spin';
                label.textContent = `AUTO-REFRESH: ON (${apiConfig.refreshInterval/1000}s)`;
                
                // Iniciar timer de actualizaci√≥n
                startRefreshTimer();
                
                addEvent('Auto-refresh activado', 'success');
            } else {
                button.classList.remove('success');
                icon.className = 'fas fa-sync-alt';
                label.textContent = 'AUTO-REFRESH: OFF';
                
                // Detener timer
                if (dataRefreshTimer) {
                    clearInterval(dataRefreshTimer);
                    dataRefreshTimer = null;
                }
                
                addEvent('Auto-refresh desactivado', 'info');
            }
        }
        
        function startRefreshTimer() {
            if (dataRefreshTimer) {
                clearInterval(dataRefreshTimer);
            }
            
            dataRefreshTimer = setInterval(() => {
                if (apiConfig.connected) {
                    fetchTransportData();
                }
            }, apiConfig.refreshInterval);
        }
        
        function toggleBackgroundMode() {
            isBackgroundMode = !isBackgroundMode;
            
            const button = document.getElementById('backgroundButton');
            const icon = document.getElementById('backgroundIcon');
            const label = document.getElementById('backgroundLabel');
            
            if (isBackgroundMode) {
                button.classList.add('success');
                icon.className = 'fas fa-check-circle';
                label.textContent = 'SEGUNDO PLANO: ON';
                
                // Solicitar permisos para notificaciones
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                
                addEvent('Modo segundo plano activado', 'success');
            } else {
                button.classList.remove('success');
                icon.className = 'fas fa-mobile-alt';
                label.textContent = 'SEGUNDO PLANO: OFF';
                
                addEvent('Modo segundo plano desactivado', 'info');
            }
        }
        
        function generateReport() {
            if (recordingData.length === 0 && realTimeData.buses.length === 0) {
                alert('No hay datos para generar un informe');
                return;
            }
            
            let report = `INFORME DE AUDITOR√çA - TRANSPORTE P√öBLICO BUENOS AIRES\n`;
            report += `===========================================================\n\n`;
            report += `Fecha: ${new Date().toLocaleDateString('es-AR')}\n`;
            report += `Hora: ${new Date().toLocaleTimeString('es-AR')}\n`;
            report += `Sistema: Auditor√≠a GPS v2.0\n\n`;
            
            if (apiConfig.connected) {
                report += `API CONFIGURADA: S√≠\n`;
                report += `Client ID: ${apiConfig.clientId}\n`;
                report += `√öltima conexi√≥n: ${apiConfig.tokenExpiry ? new Date(apiConfig.tokenExpiry - 3600000).toLocaleString() : 'N/A'}\n`;
            } else {
                report += `API CONFIGURADA: No\n`;
            }
            
            report += `\n--- DATOS DE GRABACI√ìN ---\n`;
            report += `Duraci√≥n total: ${formatTime(recordingDuration)}\n`;
            report += `Puntos registrados: ${recordingData.length}\n`;
            report += `L√≠nea auditada: ${currentLine || 'No especificada'}\n`;
            
            if (recordingData.length > 0) {
                report += `\nPuntos de muestra (cada 10 puntos):\n`;
                for (let i = 0; i < Math.min(recordingData.length, 100); i += 10) {
                    const point = recordingData[i];
                    const time = new Date(point.timestamp).toLocaleTimeString();
                    report += `${time} - Lat: ${point.lat.toFixed(6)}, Lng: ${point.lng.toFixed(6)}, Vel: ${point.speed.toFixed(1)} km/h\n`;
                }
            }
            
            report += `\n--- DATOS API EN TIEMPO REAL ---\n`;
            report += `Veh√≠culos activos: ${realTimeData.buses.length}\n`;
            report += `√öltima actualizaci√≥n: ${realTimeData.lastUpdate ? realTimeData.lastUpdate.toLocaleString() : 'N/A'}\n`;
            
            if (realTimeData.buses.length > 0) {
                report += `\nPrimeros 10 veh√≠culos:\n`;
                realTimeData.buses.slice(0, 10).forEach((bus, i) => {
                    report += `${i+1}. L√≠nea ${bus.linea || 'N/A'} - ID: ${bus.id || 'N/A'} - Vel: ${bus.velocity || 'N/A'} km/h\n`;
                });
            }
            
            report += `\n--- RESUMEN DE AUDITOR√çA ---\n`;
            report += `Velocidad promedio: ${calculateAverageSpeed()} km/h\n`;
            report += `Distancia aproximada: ${calculateApproximateDistance()} km\n`;
            report += `Tiempo total de operaci√≥n: ${formatTime(Date.now() - (recordingStartTime || Date.now()))}\n`;
            
            // Generar archivo
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auditoria_transporte_${new Date().toISOString().slice(0, 10)}_${new Date().getHours()}${new Date().getMinutes()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            addEvent('Informe generado y descargado', 'success');
        }
        
        function exportAllData() {
            const allData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    system: 'Auditor√≠a GPS Transporte BA',
                    version: '2.0.0'
                },
                apiConfig: {
                    connected: apiConfig.connected,
                    clientId: apiConfig.clientId ? `${apiConfig.clientId.substring(0, 8)}...` : null,
                    tokenExpiry: apiConfig.tokenExpiry
                },
                recordings: {
                    current: recordingData.length > 0 ? {
                        duration: recordingDuration,
                        points: recordingData.length,
                        line: currentLine
                    } : null,
                    history: JSON.parse(localStorage.getItem('recordingHistory') || '[]')
                },
                realTimeData: {
                    buses: realTimeData.buses,
                    lastUpdate: realTimeData.lastUpdate
                },
                gpsData: {
                    currentPosition: currentPosition,
                    currentSpeed: currentSpeed,
                    currentAccuracy: currentAccuracy
                }
            };
            
            const jsonData = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auditoria_completa_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            addEvent('Todos los datos exportados en formato JSON', 'success');
        }
        
        // ============================================
        // FUNCIONES UTILITARIAS
        // ============================================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radio de la Tierra en metros
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                     Math.cos(œÜ1) * Math.cos(œÜ2) *
                     Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        function formatTime(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        function calculateAverageSpeed() {
            if (recordingData.length === 0) return 0;
            const totalSpeed = recordingData.reduce((sum, point) => sum + point.speed, 0);
            return (totalSpeed / recordingData.length).toFixed(1);
        }
        
        function calculateApproximateDistance() {
            if (recordingData.length < 2) return 0;
            
            let totalDistance = 0;
            for (let i = 1; i < recordingData.length; i++) {
                const prev = recordingData[i-1];
                const curr = recordingData[i];
                totalDistance += calculateDistance(prev.lat, prev.lng, curr.lat, curr.lng);
            }
            
            return (totalDistance / 1000).toFixed(2); // Convertir a km
        }
        
        function handleGPSError(error) {
            console.error('Error GPS:', error);
            updateGPSStatus('error');
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    addEvent('Permiso de GPS denegado por el usuario', 'error');
                    break;
                case error.POSITION_UNAVAILABLE:
                    addEvent('Informaci√≥n de posici√≥n no disponible', 'error');
                    break;
                case error.TIMEOUT:
                    addEvent('Tiempo de espera de GPS agotado', 'error');
                    break;
                default:
                    addEvent('Error desconocido en GPS', 'error');
            }
        }
        
        // ============================================
        // FUNCIONES DE MODALES
        // ============================================
        function openApiModal() {
            document.getElementById('apiModal').classList.add('active');
            
            // Rellenar campos si hay configuraci√≥n guardada
            if (apiConfig.clientId) {
                document.getElementById('clientId').value = apiConfig.clientId;
            }
            if (apiConfig.clientSecret) {
                document.getElementById('clientSecret').value = apiConfig.clientSecret;
            }
            if (apiConfig.refreshInterval) {
                document.getElementById('updateInterval').value = apiConfig.refreshInterval.toString();
            }
        }
        
        function closeApiModal() {
            document.getElementById('apiModal').classList.remove('active');
        }
        
        function openDataModal() {
            document.getElementById('dataModal').classList.add('active');
            showDataTab('buses');
        }
        
        function closeDataModal() {
            document.getElementById('dataModal').classList.remove('active');
        }
        
        function showDataTab(category) {
            updateDataTable(category);
            
            // Actualizar botones activos
            document.querySelectorAll('#dataModal .config-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target.classList.add('active');
        }
        
        function refreshData() {
            if (apiConfig.connected) {
                fetchTransportData();
                showApiMessage('Datos actualizados', 'success');
            } else {
                showApiMessage('API no configurada', 'error');
            }
        }
        
        function showApiMessage(message, type) {
            const messageElement = document.getElementById('apiMessage');
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            
            setTimeout(() => {
                messageElement.className = 'message';
            }, 5000);
        }
        
        function showTokenDisplay(token) {
            const tokenDisplay = document.getElementById('tokenDisplay');
            const tokenValue = document.getElementById('tokenValue');
            
            // Mostrar solo parte del token por seguridad
            const tokenPreview = token.length > 50 
                ? `${token.substring(0, 25)}...${token.substring(token.length - 25)}`
                : token;
            
            tokenValue.textContent = tokenPreview;
            tokenDisplay.style.display = 'block';
        }
        
        function copyTokenToClipboard() {
            if (!apiConfig.accessToken) return;
            
            navigator.clipboard.writeText(apiConfig.accessToken).then(() => {
                showApiMessage('Token copiado al portapapeles', 'success');
                addEvent('Token API copiado', 'info');
            }).catch(err => {
                console.error('Error al copiar:', err);
                showApiMessage('Error al copiar token', 'error');
            });
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('apiConfigForm').addEventListener('submit', authenticateAPI);
        
        // Manejar visibilidad de p√°gina
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isRecording) {
                document.getElementById('recordingNotification').classList.add('active');
            } else {
                document.getElementById('recordingNotification').classList.remove('active');
            }
        });
        
        // Verificar token peri√≥dicamente
        setInterval(() => {
            if (apiConfig.tokenExpiry && Date.now() >= apiConfig.tokenExpiry - 300000) { // 5 minutos antes
                updateApiStatus('expired');
                addEvent('Token API pr√≥ximo a expirar', 'warning');
            }
        }, 60000); // Cada minuto
        
        // Inicializar con datos de demostraci√≥n si no hay API configurada
        setTimeout(() => {
            if (!apiConfig.connected) {
                useDemoData();
            }
        }, 3000);
        
        console.log('‚úÖ Sistema completamente inicializado');
    </script>
</body>
</html>