<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Geolocalización</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2196f3;
            --secondary: #0d47a1;
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #e0e0e0;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --gray: #2d2d2d;
            --lighter-gray: #424242;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--darker);
            color: var(--light);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
        }
        
        /* Panel izquierdo */
        .control-panel {
            width: 350px;
            background-color: var(--dark);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--gray);
        }
        
        @media (max-width: 1024px) {
            .control-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--gray);
                max-height: 40vh;
            }
        }
        
        /* Panel derecho - Mapa */
        .map-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 1000;
            pointer-events: none;
        }
        
        .map-controls {
            background-color: rgba(18, 18, 18, 0.9);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            gap: 10px;
            pointer-events: auto;
            border: 1px solid var(--gray);
        }
        
        .map-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .map-btn:hover {
            background-color: var(--secondary);
            transform: scale(1.1);
        }
        
        /* Tarjetas de información */
        .info-card {
            background-color: var(--gray);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .info-card h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Coordenadas */
        .coordinates-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .coordinate-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .coordinate-label {
            font-size: 0.9rem;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .coordinate-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
            font-family: monospace;
        }
        
        /* Detección de transporte */
        .transport-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 15px;
        }
        
        .transport-icon {
            font-size: 4rem;
            color: var(--primary);
        }
        
        .transport-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .speed-display {
            display: flex;
            align-items: baseline;
            gap: 5px;
            margin-top: 10px;
        }
        
        .speed-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .speed-unit {
            font-size: 1.2rem;
            color: #aaa;
        }
        
        .confidence-bar {
            width: 100%;
            height: 10px;
            background-color: var(--lighter-gray);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #64b5f6);
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .confidence-label {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        /* Línea de tren */
        .line-selector {
            margin-top: 15px;
        }
        
        .line-selector select {
            width: 100%;
            padding: 12px;
            background-color: var(--lighter-gray);
            color: white;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .line-info {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--lighter-gray);
        }
        
        .line-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            background-color: var(--lighter-gray);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        /* Consola */
        .console-panel {
            height: 250px;
            background-color: var(--dark);
            border-top: 1px solid var(--gray);
            display: flex;
            flex-direction: column;
        }
        
        .console-header {
            padding: 15px 20px;
            background-color: rgba(18, 18, 18, 0.9);
            border-bottom: 1px solid var(--gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .console-controls {
            display: flex;
            gap: 10px;
        }
        
        .console-btn {
            padding: 8px 15px;
            background-color: var(--lighter-gray);
            color: white;
            border: 1px solid var(--gray);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .console-btn:hover {
            background-color: var(--primary);
        }
        
        .console-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
            background-color: rgba(45, 45, 45, 0.5);
            display: flex;
            justify-content: space-between;
        }
        
        .log-entry.error {
            border-left-color: var(--error);
            background-color: rgba(244, 67, 54, 0.1);
        }
        
        .log-entry.warning {
            border-left-color: var(--warning);
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .log-entry.success {
            border-left-color: var(--success);
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .log-message {
            flex: 1;
        }
        
        .log-time {
            color: #888;
            font-size: 0.8rem;
            min-width: 70px;
            text-align: right;
        }
        
        /* Botón de permisos */
        .permission-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            text-align: center;
            padding: 30px;
        }
        
        .permission-content {
            max-width: 500px;
            background-color: var(--dark);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary);
        }
        
        .permission-icon {
            font-size: 5rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .permission-content h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .permission-content p {
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.5;
            color: #ccc;
        }
        
        .permission-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .permission-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .permission-btn.allow {
            background-color: var(--primary);
            color: white;
        }
        
        .permission-btn.allow:hover {
            background-color: var(--secondary);
            transform: translateY(-3px);
        }
        
        .permission-btn.deny {
            background-color: var(--lighter-gray);
            color: white;
        }
        
        .permission-btn.deny:hover {
            background-color: var(--gray);
        }
        
        /* Estado de conexión */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            background-color: var(--lighter-gray);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #888;
        }
        
        .status-indicator.connected {
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .status-indicator.disconnected {
            background-color: var(--error);
            box-shadow: 0 0 10px var(--error);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .coordinates-grid {
                grid-template-columns: 1fr;
            }
            
            .map-overlay {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .line-stats {
                grid-template-columns: 1fr;
            }
            
            .permission-buttons {
                flex-direction: column;
            }
        }
        
        /* Animaciones */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
    </style>
</head>
<body>
    <!-- Pantalla de permisos -->
    <div id="permissionPrompt" class="permission-prompt">
        <div class="permission-content">
            <div class="permission-icon">
                <i class="fas fa-map-marked-alt"></i>
            </div>
            <h2>Permiso de Ubicación Requerido</h2>
            <p>Para que esta aplicación funcione correctamente, necesitamos acceder a tu ubicación en tiempo real. Esto nos permitirá:</p>
            <ul style="text-align: left; margin: 20px 0; padding-left: 20px;">
                <li>Mostrar tu ubicación exacta en el mapa</li>
                <li>Calcular tu velocidad de movimiento</li>
                <li>Detectar tu medio de transporte</li>
                <li>Mostrar recorridos de transporte público cercanos</li>
            </ul>
            <p>Tu información de ubicación <strong>NO</strong> se envía a ningún servidor. Todo se procesa localmente en tu navegador.</p>
            <div class="permission-buttons">
                <button id="allowPermission" class="permission-btn allow">
                    <i class="fas fa-check-circle"></i> Permitir Ubicación
                </button>
                <button id="denyPermission" class="permission-btn deny">
                    <i class="fas fa-times-circle"></i> Denegar
                </button>
            </div>
            <div class="connection-status" style="margin-top: 30px;">
                <div class="status-indicator disconnected"></div>
                <span>Esperando permisos...</span>
            </div>
        </div>
    </div>

    <!-- Aplicación principal -->
    <div class="app-container" id="appContainer" style="display: none;">
        <div class="header">
            <h1><i class="fas fa-satellite"></i> Sistema de Geolocalización Inteligente</h1>
            <p>Detección de transporte en tiempo real basada en tu velocidad de movimiento</p>
        </div>
        
        <div class="main-content">
            <!-- Panel de control izquierdo -->
            <div class="control-panel">
                <!-- Estado de conexión -->
                <div class="connection-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">Conectando...</span>
                </div>
                
                <!-- Coordenadas -->
                <div class="info-card">
                    <h2><i class="fas fa-location-dot"></i> Ubicación Actual</h2>
                    <div class="coordinates-grid">
                        <div class="coordinate-item">
                            <div class="coordinate-label">
                                <i class="fas fa-globe-americas"></i> Latitud
                            </div>
                            <div class="coordinate-value" id="latitude">--.--</div>
                        </div>
                        <div class="coordinate-item">
                            <div class="coordinate-label">
                                <i class="fas fa-globe-americas"></i> Longitud
                            </div>
                            <div class="coordinate-value" id="longitude">--.--</div>
                        </div>
                        <div class="coordinate-item">
                            <div class="coordinate-label">
                                <i class="fas fa-bullseye"></i> Precisión
                            </div>
                            <div class="coordinate-value" id="accuracy">-- m</div>
                        </div>
                        <div class="coordinate-item">
                            <div class="coordinate-label">
                                <i class="fas fa-clock"></i> Última actualización
                            </div>
                            <div class="coordinate-value" id="timestamp">--:--:--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Detección de transporte -->
                <div class="info-card">
                    <h2><i class="fas fa-car-side"></i> Medio Detectado</h2>
                    <div class="transport-card">
                        <div class="transport-icon" id="transportIcon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="transport-name" id="transportName">
                            Esperando datos...
                        </div>
                        
                        <div class="speed-display">
                            <div class="speed-value" id="speedValue">0</div>
                            <div class="speed-unit">km/h</div>
                        </div>
                        
                        <div style="width: 100%;">
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="confidenceFill"></div>
                            </div>
                            <div class="confidence-label">
                                <span>Confianza:</span>
                                <span id="confidenceValue">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Línea de tren -->
                <div class="info-card" id="lineCard" style="display: none;">
                    <h2><i class="fas fa-train"></i> Línea de Tren</h2>
                    <div class="line-selector">
                        <select id="lineSelector">
                            <option value="sarmiento">Línea Sarmiento (Once - Moreno)</option>
                            <option value="mitre">Línea Mitre (Retiro - Tigre)</option>
                            <option value="roca">Línea Roca (Constitución - Ezeiza)</option>
                            <option value="belgrano">Línea Belgrano Norte (Retiro - Villa Rosa)</option>
                            <option value="sanmartin">Línea San Martín (Retiro - Pilar)</option>
                            <option value="urquiza">Línea Urquiza (Federico Lacroze - General Lemos)</option>
                        </select>
                    </div>
                    
                    <div class="line-info">
                        <h3 id="lineName">Línea Sarmiento</h3>
                        <p id="lineDescription" style="color: #aaa; margin-bottom: 15px;">Recorrido Once - Moreno</p>
                        
                        <div class="line-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="lineStations">17</div>
                                <div class="stat-label">Estaciones</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="lineDistance">35.5</div>
                                <div class="stat-label">Kilómetros</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="lineDuration">55</div>
                                <div class="stat-label">Minutos</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="lineFrequency">10</div>
                                <div class="stat-label">Min. frecuencia</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel del mapa -->
            <div class="map-panel">
                <div class="map-container">
                    <div id="map"></div>
                    
                    <div class="map-overlay">
                        <div class="map-controls">
                            <button class="map-btn" id="zoomIn" title="Acercar">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="map-btn" id="zoomOut" title="Alejar">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="map-btn" id="centerMap" title="Centrar en mi ubicación">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                            <button class="map-btn" id="toggleTracking" title="Alternar seguimiento">
                                <i class="fas fa-play" id="trackingIcon"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Consola -->
                <div class="console-panel">
                    <div class="console-header">
                        <div class="console-title">
                            <i class="fas fa-terminal"></i> Consola del Sistema
                        </div>
                        <div class="console-controls">
                            <button class="console-btn" id="clearConsole">
                                <i class="fas fa-trash"></i> Limpiar
                            </button>
                            <button class="console-btn" id="exportConsole">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="console-content" id="consoleContent">
                        <div class="log-entry">
                            <div class="log-message">Sistema inicializado. Esperando permisos de ubicación...</div>
                            <div class="log-time" id="currentTime">00:00:00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variables globales
        let watchId = null;
        let isTracking = false;
        let map = null;
        let userMarker = null;
        let userCircle = null;
        let trainLine = null;
        let trainStations = [];
        let lastPosition = null;
        let lastTime = null;
        let currentSpeed = 0;
        let currentTransport = "unknown";
        let consoleLog = [];
        let permissionGranted = false;
        
        // Datos de líneas de tren
        const trainLines = {
            sarmiento: {
                name: "Línea Sarmiento",
                description: "Recorrido Once - Moreno",
                color: "#FF5252",
                stations: 17,
                distance: 35.5,
                duration: 55,
                frequency: 10,
                coordinates: [
                    [-34.6091, -58.4086], // Once
                    [-34.6105, -58.4203], // Caballito
                    [-34.6182, -58.4357], // Flores
                    [-34.6358, -58.4772], // Floresta
                    [-34.6405, -58.5278], // Liniers
                    [-34.6489, -58.5658], // Villa Luro
                    [-34.6605, -58.6047], // Ramos Mejía
                    [-34.6647, -58.6314], // Haedo
                    [-34.6689, -58.6569], // Morón
                    [-34.6758, -58.7008], // Castelar
                    [-34.6819, -58.7283], // Ituzaingó
                    [-34.6900, -58.7600], // San Antonio de Padua
                    [-34.6975, -58.7883], // Merlo
                    [-34.7031, -58.8158], // Paso del Rey
                    [-34.7089, -58.8464], // Moreno
                ],
                stationNames: [
                    "Once", "Caballito", "Flores", "Floresta", "Liniers",
                    "Villa Luro", "Ramos Mejía", "Haedo", "Morón", "Castelar",
                    "Ituzaingó", "San Antonio de Padua", "Merlo", "Paso del Rey", "Moreno"
                ]
            },
            mitre: {
                name: "Línea Mitre",
                description: "Recorrido Retiro - Tigre",
                color: "#2196f3",
                stations: 21,
                distance: 28.2,
                duration: 45,
                frequency: 8,
                coordinates: [
                    [-34.5905, -58.3731], // Retiro
                    [-34.5950, -58.4019], // Lisandro de la Torre
                    [-34.5983, -58.4250], // Belgrano C
                    [-34.6025, -58.4486], // Núñez
                    [-34.5572, -58.4958], // Coghlan
                    [-34.5669, -58.5156], // Saavedra
                    [-34.5767, -58.5375], // Villa Urquiza
                    [-34.5864, -58.5597], // Villa Pueyrredón
                    [-34.5956, -58.5808], // Devoto
                    [-34.6067, -58.6067], // Beccar
                    [-34.5336, -58.6181], // San Martín
                    [-34.5436, -58.6389], // San Andrés
                    [-34.5517, -58.6603], // Miguelete
                    [-34.5611, -58.6811], // José León Suárez
                    [-34.4108, -58.6408], // Tigre
                ]
            },
            roca: {
                name: "Línea Roca",
                description: "Recorrido Constitución - Ezeiza",
                color: "#4caf50",
                stations: 24,
                distance: 42.3,
                duration: 65,
                frequency: 12,
                coordinates: [
                    [-34.6275, -58.3792], // Constitución
                    [-34.6408, -58.3914], // Parque Patricios
                    [-34.6564, -58.4108], // Barracas
                    [-34.6708, -58.4292], // Avellaneda
                    [-34.6861, -58.4494], // Sarandí
                    [-34.7019, -58.4700], // Wilde
                    [-34.7164, -58.4900], // Don Bosco
                    [-34.7325, -58.5111], // Bernal
                    [-34.7469, -58.5314], // Quilmes
                    [-34.7628, -58.5533], // Ezpeleta
                    [-34.7772, -58.5739], // Berazategui
                    [-34.7922, -58.5958], // Hudson
                    [-34.8067, -58.6164], // Punta Lara
                ]
            }
        };
        
        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', () => {
            // Actualizar hora en consola
            updateTime();
            setInterval(updateTime, 1000);
            
            // Configurar eventos
            setupEventListeners();
            
            // Inicializar mapa (pero no la geolocalización todavía)
            initMap();
            
            // Mostrar pantalla de permisos
            showPermissionPrompt();
            
            // Añadir mensaje inicial a consola
            logToConsole("Sistema inicializado. Esperando permisos de ubicación...", "info");
        });
        
        // Mostrar pantalla de permisos
        function showPermissionPrompt() {
            document.getElementById('permissionPrompt').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }
        
        // Ocultar pantalla de permisos y mostrar app
        function showApp() {
            document.getElementById('permissionPrompt').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Botones de permisos
            document.getElementById('allowPermission').addEventListener('click', requestPermission);
            document.getElementById('denyPermission').addEventListener('click', denyPermission);
            
            // Botones del mapa
            document.getElementById('zoomIn').addEventListener('click', () => {
                map.zoomIn();
                logToConsole("Mapa: Zoom aumentado", "info");
            });
            document.getElementById('zoomOut').addEventListener('click', () => {
                map.zoomOut();
                logToConsole("Mapa: Zoom reducido", "info");
            });
            document.getElementById('centerMap').addEventListener('click', centerOnUser);
            document.getElementById('toggleTracking').addEventListener('click', toggleTracking);
            
            // Selector de línea de tren
            document.getElementById('lineSelector').addEventListener('change', (e) => {
                loadTrainLine(e.target.value);
                logToConsole(`Línea cambiada a: ${trainLines[e.target.value].name}`, "info");
            });
            
            // Controles de consola
            document.getElementById('clearConsole').addEventListener('click', clearConsole);
            document.getElementById('exportConsole').addEventListener('click', exportConsole);
        }
        
        // Solicitar permiso de ubicación
        function requestPermission() {
            logToConsole("Solicitando permiso de ubicación...", "info");
            updateStatus("Solicitando permisos...", "disconnected");
            
            if (!navigator.geolocation) {
                logToConsole("ERROR: Tu navegador no soporta geolocalización", "error");
                updateStatus("Navegador no compatible", "disconnected");
                return;
            }
            
            // Solicitar permiso con getCurrentPosition
            navigator.geolocation.getCurrentPosition(
                // Éxito
                (position) => {
                    permissionGranted = true;
                    logToConsole("Permiso de ubicación concedido", "success");
                    updateStatus("Conectado - Ubicación activa", "connected");
                    showApp();
                    startTracking();
                },
                // Error
                (error) => {
                    handlePermissionError(error);
                },
                // Opciones
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        // Denegar permiso
        function denyPermission() {
            logToConsole("Permiso de ubicación denegado por el usuario", "error");
            updateStatus("Permiso denegado", "disconnected");
            
            // Mostrar mensaje de error
            const permissionContent = document.querySelector('.permission-content');
            permissionContent.innerHTML = `
                <div class="permission-icon" style="color: #f44336;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2>Permiso Denegado</h2>
                <p>Has denegado el permiso de ubicación. Esta aplicación no puede funcionar sin acceso a tu ubicación.</p>
                <p>Para usar la aplicación, necesitas permitir el acceso a tu ubicación.</p>
                <div class="permission-buttons">
                    <button id="retryPermission" class="permission-btn allow">
                        <i class="fas fa-redo"></i> Intentar Nuevamente
                    </button>
                </div>
            `;
            
            // Agregar evento al botón de reintentar
            document.getElementById('retryPermission').addEventListener('click', requestPermission);
        }
        
        // Manejar error de permisos
        function handlePermissionError(error) {
            let message = "";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Permiso de ubicación denegado por el usuario";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "La información de ubicación no está disponible";
                    break;
                case error.TIMEOUT:
                    message = "La solicitud de ubicación ha expirado";
                    break;
                case error.UNKNOWN_ERROR:
                    message = "Ocurrió un error desconocido";
                    break;
            }
            
            logToConsole(`ERROR: ${message}`, "error");
            updateStatus("Error de permisos", "disconnected");
            
            // Mostrar mensaje de error
            const permissionContent = document.querySelector('.permission-content');
            permissionContent.innerHTML = `
                <div class="permission-icon" style="color: #ff9800;">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <h2>Error de Permisos</h2>
                <p>${message}</p>
                <p>Por favor, intenta nuevamente o verifica la configuración de tu navegador.</p>
                <div class="permission-buttons">
                    <button id="retryPermission" class="permission-btn allow">
                        <i class="fas fa-redo"></i> Reintentar
                    </button>
                </div>
            `;
            
            // Agregar evento al botón de reintentar
            document.getElementById('retryPermission').addEventListener('click', requestPermission);
        }
        
        // Actualizar estado de conexión
        function updateStatus(text, status) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = text;
            indicator.className = 'status-indicator';
            indicator.classList.add(status);
            
            // Actualizar también en pantalla de permisos
            const permissionStatus = document.querySelector('.permission-prompt .connection-status span');
            if (permissionStatus) {
                permissionStatus.textContent = text;
                
                const permissionIndicator = document.querySelector('.permission-prompt .status-indicator');
                if (permissionIndicator) {
                    permissionIndicator.className = 'status-indicator';
                    permissionIndicator.classList.add(status);
                }
            }
        }
        
        // Inicializar mapa
        function initMap() {
            // Crear mapa centrado en Buenos Aires
            map = L.map('map').setView([-34.6037, -58.3816], 12);
            
            // Agregar capa de OpenStreetMap con estilo oscuro
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Cargar línea de tren por defecto
            loadTrainLine('sarmiento');
            
            logToConsole("Mapa inicializado correctamente", "success");
        }
        
        // Alternar seguimiento
        function toggleTracking() {
            if (isTracking) {
                stopTracking();
                document.getElementById('trackingIcon').className = 'fas fa-play';
                logToConsole("Seguimiento detenido", "warning");
            } else {
                startTracking();
                document.getElementById('trackingIcon').className = 'fas fa-pause';
                logToConsole("Seguimiento activado", "success");
            }
            isTracking = !isTracking;
        }
        
        // Iniciar seguimiento
        function startTracking() {
            if (!permissionGranted) {
                logToConsole("ERROR: No hay permisos de ubicación", "error");
                return;
            }
            
            // Opciones para alta precisión
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };
            
            // Obtener posición inicial
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updatePosition(position);
                    centerOnUser();
                    logToConsole("Posición inicial obtenida", "success");
                    
                    // Iniciar seguimiento continuo
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            updatePosition(position);
                            detectTransport();
                        },
                        (error) => {
                            handleLocationError(error);
                        },
                        options
                    );
                },
                (error) => {
                    handleLocationError(error);
                },
                options
            );
        }
        
        // Detener seguimiento
        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }
        
        // Actualizar posición
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const timestamp = new Date(position.timestamp);
            
            // Actualizar interfaz
            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = `${accuracy.toFixed(1)} m`;
            document.getElementById('timestamp').textContent = timestamp.toLocaleTimeString();
            
            // Calcular velocidad
            if (lastPosition && lastTime) {
                const timeDiff = (position.timestamp - lastTime) / 1000; // segundos
                if (timeDiff > 0) {
                    const distance = calculateDistance(
                        lastPosition.lat, lastPosition.lng,
                        lat, lng
                    );
                    
                    // Velocidad en km/h
                    currentSpeed = (distance / timeDiff) * 3.6;
                    
                    // Filtrar valores atípicos
                    if (currentSpeed < 300) {
                        document.getElementById('speedValue').textContent = currentSpeed.toFixed(1);
                    }
                }
            }
            
            // Guardar para próximo cálculo
            lastPosition = { lat, lng };
            lastTime = position.timestamp;
            
            // Actualizar marcador en mapa
            updateUserMarker(lat, lng, accuracy);
            
            // Log cada 5 actualizaciones
            if (Math.random() < 0.2) {
                logToConsole(`Posición: ${lat.toFixed(4)}, ${lng.toFixed(4)} | Precisión: ${accuracy.toFixed(1)}m`, "info");
            }
        }
        
        // Calcular distancia (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Actualizar marcador en mapa
        function updateUserMarker(lat, lng, accuracy) {
            const userPos = [lat, lng];
            
            if (!userMarker) {
                userMarker = L.marker(userPos, {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div class="pulse"><i class="fas fa-user" style="color:#2196f3; font-size:24px;"></i></div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(map);
                
                userCircle = L.circle(userPos, {
                    color: '#2196f3',
                    fillColor: '#2196f3',
                    fillOpacity: 0.1,
                    radius: accuracy
                }).addTo(map);
            } else {
                userMarker.setLatLng(userPos);
                userCircle.setLatLng(userPos);
                userCircle.setRadius(accuracy);
            }
        }
        
        // Centrar mapa en usuario
        function centerOnUser() {
            if (lastPosition) {
                map.setView([lastPosition.lat, lastPosition.lng], 15);
                logToConsole("Mapa centrado en ubicación actual", "info");
            }
        }
        
        // Detectar transporte
        function detectTransport() {
            let transport = "unknown";
            let confidence = 0;
            let icon = "fas fa-question-circle";
            
            // Umbrales de velocidad (km/h)
            if (currentSpeed < 1) {
                transport = "Detenido";
                confidence = 95;
                icon = "fas fa-street-view";
            } else if (currentSpeed < 6) {
                transport = "Caminando";
                confidence = 90;
                icon = "fas fa-walking";
            } else if (currentSpeed < 15) {
                transport = "Bicicleta";
                confidence = 80;
                icon = "fas fa-bicycle";
            } else if (currentSpeed < 40) {
                transport = "Auto";
                confidence = 85;
                icon = "fas fa-car";
            } else if (currentSpeed < 80) {
                transport = "Colectivo";
                confidence = 75;
                icon = "fas fa-bus";
            } else {
                transport = "Tren";
                confidence = 90;
                icon = "fas fa-train";
                showLineInfo();
            }
            
            // Actualizar si cambió el transporte
            if (transport !== currentTransport) {
                currentTransport = transport;
                
                document.getElementById('transportIcon').innerHTML = `<i class="${icon}"></i>`;
                document.getElementById('transportName').textContent = transport;
                
                // Mostrar/ocultar información de línea
                if (transport !== "Tren") {
                    document.getElementById('lineCard').style.display = 'none';
                }
                
                logToConsole(`Transporte detectado: ${transport}`, "success");
            }
            
            // Actualizar confianza
            document.getElementById('confidenceFill').style.width = `${confidence}%`;
            document.getElementById('confidenceValue').textContent = `${confidence}%`;
        }
        
        // Mostrar información de línea
        function showLineInfo() {
            const lineCard = document.getElementById('lineCard');
            const lineSelector = document.getElementById('lineSelector');
            const selectedLine = trainLines[lineSelector.value];
            
            document.getElementById('lineName').textContent = selectedLine.name;
            document.getElementById('lineDescription').textContent = selectedLine.description;
            document.getElementById('lineStations').textContent = selectedLine.stations;
            document.getElementById('lineDistance').textContent = selectedLine.distance;
            document.getElementById('lineDuration').textContent = selectedLine.duration;
            document.getElementById('lineFrequency').textContent = selectedLine.frequency;
            
            lineCard.style.display = 'block';
        }
        
        // Cargar línea de tren en mapa
        function loadTrainLine(lineId) {
            const line = trainLines[lineId];
            
            // Eliminar línea anterior
            if (trainLine) {
                map.removeLayer(trainLine);
            }
            
            // Eliminar estaciones anteriores
            trainStations.forEach(station => map.removeLayer(station));
            trainStations = [];
            
            // Crear nueva línea
            if (line.coordinates) {
                trainLine = L.polyline(line.coordinates, {
                    color: line.color,
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);
                
                // Añadir estaciones
                line.coordinates.forEach((coord, index) => {
                    const stationName = line.stationNames ? line.stationNames[index] : `Estación ${index + 1}`;
                    
                    const station = L.marker(coord, {
                        icon: L.divIcon({
                            className: 'station-marker',
                            html: `<div style="background-color:${line.color}; color:white; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold;">${index + 1}</div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    
                    station.bindTooltip(stationName);
                    trainStations.push(station);
                });
                
                // Ajustar vista
                if (line.coordinates.length > 0) {
                    const bounds = L.latLngBounds(line.coordinates);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
            
            // Mostrar información si está en tren
            if (currentTransport === "Tren") {
                showLineInfo();
            }
        }
        
        // Manejar error de geolocalización
        function handleLocationError(error) {
            let message = "";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Permiso de ubicación denegado";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Ubicación no disponible";
                    break;
                case error.TIMEOUT:
                    message = "Tiempo de espera agotado";
                    break;
                case error.UNKNOWN_ERROR:
                    message = "Error desconocido";
                    break;
            }
            
            logToConsole(`ERROR: ${message}`, "error");
            updateStatus("Error de ubicación", "disconnected");
            
            // Detener seguimiento
            if (isTracking) {
                toggleTracking();
            }
        }
        
        // Funciones de consola
        function logToConsole(message, type = "info") {
            const consoleContent = document.getElementById('consoleContent');
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <div class="log-message">${message}</div>
                <div class="log-time">${timeString}</div>
            `;
            
            consoleContent.prepend(logEntry);
            consoleLog.unshift({ message, type, timestamp: now });
            
            // Limitar a 100 mensajes
            if (consoleLog.length > 100) {
                consoleLog.pop();
                if (consoleContent.children.length > 100) {
                    consoleContent.removeChild(consoleContent.lastChild);
                }
            }
        }
        
        function clearConsole() {
            const consoleContent = document.getElementById('consoleContent');
            consoleContent.innerHTML = '';
            consoleLog = [];
            logToConsole("Consola limpiada", "info");
        }
        
        function exportConsole() {
            let exportContent = "Log de Consola - Sistema de Geolocalización\n";
            exportContent += "=============================================\n\n";
            
            consoleLog.forEach(log => {
                exportContent += `[${log.timestamp.toLocaleString()}] ${log.message}\n`;
            });
            
            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `consola_geolocalizacion_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logToConsole("Log exportado como archivo de texto", "success");
        }
        
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('currentTime').textContent = timeString;
        }
    </script>
</body>
</html>