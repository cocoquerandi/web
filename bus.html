<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Transporte Inteligente</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #000; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden; 
        }
        #map { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
        }
        
        /* Modal de permisos */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(20px);
            animation: fadeIn 0.5s ease;
        }
        
        .permission-content {
            background: rgba(20, 20, 30, 0.95);
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        
        .permission-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .permission-title {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .permission-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .permission-features {
            text-align: left;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }
        
        .feature-item:before {
            content: "‚úì";
            color: #34C759;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .permission-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .permission-btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }
        
        .permission-btn.allow {
            background: linear-gradient(135deg, #007AFF, #0056CC);
            color: white;
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.3);
        }
        
        .permission-btn.allow:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 122, 255, 0.4);
        }
        
        .permission-btn.deny {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .permission-btn.deny:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .privacy-note {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 20px;
            line-height: 1.5;
        }
        
        .privacy-link {
            color: #007AFF;
            text-decoration: none;
        }
        
        /* Estado GPS */
        .gps-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
        }
        
        .gps-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #FF3B30;
            animation: pulse-red 2s infinite;
        }
        
        .gps-dot.active {
            background: #34C759;
            animation: pulse-green 2s infinite;
        }
        
        /* Controles mejorados */
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 15px;
            border-radius: 12px;
            z-index: 1000;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            min-width: 220px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .speed-container {
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .speed-label {
            font-size: 11px;
            opacity: 0.7;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        
        .speed-value {
            font-size: 28px;
            font-weight: 800;
            color: #34C759;
            margin-bottom: 4px;
        }
        
        .direction-indicator {
            font-size: 11px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .transport-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .transport-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
            transition: all 0.3s ease;
        }
        
        .transport-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .transport-btn.active {
            background: linear-gradient(135deg, #007AFF, #0056CC);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        
        .line-selector {
            display: none;
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
        }
        
        .line-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .line-btn {
            padding: 10px 8px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.08);
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .line-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .line-btn.active {
            background: linear-gradient(135deg, #34C759, #28A745);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }
        
        .auto-detect {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            opacity: 0.9;
        }
        
        .auto-detect:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #007AFF;
        }
        
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .station-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .station-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        
        .station-item.current {
            border-left-color: #007AFF;
            background: rgba(0, 122, 255, 0.1);
        }
        
        .station-item.next {
            border-left-color: #34C759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .station-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .station-distance {
            font-size: 13px;
            color: #34C759;
            font-weight: 500;
        }
        
        .line-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            opacity: 0.7;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Bot√≥n para reactivar GPS */
        .gps-reactivate {
            position: absolute;
            bottom: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .gps-reactivate:hover {
            background: rgba(0, 0, 0, 0.95);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        
        @media (max-width: 768px) {
            .controls { 
                left: 10px; 
                top: 10px; 
                right: 10px;
                min-width: auto;
            }
            .info-panel { 
                bottom: 10px; 
                left: 10px; 
                right: 10px; 
            }
            .station-info { 
                grid-template-columns: 1fr; 
                gap: 10px; 
            }
            .transport-buttons {
                flex-direction: column;
            }
            .gps-status {
                top: 10px;
                right: 10px;
                font-size: 12px;
                padding: 8px 12px;
            }
            .gps-reactivate {
                bottom: 90px;
                right: 10px;
                padding: 10px 15px;
                font-size: 13px;
            }
            .permission-content {
                padding: 30px 20px;
                width: 95%;
            }
            .permission-buttons {
                flex-direction: column;
            }
            .permission-btn {
                width: 100%;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse-red {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(52, 199, 89, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0); }
        }
        
        .user-track {
            stroke: #007AFF;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { stroke-opacity: 0.8; }
            50% { stroke-opacity: 0.4; }
            100% { stroke-opacity: 0.8; }
        }
        
        .station-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        
        .station-marker.current {
            border-color: #007AFF;
            transform: scale(1.3);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }
        
        .station-marker.next {
            border-color: #34C759;
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(52, 199, 89, 0.4);
            animation: pulse-green 1.5s infinite;
        }
    </style>
</head>
<body>
    <!-- Modal de permisos (se muestra solo la primera vez o cuando el usuario lo solicita) -->
    <div id="permissionModal" class="permission-modal" style="display: none;">
        <div class="permission-content">
            <div class="permission-icon">üìç</div>
            <h2 class="permission-title">Acceso a tu ubicaci√≥n</h2>
            <p class="permission-text">
                Para brindarte un seguimiento preciso en tiempo real, necesitamos acceso a tu ubicaci√≥n.
            </p>
            
            <div class="permission-features">
                <div class="feature-item">Seguimiento en tiempo real de tu transporte</div>
                <div class="feature-item">Detecci√≥n autom√°tica de l√≠nea y estaci√≥n</div>
                <div class="feature-item">Distancia a la pr√≥xima estaci√≥n</div>
                <div class="feature-item">Velocidad y direcci√≥n de viaje</div>
                <div class="feature-item">Coordenadas exactas alineadas con v√≠as</div>
            </div>
            
            <div class="permission-buttons">
                <button class="permission-btn allow" onclick="allowLocationAccess()">
                    Permitir ubicaci√≥n
                </button>
                <button class="permission-btn deny" onclick="denyLocationAccess()">
                    No permitir
                </button>
            </div>
            
            <p class="privacy-note">
                Tu ubicaci√≥n se usa solo localmente en tu dispositivo. No se almacena en servidores externos. 
                Puedes cambiar los permisos en cualquier momento desde los ajustes de tu navegador.
            </p>
        </div>
    </div>
    
    <!-- Estado GPS -->
    <div id="gpsStatus" class="gps-status" style="display: none;">
        <div class="gps-dot"></div>
        <span id="gpsStatusText">Buscando GPS...</span>
    </div>
    
    <!-- Bot√≥n para reactivar GPS -->
    <div id="gpsReactivate" class="gps-reactivate" style="display: none;" onclick="reactivateGPS()">
        <span>üìç</span>
        Reactivar seguimiento
    </div>
    
    <div id="map"></div>
    
    <div class="controls">
        <div class="speed-container">
            <div class="speed-label">VELOCIDAD ACTUAL</div>
            <div class="speed-value" id="speedValue">--.- km/h</div>
            <div class="direction-indicator">
                <span id="directionArrow">‚óè</span>
                <span id="directionText">Sin GPS</span>
            </div>
        </div>
        
        <div class="transport-buttons">
            <button class="transport-btn active" onclick="selectTransport('train')">üöÜ Trenes</button>
            <button class="transport-btn" onclick="selectTransport('subte')">üöá Subtes</button>
        </div>
        
        <div class="line-selector" id="lineSelector">
            <div class="line-buttons" id="lineButtons"></div>
            <div class="auto-detect" onclick="autoDetectLine()">
                üîç Detectar l√≠nea autom√°ticamente
            </div>
        </div>
    </div>
    
    <div class="info-panel">
        <div class="station-info">
            <div class="station-item current">
                <div class="station-label">ESTACI√ìN ACTUAL</div>
                <div class="station-name" id="currentStation">Esperando GPS</div>
                <div class="station-distance" id="currentDistance">-</div>
            </div>
            <div class="station-item next">
                <div class="station-label">PR√ìXIMA ESTACI√ìN</div>
                <div class="station-name" id="nextStation">-</div>
                <div class="station-distance" id="nextDistance">-</div>
            </div>
        </div>
        <div class="line-info">
            <div>L√≠nea: <span id="detectedLine">Seleccionar l√≠nea</span></div>
            <div>Modo: <span id="detectionMode">Manual</span></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============================================
        // SISTEMA DE PERMISOS PERSISTENTE
        // ============================================
        
        const PERMISSION_STORAGE_KEY = 'transport_tracker_location_permission';
        const SETTINGS_STORAGE_KEY = 'transport_tracker_settings';
        
        // Base de datos de estaciones (mantener igual)
        const stations = {
            // ... (mantener todo el objeto stations igual del c√≥digo anterior)
        };
        
        // L√≠neas disponibles
        const transportLines = {
            train: [
                {id: 'sarmiento', name: 'Sarmiento', color: '#FF3B30'},
                {id: 'mitre_tigre', name: 'Mitre (Tigre)', color: '#007AFF'},
                {id: 'roca', name: 'Roca', color: '#FF9500'},
                {id: 'sanmartin', name: 'San Mart√≠n', color: '#4CD964'},
                {id: 'urquiza', name: 'Urquiza', color: '#FFCC00'},
                {id: 'belgranonorte', name: 'Belgrano Norte', color: '#5856D6'}
            ],
            subte: [
                {id: 'linea_a', name: 'L√≠nea A', color: '#0072BC'},
                {id: 'linea_b', name: 'L√≠nea B', color: '#D9006C'},
                {id: 'linea_c', name: 'L√≠nea C', color: '#00A1E4'},
                {id: 'linea_d', name: 'L√≠nea D', color: '#008E5B'},
                {id: 'linea_h', name: 'L√≠nea H', color: '#FFD700'}
            ]
        };
        
        // ============================================
        // SISTEMA PRINCIPAL MEJORADO
        // ============================================
        
        // Inicializar mapa
        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        
        // Variables del sistema
        let userMarker = null;
        let userTrack = [];
        let trackPolyline = null;
        let stationMarkers = new Map();
        let watchId = null;
        let lastPosition = null;
        let currentSpeed = 0;
        let currentBearing = 0;
        let currentLine = null;
        let currentTransport = 'train';
        let isAutoDetect = false;
        let userHistory = [];
        let lastStationPassed = null;
        let gpsActive = false;
        let userSettings = {};
        
        // Configuraci√≥n
        const CONFIG = {
            AUTO_DETECT_THRESHOLD: 50,
            HISTORY_SIZE: 10,
            STATION_PASS_THRESHOLD: 25,
            GPS_UPDATE_INTERVAL: 1000,
            GPS_TIMEOUT: 10000,
            INITIAL_ZOOM: 13,
            FOLLOW_ZOOM: 15
        };
        
        // ============================================
        // GESTI√ìN DE PERMISOS
        // ============================================
        
        // Cargar configuraci√≥n del usuario
        function loadUserSettings() {
            const saved = localStorage.getItem(SETTINGS_STORAGE_KEY);
            if (saved) {
                userSettings = JSON.parse(saved);
            } else {
                userSettings = {
                    locationPermission: 'unknown',
                    lastTransport: 'train',
                    lastLine: null,
                    autoDetect: false
                };
            }
            return userSettings;
        }
        
        // Guardar configuraci√≥n del usuario
        function saveUserSettings() {
            userSettings.lastTransport = currentTransport;
            userSettings.lastLine = currentLine;
            userSettings.autoDetect = isAutoDetect;
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(userSettings));
        }
        
        // Verificar permisos al iniciar
        function checkLocationPermission() {
            loadUserSettings();
            
            // Verificar si ya se concedi√≥ permiso
            if (userSettings.locationPermission === 'granted') {
                initGPS();
                return true;
            }
            
            // Si se deneg√≥ anteriormente, mostrar mensaje
            if (userSettings.locationPermission === 'denied') {
                showPermissionModal();
                return false;
            }
            
            // Si es la primera vez, verificar si el navegador ya tiene permiso
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({name: 'geolocation'})
                    .then(permissionStatus => {
                        if (permissionStatus.state === 'granted') {
                            userSettings.locationPermission = 'granted';
                            saveUserSettings();
                            initGPS();
                        } else if (permissionStatus.state === 'denied') {
                            userSettings.locationPermission = 'denied';
                            saveUserSettings();
                            showPermissionModal();
                        } else {
                            showPermissionModal();
                        }
                        
                        // Escuchar cambios en el permiso
                        permissionStatus.onchange = function() {
                            if (this.state === 'granted') {
                                userSettings.locationPermission = 'granted';
                                saveUserSettings();
                                initGPS();
                            } else if (this.state === 'denied') {
                                userSettings.locationPermission = 'denied';
                                saveUserSettings();
                                stopGPS();
                            }
                        };
                    })
                    .catch(() => {
                        // Fallback para navegadores que no soportan permissions API
                        showPermissionModal();
                    });
            } else {
                // Fallback para navegadores antiguos
                showPermissionModal();
            }
            
            return false;
        }
        
        // Mostrar modal de permisos
        function showPermissionModal() {
            const modal = document.getElementById('permissionModal');
            modal.style.display = 'flex';
        }
        
        // Ocultar modal de permisos
        function hidePermissionModal() {
            const modal = document.getElementById('permissionModal');
            modal.style.display = 'none';
        }
        
        // Usuario permite acceso a ubicaci√≥n
        function allowLocationAccess() {
            userSettings.locationPermission = 'granted';
            saveUserSettings();
            hidePermissionModal();
            initGPS();
        }
        
        // Usuario deniega acceso a ubicaci√≥n
        function denyLocationAccess() {
            userSettings.locationPermission = 'denied';
            saveUserSettings();
            hidePermissionModal();
            
            // Mostrar ubicaci√≥n por defecto sin GPS
            map.setView([-34.6037, -58.3816], CONFIG.INITIAL_ZOOM);
            loadTransportLines('train');
            
            // Mostrar bot√≥n para reactivar
            document.getElementById('gpsReactivate').style.display = 'flex';
            updateGPSStatus('denied');
        }
        
        // Reactivar GPS despu√©s de denegar
        function reactivateGPS() {
            document.getElementById('gpsReactivate').style.display = 'none';
            checkLocationPermission();
        }
        
        // ============================================
        // SISTEMA GPS MEJORADO
        // ============================================
        
        // Iniciar GPS
        function initGPS() {
            if (!navigator.geolocation) {
                alert('Tu dispositivo no soporta geolocalizaci√≥n');
                updateGPSStatus('unsupported');
                return;
            }
            
            // Mostrar estado GPS
            updateGPSStatus('searching');
            document.getElementById('gpsReactivate').style.display = 'none';
            
            // Posici√≥n inicial por defecto (Centro de Buenos Aires)
            map.setView([-34.6037, -58.3816], CONFIG.INITIAL_ZOOM);
            
            // Cargar l√≠neas seg√∫n √∫ltima configuraci√≥n
            const lastTransport = userSettings.lastTransport || 'train';
            loadTransportLines(lastTransport);
            
            // Intentar cargar √∫ltima l√≠nea seleccionada
            if (userSettings.lastLine && stations[userSettings.lastLine]) {
                const lineData = findLineData(userSettings.lastLine);
                if (lineData) {
                    selectLine(userSettings.lastLine, lineData.name, lineData.color);
                }
            }
            
            // Activar seguimiento continuo
            startWatchingPosition();
            
            // Tambi√©n obtener posici√≥n actual una vez
            navigator.geolocation.getCurrentPosition(
                position => {
                    updatePosition(position);
                    map.setView([position.coords.latitude, position.coords.longitude], CONFIG.FOLLOW_ZOOM);
                    updateGPSStatus('active');
                },
                error => {
                    handleGPSError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: CONFIG.GPS_TIMEOUT,
                    maximumAge: 0
                }
            );
        }
        
        // Iniciar seguimiento continuo
        function startWatchingPosition() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    updatePosition(position);
                    updateMovementStats(position);
                    
                    // Detectar l√≠nea autom√°ticamente si est√° activado
                    if (isAutoDetect) {
                        autoDetectCurrentLine(
                            position.coords.latitude,
                            position.coords.longitude,
                            currentSpeed,
                            currentBearing
                        );
                    }
                    
                    // Actualizar estaciones cercanas
                    if (currentLine) {
                        updateStationProximity(
                            position.coords.latitude,
                            position.coords.longitude
                        );
                    }
                    
                    updateGPSStatus('active');
                },
                error => {
                    handleGPSError(error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: CONFIG.GPS_UPDATE_INTERVAL,
                    timeout: CONFIG.GPS_TIMEOUT
                }
            );
            
            gpsActive = true;
        }
        
        // Detener GPS
        function stopGPS() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            gpsActive = false;
            updateGPSStatus('inactive');
            document.getElementById('gpsReactivate').style.display = 'flex';
        }
        
        // Manejar errores de GPS
        function handleGPSError(error) {
            console.error('GPS Error:', error);
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    userSettings.locationPermission = 'denied';
                    saveUserSettings();
                    updateGPSStatus('denied');
                    document.getElementById('gpsReactivate').style.display = 'flex';
                    break;
                case error.POSITION_UNAVAILABLE:
                    updateGPSStatus('unavailable');
                    break;
                case error.TIMEOUT:
                    updateGPSStatus('timeout');
                    break;
                default:
                    updateGPSStatus('error');
            }
            
            // Mostrar ubicaci√≥n por defecto
            map.setView([-34.6037, -58.3816], CONFIG.INITIAL_ZOOM);
        }
        
        // Actualizar estado GPS en UI
        function updateGPSStatus(status) {
            const statusElement = document.getElementById('gpsStatus');
            const statusText = document.getElementById('gpsStatusText');
            const gpsDot = document.querySelector('.gps-dot');
            
            statusElement.style.display = 'flex';
            
            switch(status) {
                case 'searching':
                    statusText.textContent = 'Buscando GPS...';
                    gpsDot.style.background = '#FF9500';
                    gpsDot.classList.remove('active');
                    break;
                case 'active':
                    statusText.textContent = 'GPS Activo';
                    gpsDot.style.background = '#34C759';
                    gpsDot.classList.add('active');
                    break;
                case 'denied':
                    statusText.textContent = 'GPS Denegado';
                    gpsDot.style.background = '#FF3B30';
                    gpsDot.classList.remove('active');
                    break;
                case 'unavailable':
                    statusText.textContent = 'GPS No Disponible';
                    gpsDot.style.background = '#FF3B30';
                    gpsDot.classList.remove('active');
                    break;
                case 'timeout':
                    statusText.textContent = 'Tiempo de GPS Agotado';
                    gpsDot.style.background = '#FF9500';
                    gpsDot.classList.remove('active');
                    break;
                case 'error':
                    statusText.textContent = 'Error de GPS';
                    gpsDot.style.background = '#FF3B30';
                    gpsDot.classList.remove('active');
                    break;
                case 'inactive':
                    statusText.textContent = 'GPS Inactivo';
                    gpsDot.style.background = '#8E8E93';
                    gpsDot.classList.remove('active');
                    break;
                default:
                    statusText.textContent = 'Estado Desconocido';
                    gpsDot.style.background = '#8E8E93';
            }
        }
        
        // ============================================
        // FUNCIONES PRINCIPALES (mantener igual con peque√±as mejoras)
        // ============================================
        
        // Actualizar posici√≥n del usuario
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Crear o actualizar marcador de usuario
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background:#007AFF;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 4px 20px rgba(0,122,255,0.8);"></div>',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    })
                }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
            
            // Agregar a historial de ruta
            userTrack.push([lat, lng]);
            if (userTrack.length > 50) {
                userTrack.shift();
            }
            
            // Actualizar polil√≠nea de ruta
            if (trackPolyline) {
                map.removeLayer(trackPolyline);
            }
            if (userTrack.length > 1) {
                trackPolyline = L.polyline(userTrack, {
                    color: '#007AFF',
                    weight: 4,
                    opacity: 0.7,
                    className: 'user-track'
                }).addTo(map);
            }
            
            // Seguir al usuario suavemente
            map.panTo([lat, lng], {animate: true, duration: 0.5});
            
            lastPosition = position;
        }
        
        // Actualizar estad√≠sticas de movimiento
        function updateMovementStats(position) {
            if (!lastPosition) return;
            
            const lat1 = lastPosition.coords.latitude;
            const lng1 = lastPosition.coords.longitude;
            const lat2 = position.coords.latitude;
            const lng2 = position.coords.longitude;
            
            const distance = getDistance(lat1, lng1, lat2, lng2);
            const timeDiff = (position.timestamp - lastPosition.timestamp) / 1000;
            
            if (timeDiff > 0) {
                currentSpeed = (distance / timeDiff) * 3.6;
                document.getElementById('speedValue').textContent = 
                    currentSpeed.toFixed(1) + ' km/h';
                
                currentBearing = calculateBearing(lat1, lng1, lat2, lng2);
                updateDirectionDisplay(currentBearing, currentSpeed);
            }
            
            userHistory.push({
                lat: lat2,
                lng: lng2,
                speed: currentSpeed,
                bearing: currentBearing,
                timestamp: position.timestamp
            });
            
            if (userHistory.length > CONFIG.HISTORY_SIZE) {
                userHistory.shift();
            }
        }
        
        // Calcular rumbo
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                     Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
        
        // Actualizar direcci√≥n en UI
        function updateDirectionDisplay(bearing, speed) {
            const directionArrow = document.getElementById('directionArrow');
            const directionText = document.getElementById('directionText');
            
            let arrow = '‚Üí';
            let text = 'Norte';
            
            if (speed < 1) {
                arrow = '‚óè';
                text = 'Detenido';
            } else if (bearing >= 337.5 || bearing < 22.5) {
                arrow = '‚Üë';
                text = 'Norte';
            } else if (bearing >= 22.5 && bearing < 67.5) {
                arrow = '‚Üó';
                text = 'Noreste';
            } else if (bearing >= 67.5 && bearing < 112.5) {
                arrow = '‚Üí';
                text = 'Este';
            } else if (bearing >= 112.5 && bearing < 157.5) {
                arrow = '‚Üò';
                text = 'Sureste';
            } else if (bearing >= 157.5 && bearing < 202.5) {
                arrow = '‚Üì';
                text = 'Sur';
            } else if (bearing >= 202.5 && bearing < 247.5) {
                arrow = '‚Üô';
                text = 'Suroeste';
            } else if (bearing >= 247.5 && bearing < 292.5) {
                arrow = '‚Üê';
                text = 'Oeste';
            } else if (bearing >= 292.5 && bearing < 337.5) {
                arrow = '‚Üñ';
                text = 'Noroeste';
            }
            
            directionArrow.textContent = arrow;
            directionText.textContent = text;
        }
        
        // Cargar l√≠neas de transporte
        function selectTransport(transport) {
            currentTransport = transport;
            
            // Actualizar botones
            document.querySelectorAll('.transport-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const lineButtons = document.getElementById('lineButtons');
            lineButtons.innerHTML = '';
            
            transportLines[transport].forEach(line => {
                const button = document.createElement('button');
                button.className = 'line-btn';
                button.textContent = line.name;
                button.style.background = `rgba(${hexToRgb(line.color)}, 0.1)`;
                button.style.border = `1px solid ${line.color}`;
                button.onclick = () => selectLine(line.id, line.name, line.color);
                lineButtons.appendChild(button);
            });
            
            document.getElementById('lineSelector').style.display = 'block';
            isAutoDetect = false;
            document.getElementById('detectionMode').textContent = 'Manual';
            
            saveUserSettings();
        }
        
        function loadTransportLines(transport) {
            currentTransport = transport;
            const lineButtons = document.getElementById('lineButtons');
            lineButtons.innerHTML = '';
            
            transportLines[transport].forEach(line => {
                const button = document.createElement('button');
                button.className = 'line-btn';
                button.textContent = line.name;
                button.style.background = `rgba(${hexToRgb(line.color)}, 0.1)`;
                button.style.border = `1px solid ${line.color}`;
                button.onclick = () => selectLine(line.id, line.name, line.color);
                lineButtons.appendChild(button);
            });
            
            document.getElementById('lineSelector').style.display = 'block';
        }
        
        // Seleccionar l√≠nea
        function selectLine(lineId, lineName, lineColor) {
            currentLine = lineId;
            isAutoDetect = false;
            
            document.querySelectorAll('.line-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('lineSelector').style.display = 'none';
            
            loadStations(lineId, lineColor);
            document.getElementById('detectedLine').textContent = lineName;
            document.getElementById('detectionMode').textContent = 'Manual';
            
            if (lastPosition) {
                updateStationProximity(
                    lastPosition.coords.latitude,
                    lastPosition.coords.longitude
                );
            }
            
            saveUserSettings();
        }
        
        // Cargar estaciones
        function loadStations(lineId, lineColor) {
            stationMarkers.forEach(marker => map.removeLayer(marker));
            stationMarkers.clear();
            
            if (stations[lineId]) {
                stations[lineId].forEach((station, index) => {
                    const marker = L.marker([station.lat, station.lng], {
                        icon: L.divIcon({
                            className: 'station-marker',
                            html: `<div style="background:${lineColor};width:14px;height:14px;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    })
                    .bindPopup(`<b>${station.name}</b><br>Orden: ${index + 1}`)
                    .addTo(map);
                    
                    stationMarkers.set(station.name, {
                        marker: marker,
                        index: index,
                        data: station
                    });
                });
            }
        }
        
        // Encontrar datos de l√≠nea
        function findLineData(lineId) {
            for (const transport in transportLines) {
                const line = transportLines[transport].find(l => l.id === lineId);
                if (line) return line;
            }
            return null;
        }
        
        // Detectar l√≠nea autom√°ticamente
        function autoDetectLine() {
            isAutoDetect = true;
            document.getElementById('lineSelector').style.display = 'none';
            document.getElementById('detectionMode').textContent = 'Autom√°tico';
            
            if (lastPosition) {
                autoDetectCurrentLine(
                    lastPosition.coords.latitude,
                    lastPosition.coords.longitude,
                    currentSpeed,
                    currentBearing
                );
            }
            
            saveUserSettings();
        }
        
        function autoDetectCurrentLine(userLat, userLng, speed, bearing) {
            let bestMatch = null;
            let bestScore = 0;
            
            transportLines[currentTransport].forEach(line => {
                const lineScore = calculateLineMatchScore(
                    line.id,
                    userLat,
                    userLng,
                    speed,
                    bearing
                );
                
                if (lineScore > bestScore) {
                    bestScore = lineScore;
                    bestMatch = line;
                }
            });
            
            if (bestMatch && bestScore > 0.3 && currentLine !== bestMatch.id) {
                currentLine = bestMatch.id;
                loadStations(bestMatch.id, bestMatch.color);
                document.getElementById('detectedLine').textContent = bestMatch.name;
                
                if (lastPosition) {
                    updateStationProximity(
                        lastPosition.coords.latitude,
                        lastPosition.coords.longitude
                    );
                }
            }
        }
        
        function calculateLineMatchScore(lineId, userLat, userLng, speed, bearing) {
            if (!stations[lineId]) return 0;
            
            const lineStations = stations[lineId];
            let minDistance = Infinity;
            
            lineStations.forEach(station => {
                const distance = getDistance(userLat, userLng, station.lat, station.lng);
                if (distance < minDistance) minDistance = distance;
            });
            
            const proximityScore = Math.max(0, 1 - (minDistance / 1000));
            
            if (speed > 5 && userHistory.length > 2) {
                const alignmentScore = calculateAlignmentScore(lineId);
                return (proximityScore * 0.6) + (alignmentScore * 0.4);
            }
            
            return proximityScore;
        }
        
        function calculateAlignmentScore(lineId) {
            const lineStations = stations[lineId];
            if (!lineStations || lineStations.length < 2) return 0;
            
            let lineBearingSum = 0;
            for (let i = 1; i < lineStations.length; i++) {
                const bearing = calculateBearing(
                    lineStations[i-1].lat, lineStations[i-1].lng,
                    lineStations[i].lat, lineStations[i].lng
                );
                lineBearingSum += bearing;
            }
            const avgLineBearing = lineBearingSum / (lineStations.length - 1);
            
            let userBearingSum = 0;
            for (let i = 1; i < userHistory.length; i++) {
                const bearing = calculateBearing(
                    userHistory[i-1].lat, userHistory[i-1].lng,
                    userHistory[i].lat, userHistory[i].lng
                );
                userBearingSum += bearing;
            }
            const avgUserBearing = userBearingSum / (userHistory.length - 1);
            
            const bearingDiff = Math.abs(avgUserBearing - avgLineBearing) % 360;
            const diff = Math.min(bearingDiff, 360 - bearingDiff);
            
            return Math.max(0, 1 - (diff / 180));
        }
        
        // Actualizar proximidad a estaciones
        function updateStationProximity(userLat, userLng) {
            if (!currentLine || !stations[currentLine]) return;
            
            const lineStations = stations[currentLine];
            let currentStation = null;
            let currentDistance = Infinity;
            let currentIndex = -1;
            
            let nextStation = null;
            let nextDistance = Infinity;
            let nextIndex = -1;
            
            lineStations.forEach((station, index) => {
                const distance = getDistance(userLat, userLng, station.lat, station.lng);
                
                if (distance < currentDistance) {
                    if (currentStation && distance < CONFIG.STATION_PASS_THRESHOLD) {
                        if (lastStationPassed !== station.name) {
                            onStationPassed(station.name);
                        }
                    }
                    
                    currentDistance = distance;
                    currentStation = station;
                    currentIndex = index;
                }
            });
            
            if (!currentStation) return;
            
            const direction = determineTravelDirection(currentIndex);
            
            if (direction === 'forward' && currentIndex < lineStations.length - 1) {
                nextIndex = currentIndex + 1;
            } else if (direction === 'backward' && currentIndex > 0) {
                nextIndex = currentIndex - 1;
            }
            
            if (nextIndex >= 0) {
                nextStation = lineStations[nextIndex];
                nextDistance = getDistance(userLat, userLng, nextStation.lat, nextStation.lng);
            }
            
            updateStationMarkers(currentStation.name, nextStation ? nextStation.name : null);
            updateStationInfo(currentStation, currentDistance, nextStation, nextDistance);
        }
        
        function determineTravelDirection(currentIndex) {
            if (userHistory.length < 3) return 'forward';
            
            const recentPoints = userHistory.slice(-5);
            let avgLat = 0, avgLng = 0;
            recentPoints.forEach(point => {
                avgLat += point.lat;
                avgLng += point.lng;
            });
            avgLat /= recentPoints.length;
            avgLng /= recentPoints.length;
            
            return 'forward';
        }
        
        function updateStationMarkers(currentStationName, nextStationName) {
            stationMarkers.forEach((data, stationName) => {
                const marker = data.marker;
                marker._icon.classList.remove('current', 'next');
                
                if (stationName === currentStationName) {
                    marker._icon.classList.add('current');
                } else if (stationName === nextStationName) {
                    marker._icon.classList.add('next');
                }
            });
        }
        
        function updateStationInfo(currentStation, currentDist, nextStation, nextDist) {
            if (!currentStation) return;
            
            document.getElementById('currentStation').textContent = currentStation.name;
            document.getElementById('currentDistance').textContent = 
                Math.round(currentDist) + ' metros';
            
            if (nextStation) {
                document.getElementById('nextStation').textContent = nextStation.name;
                document.getElementById('nextDistance').textContent = 
                    Math.round(nextDist) + ' metros';
            } else {
                document.getElementById('nextStation').textContent = '-';
                document.getElementById('nextDistance').textContent = '-';
            }
        }
        
        function onStationPassed(stationName) {
            lastStationPassed = stationName;
            console.log(`Pas√≥ por la estaci√≥n: ${stationName}`);
            
            const stationData = stationMarkers.get(stationName);
            if (stationData) {
                stationData.marker._icon.classList.remove('current', 'next');
            }
        }
        
        // Funci√≥n de distancia
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Convertir hex a rgb
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
                '0, 0, 0';
        }
        
        // Iniciar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar mapa
            map.setView([-34.6037, -58.3816], CONFIG.INITIAL_ZOOM);
            
            // Verificar permisos
            setTimeout(() => {
                checkLocationPermission();
            }, 1000);
            
            // Manejar cambios de tama√±o de ventana
            window.addEventListener('resize', () => {
                map.invalidateSize();
            });
            
            // Guardar configuraci√≥n al cerrar
            window.addEventListener('beforeunload', () => {
                saveUserSettings();
            });
        });
    </script>
</body>
</html>