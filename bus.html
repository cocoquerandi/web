<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auditor√≠a GPS - Sistema Transporte P√∫blico CABA</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Papa Parse para CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        /* ===== RESET Y BASE ===== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #0f172a; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            touch-action: pan-x pan-y;
            color: #e2e8f0;
        }
        
        /* ===== MAPA ===== */
        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        /* ===== SOLAPAS LATERALES ===== */
        .tab-container {
            position: fixed;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tab-container.left {
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .tab-container.right {
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .tab-container.bottom {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: row;
        }
        
        .tab-button {
            width: 50px;
            height: 50px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 0 12px 12px 0;
            color: #94a3b8;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .tab-container.left .tab-button {
            border-radius: 0 12px 12px 0;
        }
        
        .tab-container.right .tab-button {
            border-radius: 12px 0 0 12px;
        }
        
        .tab-container.bottom .tab-button {
            border-radius: 12px 12px 0 0;
            width: 50px;
            height: 40px;
        }
        
        .tab-button:hover {
            background: rgba(30, 41, 59, 0.95);
            color: #3b82f6;
            width: 55px;
        }
        
        .tab-button.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
            width: 55px;
        }
        
        .tab-panel {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(100, 116, 139, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 999;
            transition: all 0.3s ease;
            overflow: hidden;
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .tab-panel.left {
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            height: 80vh;
            border-radius: 0 20px 20px 0;
        }
        
        .tab-panel.right {
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            height: 80vh;
            border-radius: 20px 0 0 20px;
        }
        
        .tab-panel.bottom {
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 90vw;
            max-width: 800px;
            height: 300px;
            border-radius: 20px 20px 0 0;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 41, 59, 0.5);
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-content {
            padding: 20px;
            height: calc(100% - 70px);
            overflow-y: auto;
        }
        
        /* ===== CONTENIDO DE PANELES ===== */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-item {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .status-item.gps {
            border-left-color: #3b82f6;
        }
        
        .status-item.recording {
            border-left-color: #ef4444;
        }
        
        .status-item.audit {
            border-left-color: #10b981;
        }
        
        .status-item.network {
            border-left-color: #8b5cf6;
        }
        
        .status-item.caba {
            border-left-color: #f59e0b;
        }
        
        .status-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-value {
            font-size: 20px;
            font-weight: 700;
            color: #f8fafc;
        }
        
        .status-subvalue {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Panel de Estaciones */
        .stations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .station-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .station-card:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(5px);
        }
        
        .station-card.current {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }
        
        .station-card.next {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .station-order {
            font-size: 12px;
            color: #94a3b8;
            background: rgba(100, 116, 139, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .station-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .station-metric {
            display: flex;
            flex-direction: column;
        }
        
        .metric-label {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .metric-value {
            font-size: 14px;
            font-weight: 700;
            color: #3b82f6;
        }
        
        /* Panel de Controles */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .control-button {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            padding: 15px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .control-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-color: #3b82f6;
        }
        
        .control-button.primary {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .control-button.warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .control-button.danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .control-button.success {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #10b981;
        }
        
        .control-icon {
            font-size: 24px;
        }
        
        .control-label {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        
        /* ===== INDICADOR DE VELOCIDAD FLOTANTE ===== */
        .speed-floating {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 15px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .speed-floating:hover {
            transform: scale(1.05);
        }
        
        .speed-label {
            font-size: 10px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .speed-value {
            font-size: 24px;
            font-weight: 800;
            color: #3b82f6;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        
        .speed-value.low {
            color: #10b981;
        }
        
        .speed-value.high {
            color: #ef4444;
        }
        
        .speed-direction {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ===== MODALES ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .modal-logo {
            font-size: 48px;
            color: #3b82f6;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 10px;
        }
        
        .modal-subtitle {
            font-size: 14px;
            color: #94a3b8;
        }
        
        /* ===== FORMULARIOS ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 10px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-input::placeholder {
            color: #64748b;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 10px;
            color: #f8fafc;
            font-size: 14px;
            cursor: pointer;
        }
        
        .form-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .form-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .form-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ===== MENSAJES Y NOTIFICACIONES ===== */
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #10b981;
            display: block;
        }
        
        .message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            display: block;
        }
        
        .message.warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid #f59e0b;
            color: #f59e0b;
            display: block;
        }
        
        .recording-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 18px;
            z-index: 1001;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.3);
            display: none;
            align-items: center;
            gap: 10px;
            animation: pulseRed 2s infinite;
        }
        
        .recording-notification.active {
            display: flex;
        }
        
        @keyframes pulseRed {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        
        /* ===== TOKEN DISPLAY ===== */
        .token-display {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #3b82f6;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            color: #cbd5e1;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .token-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .token-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            background: rgba(30, 41, 59, 0.7);
            color: #94a3b8;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .token-action-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-color: #3b82f6;
        }
        
        /* ===== TABLAS ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .data-table th {
            background: rgba(30, 41, 59, 0.7);
            padding: 10px;
            text-align: left;
            color: #94a3b8;
            font-weight: 600;
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.2);
            color: #e2e8f0;
        }
        
        .data-table tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        /* ===== LOADING ===== */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            display: none;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-text {
            color: #e2e8f0;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 3px;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .tab-panel.left,
            .tab-panel.right {
                width: 90vw;
                max-width: 320px;
                height: 70vh;
            }
            
            .tab-panel.bottom {
                width: 95vw;
                height: 250px;
            }
            
            .controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .speed-floating {
                bottom: 10px;
                left: 10px;
                padding: 10px;
                min-width: 100px;
            }
            
            .speed-value {
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .tab-button {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .tab-panel.left,
            .tab-panel.right {
                width: 95vw;
                height: 80vh;
                top: 10%;
                transform: none;
            }
            
            .tab-panel.left {
                left: 0;
                border-radius: 0 20px 20px 0;
            }
            
            .tab-panel.right {
                right: 0;
                border-radius: 20px 0 0 20px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .panel-content {
                padding: 15px;
            }
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .tab-panel.active {
            animation: slideIn 0.3s ease;
        }
        
        /* ===== CAPAS DEL MAPA ===== */
        .layer-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            min-width: 200px;
        }
        
        .layer-title {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .layer-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            cursor: pointer;
        }
        
        .layer-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .layer-checkbox.checked:after {
            content: '‚úì';
            color: #3b82f6;
            font-size: 12px;
        }
        
        .layer-label {
            font-size: 13px;
            color: #e2e8f0;
        }
        
        /* ===== ESTILOS PARA MARCADORES ===== */
        .bus-marker {
            background: #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        }
        
        .train-marker {
            background: #10b981;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
        }
        
        .station-marker {
            background: #f59e0b;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.8);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Cargando sistema...</div>
    </div>

    <!-- Modal de Autenticaci√≥n CABA -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-logo">
                    <i class="fas fa-bus"></i>
                </div>
                <div class="modal-title">API Transporte CABA</div>
                <div class="modal-subtitle">Autenticaci√≥n con OAuth 2.0</div>
            </div>
            
            <form id="authForm">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-user-circle"></i>
                        Client ID
                    </label>
                    <input type="text" 
                           class="form-input" 
                           id="clientId" 
                           placeholder="Ingresa tu Client ID"
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-key"></i>
                        Client Secret
                    </label>
                    <input type="password" 
                           class="form-input" 
                           id="clientSecret" 
                           placeholder="Ingresa tu Client Secret"
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-link"></i>
                        Endpoint de Autenticaci√≥n
                    </label>
                    <input type="text" 
                           class="form-input" 
                           id="authEndpoint" 
                           value="https://apitransporte.buenosaires.gob.ar/auth/token"
                           placeholder="URL del endpoint de autenticaci√≥n">
                </div>
                
                <button type="submit" class="form-button" id="authButton">
                    <span id="authButtonText">OBTENER ACCESS TOKEN</span>
                    <div class="spinner" id="authSpinner" style="display: none;"></div>
                </button>
            </form>
            
            <div class="message" id="authMessage"></div>
            
            <div class="token-display" id="tokenDisplay" style="display: none;">
                <strong>Token obtenido:</strong>
                <div id="tokenValue"></div>
                <div class="token-actions">
                    <button class="token-action-btn" onclick="copyTokenToClipboard()">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                    <button class="token-action-btn" onclick="testApiConnection()">
                        <i class="fas fa-plug"></i> Probar Conexi√≥n
                    </button>
                    <button class="token-action-btn" onclick="closeAuthModal()">
                        <i class="fas fa-check"></i> Continuar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n CABA -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-logo">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="modal-title">Configuraci√≥n API CABA</div>
                <div class="modal-subtitle">Endpoints y par√°metros</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-server"></i>
                    API Base URL
                </label>
                <input type="text" 
                       class="form-input" 
                       id="apiBaseUrl" 
                       value="https://apitransporte.buenosaires.gob.ar/"
                       placeholder="URL base de la API">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-sync-alt"></i>
                    Intervalo de Actualizaci√≥n
                </label>
                <select class="form-select" id="updateInterval">
                    <option value="10000">10 segundos</option>
                    <option value="30000" selected>30 segundos</option>
                    <option value="60000">1 minuto</option>
                    <option value="300000">5 minutos</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-layer-group"></i>
                    Capas a Mostrar
                </label>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label class="layer-option">
                        <div class="layer-checkbox checked" onclick="toggleLayer('buses')"></div>
                        <span class="layer-label">Colectivos</span>
                    </label>
                    <label class="layer-option">
                        <div class="layer-checkbox checked" onclick="toggleLayer('trains')"></div>
                        <span class="layer-label">Trenes</span>
                    </label>
                    <label class="layer-option">
                        <div class="layer-checkbox" onclick="toggleLayer('stations')"></div>
                        <span class="layer-label">Estaciones</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i>
                    Radio de B√∫squeda
                </label>
                <input type="range" 
                       class="form-input" 
                       id="searchRadius" 
                       min="500" 
                       max="5000" 
                       step="500" 
                       value="2000">
                <div style="text-align: center; color: #94a3b8; font-size: 12px; margin-top: 5px;">
                    Radio: <span id="radiusValue">2000</span> metros
                </div>
            </div>
            
            <div class="token-actions">
                <button class="token-action-btn" onclick="saveConfig()">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button class="token-action-btn" onclick="closeConfigModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Control de Capas -->
    <div class="layer-control">
        <div class="layer-title">
            <i class="fas fa-layer-group"></i>
            CAPAS DEL MAPA
        </div>
        <div class="layer-option" onclick="toggleMapLayer('buses')">
            <div class="layer-checkbox checked" id="layerBuses"></div>
            <span class="layer-label">Colectivos</span>
        </div>
        <div class="layer-option" onclick="toggleMapLayer('trains')">
            <div class="layer-checkbox checked" id="layerTrains"></div>
            <span class="layer-label">Trenes</span>
        </div>
        <div class="layer-option" onclick="toggleMapLayer('stations')">
            <div class="layer-checkbox" id="layerStations"></div>
            <span class="layer-label">Estaciones</span>
        </div>
        <div class="layer-option" onclick="toggleMapLayer('route')">
            <div class="layer-checkbox checked" id="layerRoute"></div>
            <span class="layer-label">Mi Ruta</span>
        </div>
    </div>
    
    <!-- Indicador de Velocidad -->
    <div class="speed-floating" id="speedFloating">
        <div class="speed-label">
            <i class="fas fa-tachometer-alt"></i>
            VELOCIDAD
        </div>
        <div class="speed-value" id="speedValue">0.0 km/h</div>
        <div class="speed-direction">
            <span id="directionArrow">‚Üí</span>
            <span id="directionText">NORTE</span>
        </div>
    </div>
    
    <!-- Notificaci√≥n de Grabaci√≥n -->
    <div class="recording-notification" id="recordingNotification">
        <i class="fas fa-circle"></i>
        <span>GRABANDO ACTIVO</span>
        <span id="recordingTime">00:00</span>
    </div>
    
    <!-- Solapas -->
    <div class="tab-container left">
        <button class="tab-button active" onclick="togglePanel('status')" title="Estado del Sistema">
            <i class="fas fa-chart-line"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('lines')" title="L√≠neas">
            <i class="fas fa-route"></i>
        </button>
        <button class="tab-button" onclick="openAuthModal()" title="API CABA">
            <i class="fas fa-database"></i>
        </button>
    </div>
    
    <div class="tab-container right">
        <button class="tab-button" onclick="togglePanel('stations')" title="Estaciones">
            <i class="fas fa-map-marker-alt"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('incidents')" title="Incidencias">
            <i class="fas fa-exclamation-triangle"></i>
        </button>
        <button class="tab-button" onclick="openConfigModal()" title="Configuraci√≥n">
            <i class="fas fa-cog"></i>
        </button>
    </div>
    
    <div class="tab-container bottom">
        <button class="tab-button" onclick="togglePanel('controls')" title="Controles">
            <i class="fas fa-sliders-h"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('data')" title="Datos">
            <i class="fas fa-table"></i>
        </button>
    </div>
    
    <!-- Paneles -->
    <!-- Panel de Estado -->
    <div class="tab-panel left active" id="panelStatus">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-chart-line"></i>
                ESTADO DEL SISTEMA
            </div>
            <button class="minimize-btn" onclick="togglePanel('status')">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="status-grid">
                <div class="status-item gps">
                    <div class="status-label">
                        <i class="fas fa-satellite"></i>
                        GPS
                    </div>
                    <div class="status-value" id="gpsStatusValue">ACTIVO</div>
                    <div class="status-subvalue" id="gpsAccuracy">Precisi√≥n: 10m</div>
                </div>
                
                <div class="status-item recording">
                    <div class="status-label">
                        <i class="fas fa-record-vinyl"></i>
                        GRABACI√ìN
                    </div>
                    <div class="status-value" id="recordingStatus">INACTIVA</div>
                    <div class="status-subvalue" id="recordingDuration">00:00:00</div>
                </div>
                
                <div class="status-item audit">
                    <div class="status-label">
                        <i class="fas fa-clipboard-check"></i>
                        AUDITOR√çA
                    </div>
                    <div class="status-value" id="auditStatus">ACTIVA</div>
                    <div class="status-subvalue" id="auditIncidents">0 incidencias</div>
                </div>
                
                <div class="status-item network">
                    <div class="status-label">
                        <i class="fas fa-wifi"></i>
                        CONEXI√ìN
                    </div>
                    <div class="status-value" id="networkStatus">ONLINE</div>
                    <div class="status-subvalue" id="networkLatency">Latencia: 50ms</div>
                </div>
                
                <div class="status-item caba">
                    <div class="status-label">
                        <i class="fas fa-database"></i>
                        API CABA
                    </div>
                    <div class="status-value" id="cabaStatus">NO CONECTADO</div>
                    <div class="status-subvalue" id="cabaToken">Token: --</div>
                </div>
                
                <div class="status-item" style="border-left-color: #ec4899;">
                    <div class="status-label">
                        <i class="fas fa-bus"></i>
                        VEH√çCULOS
                    </div>
                    <div class="status-value" id="vehiclesCount">0</div>
                    <div class="status-subvalue" id="lastUpdate">√öltima: --:--</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="status-label" style="margin-bottom: 10px;">
                    <i class="fas fa-history"></i>
                    √öLTIMOS EVENTOS
                </div>
                <div id="recentEvents" style="max-height: 150px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <!-- Panel de L√≠neas -->
    <div class="tab-panel left" id="panelLines">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-route"></i>
                L√çNEAS DE TRANSPORTE
            </div>
            <button class="minimize-btn" onclick="togglePanel('lines')">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="stations-list">
                <!-- L√≠neas se cargar√°n din√°micamente -->
            </div>
        </div>
    </div>
    
    <!-- Panel de Estaciones -->
    <div class="tab-panel right" id="panelStations">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-map-marker-alt"></i>
                ESTACIONES CERCANAS
            </div>
            <button class="minimize-btn" onclick="togglePanel('stations')">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="stations-list" id="stationsList">
                <!-- Estaciones se cargar√°n din√°micamente -->
            </div>
        </div>
    </div>
    
    <!-- Panel de Incidencias -->
    <div class="tab-panel right" id="panelIncidents">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-exclamation-triangle"></i>
                INCIDENCIAS
            </div>
            <button class="minimize-btn" onclick="togglePanel('incidents')">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="panel-content">
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; color: #f59e0b; margin-bottom: 10px;">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div style="font-size: 16px; color: #f8fafc; margin-bottom: 20px;">
                    No hay incidencias reportadas
                </div>
                <button class="control-button warning" onclick="reportIncident()">
                    <div class="control-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="control-label">REPORTAR INCIDENCIA</div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Panel de Controles -->
    <div class="tab-panel bottom" id="panelControls">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-sliders-h"></i>
                CONTROLES DE AUDITOR√çA
            </div>
            <button class="minimize-btn" onclick="togglePanel('controls')">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="controls-grid">
                <button class="control-button primary" onclick="toggleRecording()" id="recordingButton">
                    <div class="control-icon">
                        <i class="fas fa-circle" id="recordingIcon"></i>
                    </div>
                    <div class="control-label" id="recordingLabel">INICIAR GRABACI√ìN</div>
                </button>
                
                <button class="control-button" onclick="centerOnUser()">
                    <div class="control-icon">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                    <div class="control-label">CENTRAR MAPA</div>
                </button>
                
                <button class="control-button success" onclick="fetchCABAData()" id="cabaDataButton">
                    <div class="control-icon">
                        <i class="fas fa-bus" id="cabaDataIcon"></i>
                    </div>
                    <div class="control-label" id="cabaDataLabel">OBTENER DATOS CABA</div>
                </button>
                
                <button class="control-button warning" onclick="openCalibration()">
                    <div class="control-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="control-label">CALIBRAR SISTEMA</div>
                </button>
                
                <button class="control-button" onclick="generateReport()">
                    <div class="control-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <div class="control-label">GENERAR INFORME</div>
                </button>
                
                <button class="control-button" onclick="toggleBackgroundMode()" id="backgroundButton">
                    <div class="control-icon">
                        <i class="fas fa-mobile-alt" id="backgroundIcon"></i>
                    </div>
                    <div class="control-label" id="backgroundLabel">SEGUNDO PLANO: OFF</div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Panel de Datos -->
    <div class="tab-panel bottom" id="panelData">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-table"></i>
                DATOS EN TIEMPO REAL
            </div>
            <button class="minimize-btn" onclick="togglePanel('data')">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="panel-content">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="token-action-btn" onclick="showDataTable('vehicles')">
                    <i class="fas fa-bus"></i> Veh√≠culos
                </button>
                <button class="token-action-btn" onclick="showDataTable('stations')">
                    <i class="fas fa-map-marker-alt"></i> Estaciones
                </button>
                <button class="token-action-btn" onclick="showDataTable('events')">
                    <i class="fas fa-history"></i> Eventos
                </button>
            </div>
            <div id="dataTableContainer">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>L√≠nea</th>
                            <th>Velocidad</th>
                            <th>√öltima Actualizaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #94a3b8;">
                                No hay datos disponibles
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN DEL SISTEMA
        // ============================================
        const CONFIG = {
            // GPS
            GPS_UPDATE_INTERVAL: 2000,
            GPS_HIGH_ACCURACY: true,
            GPS_TIMEOUT: 10000,
            GPS_MIN_ACCURACY: 50,
            
            // SEGUNDO PLANO
            BACKGROUND_INTERVAL: 5000,
            BACKGROUND_ACCURACY: 100,
            
            // GRABACI√ìN
            RECORDING_INTERVAL: 3000,
            
            // API CABA
            CABA_AUTH_ENDPOINT: "https://apitransporte.buenosaires.gob.ar/auth/token",
            CABA_API_BASE: "https://apitransporte.buenosaires.gob.ar/",
            CABA_UPDATE_INTERVAL: 30000,
            
            // UI
            UI_UPDATE_INTERVAL: 1000,
            STATIONS_UPDATE_INTERVAL: 5000
        };
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map = null;
        let userMarker = null;
        let routePolyline = null;
        let busMarkers = L.layerGroup();
        let trainMarkers = L.layerGroup();
        let stationMarkers = L.layerGroup();
        
        // Estado del sistema
        let currentLine = null;
        let isRecording = false;
        let isBackgroundMode = false;
        let activePanel = 'status';
        
        // Datos GPS
        let currentPosition = null;
        let currentSpeed = 0;
        let currentBearing = 0;
        let currentAccuracy = 0;
        
        // Grabaci√≥n
        let recordingStartTime = null;
        let recordingTimer = null;
        let recordingDuration = 0;
        let recordingData = [];
        
        // API CABA
        let cabaAccessToken = null;
        let cabaTokenExpiry = null;
        let cabaClientId = null;
        let cabaDataInterval = null;
        let lastCABAData = [];
        
        // Capas visibles
        let visibleLayers = {
            buses: true,
            trains: true,
            stations: false,
            route: true
        };
        
        // Base de datos local
        const TRANSPORT_LINES = {
            buses: [
                {id: '64', name: 'L√≠nea 64', color: '#3b82f6', type: 'bus'},
                {id: '39', name: 'L√≠nea 39', color: '#10b981', type: 'bus'},
                {id: '152', name: 'L√≠nea 152', color: '#8b5cf6', type: 'bus'},
                {id: '76', name: 'L√≠nea 76', color: '#f59e0b', type: 'bus'}
            ],
            trains: [
                {id: 'sarmiento', name: 'Sarmiento', color: '#ef4444', type: 'train'},
                {id: 'mitre', name: 'Mitre', color: '#3b82f6', type: 'train'},
                {id: 'roca', name: 'Roca', color: '#10b981', type: 'train'},
                {id: 'belgrano', name: 'Belgrano', color: '#8b5cf6', type: 'train'}
            ]
        };
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading('Inicializando sistema...');
            
            // Cargar configuraci√≥n guardada
            loadSavedConfig();
            
            // Inicializar mapa
            await initMap();
            
            // Verificar token CABA
            checkSavedToken();
            
            // Iniciar GPS
            setTimeout(() => startGPS(), 500);
            
            // Configurar paneles iniciales
            showPanel('status');
            
            // Actualizar l√≠neas en panel
            updateLinesPanel();
            
            // Cargar datos iniciales
            await loadInitialData();
            
            hideLoading();
            addEvent('Sistema inicializado correctamente', 'success');
            
            console.log('üöÄ Sistema de Auditor√≠a CABA inicializado');
        });
        
        function showLoading(message) {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        // ============================================
        // SISTEMA DE MAPA
        // ============================================
        function initMap() {
            return new Promise((resolve) => {
                map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    preferCanvas: true
                });
                
                // Mapa oscuro profesional
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© CARTO',
                    maxZoom: 19,
                    minZoom: 10
                }).addTo(map);
                
                // Vista inicial de Buenos Aires
                map.setView([-34.6037, -58.3816], 13);
                
                // Agregar capas
                busMarkers.addTo(map);
                trainMarkers.addTo(map);
                stationMarkers.addTo(map);
                
                resolve();
            });
        }
        
        // ============================================
        // AUTENTICACI√ìN API CABA
        // ============================================
        function loadSavedConfig() {
            const savedConfig = localStorage.getItem('audit_config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                if (config.apiBaseUrl) CONFIG.CABA_API_BASE = config.apiBaseUrl;
                if (config.updateInterval) CONFIG.CABA_UPDATE_INTERVAL = parseInt(config.updateInterval);
                if (config.layers) visibleLayers = config.layers;
                
                // Actualizar controles de capas
                updateLayerControls();
            }
        }
        
        function saveConfig() {
            const config = {
                apiBaseUrl: document.getElementById('apiBaseUrl').value,
                updateInterval: document.getElementById('updateInterval').value,
                layers: visibleLayers
            };
            
            localStorage.setItem('audit_config', JSON.stringify(config));
            
            CONFIG.CABA_API_BASE = config.apiBaseUrl;
            CONFIG.CABA_UPDATE_INTERVAL = parseInt(config.updateInterval);
            
            // Reiniciar intervalo si existe
            if (cabaDataInterval) {
                clearInterval(cabaDataInterval);
                startCABADataPolling();
            }
            
            showMessage('Configuraci√≥n guardada correctamente', 'success');
            closeConfigModal();
        }
        
        function checkSavedToken() {
            const savedToken = localStorage.getItem('caba_access_token');
            const savedExpiry = localStorage.getItem('caba_token_expiry');
            const savedClientId = localStorage.getItem('caba_client_id');
            
            if (savedToken && savedExpiry && Date.now() < parseInt(savedExpiry)) {
                cabaAccessToken = savedToken;
                cabaTokenExpiry = parseInt(savedExpiry);
                cabaClientId = savedClientId;
                
                updateCABAStatus('connected');
                addEvent('Token CABA restaurado desde almacenamiento local', 'success');
                
                // Iniciar polling de datos
                startCABADataPolling();
            } else {
                if (savedToken) {
                    localStorage.removeItem('caba_access_token');
                    localStorage.removeItem('caba_token_expiry');
                    localStorage.removeItem('caba_client_id');
                }
                updateCABAStatus('disconnected');
            }
        }
        
        async function authenticateCABA(event) {
            event.preventDefault();
            
            const clientId = document.getElementById('clientId').value.trim();
            const clientSecret = document.getElementById('clientSecret').value.trim();
            const authEndpoint = document.getElementById('authEndpoint').value.trim();
            
            if (!clientId || !clientSecret) {
                showMessage('Por favor, completa todos los campos', 'error');
                return;
            }
            
            const authButton = document.getElementById('authButton');
            const authButtonText = document.getElementById('authButtonText');
            const authSpinner = document.getElementById('authSpinner');
            
            authButton.disabled = true;
            authButtonText.textContent = 'OBTENIENDO TOKEN...';
            authSpinner.style.display = 'inline-block';
            
            try {
                const formData = new URLSearchParams();
                formData.append('grant_type', 'client_credentials');
                formData.append('client_id', clientId);
                formData.append('client_secret', clientSecret);
                formData.append('scope', 'transport');
                
                const response = await fetch(authEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData.toString()
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error_description || 'Error en la autenticaci√≥n');
                }
                
                // Guardar token
                cabaAccessToken = data.access_token;
                cabaClientId = clientId;
                
                const expiresIn = data.expires_in || 3600;
                cabaTokenExpiry = Date.now() + (expiresIn * 1000);
                
                localStorage.setItem('caba_access_token', cabaAccessToken);
                localStorage.setItem('caba_token_expiry', cabaTokenExpiry.toString());
                localStorage.setItem('caba_client_id', cabaClientId);
                localStorage.setItem('caba_client_secret', clientSecret);
                
                // Actualizar UI
                updateCABAStatus('connected');
                showTokenDisplay(data.access_token);
                showMessage('¬°Autenticaci√≥n exitosa! Token obtenido correctamente', 'success');
                addEvent('Autenticaci√≥n con API CABA exitosa', 'success');
                
                // Iniciar polling de datos
                startCABADataPolling();
                
            } catch (error) {
                console.error('Error en autenticaci√≥n CABA:', error);
                showMessage(`Error: ${error.message}`, 'error');
                addEvent(`Error de autenticaci√≥n: ${error.message}`, 'error');
            } finally {
                authButton.disabled = false;
                authButtonText.textContent = 'OBTENER ACCESS TOKEN';
                authSpinner.style.display = 'none';
            }
        }
        
        function startCABADataPolling() {
            // Limpiar intervalo anterior si existe
            if (cabaDataInterval) {
                clearInterval(cabaDataInterval);
            }
            
            // Obtener datos inmediatamente
            fetchCABAData();
            
            // Configurar intervalo peri√≥dico
            cabaDataInterval = setInterval(() => {
                fetchCABAData();
            }, CONFIG.CABA_UPDATE_INTERVAL);
            
            addEvent(`Polling de datos CABA iniciado (${CONFIG.CABA_UPDATE_INTERVAL/1000}s)`, 'success');
        }
        
        // ============================================
        // OBTENCI√ìN DE DATOS CABA
        // ============================================
        async function fetchCABAData() {
            if (!cabaAccessToken) {
                showMessage('Primero debes autenticarte con la API CABA', 'error');
                openAuthModal();
                return;
            }
            
            if (Date.now() >= cabaTokenExpiry) {
                showMessage('El token ha expirado. Renueva la autenticaci√≥n', 'error');
                updateCABAStatus('expired');
                openAuthModal();
                return;
            }
            
            try {
                // Ejemplo: Obtener datos de colectivos
                // Nota: Esto depende de la estructura real de la API CABA
                const response = await fetch(
                    `${CONFIG.CABA_API_BASE}colectivos/vehiclePositionsSimple?client_id=${cabaClientId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${cabaAccessToken}`,
                            'Accept': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                lastCABAData = Array.isArray(data) ? data : (data.vehicles || []);
                
                // Actualizar UI
                document.getElementById('vehiclesCount').textContent = lastCABAData.length;
                document.getElementById('lastUpdate').textContent = 
                    `√öltima: ${new Date().toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'})}`;
                
                // Procesar y mostrar datos
                processTransportData(lastCABAData);
                
                // Actualizar tabla de datos
                updateDataTable();
                
                addEvent(`Datos CABA actualizados: ${lastCABAData.length} veh√≠culos`, 'success');
                
            } catch (error) {
                console.error('Error al obtener datos CABA:', error);
                addEvent(`Error al obtener datos: ${error.message}`, 'error');
            }
        }
        
        function processTransportData(vehicles) {
            // Limpiar marcadores existentes
            busMarkers.clearLayers();
            trainMarkers.clearLayers();
            
            if (!vehicles || !Array.isArray(vehicles)) return;
            
            vehicles.forEach(vehicle => {
                if (!vehicle.latitud || !vehicle.longitud) return;
                
                // Determinar tipo de veh√≠culo
                const isTrain = vehicle.linea && vehicle.linea.toLowerCase().includes('tren');
                const markerGroup = isTrain ? trainMarkers : busMarkers;
                const iconClass = isTrain ? 'train-marker' : 'bus-marker';
                const lineColor = getLineColor(vehicle.linea);
                
                // Crear marcador
                const marker = L.marker([vehicle.latitud, vehicle.longitud], {
                    icon: L.divIcon({
                        className: 'transport-marker',
                        html: `<div class="${iconClass}" style="background:${lineColor}"></div>`,
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    })
                });
                
                // Tooltip con informaci√≥n
                const tooltipContent = `
                    <strong>L√≠nea: ${vehicle.linea || 'N/A'}</strong><br>
                    ID: ${vehicle.id || vehicle.vehicle_id || 'N/A'}<br>
                    Velocidad: ${vehicle.velocidad || '0'} km/h<br>
                    Actualizado: ${vehicle.timestamp ? new Date(vehicle.timestamp).toLocaleTimeString() : 'N/A'}
                `;
                
                marker.bindTooltip(tooltipContent);
                marker.addTo(markerGroup);
            });
        }
        
        function getLineColor(lineId) {
            // Buscar en buses
            const busLine = TRANSPORT_LINES.buses.find(b => b.id === lineId);
            if (busLine) return busLine.color;
            
            // Buscar en trenes
            const trainLine = TRANSPORT_LINES.trains.find(t => t.id === lineId);
            if (trainLine) return trainLine.color;
            
            // Color por defecto
            return '#3b82f6';
        }
        
        // ============================================
        // SISTEMA GPS
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                alert("Tu dispositivo no soporta GPS");
                return;
            }
            
            updateGPSStatus('searching');
            
            navigator.geolocation.watchPosition(
                position => handleGPSPosition(position),
                error => handleGPSError(error),
                {
                    enableHighAccuracy: CONFIG.GPS_HIGH_ACCURACY,
                    maximumAge: CONFIG.GPS_UPDATE_INTERVAL,
                    timeout: CONFIG.GPS_TIMEOUT
                }
            );
        }
        
        function handleGPSPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed;
            const heading = position.coords.heading;
            
            currentPosition = { lat, lng };
            currentAccuracy = accuracy;
            
            if (speed !== null && speed >= 0) {
                currentSpeed = speed * 3.6;
            }
            
            if (heading !== null && heading >= 0) {
                currentBearing = heading;
            }
            
            updateGPSStatus('active');
            updateSpeedDisplay();
            updateDirectionDisplay();
            updateUserPosition(lat, lng);
            
            if (isRecording) {
                recordPosition(lat, lng, speed);
            }
            
            updateNearbyStations(lat, lng);
        }
        
        function updateUserPosition(lat, lng) {
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'audit-marker',
                        html: '<div style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 15px rgba(59, 130, 246, 0.9);"></div>',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    })
                }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
            
            updateRoute(lat, lng);
        }
        
        function updateRoute(lat, lng) {
            if (!routePolyline) {
                routePolyline = L.polyline([[lat, lng]], {
                    color: '#3b82f6',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
            } else {
                const currentPath = routePolyline.getLatLngs();
                currentPath.push([lat, lng]);
                
                if (currentPath.length > 100) {
                    currentPath.shift();
                }
                
                routePolyline.setLatLngs(currentPath);
            }
        }
        
        // ============================================
        // GRABACI√ìN Y AUDITOR√çA
        // ============================================
        function toggleRecording() {
            if (!currentPosition) {
                alert("Esperando se√±al GPS...");
                return;
            }
            
            isRecording = !isRecording;
            
            const button = document.getElementById('recordingButton');
            const icon = document.getElementById('recordingIcon');
            const label = document.getElementById('recordingLabel');
            const status = document.getElementById('recordingStatus');
            
            if (isRecording) {
                recordingStartTime = Date.now();
                recordingDuration = 0;
                recordingData = [];
                
                button.classList.add('danger');
                icon.className = 'fas fa-square';
                label.textContent = 'DETENER GRABACI√ìN';
                status.textContent = 'ACTIVA';
                
                recordingTimer = setInterval(updateRecordingDisplay, 1000);
                
                if (document.hidden) {
                    document.getElementById('recordingNotification').classList.add('active');
                }
                
                addEvent('GRABACI√ìN INICIADA', 'success');
            } else {
                button.classList.remove('danger');
                icon.className = 'fas fa-circle';
                label.textContent = 'INICIAR GRABACI√ìN';
                status.textContent = 'INACTIVA';
                
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                document.getElementById('recordingNotification').classList.remove('active');
                
                addEvent('GRABACI√ìN DETENIDA', 'info');
                saveRecording();
            }
        }
        
        function recordPosition(lat, lng, speed) {
            const dataPoint = {
                timestamp: Date.now(),
                lat: lat,
                lng: lng,
                speed: currentSpeed,
                accuracy: currentAccuracy,
                bearing: currentBearing,
                line: currentLine
            };
            
            recordingData.push(dataPoint);
        }
        
        function updateRecordingDisplay() {
            if (!isRecording) return;
            
            recordingDuration = Date.now() - recordingStartTime;
            
            const hours = Math.floor(recordingDuration / 3600000);
            const minutes = Math.floor((recordingDuration % 3600000) / 60000);
            const seconds = Math.floor((recordingDuration % 60000) / 1000);
            
            const timeString = 
                hours.toString().padStart(2, '0') + ':' +
                minutes.toString().padStart(2, '0') + ':' +
                seconds.toString().padStart(2, '0');
            
            document.getElementById('recordingDuration').textContent = timeString;
            document.getElementById('recordingTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function saveRecording() {
            const recordingSession = {
                startTime: recordingStartTime,
                endTime: Date.now(),
                duration: recordingDuration,
                data: recordingData,
                line: currentLine,
                totalPoints: recordingData.length
            };
            
            localStorage.setItem('lastRecording', JSON.stringify(recordingSession));
            
            const history = JSON.parse(localStorage.getItem('recordingHistory') || '[]');
            history.push(recordingSession);
            localStorage.setItem('recordingHistory', JSON.stringify(history.slice(-10)));
        }
        
        // ============================================
        // INTERFAZ DE USUARIO
        // ============================================
        function togglePanel(panelId) {
            if (activePanel === panelId) {
                document.getElementById('panel' + capitalizeFirstLetter(activePanel)).classList.remove('active');
                document.querySelector(`[onclick="togglePanel('${activePanel}')"]`).classList.remove('active');
                activePanel = null;
                return;
            }
            
            if (activePanel) {
                document.getElementById('panel' + capitalizeFirstLetter(activePanel)).classList.remove('active');
                document.querySelector(`[onclick="togglePanel('${activePanel}')"]`).classList.remove('active');
            }
            
            showPanel(panelId);
        }
        
        function showPanel(panelId) {
            activePanel = panelId;
            document.getElementById('panel' + capitalizeFirstLetter(panelId)).classList.add('active');
            document.querySelector(`[onclick="togglePanel('${panelId}')"]`).classList.add('active');
        }
        
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        function updateSpeedDisplay() {
            const speedElement = document.getElementById('speedValue');
            speedElement.textContent = currentSpeed.toFixed(1) + ' km/h';
            
            speedElement.className = 'speed-value';
            if (currentSpeed < 5) {
                speedElement.classList.add('low');
            } else if (currentSpeed > 60) {
                speedElement.classList.add('high');
            }
        }
        
        function updateDirectionDisplay() {
            const arrow = document.getElementById('directionArrow');
            const text = document.getElementById('directionText');
            
            if (currentSpeed < 1) {
                arrow.textContent = '‚óè';
                text.textContent = 'DETENIDO';
                arrow.style.transform = 'rotate(0deg)';
                return;
            }
            
            let direction = 'NORTE';
            let arrowChar = '‚Üë';
            
            if (currentBearing >= 337.5 || currentBearing < 22.5) {
                direction = 'NORTE'; arrowChar = '‚Üë';
            } else if (currentBearing >= 22.5 && currentBearing < 67.5) {
                direction = 'NORESTE'; arrowChar = '‚Üó';
            } else if (currentBearing >= 67.5 && currentBearing < 112.5) {
                direction = 'ESTE'; arrowChar = '‚Üí';
            } else if (currentBearing >= 112.5 && currentBearing < 157.5) {
                direction = 'SURESTE'; arrowChar = '‚Üò';
            } else if (currentBearing >= 157.5 && currentBearing < 202.5) {
                direction = 'SUR'; arrowChar = '‚Üì';
            } else if (currentBearing >= 202.5 && currentBearing < 247.5) {
                direction = 'SUROESTE'; arrowChar = '‚Üô';
            } else if (currentBearing >= 247.5 && currentBearing < 292.5) {
                direction = 'OESTE'; arrowChar = '‚Üê';
            } else if (currentBearing >= 292.5 && currentBearing < 337.5) {
                direction = 'NOROESTE'; arrowChar = '‚Üñ';
            }
            
            arrow.textContent = arrowChar;
            text.textContent = direction;
            arrow.style.transform = `rotate(${currentBearing}deg)`;
        }
        
        function updateGPSStatus(status) {
            const element = document.getElementById('gpsStatusValue');
            const accuracyElement = document.getElementById('gpsAccuracy');
            
            switch(status) {
                case 'searching':
                    element.textContent = 'BUSCANDO';
                    element.style.color = '#f59e0b';
                    break;
                case 'active':
                    element.textContent = 'ACTIVO';
                    element.style.color = '#10b981';
                    accuracyElement.textContent = `Precisi√≥n: ${Math.round(currentAccuracy)}m`;
                    break;
                case 'error':
                    element.textContent = 'ERROR';
                    element.style.color = '#ef4444';
                    break;
            }
        }
        
        function updateCABAStatus(status) {
            const element = document.getElementById('cabaStatus');
            const tokenElement = document.getElementById('cabaToken');
            
            switch(status) {
                case 'connected':
                    element.textContent = 'CONECTADO';
                    element.style.color = '#10b981';
                    const timeLeft = Math.max(0, Math.floor((cabaTokenExpiry - Date.now()) / 60000));
                    tokenElement.textContent = `Expira en: ${timeLeft} min`;
                    break;
                    
                case 'disconnected':
                    element.textContent = 'NO CONECTADO';
                    element.style.color = '#ef4444';
                    tokenElement.textContent = 'Token: --';
                    break;
                    
                case 'expired':
                    element.textContent = 'TOKEN EXPIRADO';
                    element.style.color = '#f59e0b';
                    tokenElement.textContent = 'Renovar token';
                    break;
            }
        }
        
        function addEvent(message, type = 'info') {
            const eventsList = document.getElementById('recentEvents');
            const time = new Date().toLocaleTimeString('es-AR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'error') icon = '‚ùå';
            
            const eventDiv = document.createElement('div');
            eventDiv.style.cssText = `
                padding: 8px 12px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                margin-bottom: 8px;
                font-size: 12px;
                border-left: 3px solid ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            
            eventDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <span>${icon} ${message}</span>
                    <span style="color: #64748b;">${time}</span>
                </div>
            `;
            
            eventsList.insertBefore(eventDiv, eventsList.firstChild);
            
            if (eventsList.children.length > 5) {
                eventsList.removeChild(eventsList.lastChild);
            }
        }
        
        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        async function loadInitialData() {
            // Cargar datos de l√≠neas desde CSV local si existe
            try {
                const response = await fetch('data/transport_lines.csv');
                if (response.ok) {
                    const csvData = await response.text();
                    parseTransportData(csvData);
                }
            } catch (e) {
                console.log('Usando datos de l√≠neas por defecto');
            }
        }
        
        function parseTransportData(csvData) {
            Papa.parse(csvData, {
                header: true,
                complete: function(results) {
                    // Procesar resultados si es necesario
                    console.log('Datos de transporte cargados:', results.data.length);
                }
            });
        }
        
        function updateLinesPanel() {
            const linesList = document.querySelector('#panelLines .stations-list');
            linesList.innerHTML = '';
            
            // Agregar l√≠neas de buses
            TRANSPORT_LINES.buses.forEach(line => {
                const lineCard = createLineCard(line);
                linesList.appendChild(lineCard);
            });
            
            // Agregar l√≠neas de trenes
            TRANSPORT_LINES.trains.forEach(line => {
                const lineCard = createLineCard(line);
                linesList.appendChild(lineCard);
            });
        }
        
        function createLineCard(line) {
            const div = document.createElement('div');
            div.className = 'station-card';
            div.onclick = () => selectLine(line.id);
            
            div.innerHTML = `
                <div class="station-header">
                    <div class="station-name">${line.name}</div>
                    <div class="station-order">${line.type.toUpperCase()}</div>
                </div>
                <div class="station-metrics">
                    <div class="station-metric">
                        <div class="metric-label">Estado</div>
                        <div class="metric-value" style="color:#10b981;">OPERATIVO</div>
                    </div>
                    <div class="station-metric">
                        <div class="metric-label">Veh√≠culos</div>
                        <div class="metric-value">--</div>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        function updateNearbyStations(lat, lng) {
            // Esta funci√≥n se implementar√≠a con datos reales de estaciones
            // Por ahora muestra datos de ejemplo
            const stationsList = document.getElementById('stationsList');
            
            // Datos de ejemplo
            const stations = [
                {name: 'Plaza de Mayo', distance: 850, eta: 5},
                {name: 'Retiro', distance: 1200, eta: 8},
                {name: 'Once', distance: 1800, eta: 12},
                {name: 'Constituci√≥n', distance: 2400, eta: 15}
            ];
            
            stationsList.innerHTML = '';
            
            stations.forEach((station, index) => {
                const div = document.createElement('div');
                div.className = `station-card ${index === 0 ? 'current' : index === 1 ? 'next' : ''}`;
                
                div.innerHTML = `
                    <div class="station-header">
                        <div class="station-name">${station.name}</div>
                        <div class="station-order">${index + 1}</div>
                    </div>
                    <div class="station-metrics">
                        <div class="station-metric">
                            <div class="metric-label">Distancia</div>
                            <div class="metric-value">${station.distance} m</div>
                        </div>
                        <div class="station-metric">
                            <div class="metric-label">ETA</div>
                            <div class="metric-value">${station.eta} min</div>
                        </div>
                    </div>
                `;
                
                stationsList.appendChild(div);
            });
        }
        
        function updateDataTable() {
            const tableBody = document.getElementById('dataTableBody');
            
            if (!lastCABAData || lastCABAData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #94a3b8;">
                            No hay datos disponibles
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Mostrar solo los primeros 10 veh√≠culos
            const vehiclesToShow = lastCABAData.slice(0, 10);
            
            tableBody.innerHTML = vehiclesToShow.map(vehicle => `
                <tr>
                    <td>${vehicle.id || vehicle.vehicle_id || 'N/A'}</td>
                    <td>${vehicle.linea || 'N/A'}</td>
                    <td>${vehicle.velocidad || '0'} km/h</td>
                    <td>${vehicle.timestamp ? new Date(vehicle.timestamp).toLocaleTimeString() : 'N/A'}</td>
                </tr>
            `).join('');
        }
        
        // ============================================
        // CONTROL DE CAPAS
        // ============================================
        function toggleMapLayer(layer) {
            visibleLayers[layer] = !visibleLayers[layer];
            
            // Actualizar checkbox
            const checkbox = document.getElementById(`layer${capitalizeFirstLetter(layer)}`);
            checkbox.classList.toggle('checked', visibleLayers[layer]);
            
            // Mostrar/ocultar capa en el mapa
            switch(layer) {
                case 'buses':
                    if (visibleLayers.buses) {
                        map.addLayer(busMarkers);
                    } else {
                        map.removeLayer(busMarkers);
                    }
                    break;
                    
                case 'trains':
                    if (visibleLayers.trains) {
                        map.addLayer(trainMarkers);
                    } else {
                        map.removeLayer(trainMarkers);
                    }
                    break;
                    
                case 'stations':
                    if (visibleLayers.stations) {
                        map.addLayer(stationMarkers);
                    } else {
                        map.removeLayer(stationMarkers);
                    }
                    break;
                    
                case 'route':
                    if (visibleLayers.route) {
                        map.addLayer(routePolyline);
                    } else {
                        map.removeLayer(routePolyline);
                    }
                    break;
            }
            
            // Guardar preferencias
            const config = JSON.parse(localStorage.getItem('audit_config') || '{}');
            config.layers = visibleLayers;
            localStorage.setItem('audit_config', JSON.stringify(config));
        }
        
        function updateLayerControls() {
            Object.keys(visibleLayers).forEach(layer => {
                const checkbox = document.getElementById(`layer${capitalizeFirstLetter(layer)}`);
                if (checkbox) {
                    checkbox.classList.toggle('checked', visibleLayers[layer]);
                }
            });
        }
        
        // ============================================
        // FUNCIONES DE MODALES
        // ============================================
        function openAuthModal() {
            document.getElementById('authModal').classList.add('active');
            
            const savedClientId = localStorage.getItem('caba_client_id');
            const savedClientSecret = localStorage.getItem('caba_client_secret');
            
            if (savedClientId) {
                document.getElementById('clientId').value = savedClientId;
            }
            if (savedClientSecret) {
                document.getElementById('clientSecret').value = savedClientSecret;
            }
        }
        
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }
        
        function openConfigModal() {
            document.getElementById('configModal').classList.add('active');
            
            document.getElementById('apiBaseUrl').value = CONFIG.CABA_API_BASE;
            document.getElementById('updateInterval').value = CONFIG.CABA_UPDATE_INTERVAL.toString();
            document.getElementById('searchRadius').value = 2000;
            document.getElementById('radiusValue').textContent = '2000';
        }
        
        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }
        
        function showTokenDisplay(token) {
            const tokenDisplay = document.getElementById('tokenDisplay');
            const tokenValue = document.getElementById('tokenValue');
            
            const tokenPreview = token.length > 50 
                ? `${token.substring(0, 25)}...${token.substring(token.length - 25)}`
                : token;
            
            tokenValue.textContent = tokenPreview;
            tokenDisplay.style.display = 'block';
        }
        
        function showMessage(message, type) {
            const messageElement = document.getElementById('authMessage');
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    messageElement.className = 'message';
                }, 5000);
            }
        }
        
        // ============================================
        // FUNCIONES UTILITARIAS
        // ============================================
        function copyTokenToClipboard() {
            if (!cabaAccessToken) return;
            
            navigator.clipboard.writeText(cabaAccessToken).then(() => {
                showMessage('Token copiado al portapapeles', 'success');
                addEvent('Token CABA copiado al portapapeles', 'info');
            }).catch(err => {
                console.error('Error al copiar:', err);
            });
        }
        
        async function testApiConnection() {
            if (!cabaAccessToken) {
                showMessage('Primero debes obtener un token', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.CABA_API_BASE}lineas`, {
                    headers: {
                        'Authorization': `Bearer ${cabaAccessToken}`
                    }
                });
                
                if (response.ok) {
                    showMessage('¬°Conexi√≥n exitosa! La API est√° respondiendo correctamente', 'success');
                    addEvent('Prueba de conexi√≥n API CABA exitosa', 'success');
                } else {
                    throw new Error(`C√≥digo de error: ${response.status}`);
                }
            } catch (error) {
                showMessage(`Error de conexi√≥n: ${error.message}`, 'error');
                addEvent(`Error en prueba de conexi√≥n API: ${error.message}`, 'error');
            }
        }
        
        function centerOnUser() {
            if (currentPosition) {
                map.setView([currentPosition.lat, currentPosition.lng], 16, {
                    animate: true,
                    duration: 0.5
                });
                addEvent('Mapa centrado en posici√≥n actual', 'info');
            }
        }
        
        function selectLine(lineId) {
            currentLine = lineId;
            addEvent(`L√≠nea seleccionada: ${lineId.toUpperCase()}`, 'info');
        }
        
        function reportIncident() {
            const incident = prompt('Describa la incidencia:');
            if (incident) {
                addEvent(`Incidencia reportada: ${incident}`, 'warning');
                alert('Incidencia registrada en el sistema');
            }
        }
        
        function openCalibration() {
            alert('M√≥dulo de calibraci√≥n en desarrollo');
        }
        
        function generateReport() {
            if (recordingData.length === 0) {
                alert('No hay datos de grabaci√≥n para generar informe');
                return;
            }
            
            let report = `INFORME DE AUDITOR√çA - SISTEMA CABA\n`;
            report += `===================================\n\n`;
            report += `Fecha: ${new Date().toLocaleDateString()}\n`;
            report += `L√≠nea: ${currentLine || 'No especificada'}\n`;
            report += `Duraci√≥n: ${formatTime(recordingDuration)}\n`;
            report += `Puntos registrados: ${recordingData.length}\n`;
            report += `Veh√≠culos detectados: ${lastCABAData.length}\n\n`;
            report += `DATOS DE GRABACI√ìN:\n`;
            
            recordingData.forEach((point, index) => {
                if (index % 10 === 0) {
                    const time = new Date(point.timestamp).toLocaleTimeString();
                    report += `${time} - Lat: ${point.lat.toFixed(6)}, Lng: ${point.lng.toFixed(6)}, Vel: ${point.speed.toFixed(1)} km/h\n`;
                }
            });
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auditoria_caba_${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            
            addEvent('Informe generado y descargado', 'success');
        }
        
        function formatTime(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function handleGPSError(error) {
            console.error('Error GPS:', error);
            updateGPSStatus('error');
            addEvent('Error en se√±al GPS', 'error');
        }
        
        function toggleBackgroundMode() {
            isBackgroundMode = !isBackgroundMode;
            
            const button = document.getElementById('backgroundButton');
            const icon = document.getElementById('backgroundIcon');
            const label = document.getElementById('backgroundLabel');
            
            if (isBackgroundMode) {
                button.classList.add('success');
                icon.className = 'fas fa-check-circle';
                label.textContent = 'SEGUNDO PLANO: ON';
                
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            } else {
                button.classList.remove('success');
                icon.className = 'fas fa-mobile-alt';
                label.textContent = 'SEGUNDO PLANO: OFF';
            }
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('authForm').addEventListener('submit', authenticateCABA);
        
        document.getElementById('searchRadius').addEventListener('input', function() {
            document.getElementById('radiusValue').textContent = this.value;
        });
        
        // Verificar token peri√≥dicamente
        setInterval(() => {
            if (cabaAccessToken && cabaTokenExpiry) {
                const timeLeft = cabaTokenExpiry - Date.now();
                
                if (timeLeft < 300000) {
                    updateCABAStatus('expired');
                    addEvent('Token CABA por expirar. Renueva la autenticaci√≥n', 'warning');
                }
            }
        }, 60000);
        
        // Manejar visibilidad de p√°gina
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isRecording) {
                document.getElementById('recordingNotification').classList.add('active');
            } else {
                document.getElementById('recordingNotification').classList.remove('active');
            }
        });
    </script>
</body>
</html>