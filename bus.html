<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S.A.C - Sistema de Auditoría Ciudadana</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== RESET Y BASE ===== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #0f172a; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            touch-action: pan-x pan-y;
            color: #e2e8f0;
        }
        
        /* ===== ENCABEZADO S.A.C ===== */
        .sac-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 700;
            z-index: 2001;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70px;
        }
        
        .sac-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.2em;
            letter-spacing: 0.5px;
        }
        
        .sac-subtitle {
            font-size: 0.7em;
            opacity: 0.9;
            margin-top: 3px;
            font-weight: 400;
        }
        
        /* ===== MAPA ===== */
        #map { 
            position: fixed; 
            top: 70px; /* Ajustado para el header */
            left: 0; 
            width: 100%; 
            height: calc(100% - 70px); 
            z-index: 1;
        }
        
        /* ===== SOLAPAS LATERALES ===== */
        .tab-container {
            position: fixed;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tab-container.left {
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .tab-container.right {
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .tab-container.bottom {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: row;
        }
        
        .tab-button {
            width: 50px;
            height: 50px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 0 12px 12px 0;
            color: #94a3b8;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .tab-container.left .tab-button {
            border-radius: 0 12px 12px 0;
        }
        
        .tab-container.right .tab-button {
            border-radius: 12px 0 0 12px;
        }
        
        .tab-container.bottom .tab-button {
            border-radius: 12px 12px 0 0;
            width: 50px;
            height: 40px;
        }
        
        .tab-button:hover {
            background: rgba(30, 41, 59, 0.95);
            color: #3b82f6;
            width: 55px;
        }
        
        .tab-button.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
            width: 55px;
        }
        
        /* ===== PANELES ===== */
        .tab-panel {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(100, 116, 139, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 999;
            transition: all 0.3s ease;
            overflow: hidden;
            display: none; /* Todos ocultos por defecto */
        }
        
        .tab-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .tab-panel.left {
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            height: 80vh;
            border-radius: 0 20px 20px 0;
        }
        
        .tab-panel.right {
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            height: 80vh;
            border-radius: 20px 0 0 20px;
        }
        
        .tab-panel.bottom {
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 90vw;
            max-width: 800px;
            height: 300px;
            border-radius: 20px 20px 0 0;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 41, 59, 0.5);
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-content {
            padding: 20px;
            height: calc(100% - 70px);
            overflow-y: auto;
        }
        
        .close-panel {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #3b82f6;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .close-panel:hover {
            background: rgba(59, 130, 246, 0.4);
        }
        
        /* ===== CONSOLA MÓVIL ===== */
        .console-mobile {
            position: fixed;
            top: 80px;
            right: 10px;
            width: 95%;
            max-width: 400px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 12px;
            z-index: 2000;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            display: none; /* Oculta por defecto */
            flex-direction: column;
            backdrop-filter: blur(10px);
        }
        
        .console-mobile.active {
            display: flex;
        }
        
        .console-header {
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.8);
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }
        
        .console-title {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .console-content {
            padding: 12px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            background: rgba(15, 23, 42, 0.8);
        }
        
        .log-entry {
            margin-bottom: 4px;
            padding: 4px 6px;
            border-radius: 4px;
            border-left: 3px solid #3b82f6;
            background: rgba(30, 41, 59, 0.5);
            word-break: break-word;
        }
        
        .log-error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .log-success {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .log-warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        /* ===== BOTÓN DE CONSOLA ===== */
        .console-toggle {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 50%;
            color: #94a3b8;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .console-toggle:hover {
            background: rgba(30, 41, 59, 0.95);
            color: #3b82f6;
        }
        
        /* ===== CONTENIDO DE PANELES ===== */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-item {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .status-item.gps {
            border-left-color: #3b82f6;
        }
        
        .status-item.recording {
            border-left-color: #ef4444;
        }
        
        .status-item.audit {
            border-left-color: #10b981;
        }
        
        .status-item.network {
            border-left-color: #8b5cf6;
        }
        
        .status-item.api {
            border-left-color: #f59e0b;
        }
        
        .status-item.gdrive {
            border-left-color: #4285f4;
        }
        
        .status-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-value {
            font-size: 20px;
            font-weight: 700;
            color: #f8fafc;
        }
        
        .status-subvalue {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Panel de Líneas */
        .stations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .station-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .station-card:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(5px);
        }
        
        .station-card.current {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .station-order {
            font-size: 12px;
            color: #94a3b8;
            background: rgba(100, 116, 139, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .station-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .station-metric {
            display: flex;
            flex-direction: column;
        }
        
        .metric-label {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .metric-value {
            font-size: 14px;
            font-weight: 700;
            color: #3b82f6;
        }
        
        /* Panel de Controles */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .control-button {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            padding: 15px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .control-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-color: #3b82f6;
        }
        
        .control-button.primary {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .control-button.warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .control-button.danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .control-button.success {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #10b981;
        }
        
        .control-icon {
            font-size: 24px;
        }
        
        .control-label {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        
        /* ===== INDICADOR DE VELOCIDAD FLOTANTE ===== */
        .speed-floating {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 15px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .speed-floating:hover {
            transform: scale(1.05);
        }
        
        .speed-label {
            font-size: 10px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .speed-value {
            font-size: 24px;
            font-weight: 800;
            color: #3b82f6;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        
        .speed-value.low {
            color: #10b981;
        }
        
        .speed-value.high {
            color: #ef4444;
        }
        
        .speed-direction {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ===== MODALES ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .modal-logo {
            font-size: 48px;
            color: #3b82f6;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 10px;
        }
        
        .modal-subtitle {
            font-size: 14px;
            color: #94a3b8;
        }
        
        /* ===== FORMULARIOS ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.3);
            border-radius: 10px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-input::placeholder {
            color: #64748b;
        }
        
        .form-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .form-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .form-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ===== MENSAJES ===== */
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            color: #10b981;
            display: block;
        }
        
        .message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            display: block;
        }
        
        /* Notificación de Grabación Automática */
        .auto-recording-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px 20px;
            z-index: 1001;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .auto-recording-notification.active {
            display: flex;
        }
        
        .recording-notification {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px 20px;
            z-index: 1001;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.3);
            display: none;
            align-items: center;
            gap: 10px;
            animation: pulseRed 2s infinite;
        }
        
        .recording-notification.active {
            display: flex;
        }
        
        @keyframes pulseRed {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 3px;
        }
        
        /* ===== LOADING ===== */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .sac-header {
                padding: 10px 15px;
                height: 60px;
            }
            
            .sac-title {
                font-size: 1em;
            }
            
            .sac-subtitle {
                font-size: 0.65em;
            }
            
            #map {
                top: 60px;
                height: calc(100% - 60px);
            }
            
            .tab-panel.left,
            .tab-panel.right {
                width: 90vw;
                max-width: 320px;
                height: 70vh;
            }
            
            .tab-panel.bottom {
                width: 95vw;
                height: 250px;
            }
            
            .controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .speed-floating {
                bottom: 10px;
                left: 10px;
                padding: 10px;
                min-width: 100px;
            }
            
            .speed-value {
                font-size: 20px;
            }
            
            .console-mobile {
                top: 70px;
                height: 180px;
            }
            
            .auto-recording-notification {
                top: 70px;
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .recording-notification {
                top: 110px;
                padding: 8px 16px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .tab-button {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .tab-panel.left,
            .tab-panel.right {
                width: 95vw;
                height: 80vh;
                top: 10%;
                transform: none;
            }
            
            .tab-panel.left {
                left: 0;
                border-radius: 0 20px 20px 0;
            }
            
            .tab-panel.right {
                right: 0;
                border-radius: 20px 0 0 20px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .panel-content {
                padding: 15px;
            }
            
            .sac-title {
                font-size: 0.9em;
                gap: 8px;
            }
            
            .sac-subtitle {
                font-size: 0.6em;
            }
        }
    </style>
</head>
<body>
    <!-- Encabezado S.A.C -->
    <div class="sac-header">
        <div class="sac-title">
            <i class="fas fa-bus"></i>
            S.A.C - SISTEMA DE AUDITORÍA CIUDADANA
            <i class="fas fa-clipboard-check"></i>
        </div>
        <div class="sac-subtitle">Auditoría del Sistema de Transporte Público - Buenos Aires</div>
    </div>

    <!-- Modal de Configuración API -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-logo">
                    <i class="fas fa-bus"></i>
                </div>
                <div class="modal-title">API Transporte Buenos Aires</div>
                <div class="modal-subtitle">Configura tu API Key para acceder a los datos</div>
            </div>
            
            <form id="apiConfigForm">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-key"></i>
                        API Key (Client ID)
                    </label>
                    <input type="text" 
                           class="form-input" 
                           id="apiKey" 
                           placeholder="Ej: a1b2c3d4e5f6g7h8i9j0"
                           required>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                        Obtén tu API Key en: 
                        <a href="https://apitransporte.buenosaires.gob.ar/console/" 
                           target="_blank" 
                           style="color: #3b82f6;">
                            https://apitransporte.buenosaires.gob.ar/console/
                        </a>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-user-secret"></i>
                        Client Secret (Opcional)
                    </label>
                    <input type="text" 
                           class="form-input" 
                           id="clientSecret" 
                           placeholder="Tu client secret si lo tienes">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-cog"></i>
                        Configuración Avanzada
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: #94a3b8; display: block; margin-bottom: 5px;">
                                Intervalo (seg)
                            </label>
                            <select class="form-input" id="updateInterval" style="padding: 8px;">
                                <option value="30">30</option>
                                <option value="60" selected>60</option>
                                <option value="120">120</option>
                                <option value="300">300</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: #94a3b8; display: block; margin-bottom: 5px;">
                                Límite de datos
                            </label>
                            <select class="form-input" id="dataLimit" style="padding: 8px;">
                                <option value="50">50 vehículos</option>
                                <option value="100" selected>100 vehículos</option>
                                <option value="200">200 vehículos</option>
                                <option value="500">500 vehículos</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="form-button" id="saveApiButton">
                    <span id="saveApiButtonText">GUARDAR Y PROBAR CONEXIÓN</span>
                    <div class="spinner" id="saveApiSpinner" style="display: none;"></div>
                </button>
            </form>
            
            <div class="message" id="apiMessage"></div>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(100, 116, 139, 0.3);">
                <a href="https://apitransporte.buenosaires.gob.ar/console/" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    <i class="fas fa-external-link-alt"></i>
                    Documentación oficial de la API
                </a>
            </div>
        </div>
    </div>

    <!-- Modal de Configuración Google Drive -->
    <div class="modal" id="driveModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-logo">
                    <i class="fab fa-google-drive" style="color: #4285f4;"></i>
                </div>
                <div class="modal-title">Google Drive Integration</div>
                <div class="modal-subtitle">Configura la sincronización con Google Drive</div>
            </div>
            
            <form id="driveConfigForm">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-folder"></i>
                        Nombre del Archivo
                    </label>
                    <input type="text" 
                           class="form-input" 
                           id="driveFileName" 
                           placeholder="auditoria_transporte"
                           value="auditoria_transporte">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-history"></i>
                        Intervalo de Grabación
                    </label>
                    <select class="form-input" id="recordingInterval" style="padding: 12px;">
                        <option value="5">5 segundos</option>
                        <option value="10" selected>10 segundos</option>
                        <option value="30">30 segundos</option>
                        <option value="60">1 minuto</option>
                    </select>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                        Cada cuánto se guarda automáticamente en Google Drive
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Configuración de Subida
                    </label>
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="autoUpload" checked style="width: 16px; height: 16px;">
                            <span style="font-size: 13px; color: #e2e8f0;">Subida automática</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="appendData" checked style="width: 16px; height: 16px;">
                            <span style="font-size: 13px; color: #e2e8f0;">Anexar datos al mismo archivo</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="driveFolderGroup" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-folder-open"></i>
                        ID de Carpeta en Drive
                    </label>
                    <input type="text" 
                           class="form-input" 
                           id="driveFolderId" 
                           placeholder="Ej: 1ABCdEfGHijKLMnOpQRsTuVWxyZ">
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                        Deja vacío para guardar en "Mi Unidad"
                    </div>
                </div>
                
                <button type="submit" class="form-button" id="saveDriveButton" style="background: linear-gradient(135deg, #4285f4, #0d47a1);">
                    <span id="saveDriveButtonText">GUARDAR CONFIGURACIÓN</span>
                </button>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="form-button" id="authorizeButton" style="background: linear-gradient(135deg, #34a853, #0d652d);">
                        <i class="fab fa-google"></i>
                        AUTORIZAR GOOGLE DRIVE
                    </button>
                </div>
            </form>
            
            <div class="message" id="driveMessage"></div>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(100, 116, 139, 0.3);">
                <div style="font-size: 11px; color: #94a3b8;">
                    <i class="fas fa-info-circle"></i>
                    Los datos se guardarán automáticamente en tu Google Drive
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Consola Móvil (OCULTA POR DEFECTO) -->
    <div class="console-mobile" id="consoleMobile">
        <div class="console-header">
            <div class="console-title">
                <i class="fas fa-terminal"></i>
                CONSOLA DEL SISTEMA
            </div>
            <div style="display: flex; gap: 8px;">
                <button onclick="clearConsole()" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); border-radius: 6px; color: #3b82f6; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-trash"></i>
                </button>
                <button onclick="toggleConsole()" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); border-radius: 6px; color: #3b82f6; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="console-content" id="consoleOutput"></div>
    </div>
    
    <!-- Botón para mostrar consola -->
    <button class="console-toggle" onclick="toggleConsole()" title="Mostrar consola">
        <i class="fas fa-terminal"></i>
    </button>
    
    <!-- Indicador de Velocidad -->
    <div class="speed-floating" id="speedFloating">
        <div class="speed-label">
            <i class="fas fa-tachometer-alt"></i>
            VELOCIDAD
        </div>
        <div class="speed-value" id="speedValue">0.0 km/h</div>
        <div class="speed-direction">
            <span id="directionArrow">→</span>
            <span id="directionText">NORTE</span>
        </div>
    </div>
    
    <!-- Notificación de Grabación Automática -->
    <div class="auto-recording-notification" id="autoRecordingNotification">
        <i class="fas fa-save"></i>
        <span>GRABACIÓN AUTOMÁTICA ACTIVA</span>
        <span id="autoRecordingTime">Cada 5s</span>
    </div>
    
    <!-- Notificación de Grabación Manual -->
    <div class="recording-notification" id="recordingNotification">
        <i class="fas fa-circle"></i>
        <span>GRABACIÓN MANUAL ACTIVA</span>
        <span id="recordingTime">00:00</span>
    </div>
    
    <!-- Solapas -->
    <div class="tab-container left">
        <button class="tab-button" onclick="togglePanel('status')" title="Estado del Sistema">
            <i class="fas fa-chart-line"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('lines')" title="Líneas">
            <i class="fas fa-route"></i>
        </button>
        <button class="tab-button" onclick="openApiModal()" title="Configurar API">
            <i class="fas fa-database"></i>
        </button>
    </div>
    
    <div class="tab-container right">
        <button class="tab-button" onclick="togglePanel('stations')" title="Estaciones">
            <i class="fas fa-map-marker-alt"></i>
        </button>
        <button class="tab-button" onclick="openDriveModal()" title="Google Drive">
            <i class="fab fa-google-drive"></i>
        </button>
    </div>
    
    <div class="tab-container bottom">
        <button class="tab-button" onclick="togglePanel('controls')" title="Controles">
            <i class="fas fa-sliders-h"></i>
        </button>
        <button class="tab-button" onclick="togglePanel('reports')" title="Reportes">
            <i class="fas fa-file-alt"></i>
        </button>
    </div>
    
    <!-- Paneles (todos ocultos por defecto) -->
    <!-- Panel de Estado -->
    <div class="tab-panel left" id="panelStatus">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-chart-line"></i>
                ESTADO DEL SISTEMA
            </div>
            <button class="close-panel" onclick="togglePanel('status')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="status-grid">
                <div class="status-item gps">
                    <div class="status-label">
                        <i class="fas fa-satellite"></i>
                        GPS
                    </div>
                    <div class="status-value" id="gpsStatusValue">INACTIVO</div>
                    <div class="status-subvalue" id="gpsAccuracy">Esperando señal...</div>
                </div>
                
                <div class="status-item recording">
                    <div class="status-label">
                        <i class="fas fa-record-vinyl"></i>
                        GRABACIÓN AUTO
                    </div>
                    <div class="status-value" id="autoRecordingStatus">ACTIVA</div>
                    <div class="status-subvalue" id="autoRecordingInfo">Cada 5 segundos</div>
                </div>
                
                <div class="status-item audit">
                    <div class="status-label">
                        <i class="fas fa-clipboard-check"></i>
                        PUNTOS GUARDADOS
                    </div>
                    <div class="status-value" id="pointsSaved">0</div>
                    <div class="status-subvalue" id="lastSaveTime">--:--:--</div>
                </div>
                
                <div class="status-item network">
                    <div class="status-label">
                        <i class="fas fa-wifi"></i>
                        CONEXIÓN
                    </div>
                    <div class="status-value" id="networkStatus">ONLINE</div>
                    <div class="status-subvalue" id="networkLatency">--</div>
                </div>
                
                <div class="status-item api">
                    <div class="status-label">
                        <i class="fas fa-database"></i>
                        API TRANSPORTE
                    </div>
                    <div class="status-value" id="apiStatusValue">NO CONFIGURADA</div>
                    <div class="status-subvalue" id="apiEndpointValue">--</div>
                </div>
                
                <div class="status-item gdrive">
                    <div class="status-label">
                        <i class="fab fa-google-drive"></i>
                        GOOGLE DRIVE
                    </div>
                    <div class="status-value" id="driveStatusValue">NO CONFIGURADA</div>
                    <div class="status-subvalue" id="driveSyncInfo">--</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="status-label" style="margin-bottom: 10px;">
                    <i class="fas fa-history"></i>
                    ÚLTIMOS EVENTOS
                </div>
                <div id="recentEvents" style="max-height: 150px; overflow-y: auto;">
                    <div style="padding: 8px 12px; background: rgba(30, 41, 59, 0.5); border-radius: 8px; margin-bottom: 8px; font-size: 12px; border-left: 3px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>ℹ️ Sistema S.A.C inicializado</span>
                            <span style="color: #64748b;">00:00:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de Líneas -->
    <div class="tab-panel left" id="panelLines">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-route"></i>
                LÍNEAS DE TRANSPORTE
            </div>
            <button class="close-panel" onclick="togglePanel('lines')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="stations-list" id="linesList">
                <!-- Líneas se cargarán dinámicamente desde API -->
            </div>
        </div>
    </div>
    
    <!-- Panel de Controles -->
    <div class="tab-panel bottom" id="panelControls">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-sliders-h"></i>
                CONTROLES DE AUDITORÍA
            </div>
            <button class="close-panel" onclick="togglePanel('controls')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="controls-grid">
                <button class="control-button primary" onclick="toggleAutoRecording()" id="autoRecordingButton">
                    <div class="control-icon">
                        <i class="fas fa-play" id="autoRecordingIcon"></i>
                    </div>
                    <div class="control-label" id="autoRecordingLabel">PAUSAR AUTO-GRABACIÓN</div>
                </button>
                
                <button class="control-button" onclick="centerOnUser()">
                    <div class="control-icon">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                    <div class="control-label">CENTRAR MAPA</div>
                </button>
                
                <button class="control-button success" onclick="fetchTransportData()" id="fetchDataButton">
                    <div class="control-icon">
                        <i class="fas fa-bus" id="fetchDataIcon"></i>
                    </div>
                    <div class="control-label" id="fetchDataLabel">OBTENER DATOS API</div>
                </button>
                
                <button class="control-button warning" onclick="startAutoRefresh()" id="autoRefreshButton">
                    <div class="control-icon">
                        <i class="fas fa-sync-alt" id="autoRefreshIcon"></i>
                    </div>
                    <div class="control-label" id="autoRefreshLabel">AUTO-REFRESH: OFF</div>
                </button>
                
                <button class="control-button" onclick="exportToDrive()" id="exportDriveButton">
                    <div class="control-icon">
                        <i class="fab fa-google-drive"></i>
                    </div>
                    <div class="control-label">EXPORTAR A DRIVE</div>
                </button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(100, 116, 139, 0.3);">
                <div class="status-label" style="margin-bottom: 10px;">
                    <i class="fas fa-info-circle"></i>
                    INFORMACIÓN DE GRABACIÓN
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div>
                        <div style="font-size: 11px; color: #94a3b8;">Puntos grabados:</div>
                        <div style="font-size: 16px; font-weight: 700; color: #3b82f6;" id="totalPoints">0</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: #94a3b8;">Última sincronización:</div>
                        <div style="font-size: 16px; font-weight: 700; color: #10b981;" id="lastSyncTime">--:--:--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <script>
        // ============================================
        // SISTEMA DE CONSOLA
        // ============================================
        let consoleLogs = [];
        const MAX_LOGS = 50;
        
        function logToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('es-AR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            consoleLogs.unshift({
                timestamp,
                message,
                type,
                id: Date.now() + Math.random()
            });
            
            if (consoleLogs.length > MAX_LOGS) {
                consoleLogs.pop();
            }
            
            renderConsole();
            
            // También mostrar en consola real
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            console.log(`${prefix} ${message}`);
            
            // Agregar a eventos recientes
            addEvent(message, type);
        }
        
        function renderConsole() {
            const output = document.getElementById('consoleOutput');
            if (!output) return;
            
            output.innerHTML = '';
            
            consoleLogs.forEach(log => {
                const div = document.createElement('div');
                div.className = `log-entry log-${log.type}`;
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                        <span style="color: #94a3b8; font-size: 9px;">${log.timestamp}</span>
                        <span style="color: ${log.type === 'error' ? '#ef4444' : log.type === 'success' ? '#10b981' : log.type === 'warning' ? '#f59e0b' : '#94a3b8'}; font-size: 9px;">
                            ${log.type.toUpperCase()}
                        </span>
                    </div>
                    <div style="word-break: break-word;">${log.message}</div>
                `;
                output.appendChild(div);
            });
        }
        
        function clearConsole() {
            consoleLogs = [];
            renderConsole();
            logToConsole('Consola limpiada', 'info');
        }
        
        function toggleConsole() {
            const consoleElement = document.getElementById('consoleMobile');
            consoleElement.classList.toggle('active');
            
            if (consoleElement.classList.contains('active')) {
                logToConsole('Consola del sistema abierta', 'info');
            }
        }
        
        // ============================================
        // CONFIGURACIÓN API TRANSPORTE BUENOS AIRES
        // ============================================
        const TRANSPORTE_BA_API = {
            BASE_URL: "https://apitransporte.buenosaires.gob.ar/",
            ENDPOINTS: {
                COLECTIVOS_POSITIONS: "colectivos/vehiclePositionsSimple",
                COLECTIVOS_LINEAS: "colectivos/lineas",
                COLECTIVOS_RECORRIDOS: "colectivos/recorridos",
                
                TRENES_LINEAS: "trenes/lineas",
                TRENES_ESTACIONES: "trenes/estaciones",
                TRENES_POSITIONS: "trenes/vehiclePositionsSimple",
                
                SUBTES_LINEAS: "subtes/lineas",
                SUBTES_ESTACIONES: "subtes/estaciones",
                
                ECOBICI_ESTACIONES: "ecobici/estaciones"
            }
        };
        
        // ============================================
        // CONFIGURACIÓN GOOGLE DRIVE
        // ============================================
        const GOOGLE_DRIVE_CONFIG = {
            CLIENT_ID: "TU_CLIENT_ID_AQUI", // Reemplazar con tu Client ID
            API_KEY: "TU_API_KEY_AQUI", // Reemplazar con tu API Key
            SCOPES: "https://www.googleapis.com/auth/drive.file",
            DISCOVERY_DOCS: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
        };
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map = null;
        let userMarker = null;
        let routePolyline = null;
        let transportMarkers = [];
        
        // Estado del sistema
        let currentLine = null;
        let isAutoRecording = true; // Grabación automática ACTIVA por defecto
        let isManualRecording = false;
        let isAutoRefresh = false;
        let activePanel = null;
        
        // Datos GPS
        let currentPosition = null;
        let currentSpeed = 0;
        let currentBearing = 0;
        let currentAccuracy = 0;
        
        // Grabación automática
        let recordingInterval = 5000; // 5 segundos por defecto
        let autoRecordingTimer = null;
        let recordingData = [];
        let totalPoints = 0;
        let lastSaveTime = null;
        
        // Google Drive
        let gapiInitialized = false;
        let googleTokenClient = null;
        let driveConfig = {
            fileName: 'auditoria_transporte',
            folderId: '',
            autoUpload: true,
            appendData: true,
            authorized: false
        };
        
        // API Config
        let apiConfig = {
            apiKey: '',
            updateInterval: 60000,
            dataLimit: 100,
            connected: false,
            lastTest: null
        };
        
        // Datos en tiempo real
        let realTimeData = {
            colectivos: [],
            lastUpdate: null,
            totalVehicles: 0
        };
        
        // Timers
        let dataRefreshTimer = null;
        
        // Colores para líneas de transporte
        const LINE_COLORS = {
            '1': '#3b82f6', '2': '#10b981', '4': '#8b5cf6', '5': '#f59e0b',
            '6': '#ef4444', '7': '#ec4899', '8': '#06b6d4', '9': '#84cc16',
            '10': '#f97316', '12': '#8b5cf6', '15': '#10b981', '17': '#3b82f6',
            '19': '#f59e0b', '20': '#ef4444', '21': '#ec4899', '22': '#06b6d4',
            '23': '#84cc16', '24': '#f97316', '25': '#8b5cf6', '26': '#10b981',
            '28': '#3b82f6', '29': '#f59e0b', '32': '#ef4444', '33': '#ec4899',
            '34': '#06b6d4', '36': '#84cc16', '39': '#f97316', '41': '#8b5cf6',
            '42': '#10b981', '44': '#3b82f6', '45': '#f59e0b', '50': '#ef4444',
            '51': '#ec4899', '53': '#06b6d4', '55': '#84cc16', '56': '#f97316',
            '57': '#8b5cf6', '59': '#10b981', '60': '#3b82f6', '61': '#f59e0b',
            '62': '#ef4444', '63': '#ec4899', '64': '#06b6d4', '65': '#84cc16',
            '67': '#f97316', '68': '#8b5cf6', '71': '#10b981', '74': '#3b82f6',
            '75': '#f59e0b', '76': '#ef4444', '78': '#ec4899', '79': '#06b6d4',
            '80': '#84cc16', '84': '#f97316', '85': '#8b5cf6', '86': '#10b981',
            '87': '#3b82f6', '88': '#f59e0b', '91': '#ef4444', '92': '#ec4899',
            '93': '#06b6d4', '95': '#84cc16', '96': '#f97316', '98': '#8b5cf6',
            '99': '#10b981', '100': '#3b82f6', '101': '#f59e0b', '102': '#ef4444',
            '103': '#ec4899', '104': '#06b6d4', '105': '#84cc16', '106': '#f97316',
            '107': '#8b5cf6', '108': '#10b981', '109': '#3b82f6', '110': '#f59e0b',
            '111': '#ef4444', '112': '#ec4899', '113': '#06b6d4', '114': '#84cc16',
            '115': '#f97316', '117': '#8b5cf6', '118': '#10b981', '123': '#3b82f6',
            '124': '#f59e0b', '126': '#ef4444', '127': '#ec4899', '128': '#06b6d4',
            '129': '#84cc16', '130': '#f97316', '132': '#8b5cf6', '133': '#10b981',
            '134': '#3b82f6', '135': '#f59e0b', '136': '#ef4444', '140': '#ec4899',
            '141': '#06b6d4', '143': '#84cc16', '146': '#f97316', '150': '#8b5cf6',
            '151': '#10b981', '152': '#3b82f6', '158': '#f59e0b', '159': '#ef4444',
            '160': '#ec4899', '161': '#06b6d4', '163': '#84cc16', '164': '#f97316',
            '166': '#8b5cf6', '168': '#10b981', '169': '#3b82f6', '174': '#f59e0b',
            '175': '#ef4444', '176': '#ec4899', '177': '#06b6d4', '178': '#84cc16',
            '179': '#f97316', '180': '#8b5cf6', '181': '#10b981', '184': '#3b82f6',
            '185': '#f59e0b', '188': '#ef4444', '194': '#ec4899', '195': '#06b6d4',
            '196': '#84cc16', '200': '#f97316'
        };
        
        // ============================================
        // INICIALIZACIÓN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadConfigurations();
            
            // Iniciar GPS
            setTimeout(() => startGPS(), 1000);
            
            // Iniciar grabación automática
            startAutoRecording();
            
            // Test de red inicial
            testNetworkConnection();
            
            // Inicializar Google APIs
            initGoogleAPIs();
            
            logToConsole('S.A.C - Sistema de Auditoría Ciudadana inicializado', 'success');
            logToConsole('Grabación automática activada (cada 5 segundos)', 'info');
            logToConsole('Todos los paneles están cerrados por defecto', 'info');
        });
        
        // ============================================
        // SISTEMA DE MAPA
        // ============================================
        function initMap() {
            logToConsole('Inicializando mapa...', 'info');
            
            map = L.map('map', {
                zoomControl: true,
                attributionControl: true,
                preferCanvas: true
            });
            
            // Mapa oscuro de CARTO
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CARTO | © OpenStreetMap contributors',
                maxZoom: 19,
                minZoom: 10,
                subdomains: 'abcd'
            }).addTo(map);
            
            // Vista inicial de Buenos Aires
            map.setView([-34.6037, -58.3816], 14);
            
            logToConsole('✅ Mapa inicializado correctamente', 'success');
        }
        
        // ============================================
        // CONFIGURACIONES
        // ============================================
        function loadConfigurations() {
            // Cargar configuración API
            const savedApiConfig = localStorage.getItem('sac_api_config');
            if (savedApiConfig) {
                try {
                    apiConfig = JSON.parse(savedApiConfig);
                    updateApiStatus();
                    
                    if (apiConfig.apiKey) {
                        document.getElementById('apiKey').value = apiConfig.apiKey;
                    }
                } catch (e) {
                    logToConsole('Error cargando configuración API: ' + e.message, 'error');
                }
            }
            
            // Cargar configuración Drive
            const savedDriveConfig = localStorage.getItem('sac_drive_config');
            if (savedDriveConfig) {
                try {
                    driveConfig = JSON.parse(savedDriveConfig);
                    updateDriveStatus();
                    
                    document.getElementById('driveFileName').value = driveConfig.fileName;
                    document.getElementById('recordingInterval').value = driveConfig.recordingInterval || 5;
                    document.getElementById('autoUpload').checked = driveConfig.autoUpload;
                    document.getElementById('appendData').checked = driveConfig.appendData;
                    
                    if (driveConfig.recordingInterval) {
                        recordingInterval = driveConfig.recordingInterval * 1000;
                        document.getElementById('autoRecordingInfo').textContent = `Cada ${driveConfig.recordingInterval}s`;
                        document.getElementById('autoRecordingTime').textContent = `Cada ${driveConfig.recordingInterval}s`;
                    }
                } catch (e) {
                    logToConsole('Error cargando configuración Drive: ' + e.message, 'error');
                }
            }
            
            // Cargar datos grabados
            const savedRecordingData = localStorage.getItem('sac_recording_data');
            if (savedRecordingData) {
                try {
                    recordingData = JSON.parse(savedRecordingData);
                    totalPoints = recordingData.length;
                    updatePointsCount();
                    logToConsole(`📊 Datos previos cargados: ${totalPoints} puntos`, 'info');
                } catch (e) {
                    logToConsole('Error cargando datos grabados: ' + e.message, 'error');
                }
            }
        }
        
        function saveConfigurations() {
            localStorage.setItem('sac_api_config', JSON.stringify(apiConfig));
            localStorage.setItem('sac_drive_config', JSON.stringify(driveConfig));
            localStorage.setItem('sac_recording_data', JSON.stringify(recordingData));
        }
        
        // ============================================
        // GOOGLE DRIVE INTEGRATION
        // ============================================
        function initGoogleAPIs() {
            logToConsole('Inicializando Google APIs...', 'info');
            
            // Cargar Google API Client
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_DRIVE_CONFIG.API_KEY,
                        discoveryDocs: GOOGLE_DRIVE_CONFIG.DISCOVERY_DOCS,
                    });
                    
                    gapiInitialized = true;
                    logToConsole('✅ Google API Client inicializado', 'success');
                    
                    // Inicializar Google Identity Services
                    googleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
                        scope: GOOGLE_DRIVE_CONFIG.SCOPES,
                        callback: (response) => {
                            if (response.access_token) {
                                driveConfig.authorized = true;
                                updateDriveStatus();
                                logToConsole('✅ Autorización Google Drive exitosa', 'success');
                                showTemporaryMessage('Google Drive autorizado', 'success');
                                
                                // Probar conexión
                                testDriveConnection();
                            } else {
                                logToConsole('❌ Autorización Google Drive falló', 'error');
                            }
                        },
                    });
                    
                } catch (error) {
                    console.error('Error inicializando Google API:', error);
                    logToConsole('❌ Error inicializando Google API', 'error');
                }
            });
        }
        
        function authorizeGoogleDrive() {
            if (!gapiInitialized) {
                logToConsole('Google API no inicializada', 'error');
                return;
            }
            
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken({prompt: 'consent'});
            }
        }
        
        async function testDriveConnection() {
            if (!driveConfig.authorized) {
                logToConsole('Google Drive no autorizado', 'warning');
                return false;
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    pageSize: 1,
                    fields: 'files(id, name)',
                });
                
                logToConsole('✅ Conexión Google Drive verificada', 'success');
                document.getElementById('driveSyncInfo').textContent = 'Conectado';
                return true;
                
            } catch (error) {
                console.error('Error probando conexión Drive:', error);
                logToConsole('❌ Error de conexión Google Drive', 'error');
                return false;
            }
        }
        
        async function uploadToDrive(data, filename, append = true) {
            if (!driveConfig.authorized) {
                logToConsole('Google Drive no autorizado para subir datos', 'warning');
                return false;
            }
            
            try {
                let fileId = null;
                const fullFilename = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
                
                // Buscar archivo existente si append es true
                if (append) {
                    try {
                        const response = await gapi.client.drive.files.list({
                            q: `name='${fullFilename}' and trashed=false`,
                            fields: 'files(id, name)',
                            spaces: 'drive'
                        });
                        
                        if (response.result.files.length > 0) {
                            fileId = response.result.files[0].id;
                            logToConsole(`📁 Archivo existente encontrado: ${fullFilename}`, 'info');
                        }
                    } catch (searchError) {
                        console.warn('Error buscando archivo:', searchError);
                    }
                }
                
                // Convertir datos a JSON
                const jsonData = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonData], {type: 'application/json'});
                
                const metadata = {
                    name: fullFilename,
                    mimeType: 'application/json'
                };
                
                if (driveConfig.folderId) {
                    metadata.parents = [driveConfig.folderId];
                }
                
                let uploadRequest;
                
                if (fileId) {
                    // Actualizar archivo existente
                    uploadRequest = gapi.client.drive.files.update({
                        fileId: fileId,
                        uploadType: 'media',
                        media: {
                            mimeType: 'application/json',
                            body: jsonData
                        }
                    });
                } else {
                    // Crear nuevo archivo
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    form.append('file', blob);
                    
                    uploadRequest = fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({
                            'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                        }),
                        body: form
                    });
                }
                
                const response = await uploadRequest;
                const result = await response.json();
                
                lastSaveTime = new Date();
                updateDriveStatus();
                
                logToConsole(`✅ Datos subidos a Google Drive: ${fullFilename}`, 'success');
                showTemporaryMessage(`Datos guardados en Drive: ${fullFilename}`, 'success');
                
                return true;
                
            } catch (error) {
                console.error('Error subiendo a Drive:', error);
                logToConsole('❌ Error subiendo datos a Google Drive', 'error');
                return false;
            }
        }
        
        async function exportToDrive() {
            if (recordingData.length === 0) {
                showTemporaryMessage('No hay datos para exportar', 'warning');
                return;
            }
            
            const exportData = {
                metadata: {
                    system: 'S.A.C - Sistema de Auditoría Ciudadana',
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    totalPoints: recordingData.length,
                    recordingDuration: getRecordingDuration()
                },
                route: recordingData,
                statistics: {
                    totalDistance: calculateTotalDistance(),
                    averageSpeed: calculateAverageSpeed(),
                    maxSpeed: calculateMaxSpeed(),
                    pointsByHour: groupPointsByHour()
                }
            };
            
            const success = await uploadToDrive(exportData, driveConfig.fileName, driveConfig.appendData);
            
            if (success) {
                // Opcional: limpiar datos locales después de exportar
                // recordingData = [];
                // totalPoints = 0;
                // updatePointsCount();
                // saveConfigurations();
            }
        }
        
        // ============================================
        // GRABACIÓN AUTOMÁTICA
        // ============================================
        function startAutoRecording() {
            if (autoRecordingTimer) {
                clearInterval(autoRecordingTimer);
            }
            
            isAutoRecording = true;
            document.getElementById('autoRecordingNotification').classList.add('active');
            document.getElementById('autoRecordingStatus').textContent = 'ACTIVA';
            document.getElementById('autoRecordingStatus').style.color = '#10b981';
            
            autoRecordingTimer = setInterval(() => {
                if (currentPosition) {
                    recordPositionAutomatically();
                }
            }, recordingInterval);
            
            logToConsole(`🔴 Grabación automática iniciada (cada ${recordingInterval/1000}s)`, 'success');
        }
        
        function stopAutoRecording() {
            if (autoRecordingTimer) {
                clearInterval(autoRecordingTimer);
                autoRecordingTimer = null;
            }
            
            isAutoRecording = false;
            document.getElementById('autoRecordingNotification').classList.remove('active');
            document.getElementById('autoRecordingStatus').textContent = 'PAUSADA';
            document.getElementById('autoRecordingStatus').style.color = '#ef4444';
            
            logToConsole('⏸️ Grabación automática pausada', 'info');
        }
        
        function toggleAutoRecording() {
            if (isAutoRecording) {
                stopAutoRecording();
                document.getElementById('autoRecordingIcon').className = 'fas fa-play';
                document.getElementById('autoRecordingLabel').textContent = 'REANUDAR AUTO-GRABACIÓN';
            } else {
                startAutoRecording();
                document.getElementById('autoRecordingIcon').className = 'fas fa-pause';
                document.getElementById('autoRecordingLabel').textContent = 'PAUSAR AUTO-GRABACIÓN';
            }
        }
        
        function recordPositionAutomatically() {
            const dataPoint = {
                timestamp: Date.now(),
                date: new Date().toISOString(),
                lat: currentPosition.lat,
                lng: currentPosition.lng,
                speed: currentSpeed,
                accuracy: currentAccuracy,
                bearing: currentBearing,
                line: currentLine,
                metadata: {
                    autoRecorded: true,
                    interval: recordingInterval
                }
            };
            
            recordingData.push(dataPoint);
            totalPoints++;
            
            updatePointsCount();
            
            // Guardar automáticamente cada 10 puntos
            if (totalPoints % 10 === 0) {
                saveRecordingData();
                
                // Subir a Drive si está configurado
                if (driveConfig.autoUpload && driveConfig.authorized) {
                    const batchData = recordingData.slice(-10); // Últimos 10 puntos
                    uploadToDrive(batchData, `${driveConfig.fileName}_batch`, true);
                }
            }
            
            // Actualizar ruta en mapa
            updateRoute(currentPosition.lat, currentPosition.lng);
        }
        
        function updatePointsCount() {
            document.getElementById('pointsSaved').textContent = totalPoints;
            document.getElementById('totalPoints').textContent = totalPoints;
            
            if (lastSaveTime) {
                const timeStr = lastSaveTime.toLocaleTimeString('es-AR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('lastSaveTime').textContent = timeStr;
                document.getElementById('lastSyncTime').textContent = timeStr;
            }
        }
        
        function saveRecordingData() {
            saveConfigurations();
            lastSaveTime = new Date();
            updatePointsCount();
        }
        
        // ============================================
        // FUNCIONES DE CÁLCULO
        // ============================================
        function calculateTotalDistance() {
            if (recordingData.length < 2) return 0;
            
            let total = 0;
            for (let i = 1; i < recordingData.length; i++) {
                const prev = recordingData[i - 1];
                const curr = recordingData[i];
                total += calculateDistance(prev.lat, prev.lng, curr.lat, curr.lng);
            }
            
            return total;
        }
        
        function calculateAverageSpeed() {
            if (recordingData.length === 0) return 0;
            
            const total = recordingData.reduce((sum, point) => sum + (point.speed || 0), 0);
            return total / recordingData.length;
        }
        
        function calculateMaxSpeed() {
            if (recordingData.length === 0) return 0;
            
            return Math.max(...recordingData.map(point => point.speed || 0));
        }
        
        function groupPointsByHour() {
            const hours = {};
            recordingData.forEach(point => {
                const hour = new Date(point.timestamp).getHours();
                hours[hour] = (hours[hour] || 0) + 1;
            });
            return hours;
        }
        
        function getRecordingDuration() {
            if (recordingData.length < 2) return '0s';
            
            const start = recordingData[0].timestamp;
            const end = recordingData[recordingData.length - 1].timestamp;
            const duration = end - start;
            
            return formatTime(duration);
        }
        
        // ============================================
        // SISTEMA GPS
        // ============================================
        function startGPS() {
            if (!navigator.geolocation) {
                logToConsole("❌ Tu dispositivo no soporta GPS", 'error');
                updateGPSStatus('error');
                return;
            }
            
            updateGPSStatus('searching');
            
            navigator.geolocation.watchPosition(
                position => handleGPSPosition(position),
                error => handleGPSError(error),
                {
                    enableHighAccuracy: true,
                    maximumAge: 2000,
                    timeout: 15000
                }
            );
            
            logToConsole('📍 GPS iniciado - Esperando señal...', 'info');
        }
        
        function handleGPSPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed;
            const heading = position.coords.heading;
            
            currentPosition = { lat, lng };
            currentAccuracy = accuracy;
            
            if (speed !== null && speed >= 0) {
                currentSpeed = speed * 3.6; // Convertir m/s a km/h
            }
            
            if (heading !== null && heading >= 0) {
                currentBearing = heading;
            }
            
            updateGPSStatus('active');
            updateSpeedDisplay();
            updateDirectionDisplay();
            updateUserPosition(lat, lng);
        }
        
        function updateUserPosition(lat, lng) {
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: `
                            <div style="
                                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                width: 24px;
                                height: 24px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 0 15px rgba(59, 130, 246, 0.9);
                            "></div>
                        `,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
        }
        
        function updateRoute(lat, lng) {
            if (!routePolyline) {
                routePolyline = L.polyline([[lat, lng]], {
                    color: '#3b82f6',
                    weight: 4,
                    opacity: 0.7,
                    lineJoin: 'round'
                }).addTo(map);
            } else {
                const currentPath = routePolyline.getLatLngs();
                currentPath.push([lat, lng]);
                
                // Limitar a 1000 puntos para rendimiento
                if (currentPath.length > 1000) {
                    currentPath.shift();
                }
                
                routePolyline.setLatLngs(currentPath);
            }
        }
        
        // ============================================
        // INTERFAZ DE USUARIO
        // ============================================
        function togglePanel(panelId) {
            const panelElement = document.getElementById('panel' + capitalizeFirstLetter(panelId));
            const button = document.querySelector(`[onclick="togglePanel('${panelId}')"]`);
            
            if (activePanel === panelId) {
                panelElement.classList.remove('active');
                button.classList.remove('active');
                activePanel = null;
            } else {
                if (activePanel) {
                    const prevPanel = document.getElementById('panel' + capitalizeFirstLetter(activePanel));
                    const prevButton = document.querySelector(`[onclick="togglePanel('${activePanel}')"]`);
                    if (prevPanel) prevPanel.classList.remove('active');
                    if (prevButton) prevButton.classList.remove('active');
                }
                
                panelElement.classList.add('active');
                button.classList.add('active');
                activePanel = panelId;
            }
        }
        
        function openDriveModal() {
            document.getElementById('driveModal').classList.add('active');
        }
        
        function closeDriveModal() {
            document.getElementById('driveModal').classList.remove('active');
        }
        
        function updateGPSStatus(status) {
            const element = document.getElementById('gpsStatusValue');
            const accuracyElement = document.getElementById('gpsAccuracy');
            
            switch(status) {
                case 'searching':
                    element.textContent = 'BUSCANDO';
                    element.style.color = '#f59e0b';
                    accuracyElement.textContent = 'Buscando señal...';
                    break;
                case 'active':
                    element.textContent = 'ACTIVO';
                    element.style.color = '#10b981';
                    accuracyElement.textContent = `Precisión: ${Math.round(currentAccuracy)}m`;
                    break;
                case 'error':
                    element.textContent = 'ERROR';
                    element.style.color = '#ef4444';
                    accuracyElement.textContent = 'Error de conexión';
                    break;
            }
        }
        
        function updateSpeedDisplay() {
            const speedElement = document.getElementById('speedValue');
            speedElement.textContent = currentSpeed.toFixed(1) + ' km/h';
            
            speedElement.className = 'speed-value';
            if (currentSpeed < 1) {
                speedElement.textContent = '0.0 km/h';
                speedElement.classList.add('low');
            } else if (currentSpeed < 20) {
                speedElement.classList.add('low');
            } else if (currentSpeed > 60) {
                speedElement.classList.add('high');
            }
        }
        
        function updateDirectionDisplay() {
            const arrow = document.getElementById('directionArrow');
            const text = document.getElementById('directionText');
            
            if (currentSpeed < 1) {
                arrow.textContent = '●';
                text.textContent = 'DETENIDO';
                arrow.style.transform = 'rotate(0deg)';
                return;
            }
            
            let direction = 'NORTE';
            let arrowChar = '↑';
            
            if (currentBearing >= 337.5 || currentBearing < 22.5) {
                direction = 'NORTE'; arrowChar = '↑';
            } else if (currentBearing >= 22.5 && currentBearing < 67.5) {
                direction = 'NORESTE'; arrowChar = '↗';
            } else if (currentBearing >= 67.5 && currentBearing < 112.5) {
                direction = 'ESTE'; arrowChar = '→';
            } else if (currentBearing >= 112.5 && currentBearing < 157.5) {
                direction = 'SURESTE'; arrowChar = '↘';
            } else if (currentBearing >= 157.5 && currentBearing < 202.5) {
                direction = 'SUR'; arrowChar = '↓';
            } else if (currentBearing >= 202.5 && currentBearing < 247.5) {
                direction = 'SUROESTE'; arrowChar = '↙';
            } else if (currentBearing >= 247.5 && currentBearing < 292.5) {
                direction = 'OESTE'; arrowChar = '←';
            } else if (currentBearing >= 292.5 && currentBearing < 337.5) {
                direction = 'NOROESTE'; arrowChar = '↖';
            }
            
            arrow.textContent = arrowChar;
            text.textContent = direction;
            arrow.style.transform = `rotate(${currentBearing}deg)`;
        }
        
        function updateApiStatus() {
            const element = document.getElementById('apiStatusValue');
            const endpointElement = document.getElementById('apiEndpointValue');
            
            if (apiConfig.apiKey && apiConfig.connected) {
                element.textContent = 'CONECTADO';
                element.style.color = '#10b981';
                endpointElement.textContent = `API Key: ${apiConfig.apiKey.substring(0, 8)}...`;
            } else if (apiConfig.apiKey && !apiConfig.connected) {
                element.textContent = 'ERROR CONEXIÓN';
                element.style.color = '#ef4444';
                endpointElement.textContent = `API Key: ${apiConfig.apiKey.substring(0, 8)}...`;
            } else {
                element.textContent = 'NO CONFIGURADA';
                element.style.color = '#ef4444';
                endpointElement.textContent = '--';
            }
        }
        
        function updateDriveStatus() {
            const element = document.getElementById('driveStatusValue');
            const syncElement = document.getElementById('driveSyncInfo');
            
            if (driveConfig.authorized) {
                element.textContent = 'CONECTADO';
                element.style.color = '#10b981';
                syncElement.textContent = 'Sincronización activa';
            } else {
                element.textContent = 'NO CONFIGURADA';
                element.style.color = '#ef4444';
                syncElement.textContent = '--';
            }
        }
        
        function addEvent(message, type = 'info') {
            const eventsList = document.getElementById('recentEvents');
            const time = new Date().toLocaleTimeString('es-AR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            let icon = 'ℹ️';
            if (type === 'success') icon = '✅';
            if (type === 'warning') icon = '⚠️';
            if (type === 'error') icon = '❌';
            
            const eventDiv = document.createElement('div');
            eventDiv.style.cssText = `
                padding: 8px 12px;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                margin-bottom: 8px;
                font-size: 12px;
                border-left: 3px solid ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            
            eventDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <span>${icon} ${message}</span>
                    <span style="color: #64748b;">${time}</span>
                </div>
            `;
            
            eventsList.insertBefore(eventDiv, eventsList.firstChild);
            
            if (eventsList.children.length > 10) {
                eventsList.removeChild(eventsList.lastChild);
            }
        }
        
        // ============================================
        // FUNCIONES UTILITARIAS
        // ============================================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                     Math.cos(φ1) * Math.cos(φ2) *
                     Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        function formatTime(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        function showTemporaryMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? 'rgba(16, 185, 129, 0.95)' : 
                          type === 'error' ? 'rgba(239, 68, 68, 0.95)' : 
                          type === 'warning' ? 'rgba(245, 158, 11, 0.95)' : 
                          'rgba(59, 130, 246, 0.95)'};
                color: white;
                padding: 12px 20px;
                border-radius: 10px;
                z-index: 2002;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                gap: 10px;
                backdrop-filter: blur(10px);
                animation: fadeInOut 3s ease-in-out;
            `;
            
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            messageDiv.innerHTML = `${icon} ${message}`;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }
        
        async function testNetworkConnection() {
            const statusElement = document.getElementById('networkStatus');
            const latencyElement = document.getElementById('networkLatency');
            
            try {
                const startTime = Date.now();
                const response = await fetch('https://www.google.com', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                const latency = Date.now() - startTime;
                
                statusElement.textContent = 'ONLINE';
                statusElement.style.color = '#10b981';
                latencyElement.textContent = `Latencia: ${latency}ms`;
                
                return true;
            } catch (error) {
                statusElement.textContent = 'OFFLINE';
                statusElement.style.color = '#ef4444';
                latencyElement.textContent = 'Sin conexión';
                
                return false;
            }
        }
        
        function handleGPSError(error) {
            console.error('Error GPS:', error);
            updateGPSStatus('error');
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    logToConsole('❌ Permiso de GPS denegado por el usuario', 'error');
                    showTemporaryMessage('Activa la ubicación en tu navegador', 'error');
                    break;
                case error.POSITION_UNAVAILABLE:
                    logToConsole('❌ Información de posición no disponible', 'error');
                    showTemporaryMessage('GPS no disponible', 'error');
                    break;
                case error.TIMEOUT:
                    logToConsole('❌ Tiempo de espera de GPS agotado', 'error');
                    showTemporaryMessage('Tiempo de espera agotado', 'warning');
                    break;
                default:
                    logToConsole('❌ Error desconocido en GPS', 'error');
            }
        }
        
        function centerOnUser() {
            if (currentPosition) {
                map.setView([currentPosition.lat, currentPosition.lng], 16, {
                    animate: true,
                    duration: 0.5
                });
                showTemporaryMessage("Mapa centrado en tu posición", 'success');
            } else {
                showTemporaryMessage("Esperando señal GPS...", 'warning');
            }
        }
        
        // ============================================
        // CONFIGURACIÓN DE FORMULARIOS
        // ============================================
        document.getElementById('driveConfigForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            driveConfig.fileName = document.getElementById('driveFileName').value;
            driveConfig.recordingInterval = parseInt(document.getElementById('recordingInterval').value);
            driveConfig.autoUpload = document.getElementById('autoUpload').checked;
            driveConfig.appendData = document.getElementById('appendData').checked;
            
            recordingInterval = driveConfig.recordingInterval * 1000;
            
            // Reiniciar grabación con nuevo intervalo
            if (isAutoRecording) {
                stopAutoRecording();
                startAutoRecording();
            }
            
            updateDriveStatus();
            saveConfigurations();
            
            document.getElementById('driveMessage').className = 'message success';
            document.getElementById('driveMessage').textContent = 'Configuración de Drive guardada';
            
            setTimeout(() => {
                document.getElementById('driveMessage').className = 'message';
            }, 3000);
            
            logToConsole('✅ Configuración Google Drive actualizada', 'success');
            showTemporaryMessage('Configuración guardada', 'success');
        });
        
        document.getElementById('authorizeButton').addEventListener('click', function() {
            authorizeGoogleDrive();
        });
        
        // ============================================
        // INICIALIZACIÓN COMPLETA
        // ============================================
        logToConsole('✅ S.A.C - Sistema completamente inicializado', 'success');
        console.log('🚀 S.A.C - Sistema de Auditoría Ciudadana listo para producción');
        console.log('📍 Grabación automática activada cada 5 segundos');
        console.log('☁️ Google Drive integration disponible');
        
        // Animación CSS para mensajes temporales
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                10% { opacity: 1; transform: translateX(-50%) translateY(0); }
                90% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
        `;
        document.head.appendChild(style);
        
        // NOTA IMPORTANTE: Para usar Google Drive, necesitas:
        // 1. Crear un proyecto en Google Cloud Console
        // 2. Habilitar Google Drive API
        // 3. Crear credenciales OAuth 2.0
        // 4. Reemplazar CLIENT_ID y API_KEY en GOOGLE_DRIVE_CONFIG
    </script>
</body>
</html>