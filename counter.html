<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Visitantes en Tiempo Real</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        
        .counter-container {
            margin: 30px 0;
        }
        
        .counter {
            font-size: 6em;
            font-weight: 800;
            color: #667eea;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .status {
            font-size: 1.4em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            font-weight: 500;
        }
        
        .status.online {
            color: #2e7d32;
            background: #e8f5e9;
            border: 2px solid #4CAF50;
        }
        
        .status.offline {
            color: #c62828;
            background: #ffebee;
            border: 2px solid #f44336;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            padding: 12px 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .connection-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .connection-dot.online {
            background: #4CAF50;
        }
        
        .connection-dot.offline {
            background: #f44336;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .setup-guide {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin: 30px 0;
            text-align: left;
        }
        
        .setup-guide h3 {
            margin-bottom: 15px;
            color: #856404;
        }
        
        .setup-guide ol {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .setup-guide li {
            margin-bottom: 10px;
        }
        
        .setup-guide code {
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 5px;
            display: block;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            color: #d63384;
            overflow-x: auto;
            font-size: 0.9em;
        }
        
        .setup-guide a {
            color: #1976d2;
            text-decoration: none;
            font-weight: 600;
        }
        
        .setup-guide a:hover {
            text-decoration: underline;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
            font-size: 0.9em;
            color: #0d47a1;
        }
        
        .last-update {
            margin-top: 20px;
            color: #666;
            font-size: 0.9em;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .counter {
                font-size: 4em;
            }
            
            .status {
                font-size: 1.1em;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë• Visitantes en L√≠nea</h1>
        
        <div class="counter-container">
            <div class="counter" id="counter">0</div>
        </div>
        
        <div class="status online" id="statusMessage">
            Hay <span id="currentCount">0</span> visitantes en l√≠nea
        </div>
        
        <div class="connection-status">
            <div class="connection-dot" id="connectionDot"></div>
            <span id="connectionText">Conectando...</span>
        </div>
        
        <div class="setup-guide" id="setupGuide">
            <h3>‚öôÔ∏è Configuraci√≥n Paso a Paso</h3>
            <ol>
                <li>Ve a <a href="https://supabase.com" target="_blank">supabase.com</a> y reg√≠strate</li>
                <li>Crea un nuevo proyecto (gratis)</li>
                <li>En el men√∫ izquierdo, ve a <strong>SQL Editor</strong></li>
                <li>Pega este c√≥digo SQL y haz clic en <strong>RUN</strong>:</li>
            </ol>
            
            <code>
-- 1. Crear tabla de visitantes
CREATE TABLE IF NOT EXISTS visitors (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  session_id TEXT UNIQUE NOT NULL,
  last_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Crear funci√≥n para limpiar inactivos
CREATE OR REPLACE FUNCTION delete_old_visitors()
RETURNS void AS $$
BEGIN
  DELETE FROM visitors 
  WHERE last_seen < NOW() - INTERVAL '30 seconds';
END;
$$ LANGUAGE plpgsql;

-- 3. Habilitar pol√≠ticas de seguridad
ALTER TABLE visitors ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Permitir todo para visitantes" ON visitors
FOR ALL USING (true);
            </code>
            
            <p><strong>Luego:</strong></p>
            <ol start="5">
                <li>Ve a <strong>Settings ‚Üí API</strong></li>
                <li>Copia tu <strong>URL</strong> (ej: https://xyz.supabase.co)</li>
                <li>Copia tu <strong>anon public key</strong></li>
                <li>P√©galas en el c√≥digo JavaScript abajo ‚Üì</li>
            </ol>
        </div>
        
        <div class="info-box">
            <p><strong>‚ÑπÔ∏è Funcionamiento:</strong></p>
            <p>‚Ä¢ Cada visitante genera un ID √∫nico al cargar la p√°gina</p>
            <p>‚Ä¢ Se actualiza cada 10 segundos para mantenerse activo</p>
            <p>‚Ä¢ Los visitantes inactivos por 30+ segundos se eliminan</p>
            <p>‚Ä¢ El contador funciona en tiempo real en GitHub Pages</p>
        </div>
        
        <div class="last-update">
            √öltima actualizaci√≥n: <span id="lastUpdate">--:--:--</span>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN DE SUPABASE - ¬°REEMPLAZA ESTO!
        // ============================================
        const SUPABASE_URL = 'https://mtzdgshjufkpqjhwmvrb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10emRnc2hqdWZrcHFqaHdtdnJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MzYxNjAsImV4cCI6MjA4MzIxMjE2MH0.TM_7fRiGnXH__YP2QViA2JPBHerGhFjUtyi_X3srGxA';
        // ============================================
        
        // Verificar si la configuraci√≥n est√° completa
        function checkConfig() {
            const configOk = !SUPABASE_URL.includes('TU_PROYECTO');
            const setupGuide = document.getElementById('setupGuide');
            
            if (!configOk) {
                setupGuide.style.display = 'block';
                return false;
            } else {
                setupGuide.style.display = 'none';
                return true;
            }
        }
        
        // Inicializar Supabase solo si la configuraci√≥n es correcta
        let supabase;
        if (checkConfig()) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
        
        // Variables globales
        let sessionId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        let onlineCount = 0;
        let isConnected = false;
        
        // Elementos DOM
        const counterEl = document.getElementById('counter');
        const currentCountEl = document.getElementById('currentCount');
        const statusMessage = document.getElementById('statusMessage');
        const connectionText = document.getElementById('connectionText');
        const connectionDot = document.getElementById('connectionDot');
        const lastUpdate = document.getElementById('lastUpdate');
        
        // Generar ID de sesi√≥n √∫nico
        function generateSessionId() {
            return 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Actualizar hora
        function updateTime() {
            const now = new Date();
            lastUpdate.textContent = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // Conectar a Supabase
        async function connectToSupabase() {
            if (!supabase) {
                console.log('Supabase no configurado - Modo demo');
                startDemoMode();
                return;
            }
            
            try {
                console.log('Conectando a Supabase...');
                
                // Probar conexi√≥n
                const { data, error } = await supabase
                    .from('visitors')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    // Si hay error, podr√≠a ser que la tabla no existe
                    console.error('Error conectando a Supabase:', error);
                    
                    if (error.code === '42P01') { // Tabla no existe
                        showNotification('‚ö†Ô∏è La tabla "visitors" no existe. Ejecuta el SQL primero.', '#ff9800');
                    }
                    
                    setConnectionStatus(false, 'Error de conexi√≥n');
                    startDemoMode();
                    return;
                }
                
                // Conexi√≥n exitosa
                console.log('Conexi√≥n a Supabase exitosa');
                setConnectionStatus(true, 'Conectado a Supabase');
                
                // Registrar este visitante
                await registerVisitor();
                
                // Obtener contador inicial
                await updateVisitorCount();
                
                // Configurar intervalos
                setInterval(updateVisitorCount, 5000); // Actualizar cada 5 segundos
                setInterval(keepAlive, 10000); // Mantener activo cada 10 segundos
                
                // Ejecutar limpieza peri√≥dica
                setInterval(cleanupOldVisitors, 15000);
                
            } catch (error) {
                console.error('Error en connectToSupabase:', error);
                setConnectionStatus(false, 'Error de conexi√≥n');
                startDemoMode();
            }
        }
        
        // Registrar visitante
        async function registerVisitor() {
            if (!supabase || !isConnected) return;
            
            try {
                const { error } = await supabase
                    .from('visitors')
                    .upsert({
                        session_id: sessionId,
                        last_seen: new Date().toISOString()
                    }, {
                        onConflict: 'session_id'
                    });
                
                if (error) throw error;
                
                console.log('Visitante registrado:', sessionId);
            } catch (error) {
                console.error('Error registrando visitante:', error);
            }
        }
        
        // Mantener visitante activo
        async function keepAlive() {
            if (!supabase || !isConnected) return;
            
            try {
                await supabase
                    .from('visitors')
                    .update({ last_seen: new Date().toISOString() })
                    .eq('session_id', sessionId);
            } catch (error) {
                console.error('Error en keepAlive:', error);
            }
        }
        
        // Limpiar visitantes inactivos
        async function cleanupOldVisitors() {
            if (!supabase || !isConnected) return;
            
            try {
                // Ejecutar la funci√≥n de limpieza
                await supabase.rpc('delete_old_visitors');
            } catch (error) {
                // Si la funci√≥n no existe, usar DELETE directo
                try {
                    const thirtySecondsAgo = new Date(Date.now() - 30000).toISOString();
                    await supabase
                        .from('visitors')
                        .delete()
                        .lt('last_seen', thirtySecondsAgo);
                } catch (deleteError) {
                    console.error('Error limpiando visitantes:', deleteError);
                }
            }
        }
        
        // Actualizar contador de visitantes
        async function updateVisitorCount() {
            if (!supabase || !isConnected) {
                // Si no hay conexi√≥n, usar demo
                return;
            }
            
            try {
                // Limpiar visitantes inactivos primero
                await cleanupOldVisitors();
                
                // Contar visitantes activos
                const { count, error } = await supabase
                    .from('visitors')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    console.error('Error contando visitantes:', error);
                    return;
                }
                
                const newCount = count || 0;
                updateCounterUI(newCount);
                updateTime();
                
            } catch (error) {
                console.error('Error en updateVisitorCount:', error);
            }
        }
        
        // Actualizar interfaz del contador
        function updateCounterUI(newCount) {
            const oldCount = onlineCount;
            
            if (newCount === oldCount) return;
            
            onlineCount = newCount;
            
            // Actualizar n√∫meros
            counterEl.textContent = newCount;
            currentCountEl.textContent = newCount;
            
            // Animaci√≥n
            animateCounter(newCount > oldCount);
            
            // Actualizar mensaje de estado
            updateStatusMessage(newCount, oldCount);
            
            // Mostrar notificaci√≥n si cambi√≥ significativamente
            if (Math.abs(newCount - oldCount) > 0) {
                showNotification(
                    newCount > oldCount 
                        ? `üë§ Nuevo visitante! (Total: ${newCount})` 
                        : `üëã Visitante desconectado (Quedan: ${newCount})`,
                    newCount > oldCount ? '#4CAF50' : '#f44336'
                );
            }
        }
        
        // Animaci√≥n del contador
        function animateCounter(increased) {
            counterEl.style.transform = 'scale(1.3)';
            counterEl.style.color = increased ? '#4CAF50' : '#f44336';
            
            setTimeout(() => {
                counterEl.style.transform = 'scale(1)';
                counterEl.style.color = '#667eea';
            }, 300);
        }
        
        // Actualizar mensaje de estado
        function updateStatusMessage(newCount, oldCount) {
            let message = '';
            let statusClass = 'online';
            
            if (newCount === 0) {
                message = 'No hay visitantes en l√≠nea';
                statusClass = 'offline';
            } else if (newCount === 1) {
                message = 'Hay 1 visitante en l√≠nea (¬°eres t√∫!)';
                statusClass = 'online';
            } else if (newCount > oldCount) {
                message = `¬°Nuevo visitante! Ahora hay ${newCount} personas en l√≠nea`;
                statusClass = 'online';
            } else if (newCount < oldCount) {
                message = `Un visitante se fue. Quedan ${newCount} en l√≠nea`;
                statusClass = 'offline';
            } else {
                message = `Hay ${newCount} visitantes en l√≠nea`;
                statusClass = 'online';
            }
            
            statusMessage.textContent = message;
            statusMessage.className = `status ${statusClass}`;
        }
        
        // Establecer estado de conexi√≥n
        function setConnectionStatus(connected, message) {
            isConnected = connected;
            
            connectionText.textContent = message;
            
            if (connected) {
                connectionDot.className = 'connection-dot online';
                connectionText.style.color = '#4CAF50';
            } else {
                connectionDot.className = 'connection-dot offline';
                connectionText.style.color = '#f44336';
            }
        }
        
        // Mostrar notificaci√≥n temporal
        function showNotification(message, color) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
                font-weight: 600;
                max-width: 300px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Modo demostraci√≥n (si no hay Supabase configurado)
        function startDemoMode() {
            console.log('Iniciando modo demostraci√≥n...');
            
            setConnectionStatus(false, 'Modo demostraci√≥n (configura Supabase)');
            
            let demoCount = 1;
            updateCounterUI(demoCount);
            
            // Simular cambios aleatorios
            setInterval(() => {
                if (Math.random() > 0.7) {
                    if (Math.random() > 0.5 && demoCount < 8) {
                        demoCount++;
                    } else if (demoCount > 1) {
                        demoCount--;
                    }
                    
                    updateCounterUI(demoCount);
                }
                
                updateTime();
            }, 8000);
        }
        
        // Eliminar visitante al cerrar la p√°gina
        async function removeVisitorOnExit() {
            if (!supabase || !isConnected) return;
            
            try {
                await supabase
                    .from('visitors')
                    .delete()
                    .eq('session_id', sessionId);
                
                console.log('Visitante eliminado al salir:', sessionId);
            } catch (error) {
                console.error('Error eliminando visitante:', error);
            }
        }
        
        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Inicializando contador de visitantes...');
            
            // Verificar configuraci√≥n y conectar
            if (checkConfig() && supabase) {
                connectToSupabase();
            } else {
                startDemoMode();
            }
            
            // Actualizar hora cada segundo
            setInterval(updateTime, 1000);
            updateTime();
            
            // Configurar para eliminar visitante al salir
            window.addEventListener('beforeunload', removeVisitorOnExit);
            window.addEventListener('pagehide', removeVisitorOnExit);
            
            // Actualizar actividad con interacci√≥n del usuario
            document.addEventListener('click', () => {
                if (isConnected) keepAlive();
            });
            
            document.addEventListener('mousemove', () => {
                if (isConnected) keepAlive();
            });
            
            document.addEventListener('keydown', () => {
                if (isConnected) keepAlive();
            });
        });
        
        // A√±adir estilos CSS para animaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>