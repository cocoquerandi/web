<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador Debug</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: monospace; }
        
        body {
            background: #1a1a1a;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            font-size: 14px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 { color: #4CAF50; margin: 20px 0; font-size: 24px; }
        
        .panel {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }
        
        .panel.error { border-left-color: #f44336; }
        .panel.warning { border-left-color: #ff9800; }
        
        .counter {
            font-size: 72px;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            background: #333;
        }
        
        .online { color: #4CAF50; }
        .offline { color: #f44336; }
        
        .debug-info {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        
        .button:hover { background: #45a049; }
        
        .config {
            background: #ff9800;
            color: #000;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .config code {
            background: #000;
            color: #ff9800;
            padding: 10px;
            display: block;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DEBUG - Contador de Visitantes</h1>
        
        <div class="counter" id="counter">0</div>
        
        <div class="panel">
            <h3>üìä Estado del Sistema</h3>
            <div class="status" id="status">Estado: Inicializando...</div>
            <div id="connectionStatus">Conexi√≥n: Desconocido</div>
            <div id="sessionInfo">ID Sesi√≥n: Generando...</div>
        </div>
        
        <div class="config">
            <h3>‚öôÔ∏è CONFIGURACI√ìN REQUERIDA</h3>
            <p>1. Ejecuta este SQL en Supabase SQL Editor:</p>
            <code>CREATE TABLE visitors (session_id TEXT PRIMARY KEY, last_seen TIMESTAMP DEFAULT NOW());</code>
            <p>2. Luego reemplaza estos valores:</p>
            <code id="configCode">URL: https://TU_PROYECTO.supabase.co
KEY: TU_CLAVE_ANONIMA_AQUI</code>
        </div>
        
        <div class="panel">
            <h3>üõ†Ô∏è Controles</h3>
            <button class="button" onclick="forceCheck()">üîÅ Forzar Check</button>
            <button class="button" onclick="testConnection()">üîå Probar Conexi√≥n</button>
            <button class="button" onclick="clearDebug()">üßπ Limpiar Log</button>
            <button class="button" onclick="showConfig()">‚öôÔ∏è Mostrar Config</button>
        </div>
        
        <div class="panel">
            <h3>üìù Log de Debug</h3>
            <div class="debug-info" id="debugLog">Iniciando sistema...</div>
        </div>
        
        <div class="panel">
            <h3>üì° Informaci√≥n de Conexi√≥n</h3>
            <div id="connectionDetails">Cargando...</div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN - ¬°REEMPLAZA ESTOS VALORES!
        // ============================================
        const SUPABASE_URL = 'https://mtzdgshjufkpqjhwmvrb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10emRnc2hqdWZrcHFqaHdtdnJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MzYxNjAsImV4cCI6MjA4MzIxMjE2MH0.TM_7fRiGnXH__YP2QViA2JPBHerGhFjUtyi_X3srGxA';
        // ============================================
        
        // Variables globales
        let sessionId = 'debug_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
        let supabase = null;
        let onlineCount = 0;
        let debugLog = [];
        let connectionAttempts = 0;
        
        // Elementos DOM
        const counterEl = document.getElementById('counter');
        const statusEl = document.getElementById('status');
        const connectionStatusEl = document.getElementById('connectionStatus');
        const sessionInfoEl = document.getElementById('sessionInfo');
        const debugLogEl = document.getElementById('debugLog');
        const connectionDetailsEl = document.getElementById('connectionDetails');
        const configCodeEl = document.getElementById('configCode');
        
        // Funci√≥n para agregar log
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push({ message: logEntry, type });
            
            // Mostrar solo los √∫ltimos 20 logs
            const recentLogs = debugLog.slice(-20);
            debugLogEl.innerHTML = recentLogs.map(log => 
                `<div class="${log.type}">${log.message}</div>`
            ).join('');
            
            debugLogEl.scrollTop = debugLogEl.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Mostrar configuraci√≥n actual
        function showConfig() {
            addLog(`URL Config: ${SUPABASE_URL}`, 'config');
            addLog(`KEY Config: ${SUPABASE_KEY.substring(0, 20)}...`, 'config');
            addLog(`Session ID: ${sessionId}`, 'config');
        }
        
        // Limpiar log
        function clearDebug() {
            debugLog = [];
            debugLogEl.innerHTML = 'Log limpiado';
        }
        
        // Verificar configuraci√≥n
        function checkConfig() {
            const hasConfig = !SUPABASE_URL.includes('TU_PROYECTO') && 
                            !SUPABASE_KEY.includes('TU_CLAVE_ANONIMA');
            
            configCodeEl.textContent = `URL: ${SUPABASE_URL}\nKEY: ${SUPABASE_KEY.substring(0, 20)}...`;
            
            if (!hasConfig) {
                addLog('‚ùå CONFIGURACI√ìN NO V√ÅLIDA: Reemplaza los valores en el c√≥digo', 'error');
                statusEl.innerHTML = '<span class="offline">‚ùå Configura Supabase primero</span>';
                return false;
            } else {
                addLog('‚úÖ Configuraci√≥n detectada', 'success');
                return true;
            }
        }
        
        // Probar conexi√≥n
        async function testConnection() {
            addLog('üîå Probando conexi√≥n a Supabase...', 'info');
            
            try {
                // Verificar que podemos hacer una solicitud HTTP b√°sica
                const testUrl = `${SUPABASE_URL}/rest/v1/visitors?select=*&limit=1`;
                addLog(`URL de prueba: ${testUrl}`, 'info');
                
                const response = await fetch(testUrl, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                addLog(`Status: ${response.status} ${response.statusText}`, 'info');
                
                if (response.status === 200) {
                    addLog('‚úÖ Conexi√≥n HTTP exitosa', 'success');
                    return true;
                } else if (response.status === 404) {
                    addLog('‚ö†Ô∏è Tabla no existe (ejecuta el SQL)', 'warning');
                    return false;
                } else {
                    addLog(`‚ùå Error HTTP: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                addLog(`‚ùå Error de red: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Inicializar Supabase
        async function initSupabase() {
            connectionAttempts++;
            addLog(`Intento de conexi√≥n #${connectionAttempts}`, 'info');
            
            if (!checkConfig()) {
                addLog('No se puede inicializar: configuraci√≥n inv√°lida', 'error');
                return;
            }
            
            try {
                // Probar conexi√≥n primero
                const canConnect = await testConnection();
                if (!canConnect) {
                    addLog('No se puede conectar a Supabase', 'error');
                    statusEl.innerHTML = '<span class="offline">‚ùå No se puede conectar</span>';
                    return;
                }
                
                // Crear cliente Supabase
                addLog('Creando cliente Supabase...', 'info');
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Probar consulta simple
                addLog('Probando consulta a tabla visitors...', 'info');
                const { data, error } = await supabase
                    .from('visitors')
                    .select('*', { count: 'exact', head: true })
                    .limit(1);
                
                if (error) {
                    if (error.code === '42P01') {
                        addLog('‚ùå TABLA NO EXISTE: Ejecuta el SQL en Supabase', 'error');
                        statusEl.innerHTML = '<span class="offline">‚ùå Ejecuta el SQL primero</span>';
                    } else {
                        addLog(`‚ùå Error Supabase: ${error.message}`, 'error');
                        statusEl.innerHTML = `<span class="offline">‚ùå Error: ${error.message}</span>`;
                    }
                    return;
                }
                
                // Conexi√≥n exitosa
                addLog('‚úÖ Conexi√≥n a Supabase exitosa', 'success');
                statusEl.innerHTML = '<span class="online">‚úÖ Conectado a Supabase</span>';
                connectionStatusEl.textContent = 'Conexi√≥n: ‚úÖ Activa';
                
                // Registrar este visitante
                await registerVisitor();
                
                // Iniciar polling
                startPolling();
                
            } catch (error) {
                addLog(`‚ùå Error cr√≠tico: ${error.message}`, 'error');
                statusEl.innerHTML = `<span class="offline">‚ùå Error: ${error.message}</span>`;
            }
        }
        
        // Registrar visitante
        async function registerVisitor() {
            try {
                addLog(`Registrando visitante: ${sessionId}`, 'info');
                
                const { error } = await supabase
                    .from('visitors')
                    .upsert({
                        session_id: sessionId,
                        last_seen: new Date().toISOString()
                    }, {
                        onConflict: 'session_id'
                    });
                
                if (error) throw error;
                
                addLog('‚úÖ Visitante registrado', 'success');
                sessionInfoEl.textContent = `ID Sesi√≥n: ${sessionId}`;
                
            } catch (error) {
                addLog(`‚ùå Error registrando: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Actualizar contador
        async function updateCounter() {
            if (!supabase) {
                addLog('No hay cliente Supabase', 'warning');
                return;
            }
            
            try {
                // Limpiar inactivos (30 segundos)
                const cutoffTime = new Date(Date.now() - 30000).toISOString();
                
                const { error: deleteError } = await supabase
                    .from('visitors')
                    .delete()
                    .lt('last_seen', cutoffTime);
                
                if (deleteError) {
                    addLog(`Error limpiando: ${deleteError.message}`, 'warning');
                }
                
                // Obtener contador
                const { count, error } = await supabase
                    .from('visitors')
                    .select('*', { count: 'exact', head: true });
                
                if (error) throw error;
                
                const newCount = count || 0;
                
                // Actualizar UI
                updateUI(newCount);
                
                // Mantener activo
                await keepAlive();
                
            } catch (error) {
                addLog(`‚ùå Error actualizando: ${error.message}`, 'error');
            }
        }
        
        // Mantener activo
        async function keepAlive() {
            if (!supabase) return;
            
            try {
                await supabase
                    .from('visitors')
                    .update({ last_seen: new Date().toISOString() })
                    .eq('session_id', sessionId);
            } catch (error) {
                addLog(`Error keepAlive: ${error.message}`, 'warning');
            }
        }
        
        // Actualizar UI
        function updateUI(count) {
            const oldCount = onlineCount;
            onlineCount = count;
            
            counterEl.textContent = count;
            
            // Animaci√≥n
            counterEl.style.transform = 'scale(1.1)';
            setTimeout(() => counterEl.style.transform = 'scale(1)', 200);
            
            // Log si cambi√≥
            if (count !== oldCount) {
                addLog(`Contador: ${oldCount} ‚Üí ${count}`, 'success');
            }
            
            // Actualizar detalles
            connectionDetailsEl.innerHTML = `
                <div>Visitantes online: <strong>${count}</strong></div>
                <div>Tiempo: ${new Date().toLocaleTimeString()}</div>
                <div>Intento: ${connectionAttempts}</div>
            `;
        }
        
        // Forzar check
        async function forceCheck() {
            addLog('Forzando actualizaci√≥n...', 'info');
            await updateCounter();
        }
        
        // Iniciar polling
        function startPolling() {
            // Actualizar cada 5 segundos
            setInterval(updateCounter, 5000);
            
            // Mantener activo cada 10 segundos
            setInterval(keepAlive, 10000);
            
            // Primer update
            setTimeout(updateCounter, 1000);
            
            addLog('Polling iniciado (5s)', 'success');
        }
        
        // Eliminar al salir
        async function removeOnExit() {
            if (!supabase) return;
            
            try {
                await supabase
                    .from('visitors')
                    .delete()
                    .eq('session_id', sessionId);
                addLog('Visitante eliminado al salir', 'info');
            } catch (error) {
                // Ignorar
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Sistema iniciado', 'info');
            showConfig();
            
            // Mostrar info de sesi√≥n
            sessionInfoEl.textContent = `ID Sesi√≥n: ${sessionId}`;
            
            // Iniciar Supabase despu√©s de 1 segundo
            setTimeout(initSupabase, 1000);
            
            // Configurar para eliminar al salir
            window.addEventListener('beforeunload', removeOnExit);
        });
    </script>
</body>
</html>